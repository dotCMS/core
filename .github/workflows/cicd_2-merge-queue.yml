name: '-2 Merge Group Check'
on:
  merge_group:
    types: [ checks_requested ]
    branches: [ main, master ]
jobs:
  initialize:
    name: Initialize
    uses: ./.github/workflows/cicd_comp_initialize-phase.yml
    # Runs ALL tests to catch flaky tests and filter gaps that PR checks might miss
    # To enable selective testing, change to: change-detection: 'enabled'
    with:
      change-detection: 'disabled'
  build:
    name: Merge Group Build
    needs: [ initialize ]
    if: needs.initialize.outputs.found_artifacts == 'false'
    uses: ./.github/workflows/cicd_comp_build-phase.yml
    permissions:
      contents: read
      packages: write
  test:
    name: Merge Group Test
    needs: [ initialize,build ]
    if: always() && !failure() && !cancelled()
    uses: ./.github/workflows/cicd_comp_test-phase.yml
    with:
      jvm_unit_test: ${{ fromJSON(needs.initialize.outputs.filters).jvm_unit_test == 'true' }}
      integration: ${{ fromJSON(needs.initialize.outputs.filters).backend == 'true' }}
      postman: ${{ fromJSON(needs.initialize.outputs.filters).backend == 'true' }}
      karate: ${{ fromJSON(needs.initialize.outputs.filters).backend == 'true' }}
      frontend: ${{ fromJSON(needs.initialize.outputs.filters).frontend == 'true' }}
      cli: ${{ fromJSON(needs.initialize.outputs.filters).cli == 'true' || fromJSON(needs.initialize.outputs.filters).backend == 'true' }}
      e2e: false
    secrets:
      DOTCMS_LICENSE: ${{ secrets.DOTCMS_LICENSE }}
  finalize:
    name: Finalize
    if: always()
    needs: [ test ]
    uses: ./.github/workflows/cicd_comp_finalize-phase.yml
    with:
      needsData: ${{ toJson(needs) }}