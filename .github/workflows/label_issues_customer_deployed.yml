name: Add Customer Deployed Labels

on:
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      release_label:
        description: 'Release Label (e.g., "Release: 24.03")'
        required: true
        type: string
  
  # Allow repository_dispatch for external triggering (like from Argo)
  repository_dispatch:
    types: [deployment-completed]

jobs:
  add-labels:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Add Customer Deployed Labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN_DOTCMS: ${{ secrets.GITHUB_TOKEN_DOTCMS }}
        run: |
          # Determine the release label
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            RELEASE_LABEL="${{ github.event.inputs.release_label }}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            RELEASE_LABEL="${{ github.event.client_payload.release_label }}"
          else
            echo "Error: Unknown event trigger"
            exit 1
          fi
          
          echo "Adding Customer Deployed labels for release: $RELEASE_LABEL"
          
          # Execute the Python script
          cd scripts/dev-metrics
          python add_customer_deployed_label.py "$RELEASE_LABEL"
