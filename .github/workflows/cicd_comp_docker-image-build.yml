# Docker Image Build Workflow
#
# This reusable workflow is responsible for building and pushing Docker images
# for dotCMS releases. It supports building for multiple platforms and can
# be configured with custom tags and other options.
#
# Key features:
# - Supports building for multiple platforms (amd64, arm64)
# - Uses Docker buildx for efficient multi-platform builds
# - Configurable tag formats and image names
# - Optional pushing to Docker Hub

name: Docker Image Build

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to use for the build'
        required: true
        type: string
      docker_platforms:
        description: 'Docker platforms to build for (comma-separated, e.g. linux/amd64,linux/arm64)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      docker_context_cache_key:
        description: 'Cache key for Docker build context'
        required: true
        type: string
      push_images:
        description: 'Whether to push the images to the registry'
        required: false
        type: boolean
        default: true
      environment:
        description: 'The standard environment name (release, nightly, qa, trunk)'
        required: false
        type: string
        default: 'release'
      docker_tag:
        description: 'The Docker tag to use (defaults to extracted version)'
        required: false
        type: string
        default: ''
      maven_revision:
        description: 'The Maven revision property'
        required: false
        type: string
        default: ''
      maven_changelist:
        description: 'The Maven changelist property'
        required: false
        type: string
        default: ''
      docker_registry:
        description: 'Docker registry to push images to (dockerhub or ghcr)'
        required: false
        type: string
        default: 'dockerhub'
    outputs:
      formatted_tags:
        description: "The formatted tags of the Docker images"
        value: ${{ jobs.build-push-image.outputs.formatted_tags }}
    secrets:
      docker_io_username:
        required: true
      docker_io_token:
        required: true
      github_token:
        required: false

env:
  DOCKER_BUILD_CONTEXT: /home/runner/work/_temp/core-build

jobs:
  build-push-image:
    name: Build/Push Image
    runs-on: ubuntu-${{ vars.UBUNTU_RUNNER_VERSION || '24.04' }}
    outputs:
      formatted_tags: ${{ steps.docker-metadata.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - uses: ./.github/actions/core-cicd/cleanup-runner

      # Restore Docker context from cache
      - name: Restore Docker Context
        id: restore-docker-context
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.DOCKER_BUILD_CONTEXT }}/context
          key: ${{ inputs.docker_context_cache_key }}
          fail-on-cache-miss: true

      # Extract version information from the ref
      - name: Extract version
        id: extract-version
        run: |
          if [[ "${{ inputs.ref }}" =~ ^v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "Unable to extract version from ref ${{ inputs.ref }}"
            exit 1
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Image version: ${VERSION}"
          
          # Log environment and Maven information
          echo "Environment: ${{ inputs.environment }}"
          echo "Docker tag: ${{ inputs.docker_tag || steps.extract-version.outputs.version }}"
          echo "Maven revision: ${{ inputs.maven_revision }}"
          echo "Maven changelist: ${{ inputs.maven_changelist }}"

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ inputs.docker_platforms }}

      # Log in to Docker Hub
      - name: Login to Docker Hub
        if: inputs.push_images && inputs.docker_registry == 'dockerhub'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.docker_io_username }}
          password: ${{ secrets.docker_io_token }}
          
      # Log in to GitHub Container Registry
      - name: Login to GitHub Container Registry
        if: inputs.push_images && inputs.docker_registry == 'ghcr'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.github_token }}

      # Configure Docker metadata with appropriate registry
      - name: Docker meta
        id: docker-metadata
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.docker_registry == 'ghcr' && 'ghcr.io/dotcms/dotcms' || 'dotcms/dotcms' }}
          tags: |
            type=raw,value=${{ inputs.docker_tag || steps.extract-version.outputs.version }}
            type=raw,value=latest

      # Build and push Docker image
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.DOCKER_BUILD_CONTEXT }}/context
          platforms: ${{ inputs.docker_platforms }}
          push: ${{ inputs.push_images }}
          tags: ${{ steps.docker-metadata.outputs.tags }}
          labels: ${{ steps.docker-metadata.outputs.labels }} 