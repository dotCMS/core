# Build Phase Workflow
#
# This reusable workflow is responsible for performing the core build process,
# including artifact generation, validation, and optional PR checks.
#
# Key features:
# - Configurable core build execution
# - Optional PR checks
# - Supports validation profile
# - Configurable version setting
# - Optional Docker artifact generation
# - Checks for unauthorized modifications to maven.config and working directory

name: Build Phase

on:
  workflow_call:
    inputs:
      core-build:
        description: "Run core build"
        type: boolean
        default: true
      run-pr-checks:
        description: "Run PR checks"
        type: boolean
        default: false
      ref:
        description: "Branch or tag ref"
        required: false
        default: ''
        type: string
      validate:
        description: "Run validation"
        type: boolean
        default: false
      version:
        description: 'The version of the build'
        required: false
        type: string
        default: '1.0.0-SNAPSHOT'
      generate-docker:
        description: 'Generate docker artifact'
        required: false
        type: boolean
        default: true

jobs:
  # Lint GitHub Workflows
  lint-workflows:
    name: Lint GitHub Workflows
    runs-on: ubuntu-${{ vars.UBUNTU_RUNNER_VERSION || '24.04' }}
    if: inputs.run-pr-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        if: inputs.ref == ''
        with:
          fetch-depth: 0
      - name: Checkout code with ref ${{ inputs.ref }}
        if: inputs.ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Setup actionlint
        shell: bash
        run: |
          # Get the latest version or use a specific version if needed
          ACTIONLINT_VERSION=$(curl -s https://api.github.com/repos/rhysd/actionlint/releases/latest | jq -r '.tag_name')
          echo "Installing actionlint version ${ACTIONLINT_VERSION}"
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash) ${ACTIONLINT_VERSION}
          echo "$(pwd)/actionlint" >> $GITHUB_PATH

      - name: Lint GitHub workflows
        id: actionlint
        shell: bash
        run: |
          echo "::group::Linting GitHub workflows and actions"
          # Create output directory for linting results
          mkdir -p linting-results
          
          # Run actionlint on all workflow files
          # Capture both stdout and exit code
          set +e
          actionlint -color -format '{{range $err := .}}::error file={{$err.Filepath}},line={{$err.Line}},col={{$err.Column}}::{{$err.Message}}%0A```%0A{{$err.Snippet}}%0A```%0A{{end}}' > linting-results/actionlint-output.txt
          ACTIONLINT_EXIT_CODE=$?
          set -e
          
          # Output the results
          cat linting-results/actionlint-output.txt
          
          echo "Total issues found: $(grep -c '::error' linting-results/actionlint-output.txt || echo 0)"
          echo "::endgroup::"
          
          # Generate summary for GitHub Actions UI
          echo "## GitHub Workflow Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "- Files checked: $(find .github/workflows -name '*.yml' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Issues found: $(grep -c '::error' linting-results/actionlint-output.txt || echo 0)" >> $GITHUB_STEP_SUMMARY
          
          exit $ACTIONLINT_EXIT_CODE

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-lint-results
          path: linting-results/
          retention-days: 7

  # Initial JDK Build
  # This job performs a basic build and install with Maven without running tests.
  # It provides a local Maven repo for subsequent steps.
  build-jdk11:
    name: "Initial Artifact Build"
    runs-on: ubuntu-${{ vars.UBUNTU_RUNNER_VERSION || '24.04' }}
    if: inputs.core-build == true
    permissions:
      contents: read
      packages: write
    steps:
      # Checkout code based on whether a specific ref is provided
      - name: Checkout code
        uses: actions/checkout@v4
        if: inputs.ref == ''
        with:
          fetch-depth: 0
      - name: Checkout code with ref ${{ inputs.ref }}
        if: inputs.ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      # Check if .mvn/maven.config is modified in PR (only for PR checks)
      - name: Check if .mvn/maven.config is in the PR commit
        if: inputs.run-pr-checks
        run: |
          if git diff --name-only origin/main...HEAD | grep -q '^\.mvn/maven.config$'; then
            echo "Error: .mvn/maven.config should not be modified in PR commits. This should only be set on release branches."
            exit 1
          else
            echo ".mvn/maven.config is not modified in this PR."
          fi

      # Set up validation profile if required
      - name: Set up validate profile
        id: setup-validate-profile
        run: |
          if [ "${{ inputs.validate }}" == "true" ]; then
            echo "VALIDATE_PROFILE=-Pvalidate" >> $GITHUB_ENV
          else
            echo "VALIDATE_PROFILE=" >> $GITHUB_ENV
          fi

      # Run the Maven build job
      - uses: ./.github/actions/core-cicd/maven-job
        with:
          stage-name: "Initial Artifact Build"
          maven-args: "clean install ${{ env.VALIDATE_PROFILE }} -Dprod=true -DskipTests=true -Dgithub.event.name=${{ github.event_name }}"
          generate-artifacts: true
          require-main: ${{ inputs.version == '1.0.0-SNAPSHOT' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cleanup-runner: true
          version: ${{ inputs.version }}
          generate-docker: ${{ inputs.generate-docker }}

      # Check for unauthorized changes to the working directory (only for PR checks)
      - name: Check for changes to source during build
        if: inputs.run-pr-checks
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Error: There are uncommitted changes in the working directory. These may have been modified by the build process. Go back and run a full build before committing changes, or add these files to .gitignore if not required to be stored in the source to ensure the build is clean."
            git status --porcelain
            exit 1
          else
            echo "No uncommitted changes found."
          fi