#
# ⚠️ DEPRECATED WORKFLOW ⚠️
#
# This workflow is deprecated and will be removed in a future release.
#
# Migration Path:
# → Use: .github/workflows/cicd_8-manual-deploy.yml
#
# The new workflow provides:
# - Same functionality (deploy from any branch/tag)
# - Better integration with modular CI/CD phases
# - Java version override support
# - Consistent with modern pipeline architecture
# - More flexible environment and tag naming
#
# Usage comparison:
#   Old: Trigger this workflow, select branch from GitHub UI
#   New: Trigger cicd_8-manual-deploy.yml with inputs:
#        - ref: your-branch-or-tag
#        - environment: your-environment-name
#        - custom_tag: (optional) your-custom-tag
#
# Deprecation Timeline:
# - Deprecated: February 2026
# - Removal: After 2-week validation period (March 2026)
#
# Last known usage: February 16, 2026 (actively used for feature branch testing)
#

name: Build/Push dotCMS docker image [DEPRECATED]
on:
  workflow_dispatch:
    inputs:
      multi_arch:
        description: 'Build Multi-arch'
        required: true
        type: boolean
        default: true
      docker_registry:
        description: 'Docker registry to push the image to'
        required: false
        type: choice
        options:
          - 'DOCKER.IO'
          - 'GHCR.IO'
          - 'BOTH'
        default: 'DOCKER.IO'
      custom_tag:
        description: 'Custom Docker Image Tag'
        required: false
        type: string
jobs:
  prepare-build:
    name: Prepare build
    runs-on: ubuntu-${{ vars.UBUNTU_RUNNER_VERSION || '24.04' }}
    outputs:
      ref: ${{ steps.set-common-vars.outputs.ref }}
      docker_platforms: ${{ steps.set-common-vars.outputs.docker_platforms }}
    steps:
      - run: echo 'GitHub context'
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - name: Resolve Docker Platforms
        id: set-common-vars
        run: |
          ref=$(basename ${{ github.event.ref }})
          docker_platforms="${{ github.event.inputs.multi_arch == 'true' && 'linux/amd64,linux/arm64' || 'linux/amd64' }}"
          
          echo "ref=${ref}" >> $GITHUB_OUTPUT
          echo "docker_platforms=${docker_platforms}" >> $GITHUB_OUTPUT

  build_push_image:
    name: Build/Push Image
    needs: prepare-build
    uses: ./.github/workflows/legacy-release_comp_maven-build-docker-image.yml
    with:
      ref: ${{ needs.prepare-build.outputs.ref }}
      docker_platforms: ${{ needs.prepare-build.outputs.docker_platforms }}
      docker_registry: ${{ inputs.docker_registry }}
      custom_tag: ${{ inputs.custom_tag }}
    secrets:
      docker_io_username: ${{ secrets.DOCKER_USERNAME }}
      docker_io_token: ${{ secrets.DOCKER_TOKEN }}
      ghcr_io_username: ${{ secrets.DOCKER_USERNAME }}
      ghcr_io_token: ${{ secrets.GHCR_TOKEN }}
