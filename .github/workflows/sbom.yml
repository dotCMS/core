name: sbom

on:
  workflow_dispatch:

jobs:

  scanner:
    runs-on: [self-hosted, Windows, x64]

    steps:
      - name: Start dotCMS with docker
        id: start-dotcms
        run: |
          docker pull dotcms/dotcms:latest
          docker run -d dotcms/dotcms:latest
        
      - name: Pull rashik1144/core-test-results repository
        run: |
          git config pull.rebase false
          git remote add origin https://github.com/rashik1144/core-test-results.git
          git pull origin master
        working-directory: C:\Users\rashi\core-test-results
        
      - name: Get latest release version
        run: |
          $releases = Invoke-WebRequest -Uri "https://api.github.com/repos/dotCMS/core/releases" | ConvertFrom-Json
          $release_version = ($releases | ForEach-Object { $_.tag_name.TrimStart('v') }) | Sort-Object -Descending | Select-Object -First 1
          $formatted_version = "release-$release_version"
          Write-Output "Latest release version: $formatted_version"
          echo "release_version=$formatted_version" >> $env:GITHUB_ENV
        shell: powershell
        
      - name: Check server status
        id: check-server-status
        run: |
          $server_status = (Invoke-WebRequest -Uri "http://localhost:8082/dotAdmin" -Method Head -UseBasicParsing).StatusCode
          if ($server_status -eq 200) {
            Write-Output "Web server is running"
          } else {
            Write-Output "Web server is not running"
            exit 1
          }

      - name: Scan Docker Image with Syft
        run: |
          pipx run anchore_syft  dotcms/dotcms:latest -o cyclonedx-xml > cyclonedx.json
        working-directory: C:\Users\rashi\core-test-results

      - name: Stop dotCMS
        run: docker-compose down
        working-directory: C:\Users\rashi
          
      - name: Switch to release branch
        run: |
          $branch_name = "${env:release_version}"
          git fetch origin $branch_name
          if (-not $?) {
            git checkout -b $branch_name origin/$branch_name
          }
        shell: powershell
        working-directory: C:\Users\rashi\core-test-results

      - name: Add files and commit changes
        run: |
          git add .
          git commit -m "Add test results for release ${{ env.release_version }}"
        working-directory: C:\Users\rashi\core-test-results

      - name: Push changes to rashik1144/core-test-results repository
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.SECRET_PENTEST_TOKEN }}
          branch: ${{ env.release_version }}
          force: true
          directory: C:\Users\rashicore-test-results\
          repository: rashik1144/core-test-results
          
  maintenance:
    runs-on: [self-hosted, Windows, x64]

    steps:
      - name: Connect to self-hosted runner
        run: echo "Connecting to self-hosted runner to avoid termination due to inactivity"

