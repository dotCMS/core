name: Github Runner Cleanup
on:
  workflow_call:

jobs:
  runner-cleanup:
    name: Cleanup Runner Resources
    runs-on: ubuntu-latest
    if: success()
    steps:
        - name: Show Disk Usage
          run: |
            echo "# df -h"
            df -h
            
            echo '# docker images'
            docker images || true
            
            echo '# du -sh /var/lib'
            sudo du -sh /var/lib || true
            echo '# du -sh /opt/hostedtoolcache'
            sudo du -sh /opt/hostedtoolcache || true
            echo '# du -sh /imagegeneration/installers'
            sudo du -sh /imagegeneration/installers || true
            
            echo '# du -sh /home/runner'
            sudo du -sh /home/runner || true
            echo '# du -sh /home/runner/work/_temp'
            sudo du -sh /home/runner/work/_temp || true
            echo '# du -sh /home/runner/work/_actions'
            sudo du -sh /home/runner/work/_actions || true
            echo '# du -sh /home/runner/work/_tool'
            sudo du -sh /home/runner/work/_tool || true
            echo '# du -sh /home/runner/work/_config'
            sudo du -sh /home/runner/work/_config || true

        - name: Cleanup Docker
          run: |
            echo 'Cleanup Docker'
            time docker system prune -f
            time docker volume prune -f
            time docker image prune -f
            time docker container prune -f
            time docker network prune -f

        - name: Reclaim Disk Space
          run: |
            time sudo rm -rf /usr/share/dotnet || true
            time sudo rm -rf /usr/share/swift || true
            time sudo rm -rf /usr/local/lib/android || true
            time sudo rm -rf /opt/ghc || true
            time sudo rm -rf /opt/pipx || true

            time sudo rm -rf /opt/hostedtoolcache/CodeQL || true
            time sudo rm -rf /imagegeneration/installers/go-* || true
            time sudo rm -rf /imagegeneration/installers/node-* || true
            time sudo rm -rf /imagegeneration/installers/python-* || true
            
            time sudo rm -rf /home/runner/work/_temp/* || true
            time sudo rm -rf /home/runner/work/_actions/* || true
            time sudo rm -rf /home/runner/work/_tool/* || true
            time sudo rm -rf /home/runner/work/_config/* || true

        - name: Show Disk Usage
          run: |
            echo "# df -h"
            df -h

            echo '# docker images'
            docker images || true

            echo '# du -sh /var/lib'
            sudo du -sh /var/lib || true
            echo '# du -sh /opt/hostedtoolcache'
            sudo du -sh /opt/hostedtoolcache || true
            echo '# du -sh /imagegeneration/installers'
            sudo du -sh /imagegeneration/installers || true

            echo '# du -sh /home/runner'
            sudo du -sh /home/runner || true
            echo '# du -sh /home/runner/work/_temp'
            sudo du -sh /home/runner/work/_temp || true
            echo '# du -sh /home/runner/work/_actions'
            sudo du -sh /home/runner/work/_actions || true
            echo '# du -sh /home/runner/work/_tool'
            sudo du -sh /home/runner/work/_tool || true
            echo '# du -sh /home/runner/work/_config'
            sudo du -sh /home/runner/work/_config || true
