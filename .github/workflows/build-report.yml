name: CICD Reports
run-name: Reports - ${{ github.event.workflow_run.name }}
on:
  workflow_run:
    workflows: ['Maven CICD Pipeline'] 
    types: [completed]

permissions:
  checks: write

jobs:
  report:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'skipped'
    outputs:
      workflow-json: ${{ steps.workflow-data.outputs.json }}
    steps:
      - name: Log GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Download Worlfkow Data
        id: data-download
        uses: dawidd6/action-download-artifact@v2
        with:
          name: 'workflow-data'
          workflow: ${{ github.event.workflow.id }}
          run_id: ${{ github.event.workflow_run.id }}
          if_no_artifact_found: warn

      - uses: dorny/test-reporter@v1
        id: test-reporter
        if: steps.data-download.outputs.found_artifact == 'true'
        with:
          artifact: /^build-reports-test-(.*)/        # artifact name
          name: 'MVN Test Report $1'               # Name of the check run which will be created
          path: '**/target/**/TEST-*.xml'                     # Path to test results (inside artifact .zip)
          reporter: java-junit            # Format of test results
          fail-on-error: false
          
      - name: Get Workflow Data
        id: workflow-data
        if: steps.data-download.outputs.found_artifact == 'true'
        run: |
          if [[ ! -e "workflow-data.json" ]]
          then
            echo "::warn title=Artifact 'workflow-data' missing::Expected artifact 'workflow-data' does not exist for pull_request event."
          else
            json=$(jq -c '.' workflow-data.json)
            status=$(echo $json | jq -r '.aggregate_status // "null"')
            pr_number=$(echo $json | jq -r '.pr_number // "null"')
            pr_author=$(echo $json | jq -r '.pr_author // "null"')
            run_id=$(echo $json | jq -r '.run_id // "null"')
            first_fail_step=$(echo $json | jq -r '.first_fail_step // "None"')
            first_fail_module=$(echo $json | jq -r '.first_fail_module // "None"')
            first_fail_error=$(echo $json | jq -r '.first_fail_error // "None"')
            pr_title=$(echo $json | jq -r '.pr_title // "null"')
            branch=$(echo $json | jq -r '.branch // "null"')
            head_sha=$(echo $json | jq -r '.head_sha // "null"')
            head_author=$(echo $json | jq -r '.head_author // "null"')
            head_name=$(echo $json | jq -r '.head_name // "null"')
            source_repository=$(echo $json | jq -r '.source_repository // "null"')
            action_run_url="https://github.com/$source_repository/actions/runs/$run_id"
            pr_number_url="https://github.com/$source_repository/pull/$pr_number"
            branch_url="https://github.com/$source_repository/tree/$branch"
            commit_id_url="https://github.com/$source_repository/pull/$pr_number/commits/$head_sha"
            test_results_url="https://github.com/$source_repository/pull/${pr_number}/checks"
            test_conclusion=${{ steps.test-reporter.outputs.conclusion }}
            test_passed=${{ steps.test-reporter.outputs.passed }}
            test_failed=${{ steps.test-reporter.outputs.failed}}
            test_skipped=${{ steps.test-reporter.outputs.skipped }}
            test_elapsed=${{ steps.test-reporter.outputs.time }}
            
            if [[ "$status" == "SUCCESS" ]]; then
              echo "status_icon=âœ…" >> $GITHUB_OUTPUT
            else
              echo "status_icon=âŒ" >> $GITHUB_OUTPUT
            fi
            echo "json=$json" >> $GITHUB_OUTPUT
            echo "has-json=true" >> $GITHUB_OUTPUT
            echo "status=$status" >> $GITHUB_OUTPUT
            echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
            echo "pr_author=$pr_author" >> $GITHUB_OUTPUT
            echo "run_id=$run_id" >> $GITHUB_OUTPUT
            echo "first_fail_step=$first_fail_step" >> $GITHUB_OUTPUT
            echo "first_fail_module=$first_fail_module" >> $GITHUB_OUTPUT
            echo "first_fail_error=$first_fail_error" >> $GITHUB_OUTPUT
            echo "pr_title=$pr_title" >> $GITHUB_OUTPUT
            echo "branch=$branch" >> $GITHUB_OUTPUT
            echo "head_sha=$head_sha" >> $GITHUB_OUTPUT
            echo "head_author=$head_author" >> $GITHUB_OUTPUT
            echo "head_name=$head_name" >> $GITHUB_OUTPUT
            echo "source_repository=$source_repository" >> $GITHUB_OUTPUT
            echo "action_run_url=$action_run_url" >> $GITHUB_OUTPUT
            echo "pr_number_url=$pr_number_url" >> $GITHUB_OUTPUT
            echo "branch_url=$branch_url" >> $GITHUB_OUTPUT
            echo "commit_id_url=$commit_id_url" >> $GITHUB_OUTPUT
            echo "test_results_url=$test_results_url" >> $GITHUB_OUTPUT
            echo "test_conclusion=$test_conclusion" >> $GITHUB_OUTPUT
            echo "test_passed=$test_passed" >> $GITHUB_OUTPUT
            echo "test_failed=$test_failed" >> $GITHUB_OUTPUT
            echo "test_skipped=$test_skipped" >> $GITHUB_OUTPUT
            echo "test_elapsed=$test_elapsed" >> $GITHUB_OUTPUT
          fi
          
      - name: Post to a Slack channel
        if: steps.workflow-data.outputs.has-json == 'true'
        id: slack
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ vars.SLACK_REPORT_CHANNEL }}
          payload: |
            {
              "text":"Github Action ${{ steps.workflow-data.outputs.status }} for run PR #${{ steps.workflow-data.outputs.pr_number }}",

              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ“Š Github Action ${{ steps.workflow-data.outputs.status }} for run PR #${{ steps.workflow-data.outputs.pr_number }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸƒâ€â™‚ï¸ Action Run:*\n<${{ steps.workflow-data.outputs.action_run_url }} | ${{ steps.workflow-data.outputs.run_id }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*âŒ Failure Step:*\n${{ steps.workflow-data.outputs.first_fail_step }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ“¦ Failure Module:*\n${{ steps.workflow-data.outputs.first_fail_module }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ’¬ Failure Message:*\n${{ steps.workflow-data.outputs.first_fail_error }}"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ‘©â€ğŸ’» PR Author:*\n${{ steps.workflow-data.outputs.pr_author }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ“ PR Name:*\n${{ steps.workflow-data.outputs.pr_title }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ”¢ PR Number:*\n<${{ steps.workflow-data.outputs.pr_number_url }}|#${{ steps.workflow-data.outputs.pr_number }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸŒ³ Branch Name:*\n<${{ steps.workflow-data.outputs.branch_url }}|${{ steps.workflow-data.outputs.branch }}>"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ’¾ Commit ID:*\n<${{ steps.workflow-data.outputs.commit_id_url }}|#${{ steps.workflow-data.outputs.head_sha }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ§‘â€ğŸ’» Commit Author:*\n${{ steps.workflow-data.outputs.head_author }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ“œ Commit Name:*\n${{ steps.workflow-data.outputs.head_name }}"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ§ª Tests - ${{ steps.workflow-datar.outputs.test_conclusion }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *Passed*:${{ steps.workflow-data.outputs.test_passed }}  âŒ *Failed*:${{ steps.workflow-data.outputs.test_failed}}   â­ï¸ *Skipped*:${{ steps.workflow-data.outputs.test_skipped }}    â±ï¸ *Elapsed*:${{ steps.workflow-data.outputs.test_elapsed }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ” <${{ steps.workflow-data.outputs.test_results_url }} |View Results>"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
