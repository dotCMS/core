name: Maven CICD Pipeline

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
      tags:
        description: 'Tags'
        required: false
  push:
    branches:
        - master
        - release-*
    paths-ignore:
      - '.gitignore'
      - '.dockerignore'
      - 'dotCMS/src/main/webapp/html'
      - '!docker/**'
      - 'tools/**'
      - 'cicd/**'
      - '.cicd/**'
      - '*.md'
      - '*.adoc'
      - '*.txt'
      - '.github/ISSUE_TEMPLATE/**'
  pull_request:
    paths-ignore:
      - '.gitignore'
      - '.dockerignore'
      - 'dotCMS/src/main/webapp/html'
      - '!docker/**'
      - 'tools/**'
      - 'cicd/**'
      - '.cicd/**'
      - '*.md'
      - '*.adoc'
      - '*.txt'
      - '.github/ISSUE_TEMPLATE/**'
  merge_group:
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref || github.run_id }}
  cancel-in-progress: true
env:
  JVM_TEST_MAVEN_OPTS: "-e -B"
jobs:
  build-jdk11:
    name: "Initial JDK 11 Build"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
      - name: Get Date
        id: get-date
        run: |
          echo "date=$(/bin/date -u "+%Y-%m")" >> $GITHUB_OUTPUT
        shell: bash
      - name: Cache Maven Repository
        id: cache-maven
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: mavencore-${{ steps.get-date.outputs.date }}
      - name: Cache Node
        id: cache-node
        uses: actions/cache@v3
        with:
          path: |
            core-web/node_modules
            core-web/installs
          key: node-${{ steps.get-date.outputs.date }}
      - name: Build and Test with Maven
        run: ./mvnw --show-version -DskipTests=true -DskipITs=true clean install --file pom.xml

      - name: Tar Maven Repo
        shell: bash
        run: tar -czf maven-repo.tgz -C ~ .m2/repository

      - name: Persist Maven Repo
        uses: actions/upload-artifact@v3
        with:
          name: maven-repo
          path: maven-repo.tgz

      - name: Delete Local Artifacts From Cache
        shell: bash
        run: rm -r ~/.m2/repository/com/dotcms

      - name: Upload build reports
        uses: actions/upload-artifact@v3
        if: ${{ always() }}
        with:
          name: "build-reports-Initial JDK 11 Build" #Should not be picked up for JunitReports
          path: |
            target/build-report.json
            LICENSE
          retention-days: 2
  linux-jvm-tests:
    name: JVM Unit Tests - JDK ${{matrix.java.name}}
    runs-on: ubuntu-latest
    # Skip master in forks
    if: "github.repository == 'dotCMS/core' || !endsWith(github.ref, '/master')"
    needs: build-jdk11
    timeout-minutes: 240
    env:
      MAVEN_OPTS: -Xmx2048m
    strategy:
      fail-fast: false
      matrix:
        java:
          - {
            name: "11",
            java-version: 11,
            distribution: 'temurin',
            maven_args: ""
          }
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK ${{ matrix.java.name }}
        uses: actions/setup-java@v3
        with:
          java-version: ${{ matrix.java.java-version }}
          distribution: ${{ matrix.java.distribution }}

      - name: Download Maven Repo
        uses: actions/download-artifact@v3
        with:
          name: maven-repo
          path: .
      - name: Extract Maven Repo
        shell: bash
        run: tar -xzf maven-repo.tgz -C ~
      - name: Build
        run: eval ./mvnw $JVM_TEST_MAVEN_OPTS test -pl :dotcms-core ${{ matrix.java.maven_args}}
      - name: Prepare reports archive (if maven failed)
        if: failure()
        shell: bash
        run: find . -name '*-reports' -type d | tar -czf test-reports.tgz -T -
      - name: Upload reports Archive (if maven failed)
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: test-reports-linux-jvm${{matrix.java.name}}
          path: 'test-reports.tgz'
      - name: core-maven-unit-tests
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: "build-reports-test-JVM Tests - JDK ${{matrix.java.name}}"
          path: |
            **/target/*-reports/TEST-*.xml
            target/build-report.json
            LICENSE
          retention-days: 2

  linux-frontend-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    # Skip master in forks
    if: "github.repository == 'dotCMS/core' || !endsWith(github.ref, '/master')"
    needs: build-jdk11
    timeout-minutes: 240
    env:
      MAVEN_OPTS: -Xmx2048m
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v3

      - name: apt clean
        shell: bash
        run: sudo apt-get clean

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: 'temurin'

      - name: Download Maven Repo
        uses: actions/download-artifact@v3
        with:
          name: maven-repo
          path: .
      - name: Extract Maven Repo
        shell: bash
        run: tar -xzf maven-repo.tgz -C ~
      - name: Build
        run: eval ./mvnw $JVM_TEST_MAVEN_OPTS -pl :core-web test
      - name: Prepare failure archive (if maven failed)
        if: failure()
        shell: bash
        run: find . -name 'surefire-reports' -type d | tar -czf test-reports.tgz -T -
      - name: Upload failure Archive (if maven failed)
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: test-reports-frontend
          path: 'test-reports.tgz'
      - name: frontend-unit-tests
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: "build-reports-test-Frontend unit tests"
          path: |
            **/target/*-reports/**/TEST-*.xml
            target/build-report.json
            LICENSE
          retention-days: 2

  linux-integration-tests:
    name: JVM IT Tests - JDK ${{matrix.java.name}} ${{matrix.suites.name}}
    runs-on: ubuntu-latest
    # Skip master in forks
    if: "github.repository == 'dotCMS/core' || !endsWith(github.ref, '/master')"
    needs: build-jdk11
    timeout-minutes: 240
    env:
      MAVEN_OPTS: -Xmx2048m
    strategy:
      fail-fast: false
      matrix:
        java:
          - {
            name: "11",
            java-version: 11,
            distribution: 'temurin',
            maven_args: ""
          }
        suites:
          - {
              name: "MainSuite 1a",
              pathName: "mainsuite1a",
              maven_args: '"-Dit.test=MainSuite1a" -Dit.test.forkcount=1'
          }
          - {
              name: "MainSuite 1b",
              pathName: "mainsuite1b",
              maven_args: '"-Dit.test=MainSuite1b" -Dit.test.forkcount=1'
          }
          - {
              name: "MainSuite 2a",
              pathName: "mainsuite2a",
              maven_args: '"-Dit.test=MainSuite2a" -Dit.test.forkcount=1'
          }
          - {
              name: "MainSuite 2b",
              pathName: "mainsuite2b",
              maven_args: '"-Dit.test=MainSuite2b" -Dit.test.forkcount=1'
          }
    steps:
      - uses: actions/checkout@v3

      - name: apt clean
        shell: bash
        run: sudo apt-get clean

      - name: Set up IT Tests ${{ matrix.java.name }} ${{ matrix.suites.name }}
        uses: actions/setup-java@v3
        with:
          java-version: ${{ matrix.java.java-version }}
          distribution: ${{ matrix.java.distribution }}

      - name: Download Maven Repo
        uses: actions/download-artifact@v3
        with:
          name: maven-repo
          path: .
      - name: Extract Maven Repo
        shell: bash
        run: tar -xzf maven-repo.tgz -C ~
      - name: Build
        env:
          DOT_DOTCMS_LICENSE: ${{ secrets.DOTCMS_LICENSE }}
        run: eval ./mvnw $JVM_TEST_MAVEN_OPTS verify -pl :dotcms-integration ${{ matrix.suites.maven_args}} ${{ matrix.java.maven_args}}
      - name: Prepare reports archive (if maven failed)
        if: failure()
        shell: bash
        run: find . -name '*-reports' -type d | tar -czf test-reports.tgz -T -
      - name: Upload failure Archive (if maven failed)
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: test-reports-linux-jvm${{matrix.java.name}}-${{matrix.suites.pathName}}
          path: 'test-reports.tgz'
      - name: failsafe-it-tests  # Uploads will be merged with same name
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: "build-reports-test-IT Tests - JDK ${{matrix.java.name}} - ${{matrix.suites.name}}"
          path: |
            **/target/*-reports/TEST-*.xml
            target/build-report.json
            LICENSE
          retention-days: 2
  prepare-report-data:
    name: Prepare Report Data
    runs-on: ubuntu-latest
    needs: [ build-jdk11,linux-jvm-tests,linux-integration-tests,linux-frontend-tests ]
    if: always()
    steps:
      - name: Download build reports
        uses: actions/download-artifact@v3
        with:
          path: /tmp/build-step-reports

      - name: Prepare workflow data
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
         
          
          AGGREGATE_STATUS="SUCCESS"
          jobs_status="${{ toJson(needs) }}"
          echo "job status=${jobs_status}"
          while IFS=" " read -r key result; do
            key=$(echo $key | tr -d ' {')
            result=$(echo $result | tr -d ',')
            
            echo "Job: $key, Result: $result"
            
            if [[ $result == "cancelled" ]]; then
              AGGREGATE_STATUS="CANCELLED"
              break
            elif [[ $result == "failure" ]]; then
              AGGREGATE_STATUS="FAILURE"
            fi
          done < <(echo "$jobs_status" | awk -F': ' '/result:/ {print $1,$2}')
                                          
                                          
                                          
                                          
          FIRST_FAIL_STEP=""
          FIRST_FAIL_MODULE=""
          
          
          
          
          echo '{' > workflow-data.json
          
          EVENT_TYPE="${{ github.event_name }}"
          
          
          
          if [[ "$EVENT_TYPE" == "pull_request" ]]; then
            echo "Creating workflow data for pull request ${PR_TITLE}"
            BRANCH="${{ github.head_ref }}"
          else
              PR_TITLE="N/A"
              BRANCH="${{ github.ref }}"
             
              echo "Creating workflow data for branch ${BRANCH}"
          fi
          
          BRANCH="${BRANCH##*/}"
        
          PR_TITLE_JQ=$(jq --arg title "$PR_TITLE" -n '$title')
          
  
          
          
          echo '"branch": "'$BRANCH'",' >> workflow-data.json
          echo '"run_id": "'${{ github.run_id }}'",' >> workflow-data.json
          echo '"trigger_event_name": "'$GITHUB_EVENT_NAME'",' >> workflow-data.json
          echo '"source_repository": "'$GITHUB_REPOSITORY'",' >> workflow-data.json

          echo '"merge_sha": "'${{ github.sha }}'",' >> workflow-data.json
          
          echo '"base_sha": "'${{ github.event.pull_request.base.sha }}'",' >> workflow-data.json
          echo '"base_branch": "'${{ github.event.pull_request.base.sha }}'",' >> workflow-data.json
          echo '"base_author": "'${{ github.event.pull_request.base.user.login }}'",' >> workflow-data.json
          
          echo '"head_author": "'${{ github.event.pull_request.head.user.login }}'",' >> workflow-data.json
          echo '"head_name": "'${{ github.event.pull_request.head.ref }}'",' >> workflow-data.json
          echo '"head_sha": "'${{ github.event.pull_request.head.sha }}'",' >> workflow-data.json
          
          echo '"pr_id": "'${{ github.event.pull_request.id }}'",' >> workflow-data.json
          echo '"pr_number": "'${{ github.event.pull_request.number }}'",' >> workflow-data.json
          echo "\"pr_title\": $PR_TITLE_JQ," >> workflow-data.json
          echo '"pr_author": "'${{ github.event.pull_request.user.login }}'",' >> workflow-data.json
          echo '"pr_merge_state": "'${{ github.event.pull_request.mergeable_state }}'",' >> workflow-data.json
          
          
          echo '"build_reports": [' >> workflow-data.json
          total_reports=$(find /tmp/build-step-reports/build-reports-*/target -name build-report.json 2>/dev/null | wc -l)
          
          report_index=0
          if [ "$total_reports" -eq "0" ]; then
            echo "No build report files found."
          else
            for build_report in "/tmp/build-step-reports/build-reports-"*/target/build-report.json; do
              ((report_index=report_index+1))
              step_name=$(basename "$(dirname "$(dirname "$build_report")")" | sed 's/build-reports-//')
              cat "$build_report" | jq ".step_name = \"$step_name\"" >> workflow-data.json
              # If the aggregate status is still SUCCESS, check if this module failed
              if [[ "$AGGREGATE_STATUS" == "SUCCESS" ]]; then
                # Loop over each projectReport
                length=$(jq '.projectReports | length' "$build_report")
                for (( i=0; i<$length; i++ )); do
                status=$(jq -r ".projectReports[$i].status" "$build_report")
                if [[ "$status" == "FAILURE" ]]; then
                  AGGREGATE_STATUS="FAILURE"
                  FIRST_FAIL_STEP="$step_name"
                  FIRST_FAIL_MODULE="$(jq -r ".projectReports[$i].name" "$build_report")"
                  FIRST_FAIL_ERROR="$(jq -r ".projectReports[$i].error" "$build_report")"
                fi
                done
              fi
              
              # If not the last file, append a comma
              if (( report_index != total_reports )); then
                echo ',' >> workflow-data.json
              fi
            done
          fi
      
          echo '],' >> workflow-data.json
          echo '"aggregate_status": "'$AGGREGATE_STATUS'"' >> workflow-data.json
          if [[ "$AGGREGATE_STATUS" != "SUCCESS" ]]; then
            echo ',' >> workflow-data.json
            echo '"first_fail_step": "'$FIRST_FAIL_STEP'",' >> workflow-data.json
            echo '"first_fail_module": "'$FIRST_FAIL_MODULE'",' >> workflow-data.json
            echo '"first_fail_error": "'$FIRST_FAIL_ERROR'"' >> workflow-data.json
          fi
          echo '}' >> workflow-data.json

      - name: Upload workflow data
        uses: actions/upload-artifact@v3
        with:
          name: workflow-data
          path: ./workflow-data.json

