name: Build/Push dotCMS docker image (master)
on:
  push:
    branches:
      - 'master'
      - 'main'
      - 'trunk'
      - 'build-and-push-master'
      - 'issue-24516-slack-notif-master-docker'

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 11

      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3.0.0

      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.0.0

      -
        name: Login to Docker Hub
        uses: docker/login-action@v3.0.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      -
        name: Run Docker Build / Publish
        run: |
          export SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`
          echo "short sha: ${SHORT_SHA}"
          ./mvnw install -DskipTests=true -pl :dotcms-core-bundles -am
          ./mvnw install -DskipTests=true -pl :dotcms-system-bundles -am
          ./mvnw clean install -DskipTests=true -Ddocker.platforms=linux/arm64,linux/amd64 -pl :dotcms-core -am
          docker tag dotcms/dotcms-test:1.0.0-SNAPSHOT dotcms/dotcms:master_${SHORT_SHA}_snapshot
          docker tag dotcms/dotcms-test:1.0.0-SNAPSHOT dotcms/dotcms:master_latest_snapshot
          docker push dotcms/dotcms:master_${SHORT_SHA}_snapshot
          docker push dotcms/dotcms:master_latest_snapshot
          exit 0

      -
        name: Slack Notification
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.DEVELOPERS_SLACK_WEBHOOK }}
          SLACK_USERNAME: dotBot
          SLACK_TITLE: "Attention dotters: Docker image built!"
          SLACK_MSG_AUTHOR: " "
          MSG_MINIMAL: true
          SLACK_FOOTER: ""
          SLACK_ICON: https://avatars.githubusercontent.com/u/1005263?s=200&v=4
          SLACK_MESSAGE: "This automated script is happy to announce that a new docker image has been built for *master* with tag: ${{ steps.meta.outputs.tags }} :docker:"
