name: Build/Push dotCMS docker image
on:
  workflow_dispatch:
    inputs:
      multi_arch:
        description: 'Multi-arch flag, true: linux/amd64,linux/arm64 or false: linux/amd64'
        required: true
        default: 'true'
      docker_registry:
        description: 'Docker registry to push the image to'
        required: false
        type: choice
        options:
          - 'DOCKER.IO'
          - 'GHCR.IO'
          - 'BOTH'
        default: 'DOCKER.IO'
jobs:
  prepare-build:
    name: Prepare build
    runs-on: ubuntu-latest
    outputs:
      docker_platforms: ${{ steps.get-docker-platforms.outputs.docker_platforms }}
    steps:
      - name: Resolve Docker PLatforms
        id: get-docker-platforms
        run: |
          docker_platforms="${{ github.event.inputs.multi_arch == 'true' && 'linux/amd64,linux/arm64' || 'linux/amd64' }}"
          echo "docker_platforms=${docker_platforms}" >> $GITHUB_OUTPUT

  build_push_image:
    name: Build/Push Image
    needs: prepare-build
    uses: ./.github/workflows/maven-build-docker-image.yml
    with:
      ref: ${{ event.inputs.ref }}
      docker_platforms: ${{ needs.prepare-build.outputs.docker_platforms }}
      docker_registry: ${{ event.inputs.docker_registry }}
    secrets:
      docker_io_username: ${{ secrets.DOCKER_USERNAME }}
      docker_io_token: ${{ secrets.DOCKER_TOKEN }}
      ghcr_io_username: ${{ secrets.DOCKER_USERNAME }}
      ghcr_io_token: ${{ secrets.GHCR_TOKEN }}
