# Release Prepare Phase Workflow
#
# This reusable workflow is responsible for preparing a release by:
# - Validating release version format
# - Creating release branch
# - Setting release version in maven.config
# - Updating LICENSE file Change Date
# - Creating initial GitHub release
# - Caching build artifacts for subsequent phases
#
# Key features:
# - Version validation (standard and LTS formats)
# - Automatic branch and tag management
# - Maven configuration setup for production builds
# - Build artifact caching for reuse
# - GitHub release creation

name: Release Prepare Phase

on:
  workflow_call:
    inputs:
      release_version:
        description: 'Release Version (yy.mm.dd-## or yy.mm.dd_lts_v##)'
        required: true
        type: string
      release_commit:
        description: 'Commit Hash (default to latest commit)'
        required: false
        type: string
        default: ''
    secrets:
      CI_MACHINE_TOKEN:
        required: true
        description: 'CI machine token for GitHub operations'
      CI_MACHINE_USER:
        required: true
        description: 'CI machine user for git commits'
    outputs:
      release_version:
        value: ${{ jobs.prepare.outputs.release_version }}
      release_tag:
        value: ${{ jobs.prepare.outputs.release_tag }}
      release_branch:
        value: ${{ jobs.prepare.outputs.release_branch }}
      release_commit:
        value: ${{ jobs.prepare.outputs.release_commit }}
      release_hash:
        value: ${{ jobs.prepare.outputs.release_hash }}
      is_lts:
        value: ${{ jobs.prepare.outputs.is_lts }}
      is_latest:
        value: ${{ jobs.prepare.outputs.is_latest }}
      date:
        value: ${{ jobs.prepare.outputs.date }}

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-${{ vars.UBUNTU_RUNNER_VERSION || '24.04' }}
    outputs:
      release_version: ${{ steps.set-version.outputs.release_version }}
      release_tag: ${{ steps.set-version.outputs.release_tag }}
      release_branch: ${{ steps.set-version.outputs.release_branch }}
      release_commit: ${{ steps.set-version.outputs.release_commit }}
      release_hash: ${{ steps.set-version.outputs.release_hash }}
      is_lts: ${{ steps.set-version.outputs.is_lts }}
      is_latest: ${{ steps.set-version.outputs.is_latest }}
      date: ${{ steps.set-version.outputs.date }}
    steps:
      - name: Validate Release Version Format
        env:
          RELEASE_VERSION: ${{ inputs.release_version }}
        run: |
          # shellcheck disable=SC2153
          release_version="${RELEASE_VERSION}"
          if [[ ! ${release_version} =~ ^[0-9]{2}.[0-9]{2}.[0-9]{2}(-[0-9]{1,2}|_lts_v[0-9]{1,2})$ ]]; then
            echo 'Release version must be in the format yy.mm.dd-counter or yy.mm.dd_lts_v##'
            exit 1
          fi

      - run: echo 'GitHub context'
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - name: Checkout core
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_MACHINE_TOKEN }}

      - uses: ./.github/actions/core-cicd/cleanup-runner

      - name: Set Version Variables
        id: set-version
        env:
          RELEASE_VERSION: ${{ inputs.release_version }}
          RELEASE_COMMIT: ${{ inputs.release_commit }}
          CI_MACHINE_USER: ${{ secrets.CI_MACHINE_USER }}
        run: |
          git config user.name "${CI_MACHINE_USER}"
          git config user.email "dotCMS-Machine-User@dotcms.com"

          # shellcheck disable=SC2153
          release_version="${RELEASE_VERSION}"
          release_branch="release-${release_version}"
          release_tag="v${release_version}"
          # shellcheck disable=SC2153
          release_commit="${RELEASE_COMMIT}"
          if [[ -z "${release_commit}" ]]; then
            release_commit=$(git log -1 --pretty=%H)
          fi
          release_hash=${release_commit::7}
          is_lts=false
          is_latest=false
          [[ ${release_version} =~ ^[0-9]{2}.[0-9]{2}.[0-9]{2}_lts_v[0-9]{1,2}$ ]] && is_lts=true
          [[ ${release_version} =~ ^[0-9]{2}.[0-9]{2}.[0-9]{2}-[0-9]{1,2}$ ]] && is_latest=true

          {
            echo "release_version=${release_version}"
            echo "release_branch=${release_branch}"
            echo "release_tag=${release_tag}"
            echo "release_commit=${release_commit}"
            echo "release_hash=${release_hash}"
            echo "is_lts=${is_lts}"
            echo "is_latest=${is_latest}"
            echo "date=$(/bin/date -u "+%Y-%m")"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release Branch and Tag
        id: create-branch
        run: |
          release_tag=${{ steps.set-version.outputs.release_tag }}
          if git rev-parse "${release_tag}" >/dev/null 2>&1; then
            echo "Tag ${release_tag} exists, removing it"
            git push origin :refs/tags/${release_tag}
          fi

          git reset --hard ${{ steps.set-version.outputs.release_commit }}
          release_version=${{ steps.set-version.outputs.release_version }}
          release_branch=${{ steps.set-version.outputs.release_branch }}

          remote=$(git ls-remote --heads https://github.com/dotCMS/core.git "${release_branch}" | wc -l | tr -d '[:space:]')
          if [[ "${remote}" == '1' ]]; then
            echo "Release branch ${release_branch} already exists, removing it"
            git push origin :${release_branch}
          fi
          git checkout -b ${release_branch}

          # set version in .mvn/maven.config
          echo "-Dprod=true" > .mvn/maven.config
          echo "-Drevision=${release_version}" >> .mvn/maven.config
          echo "-Dchangelist=" >> .mvn/maven.config

          git add .mvn/maven.config

          # Update LICENSE file Change Date
          chmod +x .github/actions/update-license-date.sh
          .github/actions/update-license-date.sh

          # Add LICENSE file if it was modified
          if ! git diff --quiet HEAD -- LICENSE; then
            echo "LICENSE file was updated, adding to commit"
            git add LICENSE
          fi

          git status
          git commit -a -m "ðŸ Publishing release version [${release_version}]"
          git push origin ${release_branch}

          release_commit=$(git log -1 --pretty=%H)
          echo "release_commit=${release_commit}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Authorization: Bearer ${{ secrets.CI_MACHINE_TOKEN }}" \
            https://api.github.com/repos/dotCMS/core/releases \
            -d '{"tag_name": "${{ steps.set-version.outputs.release_tag }}", "name": "Release ${{ steps.set-version.outputs.release_version }}", "target_commitish": "${{ steps.create-branch.outputs.release_commit }}", "draft": false, "prerelease": false, "generate_release_notes": false}'
        if: success()