language: bash
git:
  submodules: false

cache:
  directories:
    - ${HOME}/gcloud/

# https://docs.travis-ci.com/user/environment-variables/
env:
  global:
    - GCLOUD_DIR=${HOME}/gcloud
    - PATH=${GCLOUD_DIR}/google-cloud-sdk/bin:${PATH}
    - GOOGLE_CREDENTIALS=${TRAVIS_BUILD_DIR}/credentials.json
    - CLOUDSDK_CORE_DISABLE_PROMPTS=1
    - LICENSE=${DOTCMS_LICENSE}
    - TRAVIS_WORKER_HARD_TIMEOUT=80m
    - TRAVIS_WORKER_MAX_LOG_LENGTH=20000000

before_install:
  - chmod +x travis/environment_vars.sh
  - chmod +x travis/install_gcloud.sh
  - chmod +x travis/printStoragePaths.sh
  - chmod +x travis/submit.sh
  - chmod +x travis/integration.sh
  - chmod +x travis/unit.sh

# https://docs.travis-ci.com/user/conditions-v1
# https://docs.travis-ci.com/user/conditional-builds-stages-jobs/
if: >-
  type = pull_request
  OR branch = master
  OR branch =~ ^release-
  OR branch =~ ^test-
  OR commit_message =~ travis

# https://docs.travis-ci.com/user/build-stages
jobs:
  include:
    - stage: build image
      script: bash travis/submit.sh
#    - stage: unit tests
#      script: bash travis/unit.sh
    - stage: integration tests
      env: DB_TYPE=postgres
      name: postgres
      script: bash travis/integration.sh
    - script: bash travis/unit.sh
      name: unit tests
    - script: bash travis/integration.sh
      if: type != pull_request OR commit_message =~ travis
      env: DB_TYPE=mysql
      name: mysql
    - script: bash travis/integration.sh
      if: type != pull_request OR commit_message =~ travis
      env: DB_TYPE=oracle
      name: oracle
    - script: bash travis/integration.sh
      if: type != pull_request OR commit_message =~ travis
      env: DB_TYPE=mssql
      name: mssql

install:
  - travis/environment_vars.sh
  - travis/install_gcloud.sh

# https://docs.travis-ci.com/user/notifications/#configuring-slack-notifications
# https://docs.travis-ci.com/user/encryption-keys/#usage
notifications:
  slack:
    secure: I33EhHtF4Jt3WvagvyxWkxUCA8izcXHOxHloma7OOy1+bjf8iWZjhjcMg9piHlvlpuK4ym4Y1bV5jYT7/a6On7U6VDhRj+v6tBCyEgYaK5QVi8C3xI8kWGHggC6W91brUnHHAKc2wVZkNGuHuo4eBrlwDEMPsb3eihfuNL1n5jizBUvrxQTT5upY6+FPUJOiKyQ5WekrQ5wNqSOd1hw6FoeDDwewS/d9EqbUUhjk8AhftN26dDd/ZNw7PS2upPvmEukdIsOBX4hLVFcdQRcELOhRTrmPeccUXseht3Fu5nGlWoUN72nmCmAzrH6E80SG6khw/Dqb0Q0zLFSwkS2HUi43fNs+pww0ACBhY2x9e1E9NIzxFhlcQYA79dzDkT2SbBK5BH9MiXg4vizrfWTj3fVxahqlVPlrOuWmr9fiyhYvnBcODPUW2uH2O8REFYbFT1dN9a+uIauXHfOd/ECs00CSAHHlcV5HRupaWpDlksUqxJ5d+y3+5+Cvh0Fd+8l/0JSm5yUq+stHGyAjbX/hrDfJh3SM1ip2oskNVQfgJxkcyGY3+WRM7Yrvlc7ADgmhLZGNWSDPuwpPnwRWbf5Op5aTPtyieNnzn4zGAN5iswGwaNuNLBjIRSRA3kae8fCOTZP8Nzbt0Ej2XznI7t2Jk1jypuTagw72ZTDpY5hasM0=
