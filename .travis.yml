language: bash
git:
  submodules: false

cache:
  directories:
    - ${HOME}/gcloud/

# https://docs.travis-ci.com/user/environment-variables/
env:
  global:
    - GCLOUD_DIR=${HOME}/gcloud
    - PATH=${GCLOUD_DIR}/google-cloud-sdk/bin:${PATH}
    - GOOGLE_CREDENTIALS=${TRAVIS_BUILD_DIR}/credentials.json
    - CLOUDSDK_CORE_DISABLE_PROMPTS=1
    - LICENSE=${DOTCMS_LICENSE}
    - TRAVIS_WORKER_HARD_TIMEOUT=80m
    - TRAVIS_WORKER_MAX_LOG_LENGTH=20000000
    - ALLOWED_BRANCHES=master, issue-16881-*, release-*, test-*

before_install:
  - chmod +x travis/environment_vars.sh
  - chmod +x travis/install_gcloud.sh
  - chmod +x travis/submit.sh
  - chmod +x travis/run.sh

# https://docs.travis-ci.com/user/build-stages
jobs:
  include:
    - stage: build image
      if: type = pull_request OR branch IN (env(ALLOWED_BRANCHES))
      script: bash travis/submit.sh
    - stage: integration tests
      if: type = pull_request OR branch IN (env(ALLOWED_BRANCHES))
    - script: bash travis/run.sh
      env: DB_TYPE=postgres
      name: postgres
    - script: bash travis/run.sh
      if: type != pull_request
      env: DB_TYPE=mysql
      name: mysql
    - script: bash travis/run.sh
      if: type != pull_request
      env: DB_TYPE=oracle
      name: oracle
    - script: bash travis/run.sh
      if: type != pull_request
      env: DB_TYPE=mssql
      name: mssql

install:
  - travis/environment_vars.sh
  - travis/install_gcloud.sh