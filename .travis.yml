# Copyright 2017 Google Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
language: java
git:
  submodules: false

branches:
  only:
   - /^test-16881.*$/

env:
  global:
    - GCLOUD_DIR=${HOME}/gcloud
    - PATH=${GCLOUD_DIR}/google-cloud-sdk/bin:${PATH}
    - GOOGLE_CREDENTIALS=${TRAVIS_BUILD_DIR}/credentials.json
    - CLOUDSDK_CORE_DISABLE_PROMPTS=1
    - LICENSE=${DOTCMS_LICENSE}
  matrix:
    - DB_TYPE=postgres
    - DB_TYPE=mysql

before_install:
  - chmod +x travis/environment_vars.sh
  - chmod +x travis/install_gcloud.sh
  - chmod +x travis/prepare.sh
  - chmod +rwx docker/tests/integration/postgres-docker-compose.yml
  - chmod +rwx docker/tests/integration/mysql-docker-compose.yml

install:
  - travis/environment_vars.sh
  - travis/install_gcloud.sh
  - travis/prepare.sh
#  - travis_wait mvn install

script:
  - "travis_wait 30 &"
  - >
    gcloud builds submit
    --config=travis/cloudbuild.yaml
    --substitutions=_GIT_BRANCH_COMMIT=$TRAVIS_BRANCH,COMMIT_SHA=$TRAVIS_COMMIT,_LICENSE_KEY=$LICENSE,_DB_TYPE=$DB_TYPE .
