const h=window.dotcmsFields.h;import{a as Fragment}from"./chunk-1d89c98b.js";import{a as getOriginalStatus,f as updateStatus,c as getClassNames}from"./chunk-62cd3eff.js";import{d as getErrorMessage,e as getFieldsFromLayout,f as fieldCustomProcess}from"./chunk-4205a04e.js";class DotUploadService{constructor(){}uploadFile(t,e){return"string"==typeof t?this.uploadFileByURL(t):this.uploadBinaryFile(t,e)}uploadFileByURL(t){return fetch("/api/v1/temp/byUrl",{method:"POST",headers:{"Content-Type":"application/json",Origin:window.location.hostname},body:JSON.stringify({remoteUrl:t})}).then(async t=>{if(200===t.status)return(await t.json()).tempFiles[0];throw{message:(await t.json()).message,status:t.status}})}uploadBinaryFile(t,e){let s="/api/v1/temp";s+=e?`?maxFileLength=${e}`:"";const a=new FormData;return a.append("file",t),fetch(s,{method:"POST",headers:{Origin:window.location.hostname},body:a}).then(async t=>{if(200===t.status)return(await t.json()).tempFiles[0];throw{message:(await t.json()).message,status:t.status}})}}const SUBMIT_FORM_API_URL="/api/v1/workflow/actions/default/fire/NEW",fallbackErrorMessages={500:"500 Internal Server Error",400:"400 Bad Request",401:"401 Unauthorized Error"};class DotFormComponent{constructor(){this.resetLabel="Reset",this.submitLabel="Submit",this.layout=[],this.variable="",this.status=getOriginalStatus(),this.errorMessage="",this.uploadFileInProgress=!1,this.fieldsStatus={},this.value={}}onValueChange(t){const{tagName:e}=t.target,{name:s,value:a}=t.detail,r=fieldCustomProcess[e];"DOT-BINARY-FILE"===e&&a?this.uploadFile(t).then(t=>{this.value[s]=t&&t.id}):this.value[s]=r?r(a):a}onStatusChange({detail:t}){this.fieldsStatus[t.name]=t.status,this.status=updateStatus(this.status,{dotTouched:this.getTouched(),dotPristine:this.getStatusValueByName("dotPristine"),dotValid:this.getStatusValueByName("dotValid")})}layoutWatch(){this.value=this.getUpdateValue()}fieldsToShowWatch(){this.value=this.getUpdateValue()}hostData(){return{class:getClassNames(this.status,this.status.dotValid)}}componentWillLoad(){this.value=this.getUpdateValue()}render(){return h(Fragment,null,h("form",{onSubmit:this.handleSubmit.bind(this)},this.layout.map(t=>h("dot-form-row",{row:t,"fields-to-show":this.fieldsToShow})),h("div",{class:"dot-form__buttons"},h("button",{type:"reset",onClick:()=>this.resetForm()},this.resetLabel),h("button",{type:"submit",disabled:!this.status.dotValid||this.uploadFileInProgress},this.submitLabel))),h("dot-error-message",null,this.errorMessage))}getStatusValueByName(t){return Object.values(this.fieldsStatus).map(e=>e[t]).every(t=>!0===t)}getTouched(){return Object.values(this.fieldsStatus).map(t=>t.dotTouched).includes(!0)}handleSubmit(t){t.preventDefault(),fetch(SUBMIT_FORM_API_URL,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({contentlet:Object.assign({contentType:this.variable},this.value)})}).then(async t=>{if(200!==t.status)throw{message:await t.text(),status:t.status};return t.json()}).then(t=>{this.runSuccessCallback(t.entity)}).catch(({message:t,status:e})=>{this.errorMessage=getErrorMessage(t)||fallbackErrorMessages[e]})}runSuccessCallback(contentlet){const successCallback=this.getSuccessCallback();if(successCallback)return function(){return eval(successCallback)}.call({contentlet})}getSuccessCallback(){return getFieldsFromLayout(this.layout).filter(t=>"formSuccessCallback"===t.variable)[0].values}resetForm(){Array.from(this.el.querySelectorAll("form dot-form-column > *")).forEach(t=>{try{t.reset()}catch(e){console.warn(`${t.tagName}`,e)}})}getUpdateValue(){return getFieldsFromLayout(this.layout).filter(t=>!1===t.fixed).reduce((t,{variable:e,defaultValue:s,dataType:a,values:r})=>Object.assign({},t,{[e]:s||("TEXT"!==a?r:null)}),{})}getMaxSize(t){const e=[...t.target.attributes].filter(t=>"max-file-length"===t.name)[0];return e&&e.value}uploadFile(t){const e=new DotUploadService,s=t.detail.value,a=this.getMaxSize(t),r=t.target;return!a||s.size<=a?(this.uploadFileInProgress=!0,r.errorMessage="",e.uploadFile(s,a).then(t=>(this.errorMessage="",r.previewImageUrl=t.thumbnailUrl,r.previewImageName=t.fileName,this.uploadFileInProgress=!1,t)).catch(({message:t,status:e})=>(r.clearValue(),this.uploadFileInProgress=!1,this.errorMessage=getErrorMessage(t)||fallbackErrorMessages[e],null))):(r.reset(),r.errorMessage=`File size larger than allowed ${a} bytes`,Promise.resolve(null))}static get is(){return"dot-form"}static get properties(){return{el:{elementRef:!0},errorMessage:{state:!0},fieldsToShow:{type:String,attr:"fields-to-show",watchCallbacks:["fieldsToShowWatch"]},layout:{type:"Any",attr:"layout",reflectToAttr:!0,watchCallbacks:["layoutWatch"]},resetLabel:{type:String,attr:"reset-label",reflectToAttr:!0},status:{state:!0},submitLabel:{type:String,attr:"submit-label",reflectToAttr:!0},uploadFileInProgress:{state:!0},variable:{type:String,attr:"variable",reflectToAttr:!0}}}static get listeners(){return[{name:"valueChange",method:"onValueChange"},{name:"statusChange",method:"onStatusChange"}]}static get style(){return"/**style-placeholder:dot-form:**/"}}export{DotFormComponent as DotForm};