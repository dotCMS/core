import{normalizeDriveLetter}from"../../../../base/common/labels.js";import*as path from"../../../../base/common/path.js";import{dirname}from"../../../../base/common/resources.js";import{commonPrefixLength,getLeadingWhitespace,isFalsyOrWhitespace,splitLines}from"../../../../base/common/strings.js";import{generateUuid}from"../../../../base/common/uuid.js";import{LanguageConfigurationRegistry}from"../../../common/languages/languageConfigurationRegistry.js";import{Text}from"./snippetParser.js";import*as nls from"../../../../nls.js";import{WORKSPACE_EXTENSION,isSingleFolderWorkspaceIdentifier,toWorkspaceIdentifier}from"../../../../platform/workspace/common/workspace.js";export const KnownSnippetVariableNames=Object.freeze({CURRENT_YEAR:!0,CURRENT_YEAR_SHORT:!0,CURRENT_MONTH:!0,CURRENT_DATE:!0,CURRENT_HOUR:!0,CURRENT_MINUTE:!0,CURRENT_SECOND:!0,CURRENT_DAY_NAME:!0,CURRENT_DAY_NAME_SHORT:!0,CURRENT_MONTH_NAME:!0,CURRENT_MONTH_NAME_SHORT:!0,CURRENT_SECONDS_UNIX:!0,SELECTION:!0,CLIPBOARD:!0,TM_SELECTED_TEXT:!0,TM_CURRENT_LINE:!0,TM_CURRENT_WORD:!0,TM_LINE_INDEX:!0,TM_LINE_NUMBER:!0,TM_FILENAME:!0,TM_FILENAME_BASE:!0,TM_DIRECTORY:!0,TM_FILEPATH:!0,RELATIVE_FILEPATH:!0,BLOCK_COMMENT_START:!0,BLOCK_COMMENT_END:!0,LINE_COMMENT:!0,WORKSPACE_NAME:!0,WORKSPACE_FOLDER:!0,RANDOM:!0,RANDOM_HEX:!0,UUID:!0});export class CompositeSnippetVariableResolver{constructor(_delegates){this._delegates=_delegates}resolve(variable){for(const delegate of this._delegates){let value=delegate.resolve(variable);if(void 0!==value)return value}}}export class SelectionBasedVariableResolver{constructor(_model,_selection,_selectionIdx,_overtypingCapturer){this._model=_model,this._selection=_selection,this._selectionIdx=_selectionIdx,this._overtypingCapturer=_overtypingCapturer}resolve(variable){const{name}=variable;if("SELECTION"===name||"TM_SELECTED_TEXT"===name){let value=this._model.getValueInRange(this._selection)||void 0,isMultiline=this._selection.startLineNumber!==this._selection.endLineNumber;if(!value&&this._overtypingCapturer){const info=this._overtypingCapturer.getLastOvertypedInfo(this._selectionIdx);info&&(value=info.value,isMultiline=info.multiline)}if(value&&isMultiline&&variable.snippet){const line=this._model.getLineContent(this._selection.startLineNumber),lineLeadingWhitespace=getLeadingWhitespace(line,0,this._selection.startColumn-1);let varLeadingWhitespace=lineLeadingWhitespace;variable.snippet.walk((marker=>marker!==variable&&(marker instanceof Text&&(varLeadingWhitespace=getLeadingWhitespace(splitLines(marker.value).pop())),!0)));const whitespaceCommonLength=commonPrefixLength(varLeadingWhitespace,lineLeadingWhitespace);value=value.replace(/(\r\n|\r|\n)(.*)/g,((m,newline,rest)=>`${newline}${varLeadingWhitespace.substr(whitespaceCommonLength)}${rest}`))}return value}if("TM_CURRENT_LINE"===name)return this._model.getLineContent(this._selection.positionLineNumber);if("TM_CURRENT_WORD"===name){const info=this._model.getWordAtPosition({lineNumber:this._selection.positionLineNumber,column:this._selection.positionColumn});return info&&info.word||void 0}return"TM_LINE_INDEX"===name?String(this._selection.positionLineNumber-1):"TM_LINE_NUMBER"===name?String(this._selection.positionLineNumber):void 0}}export class ModelBasedVariableResolver{constructor(_labelService,_model){this._labelService=_labelService,this._model=_model}resolve(variable){const{name}=variable;if("TM_FILENAME"===name)return path.basename(this._model.uri.fsPath);if("TM_FILENAME_BASE"===name){const name=path.basename(this._model.uri.fsPath),idx=name.lastIndexOf(".");return idx<=0?name:name.slice(0,idx)}return"TM_DIRECTORY"===name?"."===path.dirname(this._model.uri.fsPath)?"":this._labelService.getUriLabel(dirname(this._model.uri)):"TM_FILEPATH"===name?this._labelService.getUriLabel(this._model.uri):"RELATIVE_FILEPATH"===name?this._labelService.getUriLabel(this._model.uri,{relative:!0,noPrefix:!0}):void 0}}export class ClipboardBasedVariableResolver{constructor(_readClipboardText,_selectionIdx,_selectionCount,_spread){this._readClipboardText=_readClipboardText,this._selectionIdx=_selectionIdx,this._selectionCount=_selectionCount,this._spread=_spread}resolve(variable){if("CLIPBOARD"!==variable.name)return;const clipboardText=this._readClipboardText();if(clipboardText){if(this._spread){const lines=clipboardText.split(/\r\n|\n|\r/).filter((s=>!isFalsyOrWhitespace(s)));if(lines.length===this._selectionCount)return lines[this._selectionIdx]}return clipboardText}}}export class CommentBasedVariableResolver{constructor(_model,_selection){this._model=_model,this._selection=_selection}resolve(variable){const{name}=variable,langId=this._model.getLanguageIdAtPosition(this._selection.selectionStartLineNumber,this._selection.selectionStartColumn),config=LanguageConfigurationRegistry.getComments(langId);if(config)return"LINE_COMMENT"===name?config.lineCommentToken||void 0:"BLOCK_COMMENT_START"===name?config.blockCommentStartToken||void 0:"BLOCK_COMMENT_END"===name&&config.blockCommentEndToken||void 0}}export class TimeBasedVariableResolver{constructor(){this._date=new Date}resolve(variable){const{name}=variable;return"CURRENT_YEAR"===name?String(this._date.getFullYear()):"CURRENT_YEAR_SHORT"===name?String(this._date.getFullYear()).slice(-2):"CURRENT_MONTH"===name?String(this._date.getMonth().valueOf()+1).padStart(2,"0"):"CURRENT_DATE"===name?String(this._date.getDate().valueOf()).padStart(2,"0"):"CURRENT_HOUR"===name?String(this._date.getHours().valueOf()).padStart(2,"0"):"CURRENT_MINUTE"===name?String(this._date.getMinutes().valueOf()).padStart(2,"0"):"CURRENT_SECOND"===name?String(this._date.getSeconds().valueOf()).padStart(2,"0"):"CURRENT_DAY_NAME"===name?TimeBasedVariableResolver.dayNames[this._date.getDay()]:"CURRENT_DAY_NAME_SHORT"===name?TimeBasedVariableResolver.dayNamesShort[this._date.getDay()]:"CURRENT_MONTH_NAME"===name?TimeBasedVariableResolver.monthNames[this._date.getMonth()]:"CURRENT_MONTH_NAME_SHORT"===name?TimeBasedVariableResolver.monthNamesShort[this._date.getMonth()]:"CURRENT_SECONDS_UNIX"===name?String(Math.floor(this._date.getTime()/1e3)):void 0}}TimeBasedVariableResolver.dayNames=[nls.localize("Sunday","Sunday"),nls.localize("Monday","Monday"),nls.localize("Tuesday","Tuesday"),nls.localize("Wednesday","Wednesday"),nls.localize("Thursday","Thursday"),nls.localize("Friday","Friday"),nls.localize("Saturday","Saturday")],TimeBasedVariableResolver.dayNamesShort=[nls.localize("SundayShort","Sun"),nls.localize("MondayShort","Mon"),nls.localize("TuesdayShort","Tue"),nls.localize("WednesdayShort","Wed"),nls.localize("ThursdayShort","Thu"),nls.localize("FridayShort","Fri"),nls.localize("SaturdayShort","Sat")],TimeBasedVariableResolver.monthNames=[nls.localize("January","January"),nls.localize("February","February"),nls.localize("March","March"),nls.localize("April","April"),nls.localize("May","May"),nls.localize("June","June"),nls.localize("July","July"),nls.localize("August","August"),nls.localize("September","September"),nls.localize("October","October"),nls.localize("November","November"),nls.localize("December","December")],TimeBasedVariableResolver.monthNamesShort=[nls.localize("JanuaryShort","Jan"),nls.localize("FebruaryShort","Feb"),nls.localize("MarchShort","Mar"),nls.localize("AprilShort","Apr"),nls.localize("MayShort","May"),nls.localize("JuneShort","Jun"),nls.localize("JulyShort","Jul"),nls.localize("AugustShort","Aug"),nls.localize("SeptemberShort","Sep"),nls.localize("OctoberShort","Oct"),nls.localize("NovemberShort","Nov"),nls.localize("DecemberShort","Dec")];export class WorkspaceBasedVariableResolver{constructor(_workspaceService){this._workspaceService=_workspaceService}resolve(variable){if(!this._workspaceService)return;const workspaceIdentifier=toWorkspaceIdentifier(this._workspaceService.getWorkspace());return workspaceIdentifier?"WORKSPACE_NAME"===variable.name?this._resolveWorkspaceName(workspaceIdentifier):"WORKSPACE_FOLDER"===variable.name?this._resoveWorkspacePath(workspaceIdentifier):void 0:void 0}_resolveWorkspaceName(workspaceIdentifier){if(isSingleFolderWorkspaceIdentifier(workspaceIdentifier))return path.basename(workspaceIdentifier.uri.path);let filename=path.basename(workspaceIdentifier.configPath.path);return filename.endsWith(WORKSPACE_EXTENSION)&&(filename=filename.substr(0,filename.length-WORKSPACE_EXTENSION.length-1)),filename}_resoveWorkspacePath(workspaceIdentifier){if(isSingleFolderWorkspaceIdentifier(workspaceIdentifier))return normalizeDriveLetter(workspaceIdentifier.uri.fsPath);let filename=path.basename(workspaceIdentifier.configPath.path),folderpath=workspaceIdentifier.configPath.fsPath;return folderpath.endsWith(filename)&&(folderpath=folderpath.substr(0,folderpath.length-filename.length-1)),folderpath?normalizeDriveLetter(folderpath):"/"}}export class RandomBasedVariableResolver{resolve(variable){const{name}=variable;return"RANDOM"===name?Math.random().toString().slice(-6):"RANDOM_HEX"===name?Math.random().toString(16).slice(-6):"UUID"===name?generateUuid():void 0}}