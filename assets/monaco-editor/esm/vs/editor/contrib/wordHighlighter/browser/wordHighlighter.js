var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import{alert}from"../../../../base/browser/ui/aria/aria.js";import*as arrays from"../../../../base/common/arrays.js";import{createCancelablePromise,first,timeout}from"../../../../base/common/async.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{EditorAction,registerEditorAction,registerEditorContribution,registerModelAndPositionCommand}from"../../../browser/editorExtensions.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{MinimapPosition,OverviewRulerLane}from"../../../common/model.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{DocumentHighlightKind}from"../../../common/languages.js";import*as nls from"../../../../nls.js";import{IContextKeyService,RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{activeContrastBorder,editorSelectionHighlight,editorSelectionHighlightBorder,minimapSelectionOccurrenceHighlight,overviewRulerSelectionHighlightForeground,registerColor}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant,themeColorFromId}from"../../../../platform/theme/common/themeService.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";const editorWordHighlight=registerColor("editor.wordHighlightBackground",{dark:"#575757B8",light:"#57575740",hc:null},nls.localize("wordHighlight","Background color of a symbol during read-access, like reading a variable. The color must not be opaque so as not to hide underlying decorations."),!0),editorWordHighlightStrong=registerColor("editor.wordHighlightStrongBackground",{dark:"#004972B8",light:"#0e639c40",hc:null},nls.localize("wordHighlightStrong","Background color of a symbol during write-access, like writing to a variable. The color must not be opaque so as not to hide underlying decorations."),!0),editorWordHighlightBorder=registerColor("editor.wordHighlightBorder",{light:null,dark:null,hc:activeContrastBorder},nls.localize("wordHighlightBorder","Border color of a symbol during read-access, like reading a variable.")),editorWordHighlightStrongBorder=registerColor("editor.wordHighlightStrongBorder",{light:null,dark:null,hc:activeContrastBorder},nls.localize("wordHighlightStrongBorder","Border color of a symbol during write-access, like writing to a variable.")),overviewRulerWordHighlightForeground=registerColor("editorOverviewRuler.wordHighlightForeground",{dark:"#A0A0A0CC",light:"#A0A0A0CC",hc:"#A0A0A0CC"},nls.localize("overviewRulerWordHighlightForeground","Overview ruler marker color for symbol highlights. The color must not be opaque so as not to hide underlying decorations."),!0),overviewRulerWordHighlightStrongForeground=registerColor("editorOverviewRuler.wordHighlightStrongForeground",{dark:"#C0A0C0CC",light:"#C0A0C0CC",hc:"#C0A0C0CC"},nls.localize("overviewRulerWordHighlightStrongForeground","Overview ruler marker color for write-access symbol highlights. The color must not be opaque so as not to hide underlying decorations."),!0),ctxHasWordHighlights=new RawContextKey("hasWordHighlights",!1);export function getOccurrencesAtPosition(registry,model,position,token){const orderedByScore=registry.ordered(model);return first(orderedByScore.map((provider=>()=>Promise.resolve(provider.provideDocumentHighlights(model,position,token)).then(void 0,onUnexpectedExternalError))),arrays.isNonEmptyArray)}class OccurenceAtPositionRequest{constructor(_model,_selection,_wordSeparators){this._model=_model,this._selection=_selection,this._wordSeparators=_wordSeparators,this._wordRange=this._getCurrentWordRange(_model,_selection),this._result=null}get result(){return this._result||(this._result=createCancelablePromise((token=>this._compute(this._model,this._selection,this._wordSeparators,token)))),this._result}_getCurrentWordRange(model,selection){const word=model.getWordAtPosition(selection.getPosition());return word?new Range(selection.startLineNumber,word.startColumn,selection.startLineNumber,word.endColumn):null}isValid(model,selection,decorationIds){const lineNumber=selection.startLineNumber,startColumn=selection.startColumn,endColumn=selection.endColumn,currentWordRange=this._getCurrentWordRange(model,selection);let requestIsValid=Boolean(this._wordRange&&this._wordRange.equalsRange(currentWordRange));for(let i=0,len=decorationIds.length;!requestIsValid&&i<len;i++){let range=model.getDecorationRange(decorationIds[i]);range&&range.startLineNumber===lineNumber&&range.startColumn<=startColumn&&range.endColumn>=endColumn&&(requestIsValid=!0)}return requestIsValid}cancel(){this.result.cancel()}}class SemanticOccurenceAtPositionRequest extends OccurenceAtPositionRequest{constructor(model,selection,wordSeparators,providers){super(model,selection,wordSeparators),this._providers=providers}_compute(model,selection,wordSeparators,token){return getOccurrencesAtPosition(this._providers,model,selection.getPosition(),token).then((value=>value||[]))}}class TextualOccurenceAtPositionRequest extends OccurenceAtPositionRequest{constructor(model,selection,wordSeparators){super(model,selection,wordSeparators),this._selectionIsEmpty=selection.isEmpty()}_compute(model,selection,wordSeparators,token){return timeout(250,token).then((()=>{if(!selection.isEmpty())return[];const word=model.getWordAtPosition(selection.getPosition());if(!word||word.word.length>1e3)return[];return model.findMatches(word.word,!0,!1,!0,wordSeparators,!1).map((m=>({range:m.range,kind:DocumentHighlightKind.Text})))}))}isValid(model,selection,decorationIds){const currentSelectionIsEmpty=selection.isEmpty();return this._selectionIsEmpty===currentSelectionIsEmpty&&super.isValid(model,selection,decorationIds)}}function computeOccurencesAtPosition(registry,model,selection,wordSeparators){return registry.has(model)?new SemanticOccurenceAtPositionRequest(model,selection,wordSeparators,registry):new TextualOccurenceAtPositionRequest(model,selection,wordSeparators)}registerModelAndPositionCommand("_executeDocumentHighlights",((accessor,model,position)=>getOccurrencesAtPosition(accessor.get(ILanguageFeaturesService).documentHighlightProvider,model,position,CancellationToken.None)));class WordHighlighter{constructor(editor,providers,contextKeyService){this.toUnhook=new DisposableStore,this.workerRequestTokenId=0,this.workerRequestCompleted=!1,this.workerRequestValue=[],this.lastCursorPositionChangeTime=0,this.renderDecorationsTimer=-1,this.editor=editor,this.providers=providers,this._hasWordHighlights=ctxHasWordHighlights.bindTo(contextKeyService),this._ignorePositionChangeEvent=!1,this.occurrencesHighlight=this.editor.getOption(72),this.model=this.editor.getModel(),this.toUnhook.add(editor.onDidChangeCursorPosition((e=>{this._ignorePositionChangeEvent||this.occurrencesHighlight&&this._onPositionChanged(e)}))),this.toUnhook.add(editor.onDidChangeModelContent((e=>{this._stopAll()}))),this.toUnhook.add(editor.onDidChangeConfiguration((e=>{let newValue=this.editor.getOption(72);this.occurrencesHighlight!==newValue&&(this.occurrencesHighlight=newValue,this._stopAll())}))),this._decorationIds=[],this.workerRequestTokenId=0,this.workerRequest=null,this.workerRequestCompleted=!1,this.lastCursorPositionChangeTime=0,this.renderDecorationsTimer=-1}hasDecorations(){return this._decorationIds.length>0}restore(){this.occurrencesHighlight&&this._run()}_getSortedHighlights(){return arrays.coalesce(this._decorationIds.map((id=>this.model.getDecorationRange(id))).sort(Range.compareRangesUsingStarts))}moveNext(){let highlights=this._getSortedHighlights(),newIndex=(highlights.findIndex((range=>range.containsPosition(this.editor.getPosition())))+1)%highlights.length,dest=highlights[newIndex];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(dest.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(dest);const word=this._getWord();if(word){const lineContent=this.editor.getModel().getLineContent(dest.startLineNumber);alert(`${lineContent}, ${newIndex+1} of ${highlights.length} for '${word.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}moveBack(){let highlights=this._getSortedHighlights(),newIndex=(highlights.findIndex((range=>range.containsPosition(this.editor.getPosition())))-1+highlights.length)%highlights.length,dest=highlights[newIndex];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(dest.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(dest);const word=this._getWord();if(word){const lineContent=this.editor.getModel().getLineContent(dest.startLineNumber);alert(`${lineContent}, ${newIndex+1} of ${highlights.length} for '${word.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}_removeDecorations(){this._decorationIds.length>0&&(this._decorationIds=this.editor.deltaDecorations(this._decorationIds,[]),this._hasWordHighlights.set(!1))}_stopAll(){this._removeDecorations(),-1!==this.renderDecorationsTimer&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1),null!==this.workerRequest&&(this.workerRequest.cancel(),this.workerRequest=null),this.workerRequestCompleted||(this.workerRequestTokenId++,this.workerRequestCompleted=!0)}_onPositionChanged(e){this.occurrencesHighlight&&3===e.reason?this._run():this._stopAll()}_getWord(){let editorSelection=this.editor.getSelection(),lineNumber=editorSelection.startLineNumber,startColumn=editorSelection.startColumn;return this.model.getWordAtPosition({lineNumber,column:startColumn})}_run(){let editorSelection=this.editor.getSelection();if(editorSelection.startLineNumber!==editorSelection.endLineNumber)return void this._stopAll();let startColumn=editorSelection.startColumn,endColumn=editorSelection.endColumn;const word=this._getWord();if(!word||word.startColumn>startColumn||word.endColumn<endColumn)return void this._stopAll();const workerRequestIsValid=this.workerRequest&&this.workerRequest.isValid(this.model,editorSelection,this._decorationIds);if(this.lastCursorPositionChangeTime=(new Date).getTime(),workerRequestIsValid)this.workerRequestCompleted&&-1!==this.renderDecorationsTimer&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1,this._beginRenderDecorations());else{this._stopAll();let myRequestId=++this.workerRequestTokenId;this.workerRequestCompleted=!1,this.workerRequest=computeOccurencesAtPosition(this.providers,this.model,this.editor.getSelection(),this.editor.getOption(117)),this.workerRequest.result.then((data=>{myRequestId===this.workerRequestTokenId&&(this.workerRequestCompleted=!0,this.workerRequestValue=data||[],this._beginRenderDecorations())}),onUnexpectedError)}}_beginRenderDecorations(){let currentTime=(new Date).getTime(),minimumRenderTime=this.lastCursorPositionChangeTime+250;currentTime>=minimumRenderTime?(this.renderDecorationsTimer=-1,this.renderDecorations()):this.renderDecorationsTimer=setTimeout((()=>{this.renderDecorations()}),minimumRenderTime-currentTime)}renderDecorations(){this.renderDecorationsTimer=-1;let decorations=[];for(const info of this.workerRequestValue)info.range&&decorations.push({range:info.range,options:WordHighlighter._getDecorationOptions(info.kind)});this._decorationIds=this.editor.deltaDecorations(this._decorationIds,decorations),this._hasWordHighlights.set(this.hasDecorations())}static _getDecorationOptions(kind){return kind===DocumentHighlightKind.Write?this._WRITE_OPTIONS:kind===DocumentHighlightKind.Text?this._TEXT_OPTIONS:this._REGULAR_OPTIONS}dispose(){this._stopAll(),this.toUnhook.dispose()}}WordHighlighter._WRITE_OPTIONS=ModelDecorationOptions.register({description:"word-highlight-strong",stickiness:1,className:"wordHighlightStrong",overviewRuler:{color:themeColorFromId(overviewRulerWordHighlightStrongForeground),position:OverviewRulerLane.Center},minimap:{color:themeColorFromId(minimapSelectionOccurrenceHighlight),position:MinimapPosition.Inline}}),WordHighlighter._TEXT_OPTIONS=ModelDecorationOptions.register({description:"selection-highlight",stickiness:1,className:"selectionHighlight",overviewRuler:{color:themeColorFromId(overviewRulerSelectionHighlightForeground),position:OverviewRulerLane.Center},minimap:{color:themeColorFromId(minimapSelectionOccurrenceHighlight),position:MinimapPosition.Inline}}),WordHighlighter._REGULAR_OPTIONS=ModelDecorationOptions.register({description:"word-highlight",stickiness:1,className:"wordHighlight",overviewRuler:{color:themeColorFromId(overviewRulerWordHighlightForeground),position:OverviewRulerLane.Center},minimap:{color:themeColorFromId(minimapSelectionOccurrenceHighlight),position:MinimapPosition.Inline}});let WordHighlighterContribution=class WordHighlighterContribution extends Disposable{constructor(editor,contextKeyService,languageFeaturesService){super(),this.wordHighlighter=null;const createWordHighlighterIfPossible=()=>{editor.hasModel()&&(this.wordHighlighter=new WordHighlighter(editor,languageFeaturesService.documentHighlightProvider,contextKeyService))};this._register(editor.onDidChangeModel((e=>{this.wordHighlighter&&(this.wordHighlighter.dispose(),this.wordHighlighter=null),createWordHighlighterIfPossible()}))),createWordHighlighterIfPossible()}static get(editor){return editor.getContribution(WordHighlighterContribution.ID)}saveViewState(){return!(!this.wordHighlighter||!this.wordHighlighter.hasDecorations())}moveNext(){this.wordHighlighter&&this.wordHighlighter.moveNext()}moveBack(){this.wordHighlighter&&this.wordHighlighter.moveBack()}restoreViewState(state){this.wordHighlighter&&state&&this.wordHighlighter.restore()}dispose(){this.wordHighlighter&&(this.wordHighlighter.dispose(),this.wordHighlighter=null),super.dispose()}};WordHighlighterContribution.ID="editor.contrib.wordHighlighter",WordHighlighterContribution=__decorate([__param(1,IContextKeyService),__param(2,ILanguageFeaturesService)],WordHighlighterContribution);class WordHighlightNavigationAction extends EditorAction{constructor(next,opts){super(opts),this._isNext=next}run(accessor,editor){const controller=WordHighlighterContribution.get(editor);controller&&(this._isNext?controller.moveNext():controller.moveBack())}}class NextWordHighlightAction extends WordHighlightNavigationAction{constructor(){super(!0,{id:"editor.action.wordHighlight.next",label:nls.localize("wordHighlight.next.label","Go to Next Symbol Highlight"),alias:"Go to Next Symbol Highlight",precondition:ctxHasWordHighlights,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:65,weight:100}})}}class PrevWordHighlightAction extends WordHighlightNavigationAction{constructor(){super(!1,{id:"editor.action.wordHighlight.prev",label:nls.localize("wordHighlight.previous.label","Go to Previous Symbol Highlight"),alias:"Go to Previous Symbol Highlight",precondition:ctxHasWordHighlights,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1089,weight:100}})}}class TriggerWordHighlightAction extends EditorAction{constructor(){super({id:"editor.action.wordHighlight.trigger",label:nls.localize("wordHighlight.trigger.label","Trigger Symbol Highlight"),alias:"Trigger Symbol Highlight",precondition:ctxHasWordHighlights.toNegated(),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:0,weight:100}})}run(accessor,editor,args){const controller=WordHighlighterContribution.get(editor);controller&&controller.restoreViewState(!0)}}registerEditorContribution(WordHighlighterContribution.ID,WordHighlighterContribution),registerEditorAction(NextWordHighlightAction),registerEditorAction(PrevWordHighlightAction),registerEditorAction(TriggerWordHighlightAction),registerThemingParticipant(((theme,collector)=>{const selectionHighlight=theme.getColor(editorSelectionHighlight);selectionHighlight&&(collector.addRule(`.monaco-editor .focused .selectionHighlight { background-color: ${selectionHighlight}; }`),collector.addRule(`.monaco-editor .selectionHighlight { background-color: ${selectionHighlight.transparent(.5)}; }`));const wordHighlight=theme.getColor(editorWordHighlight);wordHighlight&&collector.addRule(`.monaco-editor .wordHighlight { background-color: ${wordHighlight}; }`);const wordHighlightStrong=theme.getColor(editorWordHighlightStrong);wordHighlightStrong&&collector.addRule(`.monaco-editor .wordHighlightStrong { background-color: ${wordHighlightStrong}; }`);const selectionHighlightBorder=theme.getColor(editorSelectionHighlightBorder);selectionHighlightBorder&&collector.addRule(`.monaco-editor .selectionHighlight { border: 1px ${"hc"===theme.type?"dotted":"solid"} ${selectionHighlightBorder}; box-sizing: border-box; }`);const wordHighlightBorder=theme.getColor(editorWordHighlightBorder);wordHighlightBorder&&collector.addRule(`.monaco-editor .wordHighlight { border: 1px ${"hc"===theme.type?"dashed":"solid"} ${wordHighlightBorder}; box-sizing: border-box; }`);const wordHighlightStrongBorder=theme.getColor(editorWordHighlightStrongBorder);wordHighlightStrongBorder&&collector.addRule(`.monaco-editor .wordHighlightStrong { border: 1px ${"hc"===theme.type?"dashed":"solid"} ${wordHighlightStrongBorder}; box-sizing: border-box; }`)}));