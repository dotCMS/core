var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import*as dom from"../../../../base/browser/dom.js";import{ActionViewItem}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{Separator,SubmenuAction}from"../../../../base/common/actions.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{isIOS}from"../../../../base/common/platform.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import*as nls from"../../../../nls.js";import{IMenuService,MenuId,SubmenuItemAction}from"../../../../platform/actions/common/actions.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService,IContextViewService}from"../../../../platform/contextview/browser/contextView.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";let ContextMenuController=class ContextMenuController{constructor(editor,_contextMenuService,_contextViewService,_contextKeyService,_keybindingService,_menuService){this._contextMenuService=_contextMenuService,this._contextViewService=_contextViewService,this._contextKeyService=_contextKeyService,this._keybindingService=_keybindingService,this._menuService=_menuService,this._toDispose=new DisposableStore,this._contextMenuIsBeingShownCount=0,this._editor=editor,this._toDispose.add(this._editor.onContextMenu((e=>this._onContextMenu(e)))),this._toDispose.add(this._editor.onMouseWheel((e=>{if(this._contextMenuIsBeingShownCount>0){const view=this._contextViewService.getContextViewElement(),target=e.srcElement;target.shadowRoot&&dom.getShadowRoot(view)===target.shadowRoot||this._contextViewService.hideContextView()}}))),this._toDispose.add(this._editor.onKeyDown((e=>{58===e.keyCode&&(e.preventDefault(),e.stopPropagation(),this.showContextMenu())})))}static get(editor){return editor.getContribution(ContextMenuController.ID)}_onContextMenu(e){if(!this._editor.hasModel())return;if(!this._editor.getOption(20))return this._editor.focus(),void(e.target.position&&!this._editor.getSelection().containsPosition(e.target.position)&&this._editor.setPosition(e.target.position));if(12===e.target.type)return;if(6===e.target.type&&e.target.detail.injectedText)return;if(e.event.preventDefault(),e.event.stopPropagation(),6!==e.target.type&&7!==e.target.type&&1!==e.target.type)return;if(this._editor.focus(),e.target.position){let hasSelectionAtPosition=!1;for(const selection of this._editor.getSelections())if(selection.containsPosition(e.target.position)){hasSelectionAtPosition=!0;break}hasSelectionAtPosition||this._editor.setPosition(e.target.position)}let anchor=null;1!==e.target.type&&(anchor={x:e.event.posx-1,width:2,y:e.event.posy-1,height:2}),this.showContextMenu(anchor)}showContextMenu(anchor){if(!this._editor.getOption(20))return;if(!this._editor.hasModel())return;if(!this._contextMenuService)return void this._editor.focus();const menuActions=this._getMenuActions(this._editor.getModel(),this._editor.isSimpleWidget?MenuId.SimpleEditorContext:MenuId.EditorContext);menuActions.length>0&&this._doShowContextMenu(menuActions,anchor)}_getMenuActions(model,menuId){const result=[],menu=this._menuService.createMenu(menuId,this._contextKeyService),groups=menu.getActions({arg:model.uri});menu.dispose();for(let group of groups){const[,actions]=group;let addedItems=0;for(const action of actions)if(action instanceof SubmenuItemAction){const subActions=this._getMenuActions(model,action.item.submenu);subActions.length>0&&(result.push(new SubmenuAction(action.id,action.label,subActions)),addedItems++)}else result.push(action),addedItems++;addedItems&&result.push(new Separator)}return result.length&&result.pop(),result}_doShowContextMenu(actions,anchor=null){if(!this._editor.hasModel())return;const oldHoverSetting=this._editor.getOption(53);if(this._editor.updateOptions({hover:{enabled:!1}}),!anchor){this._editor.revealPosition(this._editor.getPosition(),1),this._editor.render();const cursorCoords=this._editor.getScrolledVisiblePosition(this._editor.getPosition()),editorCoords=dom.getDomNodePagePosition(this._editor.getDomNode()),posx=editorCoords.left+cursorCoords.left,posy=editorCoords.top+cursorCoords.top+cursorCoords.height;anchor={x:posx,y:posy}}const useShadowDOM=this._editor.getOption(115)&&!isIOS;this._contextMenuIsBeingShownCount++,this._contextMenuService.showContextMenu({domForShadowRoot:useShadowDOM?this._editor.getDomNode():void 0,getAnchor:()=>anchor,getActions:()=>actions,getActionViewItem:action=>{const keybinding=this._keybindingFor(action);if(keybinding)return new ActionViewItem(action,action,{label:!0,keybinding:keybinding.getLabel(),isMenu:!0});const customActionViewItem=action;return"function"==typeof customActionViewItem.getActionViewItem?customActionViewItem.getActionViewItem():new ActionViewItem(action,action,{icon:!0,label:!0,isMenu:!0})},getKeyBinding:action=>this._keybindingFor(action),onHide:wasCancelled=>{this._contextMenuIsBeingShownCount--,this._editor.focus(),this._editor.updateOptions({hover:oldHoverSetting})}})}_keybindingFor(action){return this._keybindingService.lookupKeybinding(action.id)}dispose(){this._contextMenuIsBeingShownCount>0&&this._contextViewService.hideContextView(),this._toDispose.dispose()}};ContextMenuController.ID="editor.contrib.contextmenu",ContextMenuController=__decorate([__param(1,IContextMenuService),__param(2,IContextViewService),__param(3,IContextKeyService),__param(4,IKeybindingService),__param(5,IMenuService)],ContextMenuController);export{ContextMenuController};class ShowContextMenu extends EditorAction{constructor(){super({id:"editor.action.showContextMenu",label:nls.localize("action.showContextMenu.label","Show Editor Context Menu"),alias:"Show Editor Context Menu",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.textInputFocus,primary:1092,weight:100}})}run(accessor,editor){var _a;null===(_a=ContextMenuController.get(editor))||void 0===_a||_a.showContextMenu()}}registerEditorContribution(ContextMenuController.ID,ContextMenuController),registerEditorAction(ShowContextMenu);