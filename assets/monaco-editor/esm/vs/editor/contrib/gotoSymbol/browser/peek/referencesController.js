var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{createCancelablePromise}from"../../../../../base/common/async.js";import{onUnexpectedError}from"../../../../../base/common/errors.js";import{KeyChord}from"../../../../../base/common/keyCodes.js";import{DisposableStore}from"../../../../../base/common/lifecycle.js";import{ICodeEditorService}from"../../../../browser/services/codeEditorService.js";import{Position}from"../../../../common/core/position.js";import{Range}from"../../../../common/core/range.js";import{getOuterEditor,PeekContext}from"../../../peekView/browser/peekView.js";import*as nls from"../../../../../nls.js";import{CommandsRegistry}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr,IContextKeyService,RawContextKey}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingsRegistry}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IListService,WorkbenchListFocusContextKey,WorkbenchTreeElementCanCollapse,WorkbenchTreeElementCanExpand}from"../../../../../platform/list/browser/listService.js";import{INotificationService}from"../../../../../platform/notification/common/notification.js";import{IStorageService}from"../../../../../platform/storage/common/storage.js";import{OneReference}from"../referencesModel.js";import{LayoutData,ReferenceWidget}from"./referencesWidget.js";export const ctxReferenceSearchVisible=new RawContextKey("referenceSearchVisible",!1,nls.localize("referenceSearchVisible","Whether reference peek is visible, like 'Peek References' or 'Peek Definition'"));let ReferencesController=class ReferencesController{constructor(_defaultTreeKeyboardSupport,_editor,contextKeyService,_editorService,_notificationService,_instantiationService,_storageService,_configurationService){this._defaultTreeKeyboardSupport=_defaultTreeKeyboardSupport,this._editor=_editor,this._editorService=_editorService,this._notificationService=_notificationService,this._instantiationService=_instantiationService,this._storageService=_storageService,this._configurationService=_configurationService,this._disposables=new DisposableStore,this._requestIdPool=0,this._ignoreModelChangeEvent=!1,this._referenceSearchVisible=ctxReferenceSearchVisible.bindTo(contextKeyService)}static get(editor){return editor.getContribution(ReferencesController.ID)}dispose(){var _a,_b;this._referenceSearchVisible.reset(),this._disposables.dispose(),null===(_a=this._widget)||void 0===_a||_a.dispose(),null===(_b=this._model)||void 0===_b||_b.dispose(),this._widget=void 0,this._model=void 0}toggleWidget(range,modelPromise,peekMode){let widgetPosition;if(this._widget&&(widgetPosition=this._widget.position),this.closeWidget(),widgetPosition&&range.containsPosition(widgetPosition))return;this._peekMode=peekMode,this._referenceSearchVisible.set(!0),this._disposables.add(this._editor.onDidChangeModelLanguage((()=>{this.closeWidget()}))),this._disposables.add(this._editor.onDidChangeModel((()=>{this._ignoreModelChangeEvent||this.closeWidget()})));const data=LayoutData.fromJSON(this._storageService.get("peekViewLayout",0,"{}"));this._widget=this._instantiationService.createInstance(ReferenceWidget,this._editor,this._defaultTreeKeyboardSupport,data),this._widget.setTitle(nls.localize("labelLoading","Loading...")),this._widget.show(range),this._disposables.add(this._widget.onDidClose((()=>{modelPromise.cancel(),this._widget&&(this._storageService.store("peekViewLayout",JSON.stringify(this._widget.layoutData),0,1),this._widget=void 0),this.closeWidget()}))),this._disposables.add(this._widget.onDidSelectReference((event=>{let{element,kind}=event;if(element)switch(kind){case"open":"editor"===event.source&&this._configurationService.getValue("editor.stablePeek")||this.openReference(element,!1,!1);break;case"side":this.openReference(element,!0,!1);break;case"goto":peekMode?this._gotoReference(element):this.openReference(element,!1,!0)}})));const requestId=++this._requestIdPool;modelPromise.then((model=>{var _a;if(requestId===this._requestIdPool&&this._widget)return null===(_a=this._model)||void 0===_a||_a.dispose(),this._model=model,this._widget.setModel(this._model).then((()=>{if(this._widget&&this._model&&this._editor.hasModel()){this._model.isEmpty?this._widget.setMetaTitle(""):this._widget.setMetaTitle(nls.localize("metaTitle.N","{0} ({1})",this._model.title,this._model.references.length));let uri=this._editor.getModel().uri,pos=new Position(range.startLineNumber,range.startColumn),selection=this._model.nearestReference(uri,pos);if(selection)return this._widget.setSelection(selection).then((()=>{this._widget&&"editor"===this._editor.getOption(77)&&this._widget.focusOnPreviewEditor()}))}}));model.dispose()}),(error=>{this._notificationService.error(error)}))}changeFocusBetweenPreviewAndReferences(){this._widget&&(this._widget.isPreviewEditorFocused()?this._widget.focusOnReferenceTree():this._widget.focusOnPreviewEditor())}goToNextOrPreviousReference(fwd){return __awaiter(this,void 0,void 0,(function*(){if(!this._editor.hasModel()||!this._model||!this._widget)return;const currentPosition=this._widget.position;if(!currentPosition)return;const source=this._model.nearestReference(this._editor.getModel().uri,currentPosition);if(!source)return;const target=this._model.nextOrPreviousReference(source,fwd),editorFocus=this._editor.hasTextFocus(),previewEditorFocus=this._widget.isPreviewEditorFocused();yield this._widget.setSelection(target),yield this._gotoReference(target),editorFocus?this._editor.focus():this._widget&&previewEditorFocus&&this._widget.focusOnPreviewEditor()}))}revealReference(reference){return __awaiter(this,void 0,void 0,(function*(){this._editor.hasModel()&&this._model&&this._widget&&(yield this._widget.revealReference(reference))}))}closeWidget(focusEditor=!0){var _a,_b;null===(_a=this._widget)||void 0===_a||_a.dispose(),null===(_b=this._model)||void 0===_b||_b.dispose(),this._referenceSearchVisible.reset(),this._disposables.clear(),this._widget=void 0,this._model=void 0,focusEditor&&this._editor.focus(),this._requestIdPool+=1}_gotoReference(ref){this._widget&&this._widget.hide(),this._ignoreModelChangeEvent=!0;const range=Range.lift(ref.range).collapseToStart();return this._editorService.openCodeEditor({resource:ref.uri,options:{selection:range,selectionSource:"code.jump"}},this._editor).then((openedEditor=>{var _a;if(this._ignoreModelChangeEvent=!1,openedEditor&&this._widget)if(this._editor===openedEditor)this._widget.show(range),this._widget.focusOnReferenceTree();else{const other=ReferencesController.get(openedEditor),model=this._model.clone();this.closeWidget(),openedEditor.focus(),null==other||other.toggleWidget(range,createCancelablePromise((_=>Promise.resolve(model))),null!==(_a=this._peekMode)&&void 0!==_a&&_a)}else this.closeWidget()}),(err=>{this._ignoreModelChangeEvent=!1,onUnexpectedError(err)}))}openReference(ref,sideBySide,pinned){sideBySide||this.closeWidget();const{uri,range}=ref;this._editorService.openCodeEditor({resource:uri,options:{selection:range,selectionSource:"code.jump",pinned}},this._editor,sideBySide)}};ReferencesController.ID="editor.contrib.referencesController",ReferencesController=__decorate([__param(2,IContextKeyService),__param(3,ICodeEditorService),__param(4,INotificationService),__param(5,IInstantiationService),__param(6,IStorageService),__param(7,IConfigurationService)],ReferencesController);export{ReferencesController};function withController(accessor,fn){const outerEditor=getOuterEditor(accessor);if(!outerEditor)return;const controller=ReferencesController.get(outerEditor);controller&&fn(controller)}KeybindingsRegistry.registerCommandAndKeybindingRule({id:"togglePeekWidgetFocus",weight:100,primary:KeyChord(2089,60),when:ContextKeyExpr.or(ctxReferenceSearchVisible,PeekContext.inPeekEditor),handler(accessor){withController(accessor,(controller=>{controller.changeFocusBetweenPreviewAndReferences()}))}}),KeybindingsRegistry.registerCommandAndKeybindingRule({id:"goToNextReference",weight:90,primary:62,secondary:[70],when:ContextKeyExpr.or(ctxReferenceSearchVisible,PeekContext.inPeekEditor),handler(accessor){withController(accessor,(controller=>{controller.goToNextOrPreviousReference(!0)}))}}),KeybindingsRegistry.registerCommandAndKeybindingRule({id:"goToPreviousReference",weight:90,primary:1086,secondary:[1094],when:ContextKeyExpr.or(ctxReferenceSearchVisible,PeekContext.inPeekEditor),handler(accessor){withController(accessor,(controller=>{controller.goToNextOrPreviousReference(!1)}))}}),CommandsRegistry.registerCommandAlias("goToNextReferenceFromEmbeddedEditor","goToNextReference"),CommandsRegistry.registerCommandAlias("goToPreviousReferenceFromEmbeddedEditor","goToPreviousReference"),CommandsRegistry.registerCommandAlias("closeReferenceSearchEditor","closeReferenceSearch"),CommandsRegistry.registerCommand("closeReferenceSearch",(accessor=>withController(accessor,(controller=>controller.closeWidget())))),KeybindingsRegistry.registerKeybindingRule({id:"closeReferenceSearch",weight:-1,primary:9,secondary:[1033],when:ContextKeyExpr.and(PeekContext.inPeekEditor,ContextKeyExpr.not("config.editor.stablePeek"))}),KeybindingsRegistry.registerKeybindingRule({id:"closeReferenceSearch",weight:250,primary:9,secondary:[1033],when:ContextKeyExpr.and(ctxReferenceSearchVisible,ContextKeyExpr.not("config.editor.stablePeek"))}),KeybindingsRegistry.registerCommandAndKeybindingRule({id:"revealReference",weight:200,primary:3,mac:{primary:3,secondary:[2066]},when:ContextKeyExpr.and(ctxReferenceSearchVisible,WorkbenchListFocusContextKey,WorkbenchTreeElementCanCollapse.negate(),WorkbenchTreeElementCanExpand.negate()),handler(accessor){var _a;const focus=null===(_a=accessor.get(IListService).lastFocusedList)||void 0===_a?void 0:_a.getFocus();Array.isArray(focus)&&focus[0]instanceof OneReference&&withController(accessor,(controller=>controller.revealReference(focus[0])))}}),KeybindingsRegistry.registerCommandAndKeybindingRule({id:"openReferenceToSide",weight:100,primary:2051,mac:{primary:259},when:ContextKeyExpr.and(ctxReferenceSearchVisible,WorkbenchListFocusContextKey,WorkbenchTreeElementCanCollapse.negate(),WorkbenchTreeElementCanExpand.negate()),handler(accessor){var _a;const focus=null===(_a=accessor.get(IListService).lastFocusedList)||void 0===_a?void 0:_a.getFocus();Array.isArray(focus)&&focus[0]instanceof OneReference&&withController(accessor,(controller=>controller.openReference(focus[0],!0,!0)))}}),CommandsRegistry.registerCommand("openReference",(accessor=>{var _a;const focus=null===(_a=accessor.get(IListService).lastFocusedList)||void 0===_a?void 0:_a.getFocus();Array.isArray(focus)&&focus[0]instanceof OneReference&&withController(accessor,(controller=>controller.openReference(focus[0],!1,!0)))}));