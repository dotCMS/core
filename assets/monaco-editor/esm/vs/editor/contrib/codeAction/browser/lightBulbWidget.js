var LightBulbState,__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import*as dom from"../../../../base/browser/dom.js";import{GlobalMouseMoveMonitor,standardMouseMoveMerger}from"../../../../base/browser/globalMouseMoveMonitor.js";import{Gesture}from"../../../../base/browser/touch.js";import{Codicon}from"../../../../base/common/codicons.js";import{Emitter}from"../../../../base/common/event.js";import{Disposable}from"../../../../base/common/lifecycle.js";import"./lightBulbWidget.css";import{computeIndentLevel}from"../../../common/model/utils.js";import*as nls from"../../../../nls.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";import{editorBackground,editorLightBulbAutoFixForeground,editorLightBulbForeground}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";!function(LightBulbState){LightBulbState.Hidden={type:0};LightBulbState.Showing=class Showing{constructor(actions,trigger,editorPosition,widgetPosition){this.actions=actions,this.trigger=trigger,this.editorPosition=editorPosition,this.widgetPosition=widgetPosition,this.type=1}}}(LightBulbState||(LightBulbState={}));let LightBulbWidget=class LightBulbWidget extends Disposable{constructor(_editor,_quickFixActionId,_preferredFixActionId,_keybindingService){super(),this._editor=_editor,this._quickFixActionId=_quickFixActionId,this._preferredFixActionId=_preferredFixActionId,this._keybindingService=_keybindingService,this._onClick=this._register(new Emitter),this.onClick=this._onClick.event,this._state=LightBulbState.Hidden,this._domNode=document.createElement("div"),this._domNode.className=Codicon.lightBulb.classNames,this._editor.addContentWidget(this),this._register(this._editor.onDidChangeModelContent((_=>{const editorModel=this._editor.getModel();(1!==this.state.type||!editorModel||this.state.editorPosition.lineNumber>=editorModel.getLineCount())&&this.hide()}))),Gesture.ignoreTarget(this._domNode),this._register(dom.addStandardDisposableGenericMouseDownListener(this._domNode,(e=>{if(1!==this.state.type)return;this._editor.focus(),e.preventDefault();const{top,height}=dom.getDomNodePagePosition(this._domNode),lineHeight=this._editor.getOption(59);let pad=Math.floor(lineHeight/3);null!==this.state.widgetPosition.position&&this.state.widgetPosition.position.lineNumber<this.state.editorPosition.lineNumber&&(pad+=lineHeight),this._onClick.fire({x:e.posx,y:top+height+pad,actions:this.state.actions,trigger:this.state.trigger})}))),this._register(dom.addDisposableListener(this._domNode,"mouseenter",(e=>{if(1!=(1&e.buttons))return;this.hide();const monitor=new GlobalMouseMoveMonitor;monitor.startMonitoring(e.target,e.buttons,standardMouseMoveMerger,(()=>{}),(()=>{monitor.dispose()}))}))),this._register(this._editor.onDidChangeConfiguration((e=>{e.hasChanged(57)&&!this._editor.getOption(57).enabled&&this.hide()}))),this._updateLightBulbTitleAndIcon(),this._register(this._keybindingService.onDidUpdateKeybindings(this._updateLightBulbTitleAndIcon,this))}dispose(){super.dispose(),this._editor.removeContentWidget(this)}getId(){return"LightBulbWidget"}getDomNode(){return this._domNode}getPosition(){return 1===this._state.type?this._state.widgetPosition:null}update(actions,trigger,atPosition){if(actions.validActions.length<=0)return this.hide();const options=this._editor.getOptions();if(!options.get(57).enabled)return this.hide();const model=this._editor.getModel();if(!model)return this.hide();const{lineNumber,column}=model.validatePosition(atPosition),tabSize=model.getOptions().tabSize,fontInfo=options.get(44),lineContent=model.getLineContent(lineNumber),indent=computeIndentLevel(lineContent,tabSize),isFolded=lineNumber=>lineNumber>2&&this._editor.getTopForLineNumber(lineNumber)===this._editor.getTopForLineNumber(lineNumber-1);let effectiveLineNumber=lineNumber;if(!(fontInfo.spaceWidth*indent>22))if(lineNumber>1&&!isFolded(lineNumber-1))effectiveLineNumber-=1;else if(isFolded(lineNumber+1)){if(column*fontInfo.spaceWidth<22)return this.hide()}else effectiveLineNumber+=1;this.state=new LightBulbState.Showing(actions,trigger,atPosition,{position:{lineNumber:effectiveLineNumber,column:1},preference:LightBulbWidget._posPref}),this._editor.layoutContentWidget(this)}hide(){this.state=LightBulbState.Hidden,this._editor.layoutContentWidget(this)}get state(){return this._state}set state(value){this._state=value,this._updateLightBulbTitleAndIcon()}_updateLightBulbTitleAndIcon(){if(1===this.state.type&&this.state.actions.hasAutoFix){this._domNode.classList.remove(...Codicon.lightBulb.classNamesArray),this._domNode.classList.add(...Codicon.lightbulbAutofix.classNamesArray);const preferredKb=this._keybindingService.lookupKeybinding(this._preferredFixActionId);if(preferredKb)return void(this.title=nls.localize("preferredcodeActionWithKb","Show Code Actions. Preferred Quick Fix Available ({0})",preferredKb.getLabel()))}this._domNode.classList.remove(...Codicon.lightbulbAutofix.classNamesArray),this._domNode.classList.add(...Codicon.lightBulb.classNamesArray);const kb=this._keybindingService.lookupKeybinding(this._quickFixActionId);this.title=kb?nls.localize("codeActionWithKb","Show Code Actions ({0})",kb.getLabel()):nls.localize("codeAction","Show Code Actions")}set title(value){this._domNode.title=value}};LightBulbWidget._posPref=[0],LightBulbWidget=__decorate([__param(3,IKeybindingService)],LightBulbWidget);export{LightBulbWidget};registerThemingParticipant(((theme,collector)=>{var _a;const editorBackgroundColor=null===(_a=theme.getColor(editorBackground))||void 0===_a?void 0:_a.transparent(.7),editorLightBulbForegroundColor=theme.getColor(editorLightBulbForeground);editorLightBulbForegroundColor&&collector.addRule(`\n\t\t.monaco-editor .contentWidgets ${Codicon.lightBulb.cssSelector} {\n\t\t\tcolor: ${editorLightBulbForegroundColor};\n\t\t\tbackground-color: ${editorBackgroundColor};\n\t\t}`);const editorLightBulbAutoFixForegroundColor=theme.getColor(editorLightBulbAutoFixForeground);editorLightBulbAutoFixForegroundColor&&collector.addRule(`\n\t\t.monaco-editor .contentWidgets ${Codicon.lightbulbAutofix.cssSelector} {\n\t\t\tcolor: ${editorLightBulbAutoFixForegroundColor};\n\t\t\tbackground-color: ${editorBackgroundColor};\n\t\t}`)}));