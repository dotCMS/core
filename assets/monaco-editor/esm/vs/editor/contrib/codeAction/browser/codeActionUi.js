var _CodeActionUi_disposed,__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__classPrivateFieldSet=this&&this.__classPrivateFieldSet||function(receiver,state,value,kind,f){if("m"===kind)throw new TypeError("Private method is not writable");if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(receiver,state,kind,f){if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};import{onUnexpectedError}from"../../../../base/common/errors.js";import{Lazy}from"../../../../base/common/lazy.js";import{Disposable,MutableDisposable}from"../../../../base/common/lifecycle.js";import{MessageController}from"../../message/browser/messageController.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{CodeActionMenu}from"./codeActionMenu.js";import{LightBulbWidget}from"./lightBulbWidget.js";let CodeActionUi=class CodeActionUi extends Disposable{constructor(_editor,quickFixActionId,preferredFixActionId,delegate,instantiationService){super(),this._editor=_editor,this.delegate=delegate,this._activeCodeActions=this._register(new MutableDisposable),_CodeActionUi_disposed.set(this,!1),this._codeActionWidget=new Lazy((()=>this._register(instantiationService.createInstance(CodeActionMenu,this._editor,{onSelectCodeAction:action=>__awaiter(this,void 0,void 0,(function*(){this.delegate.applyCodeAction(action,!0)}))})))),this._lightBulbWidget=new Lazy((()=>{const widget=this._register(instantiationService.createInstance(LightBulbWidget,this._editor,quickFixActionId,preferredFixActionId));return this._register(widget.onClick((e=>this.showCodeActionList(e.trigger,e.actions,e,{includeDisabledActions:!1})))),widget}))}dispose(){__classPrivateFieldSet(this,_CodeActionUi_disposed,!0,"f"),super.dispose()}update(newState){var _a,_b,_c,_d,_e;return __awaiter(this,void 0,void 0,(function*(){if(1!==newState.type)return void(null===(_a=this._lightBulbWidget.rawValue)||void 0===_a||_a.hide());let actions;try{actions=yield newState.actions}catch(e){return void onUnexpectedError(e)}if(!__classPrivateFieldGet(this,_CodeActionUi_disposed,"f"))if(this._lightBulbWidget.getValue().update(actions,newState.trigger,newState.position),1===newState.trigger.type){if(null===(_b=newState.trigger.filter)||void 0===_b?void 0:_b.include){const validActionToApply=this.tryGetValidActionToApply(newState.trigger,actions);if(validActionToApply){try{this._lightBulbWidget.getValue().hide(),yield this.delegate.applyCodeAction(validActionToApply,!1)}finally{actions.dispose()}return}if(newState.trigger.context){const invalidAction=this.getInvalidActionThatWouldHaveBeenApplied(newState.trigger,actions);if(invalidAction&&invalidAction.action.disabled)return null===(_c=MessageController.get(this._editor))||void 0===_c||_c.showMessage(invalidAction.action.disabled,newState.trigger.context.position),void actions.dispose()}}const includeDisabledActions=!!(null===(_d=newState.trigger.filter)||void 0===_d?void 0:_d.include);if(newState.trigger.context&&(!actions.allActions.length||!includeDisabledActions&&!actions.validActions.length))return null===(_e=MessageController.get(this._editor))||void 0===_e||_e.showMessage(newState.trigger.context.notAvailableMessage,newState.trigger.context.position),this._activeCodeActions.value=actions,void actions.dispose();this._activeCodeActions.value=actions,this._codeActionWidget.getValue().show(newState.trigger,actions,newState.position,{includeDisabledActions})}else this._codeActionWidget.getValue().isVisible?actions.dispose():this._activeCodeActions.value=actions}))}getInvalidActionThatWouldHaveBeenApplied(trigger,actions){if(actions.allActions.length)return"first"===trigger.autoApply&&0===actions.validActions.length||"ifSingle"===trigger.autoApply&&1===actions.allActions.length?actions.allActions.find((({action})=>action.disabled)):void 0}tryGetValidActionToApply(trigger,actions){if(actions.validActions.length)return"first"===trigger.autoApply&&actions.validActions.length>0||"ifSingle"===trigger.autoApply&&1===actions.validActions.length?actions.validActions[0]:void 0}showCodeActionList(trigger,actions,at,options){return __awaiter(this,void 0,void 0,(function*(){this._codeActionWidget.getValue().show(trigger,actions,at,options)}))}};_CodeActionUi_disposed=new WeakMap,CodeActionUi=__decorate([__param(4,IInstantiationService)],CodeActionUi);export{CodeActionUi};