var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{RunOnceScheduler}from"../../../../base/common/async.js";import{CancellationToken,CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{LRUCache}from"../../../../base/common/map.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{DynamicCssRules}from"../../../browser/editorDom.js";import{EDITOR_FONT_DEFAULTS}from"../../../common/config/editorOptions.js";import{Range}from"../../../common/core/range.js";import*as languages from"../../../common/languages.js";import{InjectedTextCursorStops}from"../../../common/model.js";import{ModelDecorationInjectedTextOptions}from"../../../common/model/textModel.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{ITextModelService}from"../../../common/services/resolverService.js";import{ClickLinkGesture}from"../../gotoSymbol/browser/link/clickLinkGesture.js";import{InlayHintAnchor,InlayHintsFragments}from"./inlayHints.js";import{goToDefinitionWithLocation,showGoToContextMenu}from"./inlayHintsLocations.js";import{CommandsRegistry,ICommandService}from"../../../../platform/commands/common/commands.js";import{registerSingleton}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator,IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService,Severity}from"../../../../platform/notification/common/notification.js";import*as colors from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId}from"../../../../platform/theme/common/themeService.js";class InlayHintsCache{constructor(){this._entries=new LRUCache(50)}get(model){const key=InlayHintsCache._key(model);return this._entries.get(key)}set(model,value){const key=InlayHintsCache._key(model);this._entries.set(key,value)}static _key(model){return`${model.uri.toString()}/${model.getVersionId()}`}}const IInlayHintsCache=createDecorator("IInlayHintsCache");registerSingleton(IInlayHintsCache,InlayHintsCache,!0);export class RenderedInlayHintLabelPart{constructor(item,index){this.item=item,this.index=index}get part(){const label=this.item.hint.label;return"string"==typeof label?{label}:label[this.index]}}class ActiveInlayHintInfo{constructor(part,hasTriggerModifier){this.part=part,this.hasTriggerModifier=hasTriggerModifier}}let InlayHintsController=class InlayHintsController{constructor(_editor,_languageFeaturesService,_featureDebounce,_inlayHintsCache,_commandService,_notificationService,_instaService){this._editor=_editor,this._languageFeaturesService=_languageFeaturesService,this._inlayHintsCache=_inlayHintsCache,this._commandService=_commandService,this._notificationService=_notificationService,this._instaService=_instaService,this._disposables=new DisposableStore,this._sessionDisposables=new DisposableStore,this._decorationsMetadata=new Map,this._ruleFactory=new DynamicCssRules(this._editor),this._debounceInfo=_featureDebounce.for(_languageFeaturesService.inlayHintsProvider,"InlayHint",{min:25}),this._disposables.add(_languageFeaturesService.inlayHintsProvider.onDidChange((()=>this._update()))),this._disposables.add(_editor.onDidChangeModel((()=>this._update()))),this._disposables.add(_editor.onDidChangeModelLanguage((()=>this._update()))),this._disposables.add(_editor.onDidChangeConfiguration((e=>{e.hasChanged(127)&&this._update()}))),this._update()}static get(editor){var _a;return null!==(_a=editor.getContribution(InlayHintsController.ID))&&void 0!==_a?_a:void 0}dispose(){this._sessionDisposables.dispose(),this._removeAllDecorations(),this._disposables.dispose()}_update(){if(this._sessionDisposables.clear(),this._removeAllDecorations(),!this._editor.getOption(127).enabled)return;const model=this._editor.getModel();if(!model||!this._languageFeaturesService.inlayHintsProvider.has(model))return;const cached=this._inlayHintsCache.get(model);let cts;cached&&this._updateHintsDecorators([model.getFullModelRange()],cached),this._sessionDisposables.add(toDisposable((()=>{model.isDisposed()||this._cacheHintsForFastRestore(model)})));let watchedProviders=new Set;const scheduler=new RunOnceScheduler((()=>__awaiter(this,void 0,void 0,(function*(){const t1=Date.now();null==cts||cts.dispose(!0),cts=new CancellationTokenSource;const listener=model.onWillDispose((()=>null==cts?void 0:cts.cancel()));try{const myToken=cts.token,inlayHints=yield InlayHintsFragments.create(this._languageFeaturesService.inlayHintsProvider,model,this._getHintsRanges(),myToken);if(scheduler.delay=this._debounceInfo.update(model,Date.now()-t1),myToken.isCancellationRequested)return void inlayHints.dispose();for(const provider of inlayHints.provider)"function"!=typeof provider.onDidChangeInlayHints||watchedProviders.has(provider)||(watchedProviders.add(provider),this._sessionDisposables.add(provider.onDidChangeInlayHints((()=>{scheduler.isScheduled()||scheduler.schedule()}))));this._sessionDisposables.add(inlayHints),this._updateHintsDecorators(inlayHints.ranges,inlayHints.items),this._cacheHintsForFastRestore(model)}catch(err){onUnexpectedError(err)}finally{cts.dispose(),listener.dispose()}}))),this._debounceInfo.get(model));this._sessionDisposables.add(scheduler),this._sessionDisposables.add(toDisposable((()=>null==cts?void 0:cts.dispose(!0)))),scheduler.schedule(0),this._sessionDisposables.add(this._editor.onDidScrollChange((e=>{!e.scrollTopChanged&&scheduler.isScheduled()||scheduler.schedule()}))),this._sessionDisposables.add(this._editor.onDidChangeModelContent((e=>{const delay=Math.max(scheduler.delay,1250);scheduler.schedule(delay)}))),this._sessionDisposables.add(this._installLinkGesture()),this._sessionDisposables.add(this._installDblClickGesture()),this._sessionDisposables.add(this._installContextMenu())}_installLinkGesture(){const store=new DisposableStore,gesture=store.add(new ClickLinkGesture(this._editor)),sessionStore=new DisposableStore;return store.add(sessionStore),store.add(gesture.onMouseMoveOrRelevantKeyDown((e=>{const[mouseEvent]=e,labelPart=this._getInlayHintLabelPart(mouseEvent),model=this._editor.getModel();if(!labelPart||!model)return void sessionStore.clear();const cts=new CancellationTokenSource;sessionStore.add(toDisposable((()=>cts.dispose(!0)))),labelPart.item.resolve(cts.token),this._activeInlayHintPart=labelPart.part.command||labelPart.part.location?new ActiveInlayHintInfo(labelPart,mouseEvent.hasTriggerModifier):void 0;const lineNumber=labelPart.item.hint.position.lineNumber,range=new Range(lineNumber,1,lineNumber,model.getLineMaxColumn(lineNumber)),lineHints=new Set;for(const data of this._decorationsMetadata.values())range.containsRange(data.item.anchor.range)&&lineHints.add(data.item);this._updateHintsDecorators([range],Array.from(lineHints)),sessionStore.add(toDisposable((()=>{this._activeInlayHintPart=void 0,this._updateHintsDecorators([range],Array.from(lineHints))})))}))),store.add(gesture.onCancel((()=>sessionStore.clear()))),store.add(gesture.onExecute((e=>__awaiter(this,void 0,void 0,(function*(){const label=this._getInlayHintLabelPart(e);if(label){const part=label.part;part.location?this._instaService.invokeFunction(goToDefinitionWithLocation,e,this._editor,part.location):languages.Command.is(part.command)&&(yield this._invokeCommand(part.command,label.item))}}))))),store}_installDblClickGesture(){return this._editor.onMouseUp((e=>__awaiter(this,void 0,void 0,(function*(){if(2!==e.event.detail)return;const part=this._getInlayHintLabelPart(e);part&&(e.event.preventDefault(),yield part.item.resolve(CancellationToken.None),part.item.hint.command&&(yield this._invokeCommand(part.item.hint.command,part.item)))}))))}_installContextMenu(){return this._editor.onContextMenu((e=>__awaiter(this,void 0,void 0,(function*(){if(!(e.event.target instanceof HTMLElement))return;const part=this._getInlayHintLabelPart(e);part&&(yield this._instaService.invokeFunction(showGoToContextMenu,this._editor,e.event.target,part))}))))}_getInlayHintLabelPart(e){var _a;if(6!==e.target.type)return;const options=null===(_a=e.target.detail.injectedText)||void 0===_a?void 0:_a.options;return options instanceof ModelDecorationInjectedTextOptions&&(null==options?void 0:options.attachedData)instanceof RenderedInlayHintLabelPart?options.attachedData:void 0}_invokeCommand(command,item){var _a;return __awaiter(this,void 0,void 0,(function*(){try{yield this._commandService.executeCommand(command.id,...null!==(_a=command.arguments)&&void 0!==_a?_a:[])}catch(err){this._notificationService.notify({severity:Severity.Error,source:item.provider.displayName,message:err})}}))}_cacheHintsForFastRestore(model){const items=new Map;for(const[id,obj]of this._decorationsMetadata){if(items.has(obj.item))continue;let value=obj.item;const range=model.getDecorationRange(id);if(range){const anchor=new InlayHintAnchor(range,obj.item.anchor.direction);value=obj.item.with({anchor})}items.set(obj.item,value)}this._inlayHintsCache.set(model,Array.from(items.values()))}_getHintsRanges(){const model=this._editor.getModel(),visibleRanges=this._editor.getVisibleRangesPlusViewportAboveBelow(),result=[];for(const range of visibleRanges.sort(Range.compareRangesUsingStarts)){const extendedRange=model.validateRange(new Range(range.startLineNumber-30,range.startColumn,range.endLineNumber+30,range.endColumn));0!==result.length&&Range.areIntersectingOrTouching(result[result.length-1],extendedRange)?result[result.length-1]=Range.plusRange(result[result.length-1],extendedRange):result.push(extendedRange)}return result}_updateHintsDecorators(ranges,items){var _a,_b;const newDecorationsData=[],addInjectedText=(item,ref,content,cursorStops,attachedData)=>{newDecorationsData.push({item,classNameRef:ref,decoration:{range:item.anchor.range,options:{description:"InlayHint",showIfCollapsed:item.anchor.range.isEmpty(),collapseOnReplaceEdit:!item.anchor.range.isEmpty(),stickiness:0,[item.anchor.direction]:{content,inlineClassNameAffectsLetterSpacing:!0,inlineClassName:ref.className,cursorStops,attachedData}}}})},addInjectedWhitespace=(item,isLast)=>{const marginRule=this._ruleFactory.createClassNameRef({width:(fontSize/3|0)+"px",display:"inline-block"});addInjectedText(item,marginRule," ",isLast?InjectedTextCursorStops.Right:InjectedTextCursorStops.None)},{fontSize,fontFamily}=this._getLayoutInfo();this._editor.getContainerDomNode().style.setProperty("--code-editorInlayHintsFontFamily",fontFamily);for(const item of items){item.hint.paddingLeft&&addInjectedWhitespace(item,!1);const parts="string"==typeof item.hint.label?[{label:item.hint.label}]:item.hint.label;for(let i=0;i<parts.length;i++){const part=parts[i],isFirst=0===i,isLast=i===parts.length-1,cssProperties={fontSize:`${fontSize}px`,fontFamily:`var(--code-editorInlayHintsFontFamily), ${EDITOR_FONT_DEFAULTS.fontFamily}`,verticalAlign:"middle"};item.hint.command&&(cssProperties.cursor="pointer"),this._fillInColors(cssProperties,item.hint),(part.command||part.location)&&(null===(_a=this._activeInlayHintPart)||void 0===_a?void 0:_a.part.item)===item&&this._activeInlayHintPart.part.index===i&&(cssProperties.textDecoration="underline",this._activeInlayHintPart.hasTriggerModifier&&(cssProperties.color=themeColorFromId(colors.editorActiveLinkForeground),cssProperties.cursor="pointer")),isFirst&&isLast?(cssProperties.padding=`1px ${0|Math.max(1,fontSize/4)}px`,cssProperties.borderRadius=(fontSize/4|0)+"px"):isFirst?(cssProperties.padding=`1px 0 1px ${0|Math.max(1,fontSize/4)}px`,cssProperties.borderRadius=`${fontSize/4|0}px 0 0 ${fontSize/4|0}px`):isLast?(cssProperties.padding=`1px ${0|Math.max(1,fontSize/4)}px 1px 0`,cssProperties.borderRadius=`0 ${fontSize/4|0}px ${fontSize/4|0}px 0`):cssProperties.padding="1px 0 1px 0",addInjectedText(item,this._ruleFactory.createClassNameRef(cssProperties),fixSpace(part.label),isLast&&!item.hint.paddingRight?InjectedTextCursorStops.Right:InjectedTextCursorStops.None,new RenderedInlayHintLabelPart(item,i))}if(item.hint.paddingRight&&addInjectedWhitespace(item,!0),newDecorationsData.length>InlayHintsController._MAX_DECORATORS)break}const decorationIdsToReplace=[];for(const range of ranges)for(const{id}of null!==(_b=this._editor.getDecorationsInRange(range))&&void 0!==_b?_b:[]){const metadata=this._decorationsMetadata.get(id);metadata&&(decorationIdsToReplace.push(id),metadata.classNameRef.dispose(),this._decorationsMetadata.delete(id))}const newDecorationIds=this._editor.deltaDecorations(decorationIdsToReplace,newDecorationsData.map((d=>d.decoration)));for(let i=0;i<newDecorationIds.length;i++){const data=newDecorationsData[i];this._decorationsMetadata.set(newDecorationIds[i],{item:data.item,classNameRef:data.classNameRef})}}_fillInColors(props,hint){hint.kind===languages.InlayHintKind.Parameter?(props.backgroundColor=themeColorFromId(colors.editorInlayHintParameterBackground),props.color=themeColorFromId(colors.editorInlayHintParameterForeground)):hint.kind===languages.InlayHintKind.Type?(props.backgroundColor=themeColorFromId(colors.editorInlayHintTypeBackground),props.color=themeColorFromId(colors.editorInlayHintTypeForeground)):(props.backgroundColor=themeColorFromId(colors.editorInlayHintBackground),props.color=themeColorFromId(colors.editorInlayHintForeground))}_getLayoutInfo(){const options=this._editor.getOption(127),editorFontSize=this._editor.getOption(46);let fontSize=options.fontSize;(!fontSize||fontSize<5||fontSize>editorFontSize)&&(fontSize=.9*editorFontSize|0);return{fontSize,fontFamily:options.fontFamily||this._editor.getOption(43)}}_removeAllDecorations(){this._editor.deltaDecorations(Array.from(this._decorationsMetadata.keys()),[]);for(let obj of this._decorationsMetadata.values())obj.classNameRef.dispose();this._decorationsMetadata.clear()}};InlayHintsController.ID="editor.contrib.InlayHints",InlayHintsController._MAX_DECORATORS=1500,InlayHintsController=__decorate([__param(1,ILanguageFeaturesService),__param(2,ILanguageFeatureDebounceService),__param(3,IInlayHintsCache),__param(4,ICommandService),__param(5,INotificationService),__param(6,IInstantiationService)],InlayHintsController);export{InlayHintsController};function fixSpace(str){return str.replace(/[ \t]/g," ")}CommandsRegistry.registerCommand("_executeInlayHintProvider",((accessor,...args)=>__awaiter(void 0,void 0,void 0,(function*(){const[uri,range]=args;assertType(URI.isUri(uri)),assertType(Range.isIRange(range));const{inlayHintsProvider}=accessor.get(ILanguageFeaturesService),ref=yield accessor.get(ITextModelService).createModelReference(uri);try{const model=yield InlayHintsFragments.create(inlayHintsProvider,ref.object.textEditorModel,[Range.lift(range)],CancellationToken.None),result=model.items.map((i=>i.hint));return setTimeout((()=>model.dispose()),0),result}finally{ref.dispose()}}))));