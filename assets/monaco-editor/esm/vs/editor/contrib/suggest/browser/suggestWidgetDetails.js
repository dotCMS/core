var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import{isSafari}from"../../../../base/browser/browser.js";import*as dom from"../../../../base/browser/dom.js";import{DomScrollableElement}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{Codicon}from"../../../../base/common/codicons.js";import{Emitter}from"../../../../base/common/event.js";import{MarkdownString}from"../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{MarkdownRenderer}from"../../markdownRenderer/browser/markdownRenderer.js";import{EDITOR_FONT_DEFAULTS}from"../../../common/config/editorOptions.js";import{ResizableHTMLElement}from"./resizable.js";import*as nls from"../../../../nls.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";export function canExpandCompletionItem(item){return!!item&&Boolean(item.completion.documentation||item.completion.detail&&item.completion.detail!==item.completion.label)}let SuggestDetailsWidget=class SuggestDetailsWidget{constructor(_editor,instaService){this._editor=_editor,this._onDidClose=new Emitter,this.onDidClose=this._onDidClose.event,this._onDidChangeContents=new Emitter,this.onDidChangeContents=this._onDidChangeContents.event,this._disposables=new DisposableStore,this._renderDisposeable=new DisposableStore,this._borderWidth=1,this._size=new dom.Dimension(330,0),this.domNode=dom.$(".suggest-details"),this.domNode.classList.add("no-docs"),this._markdownRenderer=instaService.createInstance(MarkdownRenderer,{editor:_editor}),this._body=dom.$(".body"),this._scrollbar=new DomScrollableElement(this._body,{}),dom.append(this.domNode,this._scrollbar.getDomNode()),this._disposables.add(this._scrollbar),this._header=dom.append(this._body,dom.$(".header")),this._close=dom.append(this._header,dom.$("span"+Codicon.close.cssSelector)),this._close.title=nls.localize("details.close","Close"),this._type=dom.append(this._header,dom.$("p.type")),this._docs=dom.append(this._body,dom.$("p.docs")),this._configureFont(),this._disposables.add(this._editor.onDidChangeConfiguration((e=>{e.hasChanged(44)&&this._configureFont()})))}dispose(){this._disposables.dispose(),this._renderDisposeable.dispose()}_configureFont(){const options=this._editor.getOptions(),fontInfo=options.get(44),fontFamily=fontInfo.getMassagedFontFamily(isSafari?EDITOR_FONT_DEFAULTS.fontFamily:null),fontSize=options.get(107)||fontInfo.fontSize,lineHeight=options.get(108)||fontInfo.lineHeight,fontWeight=fontInfo.fontWeight,fontSizePx=`${fontSize}px`,lineHeightPx=`${lineHeight}px`;this.domNode.style.fontSize=fontSizePx,this.domNode.style.lineHeight=""+lineHeight/fontSize,this.domNode.style.fontWeight=fontWeight,this.domNode.style.fontFeatureSettings=fontInfo.fontFeatureSettings,this._type.style.fontFamily=fontFamily,this._close.style.height=lineHeightPx,this._close.style.width=lineHeightPx}getLayoutInfo(){const lineHeight=this._editor.getOption(108)||this._editor.getOption(44).lineHeight,borderWidth=this._borderWidth;return{lineHeight,borderWidth,borderHeight:2*borderWidth,verticalPadding:22,horizontalPadding:14}}renderLoading(){this._type.textContent=nls.localize("loading","Loading..."),this._docs.textContent="",this.domNode.classList.remove("no-docs","no-type"),this.layout(this.size.width,2*this.getLayoutInfo().lineHeight),this._onDidChangeContents.fire(this)}renderItem(item,explainMode){var _a,_b;this._renderDisposeable.clear();let{detail,documentation}=item.completion;if(explainMode){let md="";md+=`score: ${item.score[0]}\n`,md+=`prefix: ${null!==(_a=item.word)&&void 0!==_a?_a:"(no prefix)"}\n`,md+=`word: ${item.completion.filterText?item.completion.filterText+" (filterText)":item.textLabel}\n`,md+=`distance: ${item.distance} (localityBonus-setting)\n`,md+=`index: ${item.idx}, based on ${item.completion.sortText&&`sortText: "${item.completion.sortText}"`||"label"}\n`,md+=`commit_chars: ${null===(_b=item.completion.commitCharacters)||void 0===_b?void 0:_b.join("")}\n`,documentation=(new MarkdownString).appendCodeblock("empty",md),detail=`Provider: ${item.provider._debugDisplayName}`}if(explainMode||canExpandCompletionItem(item)){if(this.domNode.classList.remove("no-docs","no-type"),detail){const cappedDetail=detail.length>1e5?`${detail.substr(0,1e5)}â€¦`:detail;this._type.textContent=cappedDetail,this._type.title=cappedDetail,dom.show(this._type),this._type.classList.toggle("auto-wrap",!/\r?\n^\s+/gim.test(cappedDetail))}else dom.clearNode(this._type),this._type.title="",dom.hide(this._type),this.domNode.classList.add("no-type");if(dom.clearNode(this._docs),"string"==typeof documentation)this._docs.classList.remove("markdown-docs"),this._docs.textContent=documentation;else if(documentation){this._docs.classList.add("markdown-docs"),dom.clearNode(this._docs);const renderedContents=this._markdownRenderer.render(documentation);this._docs.appendChild(renderedContents.element),this._renderDisposeable.add(renderedContents),this._renderDisposeable.add(this._markdownRenderer.onDidRenderAsync((()=>{this.layout(this._size.width,this._type.clientHeight+this._docs.clientHeight),this._onDidChangeContents.fire(this)})))}this.domNode.style.userSelect="text",this.domNode.tabIndex=-1,this._close.onmousedown=e=>{e.preventDefault(),e.stopPropagation()},this._close.onclick=e=>{e.preventDefault(),e.stopPropagation(),this._onDidClose.fire()},this._body.scrollTop=0,this.layout(this._size.width,this._type.clientHeight+this._docs.clientHeight),this._onDidChangeContents.fire(this)}else this.clearContents()}clearContents(){this.domNode.classList.add("no-docs"),this._type.textContent="",this._docs.textContent=""}get size(){return this._size}layout(width,height){const newSize=new dom.Dimension(width,height);dom.Dimension.equals(newSize,this._size)||(this._size=newSize,dom.size(this.domNode,width,height)),this._scrollbar.scanDomNode()}scrollDown(much=8){this._body.scrollTop+=much}scrollUp(much=8){this._body.scrollTop-=much}scrollTop(){this._body.scrollTop=0}scrollBottom(){this._body.scrollTop=this._body.scrollHeight}pageDown(){this.scrollDown(80)}pageUp(){this.scrollUp(80)}set borderWidth(width){this._borderWidth=width}get borderWidth(){return this._borderWidth}};SuggestDetailsWidget=__decorate([__param(1,IInstantiationService)],SuggestDetailsWidget);export{SuggestDetailsWidget};export class SuggestDetailsOverlay{constructor(widget,_editor){let topLeftNow,sizeNow;this.widget=widget,this._editor=_editor,this._disposables=new DisposableStore,this._added=!1,this._preferAlignAtTop=!0,this._resizable=new ResizableHTMLElement,this._resizable.domNode.classList.add("suggest-details-container"),this._resizable.domNode.appendChild(widget.domNode),this._resizable.enableSashes(!1,!0,!0,!1);let deltaTop=0,deltaLeft=0;this._disposables.add(this._resizable.onDidWillResize((()=>{topLeftNow=this._topLeft,sizeNow=this._resizable.size}))),this._disposables.add(this._resizable.onDidResize((e=>{if(topLeftNow&&sizeNow){this.widget.layout(e.dimension.width,e.dimension.height);let updateTopLeft=!1;e.west&&(deltaLeft=sizeNow.width-e.dimension.width,updateTopLeft=!0),e.north&&(deltaTop=sizeNow.height-e.dimension.height,updateTopLeft=!0),updateTopLeft&&this._applyTopLeft({top:topLeftNow.top+deltaTop,left:topLeftNow.left+deltaLeft})}e.done&&(topLeftNow=void 0,sizeNow=void 0,deltaTop=0,deltaLeft=0,this._userSize=e.dimension)}))),this._disposables.add(this.widget.onDidChangeContents((()=>{var _a;this._anchorBox&&this._placeAtAnchor(this._anchorBox,null!==(_a=this._userSize)&&void 0!==_a?_a:this.widget.size,this._preferAlignAtTop)})))}dispose(){this._resizable.dispose(),this._disposables.dispose(),this.hide()}getId(){return"suggest.details"}getDomNode(){return this._resizable.domNode}getPosition(){return null}show(){this._added||(this._editor.addOverlayWidget(this),this.getDomNode().style.position="fixed",this._added=!0)}hide(sessionEnded=!1){this._resizable.clearSashHoverState(),this._added&&(this._editor.removeOverlayWidget(this),this._added=!1,this._anchorBox=void 0,this._topLeft=void 0),sessionEnded&&(this._userSize=void 0,this.widget.clearContents())}placeAtAnchor(anchor,preferAlignAtTop){var _a;const anchorBox=anchor.getBoundingClientRect();this._anchorBox=anchorBox,this._preferAlignAtTop=preferAlignAtTop,this._placeAtAnchor(this._anchorBox,null!==(_a=this._userSize)&&void 0!==_a?_a:this.widget.size,preferAlignAtTop)}_placeAtAnchor(anchorBox,size,preferAlignAtTop){var _a;const bodyBox=dom.getClientArea(document.body),info=this.widget.getLayoutInfo(),defaultMinSize=new dom.Dimension(220,2*info.lineHeight),defaultTop=anchorBox.top,eastPlacement=function(){const width=bodyBox.width-(anchorBox.left+anchorBox.width+info.borderWidth+info.horizontalPadding),left=-info.borderWidth+anchorBox.left+anchorBox.width,maxSizeTop=new dom.Dimension(width,bodyBox.height-anchorBox.top-info.borderHeight-info.verticalPadding),maxSizeBottom=maxSizeTop.with(void 0,anchorBox.top+anchorBox.height-info.borderHeight-info.verticalPadding);return{top:defaultTop,left,fit:width-size.width,maxSizeTop,maxSizeBottom,minSize:defaultMinSize.with(Math.min(width,defaultMinSize.width))}}(),placements=[eastPlacement,function(){const width=anchorBox.left-info.borderWidth-info.horizontalPadding,left=Math.max(info.horizontalPadding,anchorBox.left-size.width-info.borderWidth),maxSizeTop=new dom.Dimension(width,bodyBox.height-anchorBox.top-info.borderHeight-info.verticalPadding),maxSizeBottom=maxSizeTop.with(void 0,anchorBox.top+anchorBox.height-info.borderHeight-info.verticalPadding);return{top:defaultTop,left,fit:width-size.width,maxSizeTop,maxSizeBottom,minSize:defaultMinSize.with(Math.min(width,defaultMinSize.width))}}(),function(){const left=anchorBox.left,top=-info.borderWidth+anchorBox.top+anchorBox.height,maxSizeBottom=new dom.Dimension(anchorBox.width-info.borderHeight,bodyBox.height-anchorBox.top-anchorBox.height-info.verticalPadding);return{top,left,fit:maxSizeBottom.height-size.height,maxSizeBottom,maxSizeTop:maxSizeBottom,minSize:defaultMinSize.with(maxSizeBottom.width)}}()],placement=null!==(_a=placements.find((p=>p.fit>=0)))&&void 0!==_a?_a:placements.sort(((a,b)=>b.fit-a.fit))[0],bottom=anchorBox.top+anchorBox.height-info.borderHeight;let alignAtTop,height=size.height;const maxHeight=Math.max(placement.maxSizeTop.height,placement.maxSizeBottom.height);let maxSize;height>maxHeight&&(height=maxHeight),preferAlignAtTop?height<=placement.maxSizeTop.height?(alignAtTop=!0,maxSize=placement.maxSizeTop):(alignAtTop=!1,maxSize=placement.maxSizeBottom):height<=placement.maxSizeBottom.height?(alignAtTop=!1,maxSize=placement.maxSizeBottom):(alignAtTop=!0,maxSize=placement.maxSizeTop),this._applyTopLeft({left:placement.left,top:alignAtTop?placement.top:bottom-height}),this.getDomNode().style.position="fixed",this._resizable.enableSashes(!alignAtTop,placement===eastPlacement,alignAtTop,placement!==eastPlacement),this._resizable.minSize=placement.minSize,this._resizable.maxSize=maxSize,this._resizable.layout(height,Math.min(maxSize.width,size.width)),this.widget.layout(this._resizable.size.width,this._resizable.size.height)}_applyTopLeft(topLeft){this._topLeft=topLeft,this.getDomNode().style.left=`${this._topLeft.left}px`,this.getDomNode().style.top=`${this._topLeft.top}px`}}