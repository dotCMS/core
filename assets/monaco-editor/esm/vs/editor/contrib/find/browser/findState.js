import{Emitter}from"../../../../base/common/event.js";import{Disposable}from"../../../../base/common/lifecycle.js";import{Range}from"../../../common/core/range.js";import{MATCHES_LIMIT}from"./findModel.js";function effectiveOptionValue(override,value){return 1===override||2!==override&&value}export class FindReplaceState extends Disposable{constructor(){super(),this._onFindReplaceStateChange=this._register(new Emitter),this.onFindReplaceStateChange=this._onFindReplaceStateChange.event,this._searchString="",this._replaceString="",this._isRevealed=!1,this._isReplaceRevealed=!1,this._isRegex=!1,this._isRegexOverride=0,this._wholeWord=!1,this._wholeWordOverride=0,this._matchCase=!1,this._matchCaseOverride=0,this._preserveCase=!1,this._preserveCaseOverride=0,this._searchScope=null,this._matchesPosition=0,this._matchesCount=0,this._currentMatch=null,this._loop=!0,this._isSearching=!1,this._filters=null}get searchString(){return this._searchString}get replaceString(){return this._replaceString}get isRevealed(){return this._isRevealed}get isReplaceRevealed(){return this._isReplaceRevealed}get isRegex(){return effectiveOptionValue(this._isRegexOverride,this._isRegex)}get wholeWord(){return effectiveOptionValue(this._wholeWordOverride,this._wholeWord)}get matchCase(){return effectiveOptionValue(this._matchCaseOverride,this._matchCase)}get preserveCase(){return effectiveOptionValue(this._preserveCaseOverride,this._preserveCase)}get actualIsRegex(){return this._isRegex}get actualWholeWord(){return this._wholeWord}get actualMatchCase(){return this._matchCase}get actualPreserveCase(){return this._preserveCase}get searchScope(){return this._searchScope}get matchesPosition(){return this._matchesPosition}get matchesCount(){return this._matchesCount}get currentMatch(){return this._currentMatch}changeMatchInfo(matchesPosition,matchesCount,currentMatch){let changeEvent={moveCursor:!1,updateHistory:!1,searchString:!1,replaceString:!1,isRevealed:!1,isReplaceRevealed:!1,isRegex:!1,wholeWord:!1,matchCase:!1,preserveCase:!1,searchScope:!1,matchesPosition:!1,matchesCount:!1,currentMatch:!1,loop:!1,isSearching:!1,filters:!1},somethingChanged=!1;0===matchesCount&&(matchesPosition=0),matchesPosition>matchesCount&&(matchesPosition=matchesCount),this._matchesPosition!==matchesPosition&&(this._matchesPosition=matchesPosition,changeEvent.matchesPosition=!0,somethingChanged=!0),this._matchesCount!==matchesCount&&(this._matchesCount=matchesCount,changeEvent.matchesCount=!0,somethingChanged=!0),void 0!==currentMatch&&(Range.equalsRange(this._currentMatch,currentMatch)||(this._currentMatch=currentMatch,changeEvent.currentMatch=!0,somethingChanged=!0)),somethingChanged&&this._onFindReplaceStateChange.fire(changeEvent)}change(newState,moveCursor,updateHistory=!0){var _a;let changeEvent={moveCursor,updateHistory,searchString:!1,replaceString:!1,isRevealed:!1,isReplaceRevealed:!1,isRegex:!1,wholeWord:!1,matchCase:!1,preserveCase:!1,searchScope:!1,matchesPosition:!1,matchesCount:!1,currentMatch:!1,loop:!1,isSearching:!1,filters:!1},somethingChanged=!1;const oldEffectiveIsRegex=this.isRegex,oldEffectiveWholeWords=this.wholeWord,oldEffectiveMatchCase=this.matchCase,oldEffectivePreserveCase=this.preserveCase;void 0!==newState.searchString&&this._searchString!==newState.searchString&&(this._searchString=newState.searchString,changeEvent.searchString=!0,somethingChanged=!0),void 0!==newState.replaceString&&this._replaceString!==newState.replaceString&&(this._replaceString=newState.replaceString,changeEvent.replaceString=!0,somethingChanged=!0),void 0!==newState.isRevealed&&this._isRevealed!==newState.isRevealed&&(this._isRevealed=newState.isRevealed,changeEvent.isRevealed=!0,somethingChanged=!0),void 0!==newState.isReplaceRevealed&&this._isReplaceRevealed!==newState.isReplaceRevealed&&(this._isReplaceRevealed=newState.isReplaceRevealed,changeEvent.isReplaceRevealed=!0,somethingChanged=!0),void 0!==newState.isRegex&&(this._isRegex=newState.isRegex),void 0!==newState.wholeWord&&(this._wholeWord=newState.wholeWord),void 0!==newState.matchCase&&(this._matchCase=newState.matchCase),void 0!==newState.preserveCase&&(this._preserveCase=newState.preserveCase),void 0!==newState.searchScope&&((null===(_a=newState.searchScope)||void 0===_a?void 0:_a.every((newSearchScope=>{var _a;return null===(_a=this._searchScope)||void 0===_a?void 0:_a.some((existingSearchScope=>!Range.equalsRange(existingSearchScope,newSearchScope)))})))||(this._searchScope=newState.searchScope,changeEvent.searchScope=!0,somethingChanged=!0)),void 0!==newState.loop&&this._loop!==newState.loop&&(this._loop=newState.loop,changeEvent.loop=!0,somethingChanged=!0),void 0!==newState.isSearching&&this._isSearching!==newState.isSearching&&(this._isSearching=newState.isSearching,changeEvent.isSearching=!0,somethingChanged=!0),void 0!==newState.filters&&(this._filters?this._filters.update(newState.filters):this._filters=newState.filters,changeEvent.filters=!0,somethingChanged=!0),this._isRegexOverride=void 0!==newState.isRegexOverride?newState.isRegexOverride:0,this._wholeWordOverride=void 0!==newState.wholeWordOverride?newState.wholeWordOverride:0,this._matchCaseOverride=void 0!==newState.matchCaseOverride?newState.matchCaseOverride:0,this._preserveCaseOverride=void 0!==newState.preserveCaseOverride?newState.preserveCaseOverride:0,oldEffectiveIsRegex!==this.isRegex&&(somethingChanged=!0,changeEvent.isRegex=!0),oldEffectiveWholeWords!==this.wholeWord&&(somethingChanged=!0,changeEvent.wholeWord=!0),oldEffectiveMatchCase!==this.matchCase&&(somethingChanged=!0,changeEvent.matchCase=!0),oldEffectivePreserveCase!==this.preserveCase&&(somethingChanged=!0,changeEvent.preserveCase=!0),somethingChanged&&this._onFindReplaceStateChange.fire(changeEvent)}canNavigateBack(){return this.canNavigateInLoop()||1!==this.matchesPosition}canNavigateForward(){return this.canNavigateInLoop()||this.matchesPosition<this.matchesCount}canNavigateInLoop(){return this._loop||this.matchesCount>=MATCHES_LIMIT}}