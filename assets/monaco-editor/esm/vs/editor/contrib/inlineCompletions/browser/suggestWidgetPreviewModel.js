var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{createCancelablePromise,RunOnceScheduler}from"../../../../base/common/async.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{MutableDisposable,toDisposable}from"../../../../base/common/lifecycle.js";import{InlineCompletionTriggerKind}from"../../../common/languages.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{BaseGhostTextWidgetModel,GhostText}from"./ghostText.js";import{minimizeInlineCompletion,provideInlineCompletions,UpdateOperation}from"./inlineCompletionsModel.js";import{inlineCompletionToGhostText}from"./inlineCompletionToGhostText.js";import{SuggestWidgetInlineCompletionProvider}from"./suggestWidgetInlineCompletionProvider.js";let SuggestWidgetPreviewModel=class SuggestWidgetPreviewModel extends BaseGhostTextWidgetModel{constructor(editor,cache,languageFeaturesService){super(editor),this.cache=cache,this.languageFeaturesService=languageFeaturesService,this.suggestionInlineCompletionSource=this._register(new SuggestWidgetInlineCompletionProvider(this.editor,(()=>{var _a,_b;return null===(_b=null===(_a=this.cache.value)||void 0===_a?void 0:_a.completions[0])||void 0===_b?void 0:_b.toLiveInlineCompletion()}))),this.updateOperation=this._register(new MutableDisposable),this.updateCacheSoon=this._register(new RunOnceScheduler((()=>this.updateCache()),50)),this.minReservedLineCount=0,this._register(this.suggestionInlineCompletionSource.onDidChange((()=>{this.updateCacheSoon.schedule();this.suggestionInlineCompletionSource.state||(this.minReservedLineCount=0);const newGhostText=this.ghostText;newGhostText&&(this.minReservedLineCount=Math.max(this.minReservedLineCount,sum(newGhostText.parts.map((p=>p.lines.length-1))))),this.minReservedLineCount>=1?this.suggestionInlineCompletionSource.forceRenderingAbove():this.suggestionInlineCompletionSource.stopForceRenderingAbove(),this.onDidChangeEmitter.fire()}))),this._register(this.cache.onDidChange((()=>{this.onDidChangeEmitter.fire()}))),this._register(this.editor.onDidChangeCursorPosition((e=>{this.minReservedLineCount=0,this.updateCacheSoon.schedule(),this.onDidChangeEmitter.fire()}))),this._register(toDisposable((()=>this.suggestionInlineCompletionSource.stopForceRenderingAbove())))}get isActive(){return void 0!==this.suggestionInlineCompletionSource.state}isSuggestionPreviewEnabled(){return this.editor.getOption(106).preview}updateCache(){return __awaiter(this,void 0,void 0,(function*(){const state=this.suggestionInlineCompletionSource.state;if(!state||!state.selectedItem)return;const info={text:state.selectedItem.normalizedInlineCompletion.text,range:state.selectedItem.normalizedInlineCompletion.range,isSnippetText:state.selectedItem.isSnippetText,completionKind:state.selectedItem.completionItemKind},position=this.editor.getPosition(),promise=createCancelablePromise((token=>__awaiter(this,void 0,void 0,(function*(){let result;try{result=yield provideInlineCompletions(this.languageFeaturesService.inlineCompletionsProvider,position,this.editor.getModel(),{triggerKind:InlineCompletionTriggerKind.Automatic,selectedSuggestionInfo:info},token)}catch(e){return void onUnexpectedError(e)}token.isCancellationRequested||(this.cache.setValue(this.editor,result,InlineCompletionTriggerKind.Automatic),this.onDidChangeEmitter.fire())})))),operation=new UpdateOperation(promise,InlineCompletionTriggerKind.Automatic);this.updateOperation.value=operation,yield promise,this.updateOperation.value===operation&&this.updateOperation.clear()}))}get ghostText(){var _a,_b,_c;const isSuggestionPreviewEnabled=this.isSuggestionPreviewEnabled(),augmentedCompletion=minimizeInlineCompletion(this.editor.getModel(),null===(_b=null===(_a=this.cache.value)||void 0===_a?void 0:_a.completions[0])||void 0===_b?void 0:_b.toLiveInlineCompletion()),suggestWidgetState=this.suggestionInlineCompletionSource.state,suggestInlineCompletion=minimizeInlineCompletion(this.editor.getModel(),null===(_c=null==suggestWidgetState?void 0:suggestWidgetState.selectedItem)||void 0===_c?void 0:_c.normalizedInlineCompletion),isAugmentedCompletionValid=augmentedCompletion&&suggestInlineCompletion&&augmentedCompletion.text.startsWith(suggestInlineCompletion.text)&&augmentedCompletion.range.equalsRange(suggestInlineCompletion.range);if(!isSuggestionPreviewEnabled&&!isAugmentedCompletionValid)return;const finalCompletion=isAugmentedCompletionValid?augmentedCompletion:suggestInlineCompletion||augmentedCompletion,inlineCompletionPreviewLength=isAugmentedCompletionValid?finalCompletion.text.length-suggestInlineCompletion.text.length:0;return this.toGhostText(finalCompletion,inlineCompletionPreviewLength)}toGhostText(completion,inlineCompletionPreviewLength){const mode=this.editor.getOptions().get(106).previewMode;return completion?inlineCompletionToGhostText(completion,this.editor.getModel(),mode,this.editor.getPosition(),inlineCompletionPreviewLength)||new GhostText(completion.range.endLineNumber,[],this.minReservedLineCount):void 0}};SuggestWidgetPreviewModel=__decorate([__param(2,ILanguageFeaturesService)],SuggestWidgetPreviewModel);export{SuggestWidgetPreviewModel};function sum(arr){return arr.reduce(((a,b)=>a+b),0)}