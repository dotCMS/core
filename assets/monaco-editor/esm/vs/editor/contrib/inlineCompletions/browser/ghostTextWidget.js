var _a,__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import*as dom from"../../../../base/browser/dom.js";import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import*as strings from"../../../../base/common/strings.js";import"./ghostText.css";import{applyFontInfo}from"../../../browser/config/domFontInfo.js";import{EditorFontLigatures}from"../../../common/config/editorOptions.js";import{LineTokens}from"../../../common/tokens/lineTokens.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{createStringBuilder}from"../../../common/core/stringBuilder.js";import{ILanguageService}from"../../../common/languages/language.js";import{ghostTextBackground,ghostTextBorder,ghostTextForeground}from"../../../common/core/editorColorRegistry.js";import{LineDecoration}from"../../../common/viewLayout/lineDecorations.js";import{RenderLineInput,renderViewLine}from"../../../common/viewLayout/viewLineRenderer.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";const ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("editorGhostText",{createHTML:value=>value});let GhostTextWidget=class GhostTextWidget extends Disposable{constructor(editor,model,instantiationService,languageService){super(),this.editor=editor,this.model=model,this.instantiationService=instantiationService,this.languageService=languageService,this.disposed=!1,this.partsWidget=this._register(this.instantiationService.createInstance(DecorationsWidget,this.editor)),this.additionalLinesWidget=this._register(new AdditionalLinesWidget(this.editor,this.languageService.languageIdCodec)),this.viewMoreContentWidget=void 0,this._register(this.editor.onDidChangeConfiguration((e=>{(e.hasChanged(29)||e.hasChanged(105)||e.hasChanged(88)||e.hasChanged(83)||e.hasChanged(45)||e.hasChanged(44)||e.hasChanged(59))&&this.update()}))),this._register(toDisposable((()=>{var _a;this.disposed=!0,this.update(),null===(_a=this.viewMoreContentWidget)||void 0===_a||_a.dispose(),this.viewMoreContentWidget=void 0}))),this._register(model.onDidChange((()=>{this.update()}))),this.update()}shouldShowHoverAtViewZone(viewZoneId){return this.additionalLinesWidget.viewZoneId===viewZoneId}update(){var _a;const ghostText=this.model.ghostText;if(!this.editor.hasModel()||!ghostText||this.disposed)return this.partsWidget.clear(),void this.additionalLinesWidget.clear();const inlineTexts=new Array,additionalLines=new Array;function addToAdditionalLines(lines,className){if(additionalLines.length>0){const lastLine=additionalLines[additionalLines.length-1];className&&lastLine.decorations.push(new LineDecoration(lastLine.content.length+1,lastLine.content.length+1+lines[0].length,className,0)),lastLine.content+=lines[0],lines=lines.slice(1)}for(const line of lines)additionalLines.push({content:line,decorations:className?[new LineDecoration(1,line.length+1,className,0)]:[]})}const textBufferLine=this.editor.getModel().getLineContent(ghostText.lineNumber);let hiddenTextStartColumn;this.editor.getModel().getLineTokens(ghostText.lineNumber);let lastIdx=0;for(const part of ghostText.parts){let lines=part.lines;void 0===hiddenTextStartColumn?(inlineTexts.push({column:part.column,text:lines[0],preview:part.preview}),lines=lines.slice(1)):addToAdditionalLines([textBufferLine.substring(lastIdx,part.column-1)],void 0),lines.length>0&&(addToAdditionalLines(lines,"ghost-text"),void 0===hiddenTextStartColumn&&part.column<=textBufferLine.length&&(hiddenTextStartColumn=part.column)),lastIdx=part.column-1}void 0!==hiddenTextStartColumn&&addToAdditionalLines([textBufferLine.substring(lastIdx)],void 0),this.partsWidget.setParts(ghostText.lineNumber,inlineTexts,void 0!==hiddenTextStartColumn?{column:hiddenTextStartColumn,length:textBufferLine.length+1-hiddenTextStartColumn}:void 0),this.additionalLinesWidget.updateLines(ghostText.lineNumber,additionalLines,ghostText.additionalReservedLineCount),ghostText.parts.some((p=>p.lines.length<0))?this.viewMoreContentWidget=this.renderViewMoreLines(new Position(ghostText.lineNumber,this.editor.getModel().getLineMaxColumn(ghostText.lineNumber)),"",0):(null===(_a=this.viewMoreContentWidget)||void 0===_a||_a.dispose(),this.viewMoreContentWidget=void 0)}renderViewMoreLines(position,firstLineText,remainingLinesLength){const fontInfo=this.editor.getOption(44),domNode=document.createElement("div");domNode.className="suggest-preview-additional-widget",applyFontInfo(domNode,fontInfo);const spacer=document.createElement("span");spacer.className="content-spacer",spacer.append(firstLineText),domNode.append(spacer);const newline=document.createElement("span");newline.className="content-newline suggest-preview-text",newline.append("⏎  "),domNode.append(newline);const disposableStore=new DisposableStore,button=document.createElement("div");return button.className="button suggest-preview-text",button.append(`+${remainingLinesLength} lines…`),disposableStore.add(dom.addStandardDisposableListener(button,"mousedown",(e=>{var _a;null===(_a=this.model)||void 0===_a||_a.setExpanded(!0),e.preventDefault(),this.editor.focus()}))),domNode.append(button),new ViewMoreLinesContentWidget(this.editor,position,domNode,disposableStore)}};GhostTextWidget=__decorate([__param(2,IInstantiationService),__param(3,ILanguageService)],GhostTextWidget);export{GhostTextWidget};class DecorationsWidget{constructor(editor){this.editor=editor,this.decorationIds=[],this.disposableStore=new DisposableStore}dispose(){this.clear(),this.disposableStore.dispose()}clear(){this.editor.deltaDecorations(this.decorationIds,[]),this.disposableStore.clear()}setParts(lineNumber,parts,hiddenText){this.disposableStore.clear();if(!this.editor.getModel())return;const hiddenTextDecorations=new Array;hiddenText&&hiddenTextDecorations.push({range:Range.fromPositions(new Position(lineNumber,hiddenText.column),new Position(lineNumber,hiddenText.column+hiddenText.length)),options:{inlineClassName:"ghost-text-hidden",description:"ghost-text-hidden"}}),this.decorationIds=this.editor.deltaDecorations(this.decorationIds,parts.map((p=>({range:Range.fromPositions(new Position(lineNumber,p.column)),options:{description:"ghost-text",after:{content:p.text,inlineClassName:p.preview?"ghost-text-decoration-preview":"ghost-text-decoration"},showIfCollapsed:!0}}))).concat(hiddenTextDecorations))}}class AdditionalLinesWidget{constructor(editor,languageIdCodec){this.editor=editor,this.languageIdCodec=languageIdCodec,this._viewZoneId=void 0}get viewZoneId(){return this._viewZoneId}dispose(){this.clear()}clear(){this.editor.changeViewZones((changeAccessor=>{this._viewZoneId&&(changeAccessor.removeZone(this._viewZoneId),this._viewZoneId=void 0)}))}updateLines(lineNumber,additionalLines,minReservedLineCount){const textModel=this.editor.getModel();if(!textModel)return;const{tabSize}=textModel.getOptions();this.editor.changeViewZones((changeAccessor=>{this._viewZoneId&&(changeAccessor.removeZone(this._viewZoneId),this._viewZoneId=void 0);const heightInLines=Math.max(additionalLines.length,minReservedLineCount);if(heightInLines>0){const domNode=document.createElement("div");renderLines(domNode,tabSize,additionalLines,this.editor.getOptions(),this.languageIdCodec),this._viewZoneId=changeAccessor.addZone({afterLineNumber:lineNumber,heightInLines,domNode,afterColumnAffinity:1})}}))}}function renderLines(domNode,tabSize,lines,opts,languageIdCodec){const disableMonospaceOptimizations=opts.get(29),stopRenderingLineAfter=opts.get(105),renderControlCharacters=opts.get(83),fontLigatures=opts.get(45),fontInfo=opts.get(44),lineHeight=opts.get(59),sb=createStringBuilder(1e4);sb.appendASCIIString('<div class="suggest-preview-text">');for(let i=0,len=lines.length;i<len;i++){const lineData=lines[i],line=lineData.content;sb.appendASCIIString('<div class="view-line'),sb.appendASCIIString('" style="top:'),sb.appendASCIIString(String(i*lineHeight)),sb.appendASCIIString('px;width:1000000px;">');const isBasicASCII=strings.isBasicASCII(line),containsRTL=strings.containsRTL(line),lineTokens=LineTokens.createEmpty(line,languageIdCodec);renderViewLine(new RenderLineInput(fontInfo.isMonospace&&!disableMonospaceOptimizations,fontInfo.canUseHalfwidthRightwardsArrow,line,!1,isBasicASCII,containsRTL,0,lineTokens,lineData.decorations,tabSize,0,fontInfo.spaceWidth,fontInfo.middotWidth,fontInfo.wsmiddotWidth,stopRenderingLineAfter,"none",renderControlCharacters,fontLigatures!==EditorFontLigatures.OFF,null),sb),sb.appendASCIIString("</div>")}sb.appendASCIIString("</div>"),applyFontInfo(domNode,fontInfo);const html=sb.build(),trustedhtml=ttPolicy?ttPolicy.createHTML(html):html;domNode.innerHTML=trustedhtml}class ViewMoreLinesContentWidget extends Disposable{constructor(editor,position,domNode,disposableStore){super(),this.editor=editor,this.position=position,this.domNode=domNode,this.allowEditorOverflow=!1,this.suppressMouseDown=!1,this._register(disposableStore),this._register(toDisposable((()=>{this.editor.removeContentWidget(this)}))),this.editor.addContentWidget(this)}getId(){return"editor.widget.viewMoreLinesWidget"}getDomNode(){return this.domNode}getPosition(){return{position:this.position,preference:[0]}}}registerThemingParticipant(((theme,collector)=>{const foreground=theme.getColor(ghostTextForeground);foreground&&(collector.addRule(`.monaco-editor .ghost-text-decoration { color: ${foreground.toString()} !important; }`),collector.addRule(`.monaco-editor .ghost-text-decoration-preview { color: ${foreground.toString()} !important; }`),collector.addRule(`.monaco-editor .suggest-preview-text .ghost-text { color: ${foreground.toString()} !important; }`));const background=theme.getColor(ghostTextBackground);background&&(collector.addRule(`.monaco-editor .ghost-text-decoration { background-color: ${background.toString()}; }`),collector.addRule(`.monaco-editor .ghost-text-decoration-preview { background-color: ${background.toString()}; }`),collector.addRule(`.monaco-editor .suggest-preview-text .ghost-text { background-color: ${background.toString()}; }`));const border=theme.getColor(ghostTextBorder);border&&(collector.addRule(`.monaco-editor .suggest-preview-text .ghost-text { border: 1px solid ${border}; }`),collector.addRule(`.monaco-editor .ghost-text-decoration { border: 1px solid ${border}; }`),collector.addRule(`.monaco-editor .ghost-text-decoration-preview { border: 1px solid ${border}; }`))}));