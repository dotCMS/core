import{Emitter}from"../../base/common/event.js";import{Disposable}from"../../base/common/lifecycle.js";export class ViewModelEventDispatcher extends Disposable{constructor(){super(),this._onEvent=this._register(new Emitter),this.onEvent=this._onEvent.event,this._eventHandlers=[],this._viewEventQueue=null,this._isConsumingViewEventQueue=!1,this._collector=null,this._collectorCnt=0,this._outgoingEvents=[]}emitOutgoingEvent(e){this._addOutgoingEvent(e),this._emitOutgoingEvents()}_addOutgoingEvent(e){for(let i=0,len=this._outgoingEvents.length;i<len;i++)if(this._outgoingEvents[i].kind===e.kind)return void(this._outgoingEvents[i]=this._outgoingEvents[i].merge(e));this._outgoingEvents.push(e)}_emitOutgoingEvents(){for(;this._outgoingEvents.length>0;){if(this._collector||this._isConsumingViewEventQueue)return;const event=this._outgoingEvents.shift();event.isNoOp()||this._onEvent.fire(event)}}addViewEventHandler(eventHandler){for(let i=0,len=this._eventHandlers.length;i<len;i++)this._eventHandlers[i]===eventHandler&&console.warn("Detected duplicate listener in ViewEventDispatcher",eventHandler);this._eventHandlers.push(eventHandler)}removeViewEventHandler(eventHandler){for(let i=0;i<this._eventHandlers.length;i++)if(this._eventHandlers[i]===eventHandler){this._eventHandlers.splice(i,1);break}}beginEmitViewEvents(){return this._collectorCnt++,1===this._collectorCnt&&(this._collector=new ViewModelEventsCollector),this._collector}endEmitViewEvents(){if(this._collectorCnt--,0===this._collectorCnt){const outgoingEvents=this._collector.outgoingEvents,viewEvents=this._collector.viewEvents;this._collector=null;for(const outgoingEvent of outgoingEvents)this._addOutgoingEvent(outgoingEvent);viewEvents.length>0&&this._emitMany(viewEvents)}this._emitOutgoingEvents()}emitSingleViewEvent(event){try{this.beginEmitViewEvents().emitViewEvent(event)}finally{this.endEmitViewEvents()}}_emitMany(events){this._viewEventQueue?this._viewEventQueue=this._viewEventQueue.concat(events):this._viewEventQueue=events,this._isConsumingViewEventQueue||this._consumeViewEventQueue()}_consumeViewEventQueue(){try{this._isConsumingViewEventQueue=!0,this._doConsumeQueue()}finally{this._isConsumingViewEventQueue=!1}}_doConsumeQueue(){for(;this._viewEventQueue;){const events=this._viewEventQueue;this._viewEventQueue=null;const eventHandlers=this._eventHandlers.slice(0);for(const eventHandler of eventHandlers)eventHandler.handleEvents(events)}}}export class ViewModelEventsCollector{constructor(){this.viewEvents=[],this.outgoingEvents=[]}emitViewEvent(event){this.viewEvents.push(event)}emitOutgoingEvent(e){this.outgoingEvents.push(e)}}export class ContentSizeChangedEvent{constructor(oldContentWidth,oldContentHeight,contentWidth,contentHeight){this.kind=0,this._oldContentWidth=oldContentWidth,this._oldContentHeight=oldContentHeight,this.contentWidth=contentWidth,this.contentHeight=contentHeight,this.contentWidthChanged=this._oldContentWidth!==this.contentWidth,this.contentHeightChanged=this._oldContentHeight!==this.contentHeight}isNoOp(){return!this.contentWidthChanged&&!this.contentHeightChanged}merge(other){return 0!==other.kind?this:new ContentSizeChangedEvent(this._oldContentWidth,this._oldContentHeight,other.contentWidth,other.contentHeight)}}export class FocusChangedEvent{constructor(oldHasFocus,hasFocus){this.kind=1,this.oldHasFocus=oldHasFocus,this.hasFocus=hasFocus}isNoOp(){return this.oldHasFocus===this.hasFocus}merge(other){return 1!==other.kind?this:new FocusChangedEvent(this.oldHasFocus,other.hasFocus)}}export class ScrollChangedEvent{constructor(oldScrollWidth,oldScrollLeft,oldScrollHeight,oldScrollTop,scrollWidth,scrollLeft,scrollHeight,scrollTop){this.kind=2,this._oldScrollWidth=oldScrollWidth,this._oldScrollLeft=oldScrollLeft,this._oldScrollHeight=oldScrollHeight,this._oldScrollTop=oldScrollTop,this.scrollWidth=scrollWidth,this.scrollLeft=scrollLeft,this.scrollHeight=scrollHeight,this.scrollTop=scrollTop,this.scrollWidthChanged=this._oldScrollWidth!==this.scrollWidth,this.scrollLeftChanged=this._oldScrollLeft!==this.scrollLeft,this.scrollHeightChanged=this._oldScrollHeight!==this.scrollHeight,this.scrollTopChanged=this._oldScrollTop!==this.scrollTop}isNoOp(){return!(this.scrollWidthChanged||this.scrollLeftChanged||this.scrollHeightChanged||this.scrollTopChanged)}merge(other){return 2!==other.kind?this:new ScrollChangedEvent(this._oldScrollWidth,this._oldScrollLeft,this._oldScrollHeight,this._oldScrollTop,other.scrollWidth,other.scrollLeft,other.scrollHeight,other.scrollTop)}}export class ViewZonesChangedEvent{constructor(){this.kind=3}isNoOp(){return!1}merge(other){return this}}export class HiddenAreasChangedEvent{constructor(){this.kind=4}isNoOp(){return!1}merge(other){return this}}export class CursorStateChangedEvent{constructor(oldSelections,selections,oldModelVersionId,modelVersionId,source,reason,reachedMaxCursorCount){this.kind=6,this.oldSelections=oldSelections,this.selections=selections,this.oldModelVersionId=oldModelVersionId,this.modelVersionId=modelVersionId,this.source=source,this.reason=reason,this.reachedMaxCursorCount=reachedMaxCursorCount}static _selectionsAreEqual(a,b){if(!a&&!b)return!0;if(!a||!b)return!1;const aLen=a.length;if(aLen!==b.length)return!1;for(let i=0;i<aLen;i++)if(!a[i].equalsSelection(b[i]))return!1;return!0}isNoOp(){return CursorStateChangedEvent._selectionsAreEqual(this.oldSelections,this.selections)&&this.oldModelVersionId===this.modelVersionId}merge(other){return 6!==other.kind?this:new CursorStateChangedEvent(this.oldSelections,other.selections,this.oldModelVersionId,other.modelVersionId,other.source,other.reason,this.reachedMaxCursorCount||other.reachedMaxCursorCount)}}export class ReadOnlyEditAttemptEvent{constructor(){this.kind=5}isNoOp(){return!1}merge(other){return this}}