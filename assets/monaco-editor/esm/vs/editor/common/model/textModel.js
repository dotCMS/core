var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import{ArrayQueue}from"../../../base/common/arrays.js";import{Color}from"../../../base/common/color.js";import{onUnexpectedError}from"../../../base/common/errors.js";import{Emitter}from"../../../base/common/event.js";import{combinedDisposable,Disposable}from"../../../base/common/lifecycle.js";import*as strings from"../../../base/common/strings.js";import{URI}from"../../../base/common/uri.js";import{Position}from"../core/position.js";import{Range}from"../core/range.js";import{Selection}from"../core/selection.js";import*as model from"../model.js";import{BracketPairsTextModelPart}from"./bracketPairsTextModelPart/bracketPairsImpl.js";import{ColorizedBracketPairsDecorationProvider}from"./bracketPairsTextModelPart/colorizedBracketPairsDecorationProvider.js";import{EditStack}from"./editStack.js";import{GuidesTextModelPart}from"./guidesTextModelPart.js";import{guessIndentation}from"./indentationGuesser.js";import{IntervalNode,IntervalTree,recomputeMaxEnd}from"./intervalTree.js";import{PieceTreeTextBuffer}from"./pieceTreeTextBuffer/pieceTreeTextBuffer.js";import{PieceTreeTextBufferBuilder}from"./pieceTreeTextBuffer/pieceTreeTextBufferBuilder.js";import{InternalModelContentChangeEvent,LineInjectedText,ModelInjectedTextChangedEvent,ModelRawContentChangedEvent,ModelRawEOLChanged,ModelRawFlush,ModelRawLineChanged,ModelRawLinesDeleted,ModelRawLinesInserted}from"../textModelEvents.js";import{SearchParams,TextModelSearch}from"./textModelSearch.js";import{TextModelTokenization}from"./textModelTokens.js";import{countEOL}from"../core/eolCounter.js";import{ContiguousTokensStore}from"../tokens/contiguousTokensStore.js";import{SparseTokensStore}from"../tokens/sparseTokensStore.js";import{getWordAtText}from"../core/wordHelper.js";import{ILanguageConfigurationService}from"../languages/languageConfigurationRegistry.js";import{ILanguageService}from"../languages/language.js";import{IUndoRedoService}from"../../../platform/undoRedo/common/undoRedo.js";import{EDITOR_MODEL_DEFAULTS}from"../core/textModelDefaults.js";import{normalizeIndentation}from"../core/indentation.js";function createTextBufferBuilder(){return new PieceTreeTextBufferBuilder}export function createTextBufferFactory(text){const builder=createTextBufferBuilder();return builder.acceptChunk(text),builder.finish()}export function createTextBuffer(value,defaultEOL){return("string"==typeof value?createTextBufferFactory(value):value).create(defaultEOL)}let MODEL_ID=0;const LIMIT_FIND_COUNT=999;export const LONG_LINE_BOUNDARY=1e4;class TextModelSnapshot{constructor(source){this._source=source,this._eos=!1}read(){if(this._eos)return null;const result=[];let resultCnt=0,resultLength=0;for(;;){const tmp=this._source.read();if(null===tmp)return this._eos=!0,0===resultCnt?null:result.join("");if(tmp.length>0&&(result[resultCnt++]=tmp,resultLength+=tmp.length),resultLength>=65536)return result.join("")}}}const invalidFunc=()=>{throw new Error("Invalid change accessor")};let TextModel=class TextModel extends Disposable{constructor(source,languageId,creationOptions,associatedResource=null,_undoRedoService,_languageService,_languageConfigurationService){super(),this._undoRedoService=_undoRedoService,this._languageService=_languageService,this._languageConfigurationService=_languageConfigurationService,this._onWillDispose=this._register(new Emitter),this.onWillDispose=this._onWillDispose.event,this._onDidChangeDecorations=this._register(new DidChangeDecorationsEmitter((affectedInjectedTextLines=>this.handleBeforeFireDecorationsChangedEvent(affectedInjectedTextLines)))),this.onDidChangeDecorations=this._onDidChangeDecorations.event,this._onDidChangeLanguage=this._register(new Emitter),this.onDidChangeLanguage=this._onDidChangeLanguage.event,this._onDidChangeLanguageConfiguration=this._register(new Emitter),this.onDidChangeLanguageConfiguration=this._onDidChangeLanguageConfiguration.event,this._onDidChangeTokens=this._register(new Emitter),this.onDidChangeTokens=this._onDidChangeTokens.event,this._onDidChangeOptions=this._register(new Emitter),this.onDidChangeOptions=this._onDidChangeOptions.event,this._onDidChangeAttached=this._register(new Emitter),this.onDidChangeAttached=this._onDidChangeAttached.event,this._onDidChangeInjectedText=this._register(new Emitter),this._eventEmitter=this._register(new DidChangeContentEmitter),this._backgroundTokenizationState=0,this._onBackgroundTokenizationStateChanged=this._register(new Emitter),MODEL_ID++,this.id="$model"+MODEL_ID,this.isForSimpleWidget=creationOptions.isForSimpleWidget,this._associatedResource=null==associatedResource?URI.parse("inmemory://model/"+MODEL_ID):associatedResource,this._attachedEditorCount=0;const{textBuffer,disposable}=createTextBuffer(source,creationOptions.defaultEOL);this._buffer=textBuffer,this._bufferDisposable=disposable,this._options=TextModel.resolveOptions(this._buffer,creationOptions);const bufferLineCount=this._buffer.getLineCount(),bufferTextLength=this._buffer.getValueLengthInRange(new Range(1,1,bufferLineCount,this._buffer.getLineLength(bufferLineCount)+1),0);creationOptions.largeFileOptimizations?this._isTooLargeForTokenization=bufferTextLength>TextModel.LARGE_FILE_SIZE_THRESHOLD||bufferLineCount>TextModel.LARGE_FILE_LINE_COUNT_THRESHOLD:this._isTooLargeForTokenization=!1,this._isTooLargeForSyncing=bufferTextLength>TextModel.MODEL_SYNC_LIMIT,this._versionId=1,this._alternativeVersionId=1,this._initialUndoRedoSnapshot=null,this._isDisposed=!1,this._isDisposing=!1,this._languageId=languageId,this._languageRegistryListener=this._languageConfigurationService.onDidChange((e=>{e.affects(this._languageId)&&this._onDidChangeLanguageConfiguration.fire({})})),this._instanceId=strings.singleLetterHash(MODEL_ID),this._lastDecorationId=0,this._decorations=Object.create(null),this._decorationsTree=new DecorationsTrees,this._commandManager=new EditStack(this,this._undoRedoService),this._isUndoing=!1,this._isRedoing=!1,this._trimAutoWhitespaceLines=null,this._tokens=new ContiguousTokensStore(this._languageService.languageIdCodec),this._semanticTokens=new SparseTokensStore(this._languageService.languageIdCodec),this._tokenization=new TextModelTokenization(this,this._languageService.languageIdCodec),this._bracketPairColorizer=this._register(new BracketPairsTextModelPart(this,this._languageConfigurationService)),this._guidesTextModelPart=this._register(new GuidesTextModelPart(this,this._languageConfigurationService)),this._decorationProvider=this._register(new ColorizedBracketPairsDecorationProvider(this)),this._register(this._decorationProvider.onDidChange((()=>{this._onDidChangeDecorations.beginDeferredEmit(),this._onDidChangeDecorations.fire(),this._onDidChangeDecorations.endDeferredEmit()})))}static resolveOptions(textBuffer,options){if(options.detectIndentation){const guessedIndentation=guessIndentation(textBuffer,options.tabSize,options.insertSpaces);return new model.TextModelResolvedOptions({tabSize:guessedIndentation.tabSize,indentSize:guessedIndentation.tabSize,insertSpaces:guessedIndentation.insertSpaces,trimAutoWhitespace:options.trimAutoWhitespace,defaultEOL:options.defaultEOL,bracketPairColorizationOptions:options.bracketPairColorizationOptions})}return new model.TextModelResolvedOptions({tabSize:options.tabSize,indentSize:options.indentSize,insertSpaces:options.insertSpaces,trimAutoWhitespace:options.trimAutoWhitespace,defaultEOL:options.defaultEOL,bracketPairColorizationOptions:options.bracketPairColorizationOptions})}onDidChangeContent(listener){return this._eventEmitter.slowEvent((e=>listener(e.contentChangedEvent)))}onDidChangeContentOrInjectedText(listener){return combinedDisposable(this._eventEmitter.fastEvent((e=>listener(e.rawContentChangedEvent))),this._onDidChangeInjectedText.event((e=>listener(e))))}get bracketPairs(){return this._bracketPairColorizer}get guides(){return this._guidesTextModelPart}get backgroundTokenizationState(){return this._backgroundTokenizationState}handleTokenizationProgress(completed){if(2===this._backgroundTokenizationState)return;const newState=completed?2:1;this._backgroundTokenizationState!==newState&&(this._backgroundTokenizationState=newState,this._bracketPairColorizer.handleDidChangeBackgroundTokenizationState(),this._onBackgroundTokenizationStateChanged.fire())}dispose(){this._isDisposing=!0,this._onWillDispose.fire(),this._languageRegistryListener.dispose(),this._tokenization.dispose(),this._isDisposed=!0,super.dispose(),this._bufferDisposable.dispose(),this._isDisposing=!1;const emptyDisposedTextBuffer=new PieceTreeTextBuffer([],"","\n",!1,!1,!0,!0);emptyDisposedTextBuffer.dispose(),this._buffer=emptyDisposedTextBuffer,this._bufferDisposable=Disposable.None}_assertNotDisposed(){if(this._isDisposed)throw new Error("Model is disposed!")}_emitContentChangedEvent(rawChange,change){this._isDisposing||(this._bracketPairColorizer.handleDidChangeContent(change),this._tokenization.handleDidChangeContent(change),this._eventEmitter.fire(new InternalModelContentChangeEvent(rawChange,change)))}setValue(value){if(this._assertNotDisposed(),null===value)return;const{textBuffer,disposable}=createTextBuffer(value,this._options.defaultEOL);this._setValueFromTextBuffer(textBuffer,disposable)}_createContentChanged2(range,rangeOffset,rangeLength,text,isUndoing,isRedoing,isFlush){return{changes:[{range,rangeOffset,rangeLength,text}],eol:this._buffer.getEOL(),versionId:this.getVersionId(),isUndoing,isRedoing,isFlush}}_setValueFromTextBuffer(textBuffer,textBufferDisposable){this._assertNotDisposed();const oldFullModelRange=this.getFullModelRange(),oldModelValueLength=this.getValueLengthInRange(oldFullModelRange),endLineNumber=this.getLineCount(),endColumn=this.getLineMaxColumn(endLineNumber);this._buffer=textBuffer,this._bufferDisposable.dispose(),this._bufferDisposable=textBufferDisposable,this._increaseVersionId(),this._tokens.flush(),this._semanticTokens.flush(),this._decorations=Object.create(null),this._decorationsTree=new DecorationsTrees,this._commandManager.clear(),this._trimAutoWhitespaceLines=null,this._emitContentChangedEvent(new ModelRawContentChangedEvent([new ModelRawFlush],this._versionId,!1,!1),this._createContentChanged2(new Range(1,1,endLineNumber,endColumn),0,oldModelValueLength,this.getValue(),!1,!1,!0))}setEOL(eol){this._assertNotDisposed();const newEOL=1===eol?"\r\n":"\n";if(this._buffer.getEOL()===newEOL)return;const oldFullModelRange=this.getFullModelRange(),oldModelValueLength=this.getValueLengthInRange(oldFullModelRange),endLineNumber=this.getLineCount(),endColumn=this.getLineMaxColumn(endLineNumber);this._onBeforeEOLChange(),this._buffer.setEOL(newEOL),this._increaseVersionId(),this._onAfterEOLChange(),this._emitContentChangedEvent(new ModelRawContentChangedEvent([new ModelRawEOLChanged],this._versionId,!1,!1),this._createContentChanged2(new Range(1,1,endLineNumber,endColumn),0,oldModelValueLength,this.getValue(),!1,!1,!1))}_onBeforeEOLChange(){this._decorationsTree.ensureAllNodesHaveRanges(this)}_onAfterEOLChange(){const versionId=this.getVersionId(),allDecorations=this._decorationsTree.collectNodesPostOrder();for(let i=0,len=allDecorations.length;i<len;i++){const node=allDecorations[i],range=node.range,delta=node.cachedAbsoluteStart-node.start,startOffset=this._buffer.getOffsetAt(range.startLineNumber,range.startColumn),endOffset=this._buffer.getOffsetAt(range.endLineNumber,range.endColumn);node.cachedAbsoluteStart=startOffset,node.cachedAbsoluteEnd=endOffset,node.cachedVersionId=versionId,node.start=startOffset-delta,node.end=endOffset-delta,recomputeMaxEnd(node)}}onBeforeAttached(){this._attachedEditorCount++,1===this._attachedEditorCount&&(this._tokenization.handleDidChangeAttached(),this._onDidChangeAttached.fire(void 0))}onBeforeDetached(){this._attachedEditorCount--,0===this._attachedEditorCount&&(this._tokenization.handleDidChangeAttached(),this._onDidChangeAttached.fire(void 0))}isAttachedToEditor(){return this._attachedEditorCount>0}getAttachedEditorCount(){return this._attachedEditorCount}isTooLargeForSyncing(){return this._isTooLargeForSyncing}isTooLargeForTokenization(){return this._isTooLargeForTokenization}isDisposed(){return this._isDisposed}isDominatedByLongLines(){if(this._assertNotDisposed(),this.isTooLargeForTokenization())return!1;let smallLineCharCount=0,longLineCharCount=0;const lineCount=this._buffer.getLineCount();for(let lineNumber=1;lineNumber<=lineCount;lineNumber++){const lineLength=this._buffer.getLineLength(lineNumber);lineLength>=1e4?longLineCharCount+=lineLength:smallLineCharCount+=lineLength}return longLineCharCount>smallLineCharCount}get uri(){return this._associatedResource}getOptions(){return this._assertNotDisposed(),this._options}getFormattingOptions(){return{tabSize:this._options.indentSize,insertSpaces:this._options.insertSpaces}}updateOptions(_newOpts){this._assertNotDisposed();const tabSize=void 0!==_newOpts.tabSize?_newOpts.tabSize:this._options.tabSize,indentSize=void 0!==_newOpts.indentSize?_newOpts.indentSize:this._options.indentSize,insertSpaces=void 0!==_newOpts.insertSpaces?_newOpts.insertSpaces:this._options.insertSpaces,trimAutoWhitespace=void 0!==_newOpts.trimAutoWhitespace?_newOpts.trimAutoWhitespace:this._options.trimAutoWhitespace,bracketPairColorizationOptions=void 0!==_newOpts.bracketColorizationOptions?_newOpts.bracketColorizationOptions:this._options.bracketPairColorizationOptions,newOpts=new model.TextModelResolvedOptions({tabSize,indentSize,insertSpaces,defaultEOL:this._options.defaultEOL,trimAutoWhitespace,bracketPairColorizationOptions});if(this._options.equals(newOpts))return;const e=this._options.createChangeEvent(newOpts);this._options=newOpts,this._bracketPairColorizer.handleDidChangeOptions(e),this._decorationProvider.handleDidChangeOptions(e),this._onDidChangeOptions.fire(e)}detectIndentation(defaultInsertSpaces,defaultTabSize){this._assertNotDisposed();const guessedIndentation=guessIndentation(this._buffer,defaultTabSize,defaultInsertSpaces);this.updateOptions({insertSpaces:guessedIndentation.insertSpaces,tabSize:guessedIndentation.tabSize,indentSize:guessedIndentation.tabSize})}normalizeIndentation(str){return this._assertNotDisposed(),normalizeIndentation(str,this._options.indentSize,this._options.insertSpaces)}getVersionId(){return this._assertNotDisposed(),this._versionId}mightContainRTL(){return this._buffer.mightContainRTL()}mightContainUnusualLineTerminators(){return this._buffer.mightContainUnusualLineTerminators()}removeUnusualLineTerminators(selections=null){const matches=this.findMatches(strings.UNUSUAL_LINE_TERMINATORS.source,!1,!0,!1,null,!1,1073741824);this._buffer.resetMightContainUnusualLineTerminators(),this.pushEditOperations(selections,matches.map((m=>({range:m.range,text:null}))),(()=>null))}mightContainNonBasicASCII(){return this._buffer.mightContainNonBasicASCII()}getAlternativeVersionId(){return this._assertNotDisposed(),this._alternativeVersionId}getInitialUndoRedoSnapshot(){return this._assertNotDisposed(),this._initialUndoRedoSnapshot}getOffsetAt(rawPosition){this._assertNotDisposed();const position=this._validatePosition(rawPosition.lineNumber,rawPosition.column,0);return this._buffer.getOffsetAt(position.lineNumber,position.column)}getPositionAt(rawOffset){this._assertNotDisposed();const offset=Math.min(this._buffer.getLength(),Math.max(0,rawOffset));return this._buffer.getPositionAt(offset)}_increaseVersionId(){this._versionId=this._versionId+1,this._alternativeVersionId=this._versionId}_overwriteVersionId(versionId){this._versionId=versionId}_overwriteAlternativeVersionId(newAlternativeVersionId){this._alternativeVersionId=newAlternativeVersionId}_overwriteInitialUndoRedoSnapshot(newInitialUndoRedoSnapshot){this._initialUndoRedoSnapshot=newInitialUndoRedoSnapshot}getValue(eol,preserveBOM=!1){this._assertNotDisposed();const fullModelRange=this.getFullModelRange(),fullModelValue=this.getValueInRange(fullModelRange,eol);return preserveBOM?this._buffer.getBOM()+fullModelValue:fullModelValue}createSnapshot(preserveBOM=!1){return new TextModelSnapshot(this._buffer.createSnapshot(preserveBOM))}getValueLength(eol,preserveBOM=!1){this._assertNotDisposed();const fullModelRange=this.getFullModelRange(),fullModelValue=this.getValueLengthInRange(fullModelRange,eol);return preserveBOM?this._buffer.getBOM().length+fullModelValue:fullModelValue}getValueInRange(rawRange,eol=0){return this._assertNotDisposed(),this._buffer.getValueInRange(this.validateRange(rawRange),eol)}getValueLengthInRange(rawRange,eol=0){return this._assertNotDisposed(),this._buffer.getValueLengthInRange(this.validateRange(rawRange),eol)}getCharacterCountInRange(rawRange,eol=0){return this._assertNotDisposed(),this._buffer.getCharacterCountInRange(this.validateRange(rawRange),eol)}getLineCount(){return this._assertNotDisposed(),this._buffer.getLineCount()}getLineContent(lineNumber){if(this._assertNotDisposed(),lineNumber<1||lineNumber>this.getLineCount())throw new Error("Illegal value for lineNumber");return this._buffer.getLineContent(lineNumber)}getLineLength(lineNumber){if(this._assertNotDisposed(),lineNumber<1||lineNumber>this.getLineCount())throw new Error("Illegal value for lineNumber");return this._buffer.getLineLength(lineNumber)}getLinesContent(){return this._assertNotDisposed(),this._buffer.getLinesContent()}getEOL(){return this._assertNotDisposed(),this._buffer.getEOL()}getEndOfLineSequence(){return this._assertNotDisposed(),"\n"===this._buffer.getEOL()?0:1}getLineMinColumn(lineNumber){return this._assertNotDisposed(),1}getLineMaxColumn(lineNumber){if(this._assertNotDisposed(),lineNumber<1||lineNumber>this.getLineCount())throw new Error("Illegal value for lineNumber");return this._buffer.getLineLength(lineNumber)+1}getLineFirstNonWhitespaceColumn(lineNumber){if(this._assertNotDisposed(),lineNumber<1||lineNumber>this.getLineCount())throw new Error("Illegal value for lineNumber");return this._buffer.getLineFirstNonWhitespaceColumn(lineNumber)}getLineLastNonWhitespaceColumn(lineNumber){if(this._assertNotDisposed(),lineNumber<1||lineNumber>this.getLineCount())throw new Error("Illegal value for lineNumber");return this._buffer.getLineLastNonWhitespaceColumn(lineNumber)}_validateRangeRelaxedNoAllocations(range){const linesCount=this._buffer.getLineCount(),initialStartLineNumber=range.startLineNumber,initialStartColumn=range.startColumn;let startLineNumber=Math.floor("number"!=typeof initialStartLineNumber||isNaN(initialStartLineNumber)?1:initialStartLineNumber),startColumn=Math.floor("number"!=typeof initialStartColumn||isNaN(initialStartColumn)?1:initialStartColumn);if(startLineNumber<1)startLineNumber=1,startColumn=1;else if(startLineNumber>linesCount)startLineNumber=linesCount,startColumn=this.getLineMaxColumn(startLineNumber);else if(startColumn<=1)startColumn=1;else{const maxColumn=this.getLineMaxColumn(startLineNumber);startColumn>=maxColumn&&(startColumn=maxColumn)}const initialEndLineNumber=range.endLineNumber,initialEndColumn=range.endColumn;let endLineNumber=Math.floor("number"!=typeof initialEndLineNumber||isNaN(initialEndLineNumber)?1:initialEndLineNumber),endColumn=Math.floor("number"!=typeof initialEndColumn||isNaN(initialEndColumn)?1:initialEndColumn);if(endLineNumber<1)endLineNumber=1,endColumn=1;else if(endLineNumber>linesCount)endLineNumber=linesCount,endColumn=this.getLineMaxColumn(endLineNumber);else if(endColumn<=1)endColumn=1;else{const maxColumn=this.getLineMaxColumn(endLineNumber);endColumn>=maxColumn&&(endColumn=maxColumn)}return initialStartLineNumber===startLineNumber&&initialStartColumn===startColumn&&initialEndLineNumber===endLineNumber&&initialEndColumn===endColumn&&range instanceof Range&&!(range instanceof Selection)?range:new Range(startLineNumber,startColumn,endLineNumber,endColumn)}_isValidPosition(lineNumber,column,validationType){if("number"!=typeof lineNumber||"number"!=typeof column)return!1;if(isNaN(lineNumber)||isNaN(column))return!1;if(lineNumber<1||column<1)return!1;if((0|lineNumber)!==lineNumber||(0|column)!==column)return!1;if(lineNumber>this._buffer.getLineCount())return!1;if(1===column)return!0;if(column>this.getLineMaxColumn(lineNumber))return!1;if(1===validationType){const charCodeBefore=this._buffer.getLineCharCode(lineNumber,column-2);if(strings.isHighSurrogate(charCodeBefore))return!1}return!0}_validatePosition(_lineNumber,_column,validationType){const lineNumber=Math.floor("number"!=typeof _lineNumber||isNaN(_lineNumber)?1:_lineNumber),column=Math.floor("number"!=typeof _column||isNaN(_column)?1:_column),lineCount=this._buffer.getLineCount();if(lineNumber<1)return new Position(1,1);if(lineNumber>lineCount)return new Position(lineCount,this.getLineMaxColumn(lineCount));if(column<=1)return new Position(lineNumber,1);const maxColumn=this.getLineMaxColumn(lineNumber);if(column>=maxColumn)return new Position(lineNumber,maxColumn);if(1===validationType){const charCodeBefore=this._buffer.getLineCharCode(lineNumber,column-2);if(strings.isHighSurrogate(charCodeBefore))return new Position(lineNumber,column-1)}return new Position(lineNumber,column)}validatePosition(position){return this._assertNotDisposed(),position instanceof Position&&this._isValidPosition(position.lineNumber,position.column,1)?position:this._validatePosition(position.lineNumber,position.column,1)}_isValidRange(range,validationType){const startLineNumber=range.startLineNumber,startColumn=range.startColumn,endLineNumber=range.endLineNumber,endColumn=range.endColumn;if(!this._isValidPosition(startLineNumber,startColumn,0))return!1;if(!this._isValidPosition(endLineNumber,endColumn,0))return!1;if(1===validationType){const charCodeBeforeStart=startColumn>1?this._buffer.getLineCharCode(startLineNumber,startColumn-2):0,charCodeBeforeEnd=endColumn>1&&endColumn<=this._buffer.getLineLength(endLineNumber)?this._buffer.getLineCharCode(endLineNumber,endColumn-2):0,startInsideSurrogatePair=strings.isHighSurrogate(charCodeBeforeStart),endInsideSurrogatePair=strings.isHighSurrogate(charCodeBeforeEnd);return!startInsideSurrogatePair&&!endInsideSurrogatePair}return!0}validateRange(_range){if(this._assertNotDisposed(),_range instanceof Range&&!(_range instanceof Selection)&&this._isValidRange(_range,1))return _range;const start=this._validatePosition(_range.startLineNumber,_range.startColumn,0),end=this._validatePosition(_range.endLineNumber,_range.endColumn,0),startLineNumber=start.lineNumber,startColumn=start.column,endLineNumber=end.lineNumber,endColumn=end.column;{const charCodeBeforeStart=startColumn>1?this._buffer.getLineCharCode(startLineNumber,startColumn-2):0,charCodeBeforeEnd=endColumn>1&&endColumn<=this._buffer.getLineLength(endLineNumber)?this._buffer.getLineCharCode(endLineNumber,endColumn-2):0,startInsideSurrogatePair=strings.isHighSurrogate(charCodeBeforeStart),endInsideSurrogatePair=strings.isHighSurrogate(charCodeBeforeEnd);return startInsideSurrogatePair||endInsideSurrogatePair?startLineNumber===endLineNumber&&startColumn===endColumn?new Range(startLineNumber,startColumn-1,endLineNumber,endColumn-1):startInsideSurrogatePair&&endInsideSurrogatePair?new Range(startLineNumber,startColumn-1,endLineNumber,endColumn+1):startInsideSurrogatePair?new Range(startLineNumber,startColumn-1,endLineNumber,endColumn):new Range(startLineNumber,startColumn,endLineNumber,endColumn+1):new Range(startLineNumber,startColumn,endLineNumber,endColumn)}}modifyPosition(rawPosition,offset){this._assertNotDisposed();const candidate=this.getOffsetAt(rawPosition)+offset;return this.getPositionAt(Math.min(this._buffer.getLength(),Math.max(0,candidate)))}getFullModelRange(){this._assertNotDisposed();const lineCount=this.getLineCount();return new Range(1,1,lineCount,this.getLineMaxColumn(lineCount))}findMatchesLineByLine(searchRange,searchData,captureMatches,limitResultCount){return this._buffer.findMatchesLineByLine(searchRange,searchData,captureMatches,limitResultCount)}findMatches(searchString,rawSearchScope,isRegex,matchCase,wordSeparators,captureMatches,limitResultCount=999){this._assertNotDisposed();let searchRanges=null;null!==rawSearchScope&&(Array.isArray(rawSearchScope)||(rawSearchScope=[rawSearchScope]),rawSearchScope.every((searchScope=>Range.isIRange(searchScope)))&&(searchRanges=rawSearchScope.map((searchScope=>this.validateRange(searchScope))))),null===searchRanges&&(searchRanges=[this.getFullModelRange()]),searchRanges=searchRanges.sort(((d1,d2)=>d1.startLineNumber-d2.startLineNumber||d1.startColumn-d2.startColumn));const uniqueSearchRanges=[];let matchMapper;if(uniqueSearchRanges.push(searchRanges.reduce(((prev,curr)=>Range.areIntersecting(prev,curr)?prev.plusRange(curr):(uniqueSearchRanges.push(prev),curr)))),!isRegex&&searchString.indexOf("\n")<0){const searchData=new SearchParams(searchString,isRegex,matchCase,wordSeparators).parseSearchRequest();if(!searchData)return[];matchMapper=searchRange=>this.findMatchesLineByLine(searchRange,searchData,captureMatches,limitResultCount)}else matchMapper=searchRange=>TextModelSearch.findMatches(this,new SearchParams(searchString,isRegex,matchCase,wordSeparators),searchRange,captureMatches,limitResultCount);return uniqueSearchRanges.map(matchMapper).reduce(((arr,matches)=>arr.concat(matches)),[])}findNextMatch(searchString,rawSearchStart,isRegex,matchCase,wordSeparators,captureMatches){this._assertNotDisposed();const searchStart=this.validatePosition(rawSearchStart);if(!isRegex&&searchString.indexOf("\n")<0){const searchData=new SearchParams(searchString,isRegex,matchCase,wordSeparators).parseSearchRequest();if(!searchData)return null;const lineCount=this.getLineCount();let searchRange=new Range(searchStart.lineNumber,searchStart.column,lineCount,this.getLineMaxColumn(lineCount)),ret=this.findMatchesLineByLine(searchRange,searchData,captureMatches,1);return TextModelSearch.findNextMatch(this,new SearchParams(searchString,isRegex,matchCase,wordSeparators),searchStart,captureMatches),ret.length>0?ret[0]:(searchRange=new Range(1,1,searchStart.lineNumber,this.getLineMaxColumn(searchStart.lineNumber)),ret=this.findMatchesLineByLine(searchRange,searchData,captureMatches,1),ret.length>0?ret[0]:null)}return TextModelSearch.findNextMatch(this,new SearchParams(searchString,isRegex,matchCase,wordSeparators),searchStart,captureMatches)}findPreviousMatch(searchString,rawSearchStart,isRegex,matchCase,wordSeparators,captureMatches){this._assertNotDisposed();const searchStart=this.validatePosition(rawSearchStart);return TextModelSearch.findPreviousMatch(this,new SearchParams(searchString,isRegex,matchCase,wordSeparators),searchStart,captureMatches)}pushStackElement(){this._commandManager.pushStackElement()}popStackElement(){this._commandManager.popStackElement()}pushEOL(eol){if(("\n"===this.getEOL()?0:1)!==eol)try{this._onDidChangeDecorations.beginDeferredEmit(),this._eventEmitter.beginDeferredEmit(),null===this._initialUndoRedoSnapshot&&(this._initialUndoRedoSnapshot=this._undoRedoService.createSnapshot(this.uri)),this._commandManager.pushEOL(eol)}finally{this._eventEmitter.endDeferredEmit(),this._onDidChangeDecorations.endDeferredEmit()}}_validateEditOperation(rawOperation){return rawOperation instanceof model.ValidAnnotatedEditOperation?rawOperation:new model.ValidAnnotatedEditOperation(rawOperation.identifier||null,this.validateRange(rawOperation.range),rawOperation.text,rawOperation.forceMoveMarkers||!1,rawOperation.isAutoWhitespaceEdit||!1,rawOperation._isTracked||!1)}_validateEditOperations(rawOperations){const result=[];for(let i=0,len=rawOperations.length;i<len;i++)result[i]=this._validateEditOperation(rawOperations[i]);return result}pushEditOperations(beforeCursorState,editOperations,cursorStateComputer){try{return this._onDidChangeDecorations.beginDeferredEmit(),this._eventEmitter.beginDeferredEmit(),this._pushEditOperations(beforeCursorState,this._validateEditOperations(editOperations),cursorStateComputer)}finally{this._eventEmitter.endDeferredEmit(),this._onDidChangeDecorations.endDeferredEmit()}}_pushEditOperations(beforeCursorState,editOperations,cursorStateComputer){if(this._options.trimAutoWhitespace&&this._trimAutoWhitespaceLines){const incomingEdits=editOperations.map((op=>({range:this.validateRange(op.range),text:op.text})));let editsAreNearCursors=!0;if(beforeCursorState)for(let i=0,len=beforeCursorState.length;i<len;i++){const sel=beforeCursorState[i];let foundEditNearSel=!1;for(let j=0,lenJ=incomingEdits.length;j<lenJ;j++){const editRange=incomingEdits[j].range,selIsAbove=editRange.startLineNumber>sel.endLineNumber,selIsBelow=sel.startLineNumber>editRange.endLineNumber;if(!selIsAbove&&!selIsBelow){foundEditNearSel=!0;break}}if(!foundEditNearSel){editsAreNearCursors=!1;break}}if(editsAreNearCursors)for(let i=0,len=this._trimAutoWhitespaceLines.length;i<len;i++){const trimLineNumber=this._trimAutoWhitespaceLines[i],maxLineColumn=this.getLineMaxColumn(trimLineNumber);let allowTrimLine=!0;for(let j=0,lenJ=incomingEdits.length;j<lenJ;j++){const editRange=incomingEdits[j].range,editText=incomingEdits[j].text;if(!(trimLineNumber<editRange.startLineNumber||trimLineNumber>editRange.endLineNumber)&&!(trimLineNumber===editRange.startLineNumber&&editRange.startColumn===maxLineColumn&&editRange.isEmpty()&&editText&&editText.length>0&&"\n"===editText.charAt(0)||trimLineNumber===editRange.startLineNumber&&1===editRange.startColumn&&editRange.isEmpty()&&editText&&editText.length>0&&"\n"===editText.charAt(editText.length-1))){allowTrimLine=!1;break}}if(allowTrimLine){const trimRange=new Range(trimLineNumber,1,trimLineNumber,maxLineColumn);editOperations.push(new model.ValidAnnotatedEditOperation(null,trimRange,null,!1,!1,!1))}}this._trimAutoWhitespaceLines=null}return null===this._initialUndoRedoSnapshot&&(this._initialUndoRedoSnapshot=this._undoRedoService.createSnapshot(this.uri)),this._commandManager.pushEditOperation(beforeCursorState,editOperations,cursorStateComputer)}_applyUndo(changes,eol,resultingAlternativeVersionId,resultingSelection){const edits=changes.map((change=>{const rangeStart=this.getPositionAt(change.newPosition),rangeEnd=this.getPositionAt(change.newEnd);return{range:new Range(rangeStart.lineNumber,rangeStart.column,rangeEnd.lineNumber,rangeEnd.column),text:change.oldText}}));this._applyUndoRedoEdits(edits,eol,!0,!1,resultingAlternativeVersionId,resultingSelection)}_applyRedo(changes,eol,resultingAlternativeVersionId,resultingSelection){const edits=changes.map((change=>{const rangeStart=this.getPositionAt(change.oldPosition),rangeEnd=this.getPositionAt(change.oldEnd);return{range:new Range(rangeStart.lineNumber,rangeStart.column,rangeEnd.lineNumber,rangeEnd.column),text:change.newText}}));this._applyUndoRedoEdits(edits,eol,!1,!0,resultingAlternativeVersionId,resultingSelection)}_applyUndoRedoEdits(edits,eol,isUndoing,isRedoing,resultingAlternativeVersionId,resultingSelection){try{this._onDidChangeDecorations.beginDeferredEmit(),this._eventEmitter.beginDeferredEmit(),this._isUndoing=isUndoing,this._isRedoing=isRedoing,this.applyEdits(edits,!1),this.setEOL(eol),this._overwriteAlternativeVersionId(resultingAlternativeVersionId)}finally{this._isUndoing=!1,this._isRedoing=!1,this._eventEmitter.endDeferredEmit(resultingSelection),this._onDidChangeDecorations.endDeferredEmit()}}applyEdits(rawOperations,computeUndoEdits=!1){try{this._onDidChangeDecorations.beginDeferredEmit(),this._eventEmitter.beginDeferredEmit();const operations=this._validateEditOperations(rawOperations);return this._doApplyEdits(operations,computeUndoEdits)}finally{this._eventEmitter.endDeferredEmit(),this._onDidChangeDecorations.endDeferredEmit()}}_doApplyEdits(rawOperations,computeUndoEdits){const oldLineCount=this._buffer.getLineCount(),result=this._buffer.applyEdits(rawOperations,this._options.trimAutoWhitespace,computeUndoEdits),newLineCount=this._buffer.getLineCount(),contentChanges=result.changes;if(this._trimAutoWhitespaceLines=result.trimAutoWhitespaceLineNumbers,0!==contentChanges.length){for(let i=0,len=contentChanges.length;i<len;i++){const change=contentChanges[i],[eolCount,firstLineLength,lastLineLength]=countEOL(change.text);this._tokens.acceptEdit(change.range,eolCount,firstLineLength),this._semanticTokens.acceptEdit(change.range,eolCount,firstLineLength,lastLineLength,change.text.length>0?change.text.charCodeAt(0):0),this._decorationsTree.acceptReplace(change.rangeOffset,change.rangeLength,change.text.length,change.forceMoveMarkers)}const rawContentChanges=[];this._increaseVersionId();let lineCount=oldLineCount;for(let i=0,len=contentChanges.length;i<len;i++){const change=contentChanges[i],[eolCount]=countEOL(change.text);this._onDidChangeDecorations.fire();const startLineNumber=change.range.startLineNumber,endLineNumber=change.range.endLineNumber,deletingLinesCnt=endLineNumber-startLineNumber,insertingLinesCnt=eolCount,editingLinesCnt=Math.min(deletingLinesCnt,insertingLinesCnt),changeLineCountDelta=insertingLinesCnt-deletingLinesCnt,currentEditStartLineNumber=newLineCount-lineCount-changeLineCountDelta+startLineNumber,firstEditLineNumber=currentEditStartLineNumber,lastInsertedLineNumber=currentEditStartLineNumber+insertingLinesCnt,decorationsWithInjectedTextInEditedRange=this._decorationsTree.getInjectedTextInInterval(this,this.getOffsetAt(new Position(firstEditLineNumber,1)),this.getOffsetAt(new Position(lastInsertedLineNumber,this.getLineMaxColumn(lastInsertedLineNumber))),0),injectedTextInEditedRange=LineInjectedText.fromDecorations(decorationsWithInjectedTextInEditedRange),injectedTextInEditedRangeQueue=new ArrayQueue(injectedTextInEditedRange);for(let j=editingLinesCnt;j>=0;j--){const editLineNumber=startLineNumber+j,currentEditLineNumber=currentEditStartLineNumber+j;injectedTextInEditedRangeQueue.takeFromEndWhile((r=>r.lineNumber>currentEditLineNumber));const decorationsInCurrentLine=injectedTextInEditedRangeQueue.takeFromEndWhile((r=>r.lineNumber===currentEditLineNumber));rawContentChanges.push(new ModelRawLineChanged(editLineNumber,this.getLineContent(currentEditLineNumber),decorationsInCurrentLine))}if(editingLinesCnt<deletingLinesCnt){const spliceStartLineNumber=startLineNumber+editingLinesCnt;rawContentChanges.push(new ModelRawLinesDeleted(spliceStartLineNumber+1,endLineNumber))}if(editingLinesCnt<insertingLinesCnt){const injectedTextInEditedRangeQueue=new ArrayQueue(injectedTextInEditedRange),spliceLineNumber=startLineNumber+editingLinesCnt,cnt=insertingLinesCnt-editingLinesCnt,fromLineNumber=newLineCount-lineCount-cnt+spliceLineNumber+1,injectedTexts=[],newLines=[];for(let i=0;i<cnt;i++){const lineNumber=fromLineNumber+i;newLines[i]=this.getLineContent(lineNumber),injectedTextInEditedRangeQueue.takeWhile((r=>r.lineNumber<lineNumber)),injectedTexts[i]=injectedTextInEditedRangeQueue.takeWhile((r=>r.lineNumber===lineNumber))}rawContentChanges.push(new ModelRawLinesInserted(spliceLineNumber+1,startLineNumber+insertingLinesCnt,newLines,injectedTexts))}lineCount+=changeLineCountDelta}this._emitContentChangedEvent(new ModelRawContentChangedEvent(rawContentChanges,this.getVersionId(),this._isUndoing,this._isRedoing),{changes:contentChanges,eol:this._buffer.getEOL(),versionId:this.getVersionId(),isUndoing:this._isUndoing,isRedoing:this._isRedoing,isFlush:!1})}return null===result.reverseEdits?void 0:result.reverseEdits}undo(){return this._undoRedoService.undo(this.uri)}canUndo(){return this._undoRedoService.canUndo(this.uri)}redo(){return this._undoRedoService.redo(this.uri)}canRedo(){return this._undoRedoService.canRedo(this.uri)}handleBeforeFireDecorationsChangedEvent(affectedInjectedTextLines){if(null===affectedInjectedTextLines||0===affectedInjectedTextLines.size)return;const lineChangeEvents=[...affectedInjectedTextLines].map((lineNumber=>new ModelRawLineChanged(lineNumber,this.getLineContent(lineNumber),this._getInjectedTextInLine(lineNumber))));this._onDidChangeInjectedText.fire(new ModelInjectedTextChangedEvent(lineChangeEvents))}changeDecorations(callback,ownerId=0){this._assertNotDisposed();try{return this._onDidChangeDecorations.beginDeferredEmit(),this._changeDecorations(ownerId,callback)}finally{this._onDidChangeDecorations.endDeferredEmit()}}_changeDecorations(ownerId,callback){const changeAccessor={addDecoration:(range,options)=>this._deltaDecorationsImpl(ownerId,[],[{range,options}])[0],changeDecoration:(id,newRange)=>{this._changeDecorationImpl(id,newRange)},changeDecorationOptions:(id,options)=>{this._changeDecorationOptionsImpl(id,_normalizeOptions(options))},removeDecoration:id=>{this._deltaDecorationsImpl(ownerId,[id],[])},deltaDecorations:(oldDecorations,newDecorations)=>0===oldDecorations.length&&0===newDecorations.length?[]:this._deltaDecorationsImpl(ownerId,oldDecorations,newDecorations)};let result=null;try{result=callback(changeAccessor)}catch(e){onUnexpectedError(e)}return changeAccessor.addDecoration=invalidFunc,changeAccessor.changeDecoration=invalidFunc,changeAccessor.changeDecorationOptions=invalidFunc,changeAccessor.removeDecoration=invalidFunc,changeAccessor.deltaDecorations=invalidFunc,result}deltaDecorations(oldDecorations,newDecorations,ownerId=0){if(this._assertNotDisposed(),oldDecorations||(oldDecorations=[]),0===oldDecorations.length&&0===newDecorations.length)return[];try{return this._onDidChangeDecorations.beginDeferredEmit(),this._deltaDecorationsImpl(ownerId,oldDecorations,newDecorations)}finally{this._onDidChangeDecorations.endDeferredEmit()}}_getTrackedRange(id){return this.getDecorationRange(id)}_setTrackedRange(id,newRange,newStickiness){const node=id?this._decorations[id]:null;if(!node)return newRange?this._deltaDecorationsImpl(0,[],[{range:newRange,options:TRACKED_RANGE_OPTIONS[newStickiness]}])[0]:null;if(!newRange)return this._decorationsTree.delete(node),delete this._decorations[node.id],null;const range=this._validateRangeRelaxedNoAllocations(newRange),startOffset=this._buffer.getOffsetAt(range.startLineNumber,range.startColumn),endOffset=this._buffer.getOffsetAt(range.endLineNumber,range.endColumn);return this._decorationsTree.delete(node),node.reset(this.getVersionId(),startOffset,endOffset,range),node.setOptions(TRACKED_RANGE_OPTIONS[newStickiness]),this._decorationsTree.insert(node),node.id}removeAllDecorationsWithOwnerId(ownerId){if(this._isDisposed)return;const nodes=this._decorationsTree.collectNodesFromOwner(ownerId);for(let i=0,len=nodes.length;i<len;i++){const node=nodes[i];this._decorationsTree.delete(node),delete this._decorations[node.id]}}getDecorationOptions(decorationId){const node=this._decorations[decorationId];return node?node.options:null}getDecorationRange(decorationId){const node=this._decorations[decorationId];return node?this._decorationsTree.getNodeRange(this,node):null}getLineDecorations(lineNumber,ownerId=0,filterOutValidation=!1){return lineNumber<1||lineNumber>this.getLineCount()?[]:this.getLinesDecorations(lineNumber,lineNumber,ownerId,filterOutValidation)}getLinesDecorations(_startLineNumber,_endLineNumber,ownerId=0,filterOutValidation=!1){const lineCount=this.getLineCount(),startLineNumber=Math.min(lineCount,Math.max(1,_startLineNumber)),endLineNumber=Math.min(lineCount,Math.max(1,_endLineNumber)),endColumn=this.getLineMaxColumn(endLineNumber),range=new Range(startLineNumber,1,endLineNumber,endColumn),decorations=this._getDecorationsInRange(range,ownerId,filterOutValidation);return decorations.push(...this._decorationProvider.getDecorationsInRange(range,ownerId,filterOutValidation)),decorations}getDecorationsInRange(range,ownerId=0,filterOutValidation=!1){const validatedRange=this.validateRange(range),decorations=this._getDecorationsInRange(validatedRange,ownerId,filterOutValidation);return decorations.push(...this._decorationProvider.getDecorationsInRange(validatedRange,ownerId,filterOutValidation)),decorations}getOverviewRulerDecorations(ownerId=0,filterOutValidation=!1){return this._decorationsTree.getAll(this,ownerId,filterOutValidation,!0)}getInjectedTextDecorations(ownerId=0){return this._decorationsTree.getAllInjectedText(this,ownerId)}_getInjectedTextInLine(lineNumber){const startOffset=this._buffer.getOffsetAt(lineNumber,1),endOffset=startOffset+this._buffer.getLineLength(lineNumber),result=this._decorationsTree.getInjectedTextInInterval(this,startOffset,endOffset,0);return LineInjectedText.fromDecorations(result).filter((t=>t.lineNumber===lineNumber))}getAllDecorations(ownerId=0,filterOutValidation=!1){let result=this._decorationsTree.getAll(this,ownerId,filterOutValidation,!1);return result=result.concat(this._decorationProvider.getAllDecorations(ownerId,filterOutValidation)),result}_getDecorationsInRange(filterRange,filterOwnerId,filterOutValidation){const startOffset=this._buffer.getOffsetAt(filterRange.startLineNumber,filterRange.startColumn),endOffset=this._buffer.getOffsetAt(filterRange.endLineNumber,filterRange.endColumn);return this._decorationsTree.getAllInInterval(this,startOffset,endOffset,filterOwnerId,filterOutValidation)}getRangeAt(start,end){return this._buffer.getRangeAt(start,end-start)}_changeDecorationImpl(decorationId,_range){const node=this._decorations[decorationId];if(!node)return;if(node.options.after){const oldRange=this.getDecorationRange(decorationId);this._onDidChangeDecorations.recordLineAffectedByInjectedText(oldRange.endLineNumber)}if(node.options.before){const oldRange=this.getDecorationRange(decorationId);this._onDidChangeDecorations.recordLineAffectedByInjectedText(oldRange.startLineNumber)}const range=this._validateRangeRelaxedNoAllocations(_range),startOffset=this._buffer.getOffsetAt(range.startLineNumber,range.startColumn),endOffset=this._buffer.getOffsetAt(range.endLineNumber,range.endColumn);this._decorationsTree.delete(node),node.reset(this.getVersionId(),startOffset,endOffset,range),this._decorationsTree.insert(node),this._onDidChangeDecorations.checkAffectedAndFire(node.options),node.options.after&&this._onDidChangeDecorations.recordLineAffectedByInjectedText(range.endLineNumber),node.options.before&&this._onDidChangeDecorations.recordLineAffectedByInjectedText(range.startLineNumber)}_changeDecorationOptionsImpl(decorationId,options){const node=this._decorations[decorationId];if(!node)return;const nodeWasInOverviewRuler=!(!node.options.overviewRuler||!node.options.overviewRuler.color),nodeIsInOverviewRuler=!(!options.overviewRuler||!options.overviewRuler.color);if(this._onDidChangeDecorations.checkAffectedAndFire(node.options),this._onDidChangeDecorations.checkAffectedAndFire(options),node.options.after||options.after){const nodeRange=this._decorationsTree.getNodeRange(this,node);this._onDidChangeDecorations.recordLineAffectedByInjectedText(nodeRange.endLineNumber)}if(node.options.before||options.before){const nodeRange=this._decorationsTree.getNodeRange(this,node);this._onDidChangeDecorations.recordLineAffectedByInjectedText(nodeRange.startLineNumber)}nodeWasInOverviewRuler!==nodeIsInOverviewRuler?(this._decorationsTree.delete(node),node.setOptions(options),this._decorationsTree.insert(node)):node.setOptions(options)}_deltaDecorationsImpl(ownerId,oldDecorationsIds,newDecorations){const versionId=this.getVersionId(),oldDecorationsLen=oldDecorationsIds.length;let oldDecorationIndex=0;const newDecorationsLen=newDecorations.length;let newDecorationIndex=0;const result=new Array(newDecorationsLen);for(;oldDecorationIndex<oldDecorationsLen||newDecorationIndex<newDecorationsLen;){let node=null;if(oldDecorationIndex<oldDecorationsLen){do{node=this._decorations[oldDecorationsIds[oldDecorationIndex++]]}while(!node&&oldDecorationIndex<oldDecorationsLen);if(node){if(node.options.after){const nodeRange=this._decorationsTree.getNodeRange(this,node);this._onDidChangeDecorations.recordLineAffectedByInjectedText(nodeRange.endLineNumber)}if(node.options.before){const nodeRange=this._decorationsTree.getNodeRange(this,node);this._onDidChangeDecorations.recordLineAffectedByInjectedText(nodeRange.startLineNumber)}this._decorationsTree.delete(node),this._onDidChangeDecorations.checkAffectedAndFire(node.options)}}if(newDecorationIndex<newDecorationsLen){if(!node){const internalDecorationId=++this._lastDecorationId,decorationId=`${this._instanceId};${internalDecorationId}`;node=new IntervalNode(decorationId,0,0),this._decorations[decorationId]=node}const newDecoration=newDecorations[newDecorationIndex],range=this._validateRangeRelaxedNoAllocations(newDecoration.range),options=_normalizeOptions(newDecoration.options),startOffset=this._buffer.getOffsetAt(range.startLineNumber,range.startColumn),endOffset=this._buffer.getOffsetAt(range.endLineNumber,range.endColumn);node.ownerId=ownerId,node.reset(versionId,startOffset,endOffset,range),node.setOptions(options),node.options.after&&this._onDidChangeDecorations.recordLineAffectedByInjectedText(range.endLineNumber),node.options.before&&this._onDidChangeDecorations.recordLineAffectedByInjectedText(range.startLineNumber),this._onDidChangeDecorations.checkAffectedAndFire(options),this._decorationsTree.insert(node),result[newDecorationIndex]=node.id,newDecorationIndex++}else node&&delete this._decorations[node.id]}return result}setTokens(tokens,backgroundTokenizationCompleted=!1){if(0!==tokens.length){const ranges=[];for(let i=0,len=tokens.length;i<len;i++){const element=tokens[i];let minChangedLineNumber=0,maxChangedLineNumber=0,hasChange=!1;for(let lineNumber=element.startLineNumber;lineNumber<=element.endLineNumber;lineNumber++)if(hasChange)this._tokens.setTokens(this._languageId,lineNumber-1,this._buffer.getLineLength(lineNumber),element.getLineTokens(lineNumber),!1),maxChangedLineNumber=lineNumber;else{this._tokens.setTokens(this._languageId,lineNumber-1,this._buffer.getLineLength(lineNumber),element.getLineTokens(lineNumber),!0)&&(hasChange=!0,minChangedLineNumber=lineNumber,maxChangedLineNumber=lineNumber)}hasChange&&ranges.push({fromLineNumber:minChangedLineNumber,toLineNumber:maxChangedLineNumber})}ranges.length>0&&this._emitModelTokensChangedEvent({tokenizationSupportChanged:!1,semanticTokensApplied:!1,ranges})}this.handleTokenizationProgress(backgroundTokenizationCompleted)}setSemanticTokens(tokens,isComplete){this._semanticTokens.set(tokens,isComplete),this._emitModelTokensChangedEvent({tokenizationSupportChanged:!1,semanticTokensApplied:null!==tokens,ranges:[{fromLineNumber:1,toLineNumber:this.getLineCount()}]})}hasCompleteSemanticTokens(){return this._semanticTokens.isComplete()}hasSomeSemanticTokens(){return!this._semanticTokens.isEmpty()}setPartialSemanticTokens(range,tokens){if(this.hasCompleteSemanticTokens())return;const changedRange=this.validateRange(this._semanticTokens.setPartial(range,tokens));this._emitModelTokensChangedEvent({tokenizationSupportChanged:!1,semanticTokensApplied:!0,ranges:[{fromLineNumber:changedRange.startLineNumber,toLineNumber:changedRange.endLineNumber}]})}tokenizeViewport(startLineNumber,endLineNumber){startLineNumber=Math.max(1,startLineNumber),endLineNumber=Math.min(this._buffer.getLineCount(),endLineNumber),this._tokenization.tokenizeViewport(startLineNumber,endLineNumber)}clearTokens(){this._tokens.flush(),this._emitModelTokensChangedEvent({tokenizationSupportChanged:!0,semanticTokensApplied:!1,ranges:[{fromLineNumber:1,toLineNumber:this._buffer.getLineCount()}]})}_emitModelTokensChangedEvent(e){this._isDisposing||(this._bracketPairColorizer.handleDidChangeTokens(e),this._onDidChangeTokens.fire(e))}resetTokenization(){this._tokenization.reset()}forceTokenization(lineNumber){if(lineNumber<1||lineNumber>this.getLineCount())throw new Error("Illegal value for lineNumber");this._tokenization.forceTokenization(lineNumber)}isCheapToTokenize(lineNumber){return this._tokenization.isCheapToTokenize(lineNumber)}tokenizeIfCheap(lineNumber){this.isCheapToTokenize(lineNumber)&&this.forceTokenization(lineNumber)}getLineTokens(lineNumber){if(lineNumber<1||lineNumber>this.getLineCount())throw new Error("Illegal value for lineNumber");return this._getLineTokens(lineNumber)}_getLineTokens(lineNumber){const lineText=this.getLineContent(lineNumber),syntacticTokens=this._tokens.getTokens(this._languageId,lineNumber-1,lineText);return this._semanticTokens.addSparseTokens(lineNumber,syntacticTokens)}getLanguageId(){return this._languageId}setMode(languageId){if(this._languageId===languageId)return;const e={oldLanguage:this._languageId,newLanguage:languageId};this._languageId=languageId,this._bracketPairColorizer.handleDidChangeLanguage(e),this._tokenization.handleDidChangeLanguage(e),this._onDidChangeLanguage.fire(e),this._onDidChangeLanguageConfiguration.fire({})}getLanguageIdAtPosition(lineNumber,column){const position=this.validatePosition(new Position(lineNumber,column)),lineTokens=this.getLineTokens(position.lineNumber);return lineTokens.getLanguageId(lineTokens.findTokenIndexAtOffset(position.column-1))}getTokenTypeIfInsertingCharacter(lineNumber,column,character){const position=this.validatePosition(new Position(lineNumber,column));return this._tokenization.getTokenTypeIfInsertingCharacter(position,character)}tokenizeLineWithEdit(position,length,newText){const validatedPosition=this.validatePosition(position);return this._tokenization.tokenizeLineWithEdit(validatedPosition,length,newText)}getLanguageConfiguration(languageId){return this._languageConfigurationService.getLanguageConfiguration(languageId)}getWordAtPosition(_position){this._assertNotDisposed();const position=this.validatePosition(_position),lineContent=this.getLineContent(position.lineNumber),lineTokens=this._getLineTokens(position.lineNumber),tokenIndex=lineTokens.findTokenIndexAtOffset(position.column-1),[rbStartOffset,rbEndOffset]=TextModel._findLanguageBoundaries(lineTokens,tokenIndex),rightBiasedWord=getWordAtText(position.column,this.getLanguageConfiguration(lineTokens.getLanguageId(tokenIndex)).getWordDefinition(),lineContent.substring(rbStartOffset,rbEndOffset),rbStartOffset);if(rightBiasedWord&&rightBiasedWord.startColumn<=_position.column&&_position.column<=rightBiasedWord.endColumn)return rightBiasedWord;if(tokenIndex>0&&rbStartOffset===position.column-1){const[lbStartOffset,lbEndOffset]=TextModel._findLanguageBoundaries(lineTokens,tokenIndex-1),leftBiasedWord=getWordAtText(position.column,this.getLanguageConfiguration(lineTokens.getLanguageId(tokenIndex-1)).getWordDefinition(),lineContent.substring(lbStartOffset,lbEndOffset),lbStartOffset);if(leftBiasedWord&&leftBiasedWord.startColumn<=_position.column&&_position.column<=leftBiasedWord.endColumn)return leftBiasedWord}return null}static _findLanguageBoundaries(lineTokens,tokenIndex){const languageId=lineTokens.getLanguageId(tokenIndex);let startOffset=0;for(let i=tokenIndex;i>=0&&lineTokens.getLanguageId(i)===languageId;i--)startOffset=lineTokens.getStartOffset(i);let endOffset=lineTokens.getLineContent().length;for(let i=tokenIndex,tokenCount=lineTokens.getCount();i<tokenCount&&lineTokens.getLanguageId(i)===languageId;i++)endOffset=lineTokens.getEndOffset(i);return[startOffset,endOffset]}getWordUntilPosition(position){const wordAtPosition=this.getWordAtPosition(position);return wordAtPosition?{word:wordAtPosition.word.substr(0,position.column-wordAtPosition.startColumn),startColumn:wordAtPosition.startColumn,endColumn:position.column}:{word:"",startColumn:position.column,endColumn:position.column}}normalizePosition(position,affinity){return position}getLineIndentColumn(lineNumber){return indentOfLine(this.getLineContent(lineNumber))+1}};TextModel.MODEL_SYNC_LIMIT=52428800,TextModel.LARGE_FILE_SIZE_THRESHOLD=20971520,TextModel.LARGE_FILE_LINE_COUNT_THRESHOLD=3e5,TextModel.DEFAULT_CREATION_OPTIONS={isForSimpleWidget:!1,tabSize:EDITOR_MODEL_DEFAULTS.tabSize,indentSize:EDITOR_MODEL_DEFAULTS.indentSize,insertSpaces:EDITOR_MODEL_DEFAULTS.insertSpaces,detectIndentation:!1,defaultEOL:1,trimAutoWhitespace:EDITOR_MODEL_DEFAULTS.trimAutoWhitespace,largeFileOptimizations:EDITOR_MODEL_DEFAULTS.largeFileOptimizations,bracketPairColorizationOptions:EDITOR_MODEL_DEFAULTS.bracketPairColorizationOptions},TextModel=__decorate([__param(4,IUndoRedoService),__param(5,ILanguageService),__param(6,ILanguageConfigurationService)],TextModel);export{TextModel};function indentOfLine(line){let indent=0;for(const c of line){if(" "!==c&&"\t"!==c)break;indent++}return indent}function isNodeInOverviewRuler(node){return!(!node.options.overviewRuler||!node.options.overviewRuler.color)}function isNodeInjectedText(node){return!!node.options.after||!!node.options.before}class DecorationsTrees{constructor(){this._decorationsTree0=new IntervalTree,this._decorationsTree1=new IntervalTree,this._injectedTextDecorationsTree=new IntervalTree}ensureAllNodesHaveRanges(host){this.getAll(host,0,!1,!1)}_ensureNodesHaveRanges(host,nodes){for(const node of nodes)null===node.range&&(node.range=host.getRangeAt(node.cachedAbsoluteStart,node.cachedAbsoluteEnd));return nodes}getAllInInterval(host,start,end,filterOwnerId,filterOutValidation){const versionId=host.getVersionId(),result=this._intervalSearch(start,end,filterOwnerId,filterOutValidation,versionId);return this._ensureNodesHaveRanges(host,result)}_intervalSearch(start,end,filterOwnerId,filterOutValidation,cachedVersionId){const r0=this._decorationsTree0.intervalSearch(start,end,filterOwnerId,filterOutValidation,cachedVersionId),r1=this._decorationsTree1.intervalSearch(start,end,filterOwnerId,filterOutValidation,cachedVersionId),r2=this._injectedTextDecorationsTree.intervalSearch(start,end,filterOwnerId,filterOutValidation,cachedVersionId);return r0.concat(r1).concat(r2)}getInjectedTextInInterval(host,start,end,filterOwnerId){const versionId=host.getVersionId(),result=this._injectedTextDecorationsTree.intervalSearch(start,end,filterOwnerId,!1,versionId);return this._ensureNodesHaveRanges(host,result).filter((i=>i.options.showIfCollapsed||!i.range.isEmpty()))}getAllInjectedText(host,filterOwnerId){const versionId=host.getVersionId(),result=this._injectedTextDecorationsTree.search(filterOwnerId,!1,versionId);return this._ensureNodesHaveRanges(host,result).filter((i=>i.options.showIfCollapsed||!i.range.isEmpty()))}getAll(host,filterOwnerId,filterOutValidation,overviewRulerOnly){const versionId=host.getVersionId(),result=this._search(filterOwnerId,filterOutValidation,overviewRulerOnly,versionId);return this._ensureNodesHaveRanges(host,result)}_search(filterOwnerId,filterOutValidation,overviewRulerOnly,cachedVersionId){if(overviewRulerOnly)return this._decorationsTree1.search(filterOwnerId,filterOutValidation,cachedVersionId);{const r0=this._decorationsTree0.search(filterOwnerId,filterOutValidation,cachedVersionId),r1=this._decorationsTree1.search(filterOwnerId,filterOutValidation,cachedVersionId),r2=this._injectedTextDecorationsTree.search(filterOwnerId,filterOutValidation,cachedVersionId);return r0.concat(r1).concat(r2)}}collectNodesFromOwner(ownerId){const r0=this._decorationsTree0.collectNodesFromOwner(ownerId),r1=this._decorationsTree1.collectNodesFromOwner(ownerId),r2=this._injectedTextDecorationsTree.collectNodesFromOwner(ownerId);return r0.concat(r1).concat(r2)}collectNodesPostOrder(){const r0=this._decorationsTree0.collectNodesPostOrder(),r1=this._decorationsTree1.collectNodesPostOrder(),r2=this._injectedTextDecorationsTree.collectNodesPostOrder();return r0.concat(r1).concat(r2)}insert(node){isNodeInjectedText(node)?this._injectedTextDecorationsTree.insert(node):isNodeInOverviewRuler(node)?this._decorationsTree1.insert(node):this._decorationsTree0.insert(node)}delete(node){isNodeInjectedText(node)?this._injectedTextDecorationsTree.delete(node):isNodeInOverviewRuler(node)?this._decorationsTree1.delete(node):this._decorationsTree0.delete(node)}getNodeRange(host,node){const versionId=host.getVersionId();return node.cachedVersionId!==versionId&&this._resolveNode(node,versionId),null===node.range&&(node.range=host.getRangeAt(node.cachedAbsoluteStart,node.cachedAbsoluteEnd)),node.range}_resolveNode(node,cachedVersionId){isNodeInjectedText(node)?this._injectedTextDecorationsTree.resolveNode(node,cachedVersionId):isNodeInOverviewRuler(node)?this._decorationsTree1.resolveNode(node,cachedVersionId):this._decorationsTree0.resolveNode(node,cachedVersionId)}acceptReplace(offset,length,textLength,forceMoveMarkers){this._decorationsTree0.acceptReplace(offset,length,textLength,forceMoveMarkers),this._decorationsTree1.acceptReplace(offset,length,textLength,forceMoveMarkers),this._injectedTextDecorationsTree.acceptReplace(offset,length,textLength,forceMoveMarkers)}}function cleanClassName(className){return className.replace(/[^a-z0-9\-_]/gi," ")}class DecorationOptions{constructor(options){this.color=options.color||"",this.darkColor=options.darkColor||""}}export class ModelDecorationOverviewRulerOptions extends DecorationOptions{constructor(options){super(options),this._resolvedColor=null,this.position="number"==typeof options.position?options.position:model.OverviewRulerLane.Center}getColor(theme){return this._resolvedColor||("light"!==theme.type&&this.darkColor?this._resolvedColor=this._resolveColor(this.darkColor,theme):this._resolvedColor=this._resolveColor(this.color,theme)),this._resolvedColor}invalidateCachedColor(){this._resolvedColor=null}_resolveColor(color,theme){if("string"==typeof color)return color;const c=color?theme.getColor(color.id):null;return c?c.toString():""}}export class ModelDecorationMinimapOptions extends DecorationOptions{constructor(options){super(options),this.position=options.position}getColor(theme){return this._resolvedColor||("light"!==theme.type&&this.darkColor?this._resolvedColor=this._resolveColor(this.darkColor,theme):this._resolvedColor=this._resolveColor(this.color,theme)),this._resolvedColor}invalidateCachedColor(){this._resolvedColor=void 0}_resolveColor(color,theme){return"string"==typeof color?Color.fromHex(color):theme.getColor(color.id)}}export class ModelDecorationInjectedTextOptions{constructor(options){this.content=options.content||"",this.inlineClassName=options.inlineClassName||null,this.inlineClassNameAffectsLetterSpacing=options.inlineClassNameAffectsLetterSpacing||!1,this.attachedData=options.attachedData||null,this.cursorStops=options.cursorStops||null}static from(options){return options instanceof ModelDecorationInjectedTextOptions?options:new ModelDecorationInjectedTextOptions(options)}}export class ModelDecorationOptions{constructor(options){var _a,_b;this.description=options.description,this.stickiness=options.stickiness||0,this.zIndex=options.zIndex||0,this.className=options.className?cleanClassName(options.className):null,this.hoverMessage=options.hoverMessage||null,this.glyphMarginHoverMessage=options.glyphMarginHoverMessage||null,this.isWholeLine=options.isWholeLine||!1,this.showIfCollapsed=options.showIfCollapsed||!1,this.collapseOnReplaceEdit=options.collapseOnReplaceEdit||!1,this.overviewRuler=options.overviewRuler?new ModelDecorationOverviewRulerOptions(options.overviewRuler):null,this.minimap=options.minimap?new ModelDecorationMinimapOptions(options.minimap):null,this.glyphMarginClassName=options.glyphMarginClassName?cleanClassName(options.glyphMarginClassName):null,this.linesDecorationsClassName=options.linesDecorationsClassName?cleanClassName(options.linesDecorationsClassName):null,this.firstLineDecorationClassName=options.firstLineDecorationClassName?cleanClassName(options.firstLineDecorationClassName):null,this.marginClassName=options.marginClassName?cleanClassName(options.marginClassName):null,this.inlineClassName=options.inlineClassName?cleanClassName(options.inlineClassName):null,this.inlineClassNameAffectsLetterSpacing=options.inlineClassNameAffectsLetterSpacing||!1,this.beforeContentClassName=options.beforeContentClassName?cleanClassName(options.beforeContentClassName):null,this.afterContentClassName=options.afterContentClassName?cleanClassName(options.afterContentClassName):null,this.after=options.after?ModelDecorationInjectedTextOptions.from(options.after):null,this.before=options.before?ModelDecorationInjectedTextOptions.from(options.before):null,this.hideInCommentTokens=null!==(_a=options.hideInCommentTokens)&&void 0!==_a&&_a,this.hideInStringTokens=null!==(_b=options.hideInStringTokens)&&void 0!==_b&&_b}static register(options){return new ModelDecorationOptions(options)}static createDynamic(options){return new ModelDecorationOptions(options)}}ModelDecorationOptions.EMPTY=ModelDecorationOptions.register({description:"empty"});const TRACKED_RANGE_OPTIONS=[ModelDecorationOptions.register({description:"tracked-range-always-grows-when-typing-at-edges",stickiness:0}),ModelDecorationOptions.register({description:"tracked-range-never-grows-when-typing-at-edges",stickiness:1}),ModelDecorationOptions.register({description:"tracked-range-grows-only-when-typing-before",stickiness:2}),ModelDecorationOptions.register({description:"tracked-range-grows-only-when-typing-after",stickiness:3})];function _normalizeOptions(options){return options instanceof ModelDecorationOptions?options:ModelDecorationOptions.createDynamic(options)}export class DidChangeDecorationsEmitter extends Disposable{constructor(handleBeforeFire){super(),this.handleBeforeFire=handleBeforeFire,this._actual=this._register(new Emitter),this.event=this._actual.event,this._affectedInjectedTextLines=null,this._deferredCnt=0,this._shouldFire=!1,this._affectsMinimap=!1,this._affectsOverviewRuler=!1}beginDeferredEmit(){this._deferredCnt++}endDeferredEmit(){var _a;if(this._deferredCnt--,0===this._deferredCnt){if(this._shouldFire){this.handleBeforeFire(this._affectedInjectedTextLines);const event={affectsMinimap:this._affectsMinimap,affectsOverviewRuler:this._affectsOverviewRuler};this._shouldFire=!1,this._affectsMinimap=!1,this._affectsOverviewRuler=!1,this._actual.fire(event)}null===(_a=this._affectedInjectedTextLines)||void 0===_a||_a.clear(),this._affectedInjectedTextLines=null}}recordLineAffectedByInjectedText(lineNumber){this._affectedInjectedTextLines||(this._affectedInjectedTextLines=new Set),this._affectedInjectedTextLines.add(lineNumber)}checkAffectedAndFire(options){this._affectsMinimap||(this._affectsMinimap=!(!options.minimap||!options.minimap.position)),this._affectsOverviewRuler||(this._affectsOverviewRuler=!(!options.overviewRuler||!options.overviewRuler.color)),this._shouldFire=!0}fire(){this._affectsMinimap=!0,this._affectsOverviewRuler=!0,this._shouldFire=!0}}export class DidChangeContentEmitter extends Disposable{constructor(){super(),this._fastEmitter=this._register(new Emitter),this.fastEvent=this._fastEmitter.event,this._slowEmitter=this._register(new Emitter),this.slowEvent=this._slowEmitter.event,this._deferredCnt=0,this._deferredEvent=null}beginDeferredEmit(){this._deferredCnt++}endDeferredEmit(resultingSelection=null){if(this._deferredCnt--,0===this._deferredCnt&&null!==this._deferredEvent){this._deferredEvent.rawContentChangedEvent.resultingSelection=resultingSelection;const e=this._deferredEvent;this._deferredEvent=null,this._fastEmitter.fire(e),this._slowEmitter.fire(e)}}fire(e){this._deferredCnt>0?this._deferredEvent?this._deferredEvent=this._deferredEvent.merge(e):this._deferredEvent=e:(this._fastEmitter.fire(e),this._slowEmitter.fire(e))}}