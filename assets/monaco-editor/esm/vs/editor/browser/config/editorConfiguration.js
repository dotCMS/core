var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import*as browser from"../../../base/browser/browser.js";import*as arrays from"../../../base/common/arrays.js";import{Emitter}from"../../../base/common/event.js";import{Disposable}from"../../../base/common/lifecycle.js";import*as objects from"../../../base/common/objects.js";import*as platform from"../../../base/common/platform.js";import{ElementSizeObserver}from"./elementSizeObserver.js";import{FontMeasurements}from"./fontMeasurements.js";import{migrateOptions}from"./migrateOptions.js";import{TabFocus}from"./tabFocus.js";import{ComputeOptionsMemory,ConfigurationChangedEvent,editorOptionsRegistry}from"../../common/config/editorOptions.js";import{EditorZoom}from"../../common/config/editorZoom.js";import{BareFontInfo}from"../../common/config/fontInfo.js";import{IAccessibilityService}from"../../../platform/accessibility/common/accessibility.js";let EditorConfiguration=class EditorConfiguration extends Disposable{constructor(isSimpleWidget,options,container,_accessibilityService){super(),this._accessibilityService=_accessibilityService,this._onDidChange=this._register(new Emitter),this.onDidChange=this._onDidChange.event,this._onDidChangeFast=this._register(new Emitter),this.onDidChangeFast=this._onDidChangeFast.event,this._isDominatedByLongLines=!1,this._viewLineCount=1,this._lineNumbersDigitCount=1,this._reservedHeight=0,this._computeOptionsMemory=new ComputeOptionsMemory,this.isSimpleWidget=isSimpleWidget,this._containerObserver=this._register(new ElementSizeObserver(container,options.dimension)),this._rawOptions=deepCloneAndMigrateOptions(options),this._validatedOptions=EditorOptionsUtil.validateOptions(this._rawOptions),this.options=this._computeOptions(),this.options.get(10)&&this._containerObserver.startObserving(),this._register(EditorZoom.onDidChangeZoomLevel((()=>this._recomputeOptions()))),this._register(TabFocus.onDidChangeTabFocus((()=>this._recomputeOptions()))),this._register(this._containerObserver.onDidChange((()=>this._recomputeOptions()))),this._register(FontMeasurements.onDidChange((()=>this._recomputeOptions()))),this._register(browser.PixelRatio.onDidChange((()=>this._recomputeOptions()))),this._register(this._accessibilityService.onDidChangeScreenReaderOptimized((()=>this._recomputeOptions())))}_recomputeOptions(){const newOptions=this._computeOptions(),changeEvent=EditorOptionsUtil.checkEquals(this.options,newOptions);null!==changeEvent&&(this.options=newOptions,this._onDidChangeFast.fire(changeEvent),this._onDidChange.fire(changeEvent))}_computeOptions(){const partialEnv=this._readEnvConfiguration(),bareFontInfo=BareFontInfo.createFromValidatedSettings(this._validatedOptions,partialEnv.pixelRatio,this.isSimpleWidget),fontInfo=this._readFontInfo(bareFontInfo),env={memory:this._computeOptionsMemory,outerWidth:partialEnv.outerWidth,outerHeight:partialEnv.outerHeight-this._reservedHeight,fontInfo,extraEditorClassName:partialEnv.extraEditorClassName,isDominatedByLongLines:this._isDominatedByLongLines,viewLineCount:this._viewLineCount,lineNumbersDigitCount:this._lineNumbersDigitCount,emptySelectionClipboard:partialEnv.emptySelectionClipboard,pixelRatio:partialEnv.pixelRatio,tabFocusMode:TabFocus.getTabFocusMode(),accessibilitySupport:partialEnv.accessibilitySupport};return EditorOptionsUtil.computeOptions(this._validatedOptions,env)}_readEnvConfiguration(){return{extraEditorClassName:getExtraEditorClassName(),outerWidth:this._containerObserver.getWidth(),outerHeight:this._containerObserver.getHeight(),emptySelectionClipboard:browser.isWebKit||browser.isFirefox,pixelRatio:browser.PixelRatio.value,accessibilitySupport:this._accessibilityService.isScreenReaderOptimized()?2:this._accessibilityService.getAccessibilitySupport()}}_readFontInfo(bareFontInfo){return FontMeasurements.readFontInfo(bareFontInfo)}getRawOptions(){return this._rawOptions}updateOptions(_newOptions){const newOptions=deepCloneAndMigrateOptions(_newOptions);EditorOptionsUtil.applyUpdate(this._rawOptions,newOptions)&&(this._validatedOptions=EditorOptionsUtil.validateOptions(this._rawOptions),this._recomputeOptions())}observeContainer(dimension){this._containerObserver.observe(dimension)}setIsDominatedByLongLines(isDominatedByLongLines){this._isDominatedByLongLines!==isDominatedByLongLines&&(this._isDominatedByLongLines=isDominatedByLongLines,this._recomputeOptions())}setModelLineCount(modelLineCount){const lineNumbersDigitCount=digitCount(modelLineCount);this._lineNumbersDigitCount!==lineNumbersDigitCount&&(this._lineNumbersDigitCount=lineNumbersDigitCount,this._recomputeOptions())}setViewLineCount(viewLineCount){this._viewLineCount!==viewLineCount&&(this._viewLineCount=viewLineCount,this._recomputeOptions())}setReservedHeight(reservedHeight){this._reservedHeight!==reservedHeight&&(this._reservedHeight=reservedHeight,this._recomputeOptions())}};EditorConfiguration=__decorate([__param(3,IAccessibilityService)],EditorConfiguration);export{EditorConfiguration};function digitCount(n){let r=0;for(;n;)n=Math.floor(n/10),r++;return r||1}function getExtraEditorClassName(){let extra="";return browser.isSafari||browser.isWebkitWebView||(extra+="no-user-select "),browser.isSafari&&(extra+="no-minimap-shadow "),platform.isMacintosh&&(extra+="mac "),extra}class ValidatedEditorOptions{constructor(){this._values=[]}_read(option){return this._values[option]}get(id){return this._values[id]}_write(option,value){this._values[option]=value}}export class ComputedEditorOptions{constructor(){this._values=[]}_read(id){if(id>=this._values.length)throw new Error("Cannot read uninitialized value");return this._values[id]}get(id){return this._read(id)}_write(id,value){this._values[id]=value}}class EditorOptionsUtil{static validateOptions(options){const result=new ValidatedEditorOptions;for(const editorOption of editorOptionsRegistry){const value="_never_"===editorOption.name?void 0:options[editorOption.name];result._write(editorOption.id,editorOption.validate(value))}return result}static computeOptions(options,env){const result=new ComputedEditorOptions;for(const editorOption of editorOptionsRegistry)result._write(editorOption.id,editorOption.compute(env,result,options._read(editorOption.id)));return result}static _deepEquals(a,b){if("object"!=typeof a||"object"!=typeof b||!a||!b)return a===b;if(Array.isArray(a)||Array.isArray(b))return!(!Array.isArray(a)||!Array.isArray(b))&&arrays.equals(a,b);if(Object.keys(a).length!==Object.keys(b).length)return!1;for(const key in a)if(!EditorOptionsUtil._deepEquals(a[key],b[key]))return!1;return!0}static checkEquals(a,b){const result=[];let somethingChanged=!1;for(const editorOption of editorOptionsRegistry){const changed=!EditorOptionsUtil._deepEquals(a._read(editorOption.id),b._read(editorOption.id));result[editorOption.id]=changed,changed&&(somethingChanged=!0)}return somethingChanged?new ConfigurationChangedEvent(result):null}static applyUpdate(options,update){let changed=!1;for(const editorOption of editorOptionsRegistry)if(update.hasOwnProperty(editorOption.name)){const result=editorOption.applyUpdate(options[editorOption.name],update[editorOption.name]);options[editorOption.name]=result.newValue,changed=changed||result.didChange}return changed}}function deepCloneAndMigrateOptions(_options){const options=objects.deepClone(_options);return migrateOptions(options),options}