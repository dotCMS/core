var StorageState,__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{ThrottledDelayer}from"../../../common/async.js";import{Emitter,Event}from"../../../common/event.js";import{Disposable}from"../../../common/lifecycle.js";import{isUndefinedOrNull}from"../../../common/types.js";!function(StorageState){StorageState[StorageState.None=0]="None",StorageState[StorageState.Initialized=1]="Initialized",StorageState[StorageState.Closed=2]="Closed"}(StorageState||(StorageState={}));export class Storage extends Disposable{constructor(database,options=Object.create(null)){super(),this.database=database,this.options=options,this._onDidChangeStorage=this._register(new Emitter),this.onDidChangeStorage=this._onDidChangeStorage.event,this.state=StorageState.None,this.cache=new Map,this.flushDelayer=new ThrottledDelayer(Storage.DEFAULT_FLUSH_DELAY),this.pendingDeletes=new Set,this.pendingInserts=new Map,this.whenFlushedCallbacks=[],this.registerListeners()}registerListeners(){this._register(this.database.onDidChangeItemsExternal((e=>this.onDidChangeItemsExternal(e))))}onDidChangeItemsExternal(e){var _a,_b;null===(_a=e.changed)||void 0===_a||_a.forEach(((value,key)=>this.accept(key,value))),null===(_b=e.deleted)||void 0===_b||_b.forEach((key=>this.accept(key,void 0)))}accept(key,value){if(this.state===StorageState.Closed)return;let changed=!1;if(isUndefinedOrNull(value))changed=this.cache.delete(key);else{this.cache.get(key)!==value&&(this.cache.set(key,value),changed=!0)}changed&&this._onDidChangeStorage.fire(key)}get(key,fallbackValue){const value=this.cache.get(key);return isUndefinedOrNull(value)?fallbackValue:value}getBoolean(key,fallbackValue){const value=this.get(key);return isUndefinedOrNull(value)?fallbackValue:"true"===value}getNumber(key,fallbackValue){const value=this.get(key);return isUndefinedOrNull(value)?fallbackValue:parseInt(value,10)}set(key,value){return __awaiter(this,void 0,void 0,(function*(){if(this.state===StorageState.Closed)return;if(isUndefinedOrNull(value))return this.delete(key);const valueStr=String(value);return this.cache.get(key)!==valueStr?(this.cache.set(key,valueStr),this.pendingInserts.set(key,valueStr),this.pendingDeletes.delete(key),this._onDidChangeStorage.fire(key),this.doFlush()):void 0}))}delete(key){return __awaiter(this,void 0,void 0,(function*(){if(this.state===StorageState.Closed)return;return this.cache.delete(key)?(this.pendingDeletes.has(key)||this.pendingDeletes.add(key),this.pendingInserts.delete(key),this._onDidChangeStorage.fire(key),this.doFlush()):void 0}))}get hasPending(){return this.pendingInserts.size>0||this.pendingDeletes.size>0}flushPending(){return __awaiter(this,void 0,void 0,(function*(){if(!this.hasPending)return;const updateRequest={insert:this.pendingInserts,delete:this.pendingDeletes};return this.pendingDeletes=new Set,this.pendingInserts=new Map,this.database.updateItems(updateRequest).finally((()=>{var _a;if(!this.hasPending)for(;this.whenFlushedCallbacks.length;)null===(_a=this.whenFlushedCallbacks.pop())||void 0===_a||_a()}))}))}doFlush(delay){return __awaiter(this,void 0,void 0,(function*(){return this.flushDelayer.trigger((()=>this.flushPending()),delay)}))}dispose(){this.flushDelayer.dispose(),super.dispose()}}Storage.DEFAULT_FLUSH_DELAY=100;export class InMemoryStorageDatabase{constructor(){this.onDidChangeItemsExternal=Event.None,this.items=new Map}updateItems(request){return __awaiter(this,void 0,void 0,(function*(){request.insert&&request.insert.forEach(((value,key)=>this.items.set(key,value))),request.delete&&request.delete.forEach((key=>this.items.delete(key)))}))}}