import*as dom from"../../dom.js";import{DomEmitter}from"../../event.js";import{renderFormattedText,renderText}from"../../formattedTextRenderer.js";import{ActionBar}from"../actionbar/actionbar.js";import*as aria from"../aria/aria.js";import{ScrollableElement}from"../scrollbar/scrollableElement.js";import{Widget}from"../widget.js";import{Color}from"../../../common/color.js";import{Emitter,Event}from"../../../common/event.js";import{HistoryNavigator}from"../../../common/history.js";import{mixin}from"../../../common/objects.js";import"./inputBox.css";import*as nls from"../../../../nls.js";const $=dom.$,defaultOpts={inputBackground:Color.fromHex("#3C3C3C"),inputForeground:Color.fromHex("#CCCCCC"),inputValidationInfoBorder:Color.fromHex("#55AAFF"),inputValidationInfoBackground:Color.fromHex("#063B49"),inputValidationWarningBorder:Color.fromHex("#B89500"),inputValidationWarningBackground:Color.fromHex("#352A05"),inputValidationErrorBorder:Color.fromHex("#BE1100"),inputValidationErrorBackground:Color.fromHex("#5A1D1D")};export class InputBox extends Widget{constructor(container,contextViewProvider,options){var _a;super(),this.state="idle",this.maxHeight=Number.POSITIVE_INFINITY,this._onDidChange=this._register(new Emitter),this.onDidChange=this._onDidChange.event,this._onDidHeightChange=this._register(new Emitter),this.onDidHeightChange=this._onDidHeightChange.event,this.contextViewProvider=contextViewProvider,this.options=options||Object.create(null),mixin(this.options,defaultOpts,!1),this.message=null,this.placeholder=this.options.placeholder||"",this.tooltip=null!==(_a=this.options.tooltip)&&void 0!==_a?_a:this.placeholder||"",this.ariaLabel=this.options.ariaLabel||"",this.inputBackground=this.options.inputBackground,this.inputForeground=this.options.inputForeground,this.inputBorder=this.options.inputBorder,this.inputValidationInfoBorder=this.options.inputValidationInfoBorder,this.inputValidationInfoBackground=this.options.inputValidationInfoBackground,this.inputValidationInfoForeground=this.options.inputValidationInfoForeground,this.inputValidationWarningBorder=this.options.inputValidationWarningBorder,this.inputValidationWarningBackground=this.options.inputValidationWarningBackground,this.inputValidationWarningForeground=this.options.inputValidationWarningForeground,this.inputValidationErrorBorder=this.options.inputValidationErrorBorder,this.inputValidationErrorBackground=this.options.inputValidationErrorBackground,this.inputValidationErrorForeground=this.options.inputValidationErrorForeground,this.options.validationOptions&&(this.validation=this.options.validationOptions.validation),this.element=dom.append(container,$(".monaco-inputbox.idle"));let tagName=this.options.flexibleHeight?"textarea":"input",wrapper=dom.append(this.element,$(".ibwrapper"));if(this.input=dom.append(wrapper,$(tagName+".input.empty")),this.input.setAttribute("autocorrect","off"),this.input.setAttribute("autocapitalize","off"),this.input.setAttribute("spellcheck","false"),this.onfocus(this.input,(()=>this.element.classList.add("synthetic-focus"))),this.onblur(this.input,(()=>this.element.classList.remove("synthetic-focus"))),this.options.flexibleHeight){this.maxHeight="number"==typeof this.options.flexibleMaxHeight?this.options.flexibleMaxHeight:Number.POSITIVE_INFINITY,this.mirror=dom.append(wrapper,$("div.mirror")),this.mirror.innerText=" ",this.scrollableElement=new ScrollableElement(this.element,{vertical:1}),this.options.flexibleWidth&&(this.input.setAttribute("wrap","off"),this.mirror.style.whiteSpace="pre",this.mirror.style.wordWrap="initial"),dom.append(container,this.scrollableElement.getDomNode()),this._register(this.scrollableElement),this._register(this.scrollableElement.onScroll((e=>this.input.scrollTop=e.scrollTop)));const onSelectionChange=this._register(new DomEmitter(document,"selectionchange")),onAnchoredSelectionChange=Event.filter(onSelectionChange.event,(()=>{const selection=document.getSelection();return(null==selection?void 0:selection.anchorNode)===wrapper}));this._register(onAnchoredSelectionChange(this.updateScrollDimensions,this)),this._register(this.onDidHeightChange(this.updateScrollDimensions,this))}else this.input.type=this.options.type||"text",this.input.setAttribute("wrap","off");this.ariaLabel&&this.input.setAttribute("aria-label",this.ariaLabel),this.placeholder&&!this.options.showPlaceholderOnFocus&&this.setPlaceHolder(this.placeholder),this.tooltip&&this.setTooltip(this.tooltip),this.oninput(this.input,(()=>this.onValueChange())),this.onblur(this.input,(()=>this.onBlur())),this.onfocus(this.input,(()=>this.onFocus())),this.ignoreGesture(this.input),setTimeout((()=>this.updateMirror()),0),this.options.actions&&(this.actionbar=this._register(new ActionBar(this.element)),this.actionbar.push(this.options.actions,{icon:!0,label:!1})),this.applyStyles()}onBlur(){this._hideMessage(),this.options.showPlaceholderOnFocus&&this.input.setAttribute("placeholder","")}onFocus(){this._showMessage(),this.options.showPlaceholderOnFocus&&this.input.setAttribute("placeholder",this.placeholder||"")}setPlaceHolder(placeHolder){this.placeholder=placeHolder,this.input.setAttribute("placeholder",placeHolder)}setTooltip(tooltip){this.tooltip=tooltip,this.input.title=tooltip}setAriaLabel(label){this.ariaLabel=label,label?this.input.setAttribute("aria-label",this.ariaLabel):this.input.removeAttribute("aria-label")}getAriaLabel(){return this.ariaLabel}get inputElement(){return this.input}get value(){return this.input.value}set value(newValue){this.input.value!==newValue&&(this.input.value=newValue,this.onValueChange())}get height(){return"number"==typeof this.cachedHeight?this.cachedHeight:dom.getTotalHeight(this.element)}focus(){this.input.focus()}blur(){this.input.blur()}hasFocus(){return document.activeElement===this.input}select(range=null){this.input.select(),range&&(this.input.setSelectionRange(range.start,range.end),range.end===this.input.value.length&&(this.input.scrollLeft=this.input.scrollWidth))}isSelectionAtEnd(){return this.input.selectionEnd===this.input.value.length&&this.input.selectionStart===this.input.selectionEnd}enable(){this.input.removeAttribute("disabled")}disable(){this.blur(),this.input.disabled=!0,this._hideMessage()}get width(){return dom.getTotalWidth(this.input)}set width(width){if(this.options.flexibleHeight&&this.options.flexibleWidth){let horizontalPadding=0;if(this.mirror){horizontalPadding=(parseFloat(this.mirror.style.paddingLeft||"")||0)+(parseFloat(this.mirror.style.paddingRight||"")||0)}this.input.style.width=width-horizontalPadding+"px"}else this.input.style.width=width+"px";this.mirror&&(this.mirror.style.width=width+"px")}set paddingRight(paddingRight){this.input.style.width=`calc(100% - ${paddingRight}px)`,this.mirror&&(this.mirror.style.paddingRight=paddingRight+"px")}updateScrollDimensions(){if("number"!=typeof this.cachedContentHeight||"number"!=typeof this.cachedHeight||!this.scrollableElement)return;const scrollHeight=this.cachedContentHeight,height=this.cachedHeight,scrollTop=this.input.scrollTop;this.scrollableElement.setScrollDimensions({scrollHeight,height}),this.scrollableElement.setScrollPosition({scrollTop})}showMessage(message,force){this.message=message,this.element.classList.remove("idle"),this.element.classList.remove("info"),this.element.classList.remove("warning"),this.element.classList.remove("error"),this.element.classList.add(this.classForType(message.type));const styles=this.stylesForType(this.message.type);this.element.style.border=styles.border?`1px solid ${styles.border}`:"",(this.hasFocus()||force)&&this._showMessage()}hideMessage(){this.message=null,this.element.classList.remove("info"),this.element.classList.remove("warning"),this.element.classList.remove("error"),this.element.classList.add("idle"),this._hideMessage(),this.applyStyles()}validate(){let errorMsg=null;return this.validation&&(errorMsg=this.validation(this.value),errorMsg?(this.inputElement.setAttribute("aria-invalid","true"),this.showMessage(errorMsg)):this.inputElement.hasAttribute("aria-invalid")&&(this.inputElement.removeAttribute("aria-invalid"),this.hideMessage())),null==errorMsg?void 0:errorMsg.type}stylesForType(type){switch(type){case 1:return{border:this.inputValidationInfoBorder,background:this.inputValidationInfoBackground,foreground:this.inputValidationInfoForeground};case 2:return{border:this.inputValidationWarningBorder,background:this.inputValidationWarningBackground,foreground:this.inputValidationWarningForeground};default:return{border:this.inputValidationErrorBorder,background:this.inputValidationErrorBackground,foreground:this.inputValidationErrorForeground}}}classForType(type){switch(type){case 1:return"info";case 2:return"warning";default:return"error"}}_showMessage(){if(!this.contextViewProvider||!this.message)return;let div,alertText,layout=()=>div.style.width=dom.getTotalWidth(this.element)+"px";this.contextViewProvider.showContextView({getAnchor:()=>this.element,anchorAlignment:1,render:container=>{if(!this.message)return null;div=dom.append(container,$(".monaco-inputbox-container")),layout();const renderOptions={inline:!0,className:"monaco-inputbox-message"},spanElement=this.message.formatContent?renderFormattedText(this.message.content,renderOptions):renderText(this.message.content,renderOptions);spanElement.classList.add(this.classForType(this.message.type));const styles=this.stylesForType(this.message.type);return spanElement.style.backgroundColor=styles.background?styles.background.toString():"",spanElement.style.color=styles.foreground?styles.foreground.toString():"",spanElement.style.border=styles.border?`1px solid ${styles.border}`:"",dom.append(div,spanElement),null},onHide:()=>{this.state="closed"},layout}),alertText=3===this.message.type?nls.localize("alertErrorMessage","Error: {0}",this.message.content):2===this.message.type?nls.localize("alertWarningMessage","Warning: {0}",this.message.content):nls.localize("alertInfoMessage","Info: {0}",this.message.content),aria.alert(alertText),this.state="open"}_hideMessage(){this.contextViewProvider&&("open"===this.state&&this.contextViewProvider.hideContextView(),this.state="idle")}onValueChange(){this._onDidChange.fire(this.value),this.validate(),this.updateMirror(),this.input.classList.toggle("empty",!this.value),"open"===this.state&&this.contextViewProvider&&this.contextViewProvider.layout()}updateMirror(){if(!this.mirror)return;const value=this.value,suffix=10===value.charCodeAt(value.length-1)?" ":"";(value+suffix).replace(/\u000c/g,"")?this.mirror.textContent=value+suffix:this.mirror.innerText=" ",this.layout()}style(styles){this.inputBackground=styles.inputBackground,this.inputForeground=styles.inputForeground,this.inputBorder=styles.inputBorder,this.inputValidationInfoBackground=styles.inputValidationInfoBackground,this.inputValidationInfoForeground=styles.inputValidationInfoForeground,this.inputValidationInfoBorder=styles.inputValidationInfoBorder,this.inputValidationWarningBackground=styles.inputValidationWarningBackground,this.inputValidationWarningForeground=styles.inputValidationWarningForeground,this.inputValidationWarningBorder=styles.inputValidationWarningBorder,this.inputValidationErrorBackground=styles.inputValidationErrorBackground,this.inputValidationErrorForeground=styles.inputValidationErrorForeground,this.inputValidationErrorBorder=styles.inputValidationErrorBorder,this.applyStyles()}applyStyles(){const background=this.inputBackground?this.inputBackground.toString():"",foreground=this.inputForeground?this.inputForeground.toString():"",border=this.inputBorder?this.inputBorder.toString():"";this.element.style.backgroundColor=background,this.element.style.color=foreground,this.input.style.backgroundColor="inherit",this.input.style.color=foreground,this.element.style.borderWidth=border?"1px":"",this.element.style.borderStyle=border?"solid":"",this.element.style.borderColor=border}layout(){if(!this.mirror)return;const previousHeight=this.cachedContentHeight;this.cachedContentHeight=dom.getTotalHeight(this.mirror),previousHeight!==this.cachedContentHeight&&(this.cachedHeight=Math.min(this.cachedContentHeight,this.maxHeight),this.input.style.height=this.cachedHeight+"px",this._onDidHeightChange.fire(this.cachedContentHeight))}insertAtCursor(text){const inputElement=this.inputElement,start=inputElement.selectionStart,end=inputElement.selectionEnd,content=inputElement.value;null!==start&&null!==end&&(this.value=content.substr(0,start)+text+content.substr(end),inputElement.setSelectionRange(start+1,start+1),this.layout())}dispose(){this._hideMessage(),this.message=null,this.actionbar&&this.actionbar.dispose(),super.dispose()}}export class HistoryInputBox extends InputBox{constructor(container,contextViewProvider,options){const NLS_PLACEHOLDER_HISTORY_HINT=nls.localize({key:"history.inputbox.hint",comment:["Text will be prefixed with ⇅ plus a single space, then used as a hint where input field keeps history"]},"for history"),NLS_PLACEHOLDER_HISTORY_HINT_SUFFIX=` or ⇅ ${NLS_PLACEHOLDER_HISTORY_HINT}`,NLS_PLACEHOLDER_HISTORY_HINT_SUFFIX_IN_PARENS=` (⇅ ${NLS_PLACEHOLDER_HISTORY_HINT})`;super(container,contextViewProvider,options),this.history=new HistoryNavigator(options.history,100);const addSuffix=()=>{if(options.showHistoryHint&&options.showHistoryHint()&&!this.placeholder.endsWith(NLS_PLACEHOLDER_HISTORY_HINT_SUFFIX)&&!this.placeholder.endsWith(NLS_PLACEHOLDER_HISTORY_HINT_SUFFIX_IN_PARENS)&&this.history.getHistory().length){const suffix=this.placeholder.endsWith(")")?NLS_PLACEHOLDER_HISTORY_HINT_SUFFIX:NLS_PLACEHOLDER_HISTORY_HINT_SUFFIX_IN_PARENS,suffixedPlaceholder=this.placeholder+suffix;options.showPlaceholderOnFocus&&document.activeElement!==this.input?this.placeholder=suffixedPlaceholder:this.setPlaceHolder(suffixedPlaceholder)}};this.observer=new MutationObserver(((mutationList,observer)=>{mutationList.forEach((mutation=>{mutation.target.textContent||addSuffix()}))})),this.observer.observe(this.input,{attributeFilter:["class"]}),this.onfocus(this.input,(()=>addSuffix())),this.onblur(this.input,(()=>{const resetPlaceholder=historyHint=>{if(this.placeholder.endsWith(historyHint)){const revertedPlaceholder=this.placeholder.slice(0,this.placeholder.length-historyHint.length);return options.showPlaceholderOnFocus?this.placeholder=revertedPlaceholder:this.setPlaceHolder(revertedPlaceholder),!0}return!1};resetPlaceholder(NLS_PLACEHOLDER_HISTORY_HINT_SUFFIX_IN_PARENS)||resetPlaceholder(NLS_PLACEHOLDER_HISTORY_HINT_SUFFIX)}))}dispose(){super.dispose(),this.observer&&(this.observer.disconnect(),this.observer=void 0)}addToHistory(){this.value&&this.value!==this.getCurrentValue()&&this.history.add(this.value)}showNextValue(){this.history.has(this.value)||this.addToHistory();let next=this.getNextValue();next&&(next=next===this.value?this.getNextValue():next),next&&(this.value=next,aria.status(this.value))}showPreviousValue(){this.history.has(this.value)||this.addToHistory();let previous=this.getPreviousValue();previous&&(previous=previous===this.value?this.getPreviousValue():previous),previous&&(this.value=previous,aria.status(this.value))}getCurrentValue(){let currentValue=this.history.current();return currentValue||(currentValue=this.history.last(),this.history.next()),currentValue}getPreviousValue(){return this.history.previous()||this.history.first()}getNextValue(){return this.history.next()||this.history.last()}}