import{$,append,clearNode,createStyleSheet}from"../../dom.js";import{List}from"../list/listWidget.js";import{SplitView}from"../splitview/splitview.js";import{Emitter,Event}from"../../../common/event.js";import{DisposableStore}from"../../../common/lifecycle.js";import"./table.css";class TableListRenderer{constructor(columns,renderers,getColumnSize){this.columns=columns,this.getColumnSize=getColumnSize,this.templateId=TableListRenderer.TemplateId,this.renderedTemplates=new Set;const rendererMap=new Map(renderers.map((r=>[r.templateId,r])));this.renderers=[];for(const column of columns){const renderer=rendererMap.get(column.templateId);if(!renderer)throw new Error(`Table cell renderer for template id ${column.templateId} not found.`);this.renderers.push(renderer)}}renderTemplate(container){const rowContainer=append(container,$(".monaco-table-tr")),cellContainers=[],cellTemplateData=[];for(let i=0;i<this.columns.length;i++){const renderer=this.renderers[i],cellContainer=append(rowContainer,$(".monaco-table-td",{"data-col-index":i}));cellContainer.style.width=`${this.getColumnSize(i)}px`,cellContainers.push(cellContainer),cellTemplateData.push(renderer.renderTemplate(cellContainer))}const result={container,cellContainers,cellTemplateData};return this.renderedTemplates.add(result),result}renderElement(element,index,templateData,height){for(let i=0;i<this.columns.length;i++){const cell=this.columns[i].project(element);this.renderers[i].renderElement(cell,index,templateData.cellTemplateData[i],height)}}disposeElement(element,index,templateData,height){for(let i=0;i<this.columns.length;i++){const renderer=this.renderers[i];if(renderer.disposeElement){const cell=this.columns[i].project(element);renderer.disposeElement(cell,index,templateData.cellTemplateData[i],height)}}}disposeTemplate(templateData){for(let i=0;i<this.columns.length;i++){this.renderers[i].disposeTemplate(templateData.cellTemplateData[i])}clearNode(templateData.container),this.renderedTemplates.delete(templateData)}layoutColumn(index,size){for(const{cellContainers}of this.renderedTemplates)cellContainers[index].style.width=`${size}px`}}function asListVirtualDelegate(delegate){return{getHeight:row=>delegate.getHeight(row),getTemplateId:()=>TableListRenderer.TemplateId}}TableListRenderer.TemplateId="row";class ColumnHeader{constructor(column,index){this.column=column,this.index=index,this._onDidLayout=new Emitter,this.onDidLayout=this._onDidLayout.event,this.element=$(".monaco-table-th",{"data-col-index":index,title:column.tooltip},column.label)}get minimumSize(){var _a;return null!==(_a=this.column.minimumWidth)&&void 0!==_a?_a:120}get maximumSize(){var _a;return null!==(_a=this.column.maximumWidth)&&void 0!==_a?_a:Number.POSITIVE_INFINITY}get onDidChange(){var _a;return null!==(_a=this.column.onDidChangeWidthConstraints)&&void 0!==_a?_a:Event.None}layout(size){this._onDidLayout.fire([this.index,size])}}export class Table{constructor(user,container,virtualDelegate,columns,renderers,_options){this.virtualDelegate=virtualDelegate,this.domId="table_id_"+ ++Table.InstanceCount,this.disposables=new DisposableStore,this.cachedWidth=0,this.cachedHeight=0,this.domNode=append(container,$(`.monaco-table.${this.domId}`));const headers=columns.map(((c,i)=>new ColumnHeader(c,i))),descriptor={size:headers.reduce(((a,b)=>a+b.column.weight),0),views:headers.map((view=>({size:view.column.weight,view})))};this.splitview=this.disposables.add(new SplitView(this.domNode,{orientation:1,scrollbarVisibility:2,getSashOrthogonalSize:()=>this.cachedHeight,descriptor})),this.splitview.el.style.height=`${virtualDelegate.headerRowHeight}px`,this.splitview.el.style.lineHeight=`${virtualDelegate.headerRowHeight}px`;const renderer=new TableListRenderer(columns,renderers,(i=>this.splitview.getViewSize(i)));this.list=this.disposables.add(new List(user,this.domNode,asListVirtualDelegate(virtualDelegate),[renderer],_options)),Event.any(...headers.map((h=>h.onDidLayout)))((([index,size])=>renderer.layoutColumn(index,size)),null,this.disposables),this.splitview.onDidSashReset((index=>{const totalWeight=columns.reduce(((r,c)=>r+c.weight),0),size=columns[index].weight/totalWeight*this.cachedWidth;this.splitview.resizeView(index,size)}),null,this.disposables),this.styleElement=createStyleSheet(this.domNode),this.style({})}get onDidChangeFocus(){return this.list.onDidChangeFocus}get onDidChangeSelection(){return this.list.onDidChangeSelection}get onMouseDblClick(){return this.list.onMouseDblClick}get onPointer(){return this.list.onPointer}get onDidFocus(){return this.list.onDidFocus}get onDidDispose(){return this.list.onDidDispose}updateOptions(options){this.list.updateOptions(options)}splice(start,deleteCount,elements=[]){this.list.splice(start,deleteCount,elements)}getHTMLElement(){return this.domNode}style(styles){const content=[];content.push(`.monaco-table.${this.domId} > .monaco-split-view2 .monaco-sash.vertical::before {\n\t\t\ttop: ${this.virtualDelegate.headerRowHeight+1}px;\n\t\t\theight: calc(100% - ${this.virtualDelegate.headerRowHeight}px);\n\t\t}`),this.styleElement.textContent=content.join("\n"),this.list.style(styles)}getSelectedElements(){return this.list.getSelectedElements()}getSelection(){return this.list.getSelection()}getFocus(){return this.list.getFocus()}dispose(){this.disposables.dispose()}}Table.InstanceCount=0;