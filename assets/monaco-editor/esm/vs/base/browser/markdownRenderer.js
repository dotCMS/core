import*as DOM from"./dom.js";import*as dompurify from"./dompurify/dompurify.js";import{DomEmitter}from"./event.js";import{createElement}from"./formattedTextRenderer.js";import{StandardMouseEvent}from"./mouseEvent.js";import{renderLabelWithIcons}from"./ui/iconLabel/iconLabels.js";import{raceCancellation}from"../common/async.js";import{CancellationTokenSource}from"../common/cancellation.js";import{onUnexpectedError}from"../common/errors.js";import{Event}from"../common/event.js";import{parseHrefAndDimensions,removeMarkdownEscapes}from"../common/htmlContent.js";import{markdownEscapeEscapedIcons}from"../common/iconLabels.js";import{defaultGenerator}from"../common/idGenerator.js";import{DisposableStore}from"../common/lifecycle.js";import{marked}from"../common/marked/marked.js";import{parse}from"../common/marshalling.js";import{FileAccess,Schemas}from"../common/network.js";import{cloneAndChange}from"../common/objects.js";import{dirname,resolvePath}from"../common/resources.js";import{escape}from"../common/strings.js";import{URI}from"../common/uri.js";export function renderMarkdown(markdown,options={},markedOptions={}){var _a;const disposables=new DisposableStore;let isDisposed=!1;const cts=disposables.add(new CancellationTokenSource),element=createElement(options),_uriMassage=function(part){let data;try{data=parse(decodeURIComponent(part))}catch(e){}return data?(data=cloneAndChange(data,(value=>markdown.uris&&markdown.uris[value]?URI.revive(markdown.uris[value]):void 0)),encodeURIComponent(JSON.stringify(data))):part},_href=function(href,isDomUri){const data=markdown.uris&&markdown.uris[href];let uri=URI.revive(data);return isDomUri?href.startsWith(Schemas.data+":")?href:(uri||(uri=URI.parse(href)),FileAccess.asBrowserUri(uri).toString(!0)):uri?URI.parse(href).toString()===uri.toString()?href:(uri.query&&(uri=uri.with({query:_uriMassage(uri.query)})),uri.toString()):href};let signalInnerHTML;const withInnerHTML=new Promise((c=>signalInnerHTML=c)),renderer=new marked.Renderer;if(renderer.image=(href,title,text)=>{let dimensions=[],attributes=[];return href&&(({href,dimensions}=parseHrefAndDimensions(href)),attributes.push(`src="${href}"`)),text&&attributes.push(`alt="${text}"`),title&&attributes.push(`title="${title}"`),dimensions.length&&(attributes=attributes.concat(dimensions)),"<img "+attributes.join(" ")+">"},renderer.link=(href,title,text)=>"string"!=typeof href?"":(href===text&&(text=removeMarkdownEscapes(text)),href=_href(href,!1),markdown.baseUri&&(href=resolveWithBaseUri(URI.from(markdown.baseUri),href)),title="string"==typeof title?removeMarkdownEscapes(title):"",!(href=removeMarkdownEscapes(href))||/^data:|javascript:/i.test(href)||/^command:/i.test(href)&&!markdown.isTrusted||/^command:(\/\/\/)?_workbench\.downloadResource/i.test(href)?text:`<a data-href="${href=href.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}" title="${title||href}">${text}</a>`),renderer.paragraph=text=>`<p>${text}</p>`,options.codeBlockRenderer&&(renderer.code=(code,lang)=>{const value=options.codeBlockRenderer(null!=lang?lang:"",code),id=defaultGenerator.nextId();return raceCancellation(Promise.all([value,withInnerHTML]),cts.token).then((values=>{var _a;if(!isDisposed&&values){const span=element.querySelector(`div[data-code="${id}"]`);span&&DOM.reset(span,values[0]),null===(_a=options.asyncRenderCallback)||void 0===_a||_a.call(options)}})).catch((()=>{})),`<div class="code" data-code="${id}">${escape(code)}</div>`}),options.actionHandler){const onClick=options.actionHandler.disposables.add(new DomEmitter(element,"click")),onAuxClick=options.actionHandler.disposables.add(new DomEmitter(element,"auxclick"));options.actionHandler.disposables.add(Event.any(onClick.event,onAuxClick.event)((e=>{const mouseEvent=new StandardMouseEvent(e);if(!mouseEvent.leftButton&&!mouseEvent.middleButton)return;let target=mouseEvent.target;if("A"===target.tagName||(target=target.parentElement,target&&"A"===target.tagName))try{let href=target.dataset.href;href&&(markdown.baseUri&&(href=resolveWithBaseUri(URI.from(markdown.baseUri),href)),options.actionHandler.callback(href,mouseEvent))}catch(err){onUnexpectedError(err)}finally{mouseEvent.preventDefault()}})))}markdown.supportHtml||(markedOptions.sanitizer=html=>(markdown.isTrusted?html.match(/^(<span[^>]+>)|(<\/\s*span>)$/):void 0)?html:"",markedOptions.sanitize=!0,markedOptions.silent=!0),markedOptions.renderer=renderer;let value=null!==(_a=markdown.value)&&void 0!==_a?_a:"";value.length>1e5&&(value=`${value.substr(0,1e5)}â€¦`),markdown.supportThemeIcons&&(value=markdownEscapeEscapedIcons(value));let renderedMarkdown=marked.parse(value,markedOptions);if(markdown.supportThemeIcons){renderedMarkdown=renderLabelWithIcons(renderedMarkdown).map((e=>"string"==typeof e?e:e.outerHTML)).join("")}const markdownHtmlDoc=(new DOMParser).parseFromString(sanitizeRenderedMarkdown(markdown,renderedMarkdown),"text/html");if(markdownHtmlDoc.body.querySelectorAll("img").forEach((img=>{const src=img.getAttribute("src");if(src){let href=src;try{markdown.baseUri&&(href=resolveWithBaseUri(URI.from(markdown.baseUri),href))}catch(err){}img.src=_href(href,!0)}})),element.innerHTML=sanitizeRenderedMarkdown(markdown,markdownHtmlDoc.body.innerHTML),signalInnerHTML(),options.asyncRenderCallback)for(const img of element.getElementsByTagName("img")){const listener=disposables.add(DOM.addDisposableListener(img,"load",(()=>{listener.dispose(),options.asyncRenderCallback()})))}return{element,dispose:()=>{isDisposed=!0,cts.cancel(),disposables.dispose()}}}function resolveWithBaseUri(baseUri,href){return/^\w[\w\d+.-]*:/.test(href)?href:baseUri.path.endsWith("/")?resolvePath(baseUri,href).toString():resolvePath(dirname(baseUri),href).toString()}function sanitizeRenderedMarkdown(options,renderedMarkdown){const{config,allowedSchemes}=getSanitizerOptions(options);dompurify.addHook("uponSanitizeAttribute",((element,e)=>{if("style"!==e.attrName&&"class"!==e.attrName);else{if("SPAN"===element.tagName){if("style"===e.attrName)return void(e.keepAttr=/^(color\:#[0-9a-fA-F]+;)?(background-color\:#[0-9a-fA-F]+;)?$/.test(e.attrValue));if("class"===e.attrName)return void(e.keepAttr=/^codicon codicon-[a-z\-]+( codicon-modifier-[a-z\-]+)?$/.test(e.attrValue))}e.keepAttr=!1}}));const anchor=document.createElement("a");dompurify.addHook("afterSanitizeAttributes",(node=>{for(const attr of["href","src"])node.hasAttribute(attr)&&(anchor.href=node.getAttribute(attr),allowedSchemes.includes(anchor.protocol.replace(/:$/,""))||node.removeAttribute(attr))}));try{return dompurify.sanitize(renderedMarkdown,Object.assign(Object.assign({},config),{RETURN_TRUSTED_TYPE:!0}))}finally{dompurify.removeHook("uponSanitizeAttribute"),dompurify.removeHook("afterSanitizeAttributes")}}function getSanitizerOptions(options){const allowedSchemes=[Schemas.http,Schemas.https,Schemas.mailto,Schemas.data,Schemas.file,Schemas.vscodeFileResource,Schemas.vscodeRemote,Schemas.vscodeRemoteResource];return options.isTrusted&&allowedSchemes.push(Schemas.command),{config:{ALLOWED_TAGS:["ul","li","p","b","i","code","blockquote","ol","h1","h2","h3","h4","h5","h6","hr","em","pre","table","thead","tbody","tr","th","td","div","del","a","strong","br","img","span"],ALLOWED_ATTR:["href","data-href","target","title","src","alt","class","style","data-code","width","height","align"],ALLOW_UNKNOWN_PROTOCOLS:!0},allowedSchemes}}