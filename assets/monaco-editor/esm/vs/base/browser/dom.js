import*as browser from"./browser.js";import{BrowserFeatures}from"./canIUse.js";import{StandardKeyboardEvent}from"./keyboardEvent.js";import{StandardMouseEvent}from"./mouseEvent.js";import{TimeoutTimer}from"../common/async.js";import{onUnexpectedError}from"../common/errors.js";import*as event from"../common/event.js";import{Disposable,DisposableStore,toDisposable}from"../common/lifecycle.js";import{FileAccess,RemoteAuthorities}from"../common/network.js";import*as platform from"../common/platform.js";export function clearNode(node){for(;node.firstChild;)node.firstChild.remove()}export function isInDOM(node){var _a;return null!==(_a=null==node?void 0:node.isConnected)&&void 0!==_a&&_a}class DomListener{constructor(node,type,handler,options){this._node=node,this._type=type,this._handler=handler,this._options=options||!1,this._node.addEventListener(this._type,this._handler,this._options)}dispose(){this._handler&&(this._node.removeEventListener(this._type,this._handler,this._options),this._node=null,this._handler=null)}}export function addDisposableListener(node,type,handler,useCaptureOrOptions){return new DomListener(node,type,handler,useCaptureOrOptions)}function _wrapAsStandardMouseEvent(handler){return function(e){return handler(new StandardMouseEvent(e))}}function _wrapAsStandardKeyboardEvent(handler){return function(e){return handler(new StandardKeyboardEvent(e))}}export let addStandardDisposableListener=function addStandardDisposableListener(node,type,handler,useCapture){let wrapHandler=handler;return"click"===type||"mousedown"===type?wrapHandler=_wrapAsStandardMouseEvent(handler):"keydown"!==type&&"keypress"!==type&&"keyup"!==type||(wrapHandler=_wrapAsStandardKeyboardEvent(handler)),addDisposableListener(node,type,wrapHandler,useCapture)};export let addStandardDisposableGenericMouseDownListener=function addStandardDisposableListener(node,handler,useCapture){return addDisposableGenericMouseDownListener(node,_wrapAsStandardMouseEvent(handler),useCapture)};export let addStandardDisposableGenericMouseUpListener=function addStandardDisposableListener(node,handler,useCapture){return addDisposableGenericMouseUpListener(node,_wrapAsStandardMouseEvent(handler),useCapture)};export function addDisposableGenericMouseDownListener(node,handler,useCapture){return addDisposableListener(node,platform.isIOS&&BrowserFeatures.pointerEvents?EventType.POINTER_DOWN:EventType.MOUSE_DOWN,handler,useCapture)}export function addDisposableGenericMouseUpListener(node,handler,useCapture){return addDisposableListener(node,platform.isIOS&&BrowserFeatures.pointerEvents?EventType.POINTER_UP:EventType.MOUSE_UP,handler,useCapture)}export function addDisposableNonBubblingMouseOutListener(node,handler){return addDisposableListener(node,"mouseout",(e=>{let toElement=e.relatedTarget;for(;toElement&&toElement!==node;)toElement=toElement.parentNode;toElement!==node&&handler(e)}))}export function addDisposableNonBubblingPointerOutListener(node,handler){return addDisposableListener(node,"pointerout",(e=>{let toElement=e.relatedTarget;for(;toElement&&toElement!==node;)toElement=toElement.parentNode;toElement!==node&&handler(e)}))}export function createEventEmitter(target,type,options){let domListener=null;const handler=e=>result.fire(e),result=new event.Emitter({onFirstListenerAdd:()=>{domListener||(domListener=new DomListener(target,type,handler,options))},onLastListenerRemove:()=>{domListener&&(domListener.dispose(),domListener=null)}});return result}let _animationFrame=null;function doRequestAnimationFrame(callback){if(!_animationFrame){const emulatedRequestAnimationFrame=callback=>setTimeout((()=>callback((new Date).getTime())),0);_animationFrame=self.requestAnimationFrame||self.msRequestAnimationFrame||self.webkitRequestAnimationFrame||self.mozRequestAnimationFrame||self.oRequestAnimationFrame||emulatedRequestAnimationFrame}return _animationFrame.call(self,callback)}export let runAtThisOrScheduleAtNextAnimationFrame;export let scheduleAtNextAnimationFrame;class AnimationFrameQueueItem{constructor(runner,priority=0){this._runner=runner,this.priority=priority,this._canceled=!1}dispose(){this._canceled=!0}execute(){if(!this._canceled)try{this._runner()}catch(e){onUnexpectedError(e)}}static sort(a,b){return b.priority-a.priority}}!function(){let NEXT_QUEUE=[],CURRENT_QUEUE=null,animFrameRequested=!1,inAnimationFrameRunner=!1,animationFrameRunner=()=>{for(animFrameRequested=!1,CURRENT_QUEUE=NEXT_QUEUE,NEXT_QUEUE=[],inAnimationFrameRunner=!0;CURRENT_QUEUE.length>0;){CURRENT_QUEUE.sort(AnimationFrameQueueItem.sort),CURRENT_QUEUE.shift().execute()}inAnimationFrameRunner=!1};scheduleAtNextAnimationFrame=(runner,priority=0)=>{let item=new AnimationFrameQueueItem(runner,priority);return NEXT_QUEUE.push(item),animFrameRequested||(animFrameRequested=!0,doRequestAnimationFrame(animationFrameRunner)),item},runAtThisOrScheduleAtNextAnimationFrame=(runner,priority)=>{if(inAnimationFrameRunner){let item=new AnimationFrameQueueItem(runner,priority);return CURRENT_QUEUE.push(item),item}return scheduleAtNextAnimationFrame(runner,priority)}}();const MINIMUM_TIME_MS=8,DEFAULT_EVENT_MERGER=function(lastEvent,currentEvent){return currentEvent};class TimeoutThrottledDomListener extends Disposable{constructor(node,type,handler,eventMerger=DEFAULT_EVENT_MERGER,minimumTimeMs=8){super();let lastEvent=null,lastHandlerTime=0,timeout=this._register(new TimeoutTimer),invokeHandler=()=>{lastHandlerTime=(new Date).getTime(),handler(lastEvent),lastEvent=null};this._register(addDisposableListener(node,type,(e=>{lastEvent=eventMerger(lastEvent,e);let elapsedTime=(new Date).getTime()-lastHandlerTime;elapsedTime>=minimumTimeMs?(timeout.cancel(),invokeHandler()):timeout.setIfNotSet(invokeHandler,minimumTimeMs-elapsedTime)})))}}export function addDisposableThrottledListener(node,type,handler,eventMerger,minimumTimeMs){return new TimeoutThrottledDomListener(node,type,handler,eventMerger,minimumTimeMs)}export function getComputedStyle(el){return document.defaultView.getComputedStyle(el,null)}export function getClientArea(element){if(element!==document.body)return new Dimension(element.clientWidth,element.clientHeight);if(platform.isIOS&&window.visualViewport)return new Dimension(window.visualViewport.width,window.visualViewport.height);if(window.innerWidth&&window.innerHeight)return new Dimension(window.innerWidth,window.innerHeight);if(document.body&&document.body.clientWidth&&document.body.clientHeight)return new Dimension(document.body.clientWidth,document.body.clientHeight);if(document.documentElement&&document.documentElement.clientWidth&&document.documentElement.clientHeight)return new Dimension(document.documentElement.clientWidth,document.documentElement.clientHeight);throw new Error("Unable to figure out browser width and height")}class SizeUtils{static convertToPixels(element,value){return parseFloat(value)||0}static getDimension(element,cssPropertyName,jsPropertyName){let computedStyle=getComputedStyle(element),value="0";return computedStyle&&(value=computedStyle.getPropertyValue?computedStyle.getPropertyValue(cssPropertyName):computedStyle.getAttribute(jsPropertyName)),SizeUtils.convertToPixels(element,value)}static getBorderLeftWidth(element){return SizeUtils.getDimension(element,"border-left-width","borderLeftWidth")}static getBorderRightWidth(element){return SizeUtils.getDimension(element,"border-right-width","borderRightWidth")}static getBorderTopWidth(element){return SizeUtils.getDimension(element,"border-top-width","borderTopWidth")}static getBorderBottomWidth(element){return SizeUtils.getDimension(element,"border-bottom-width","borderBottomWidth")}static getPaddingLeft(element){return SizeUtils.getDimension(element,"padding-left","paddingLeft")}static getPaddingRight(element){return SizeUtils.getDimension(element,"padding-right","paddingRight")}static getPaddingTop(element){return SizeUtils.getDimension(element,"padding-top","paddingTop")}static getPaddingBottom(element){return SizeUtils.getDimension(element,"padding-bottom","paddingBottom")}static getMarginLeft(element){return SizeUtils.getDimension(element,"margin-left","marginLeft")}static getMarginTop(element){return SizeUtils.getDimension(element,"margin-top","marginTop")}static getMarginRight(element){return SizeUtils.getDimension(element,"margin-right","marginRight")}static getMarginBottom(element){return SizeUtils.getDimension(element,"margin-bottom","marginBottom")}}export class Dimension{constructor(width,height){this.width=width,this.height=height}with(width=this.width,height=this.height){return width!==this.width||height!==this.height?new Dimension(width,height):this}static is(obj){return"object"==typeof obj&&"number"==typeof obj.height&&"number"==typeof obj.width}static lift(obj){return obj instanceof Dimension?obj:new Dimension(obj.width,obj.height)}static equals(a,b){return a===b||!(!a||!b)&&(a.width===b.width&&a.height===b.height)}}Dimension.None=new Dimension(0,0);export function getTopLeftOffset(element){let offsetParent=element.offsetParent,top=element.offsetTop,left=element.offsetLeft;for(;null!==(element=element.parentNode)&&element!==document.body&&element!==document.documentElement;){top-=element.scrollTop;const c=isShadowRoot(element)?null:getComputedStyle(element);c&&(left-="rtl"!==c.direction?element.scrollLeft:-element.scrollLeft),element===offsetParent&&(left+=SizeUtils.getBorderLeftWidth(element),top+=SizeUtils.getBorderTopWidth(element),top+=element.offsetTop,left+=element.offsetLeft,offsetParent=element.offsetParent)}return{left,top}}export function size(element,width,height){"number"==typeof width&&(element.style.width=`${width}px`),"number"==typeof height&&(element.style.height=`${height}px`)}export function getDomNodePagePosition(domNode){let bb=domNode.getBoundingClientRect();return{left:bb.left+StandardWindow.scrollX,top:bb.top+StandardWindow.scrollY,width:bb.width,height:bb.height}}export const StandardWindow=new class{get scrollX(){return"number"==typeof window.scrollX?window.scrollX:document.body.scrollLeft+document.documentElement.scrollLeft}get scrollY(){return"number"==typeof window.scrollY?window.scrollY:document.body.scrollTop+document.documentElement.scrollTop}};export function getTotalWidth(element){let margin=SizeUtils.getMarginLeft(element)+SizeUtils.getMarginRight(element);return element.offsetWidth+margin}export function getContentWidth(element){let border=SizeUtils.getBorderLeftWidth(element)+SizeUtils.getBorderRightWidth(element),padding=SizeUtils.getPaddingLeft(element)+SizeUtils.getPaddingRight(element);return element.offsetWidth-border-padding}export function getContentHeight(element){let border=SizeUtils.getBorderTopWidth(element)+SizeUtils.getBorderBottomWidth(element),padding=SizeUtils.getPaddingTop(element)+SizeUtils.getPaddingBottom(element);return element.offsetHeight-border-padding}export function getTotalHeight(element){let margin=SizeUtils.getMarginTop(element)+SizeUtils.getMarginBottom(element);return element.offsetHeight+margin}export function isAncestor(testChild,testAncestor){for(;testChild;){if(testChild===testAncestor)return!0;testChild=testChild.parentNode}return!1}export function findParentWithClass(node,clazz,stopAtClazzOrNode){for(;node&&node.nodeType===node.ELEMENT_NODE;){if(node.classList.contains(clazz))return node;if(stopAtClazzOrNode)if("string"==typeof stopAtClazzOrNode){if(node.classList.contains(stopAtClazzOrNode))return null}else if(node===stopAtClazzOrNode)return null;node=node.parentNode}return null}export function hasParentWithClass(node,clazz,stopAtClazzOrNode){return!!findParentWithClass(node,clazz,stopAtClazzOrNode)}export function isShadowRoot(node){return node&&!!node.host&&!!node.mode}export function isInShadowDOM(domNode){return!!getShadowRoot(domNode)}export function getShadowRoot(domNode){for(;domNode.parentNode;){if(domNode===document.body)return null;domNode=domNode.parentNode}return isShadowRoot(domNode)?domNode:null}export function getActiveElement(){let result=document.activeElement;for(;null==result?void 0:result.shadowRoot;)result=result.shadowRoot.activeElement;return result}export function createStyleSheet(container=document.getElementsByTagName("head")[0]){let style=document.createElement("style");return style.type="text/css",style.media="screen",container.appendChild(style),style}let _sharedStyleSheet=null;function getSharedStyleSheet(){return _sharedStyleSheet||(_sharedStyleSheet=createStyleSheet()),_sharedStyleSheet}function getDynamicStyleSheetRules(style){var _a,_b;return(null===(_a=null==style?void 0:style.sheet)||void 0===_a?void 0:_a.rules)?style.sheet.rules:(null===(_b=null==style?void 0:style.sheet)||void 0===_b?void 0:_b.cssRules)?style.sheet.cssRules:[]}export function createCSSRule(selector,cssText,style=getSharedStyleSheet()){style&&cssText&&style.sheet.insertRule(selector+"{"+cssText+"}",0)}export function removeCSSRulesContainingSelector(ruleName,style=getSharedStyleSheet()){if(!style)return;let rules=getDynamicStyleSheetRules(style),toDelete=[];for(let i=0;i<rules.length;i++){-1!==rules[i].selectorText.indexOf(ruleName)&&toDelete.push(i)}for(let i=toDelete.length-1;i>=0;i--)style.sheet.deleteRule(toDelete[i])}export function isHTMLElement(o){return"object"==typeof HTMLElement?o instanceof HTMLElement:o&&"object"==typeof o&&1===o.nodeType&&"string"==typeof o.nodeName}export const EventType={CLICK:"click",AUXCLICK:"auxclick",DBLCLICK:"dblclick",MOUSE_UP:"mouseup",MOUSE_DOWN:"mousedown",MOUSE_OVER:"mouseover",MOUSE_MOVE:"mousemove",MOUSE_OUT:"mouseout",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_WHEEL:"wheel",POINTER_UP:"pointerup",POINTER_DOWN:"pointerdown",POINTER_MOVE:"pointermove",CONTEXT_MENU:"contextmenu",WHEEL:"wheel",KEY_DOWN:"keydown",KEY_PRESS:"keypress",KEY_UP:"keyup",LOAD:"load",BEFORE_UNLOAD:"beforeunload",UNLOAD:"unload",PAGE_SHOW:"pageshow",PAGE_HIDE:"pagehide",ABORT:"abort",ERROR:"error",RESIZE:"resize",SCROLL:"scroll",FULLSCREEN_CHANGE:"fullscreenchange",WK_FULLSCREEN_CHANGE:"webkitfullscreenchange",SELECT:"select",CHANGE:"change",SUBMIT:"submit",RESET:"reset",FOCUS:"focus",FOCUS_IN:"focusin",FOCUS_OUT:"focusout",BLUR:"blur",INPUT:"input",STORAGE:"storage",DRAG_START:"dragstart",DRAG:"drag",DRAG_ENTER:"dragenter",DRAG_LEAVE:"dragleave",DRAG_OVER:"dragover",DROP:"drop",DRAG_END:"dragend",ANIMATION_START:browser.isWebKit?"webkitAnimationStart":"animationstart",ANIMATION_END:browser.isWebKit?"webkitAnimationEnd":"animationend",ANIMATION_ITERATION:browser.isWebKit?"webkitAnimationIteration":"animationiteration"};export const EventHelper={stop:function(e,cancelBubble){e.preventDefault?e.preventDefault():e.returnValue=!1,cancelBubble&&(e.stopPropagation?e.stopPropagation():e.cancelBubble=!0)}};export function saveParentsScrollTop(node){let r=[];for(let i=0;node&&node.nodeType===node.ELEMENT_NODE;i++)r[i]=node.scrollTop,node=node.parentNode;return r}export function restoreParentsScrollTop(node,state){for(let i=0;node&&node.nodeType===node.ELEMENT_NODE;i++)node.scrollTop!==state[i]&&(node.scrollTop=state[i]),node=node.parentNode}class FocusTracker extends Disposable{constructor(element){super(),this._onDidFocus=this._register(new event.Emitter),this.onDidFocus=this._onDidFocus.event,this._onDidBlur=this._register(new event.Emitter),this.onDidBlur=this._onDidBlur.event;let hasFocus=FocusTracker.hasFocusWithin(element),loosingFocus=!1;const onFocus=()=>{loosingFocus=!1,hasFocus||(hasFocus=!0,this._onDidFocus.fire())},onBlur=()=>{hasFocus&&(loosingFocus=!0,window.setTimeout((()=>{loosingFocus&&(loosingFocus=!1,hasFocus=!1,this._onDidBlur.fire())}),0))};this._refreshStateHandler=()=>{FocusTracker.hasFocusWithin(element)!==hasFocus&&(hasFocus?onBlur():onFocus())},this._register(addDisposableListener(element,EventType.FOCUS,onFocus,!0)),this._register(addDisposableListener(element,EventType.BLUR,onBlur,!0)),this._register(addDisposableListener(element,EventType.FOCUS_IN,(()=>this._refreshStateHandler()))),this._register(addDisposableListener(element,EventType.FOCUS_OUT,(()=>this._refreshStateHandler())))}static hasFocusWithin(element){const shadowRoot=getShadowRoot(element);return isAncestor(shadowRoot?shadowRoot.activeElement:document.activeElement,element)}}export function trackFocus(element){return new FocusTracker(element)}export function append(parent,...children){if(parent.append(...children),1===children.length&&"string"!=typeof children[0])return children[0]}export function prepend(parent,child){return parent.insertBefore(child,parent.firstChild),child}export function reset(parent,...children){parent.innerText="",append(parent,...children)}const SELECTOR_REGEX=/([\w\-]+)?(#([\w\-]+))?((\.([\w\-]+))*)/;export var Namespace;function _$(namespace,description,attrs,...children){let match=SELECTOR_REGEX.exec(description);if(!match)throw new Error("Bad use of emmet");attrs=Object.assign({},attrs||{});let result,tagName=match[1]||"div";return result=namespace!==Namespace.HTML?document.createElementNS(namespace,tagName):document.createElement(tagName),match[3]&&(result.id=match[3]),match[4]&&(result.className=match[4].replace(/\./g," ").trim()),Object.keys(attrs).forEach((name=>{const value=attrs[name];void 0!==value&&(/^on\w+$/.test(name)?result[name]=value:"selected"===name?value&&result.setAttribute(name,"true"):result.setAttribute(name,value))})),result.append(...children),result}!function(Namespace){Namespace.HTML="http://www.w3.org/1999/xhtml",Namespace.SVG="http://www.w3.org/2000/svg"}(Namespace||(Namespace={}));export function $(description,attrs,...children){return _$(Namespace.HTML,description,attrs,...children)}$.SVG=function(description,attrs,...children){return _$(Namespace.SVG,description,attrs,...children)};export function show(...elements){for(let element of elements)element.style.display="",element.removeAttribute("aria-hidden")}export function hide(...elements){for(let element of elements)element.style.display="none",element.setAttribute("aria-hidden","true")}export function getElementsByTagName(tag){return Array.prototype.slice.call(document.getElementsByTagName(tag),0)}export function computeScreenAwareSize(cssPx){const screenPx=window.devicePixelRatio*cssPx;return Math.max(1,Math.floor(screenPx))/window.devicePixelRatio}export function windowOpenNoOpener(url){window.open(url,"_blank","noopener")}export function animate(fn){const step=()=>{fn(),stepDisposable=scheduleAtNextAnimationFrame(step)};let stepDisposable=scheduleAtNextAnimationFrame(step);return toDisposable((()=>stepDisposable.dispose()))}RemoteAuthorities.setPreferredWebSchema(/^https:/.test(window.location.href)?"https":"http");export function asCSSUrl(uri){return uri?`url('${FileAccess.asBrowserUri(uri).toString(!0).replace(/'/g,"%27")}')`:"url('')"}export function asCSSPropertyValue(value){return`'${value.replace(/'/g,"%27")}'`}export class ModifierKeyEmitter extends event.Emitter{constructor(){super(),this._subscriptions=new DisposableStore,this._keyStatus={altKey:!1,shiftKey:!1,ctrlKey:!1,metaKey:!1},this._subscriptions.add(addDisposableListener(window,"keydown",(e=>{if(e.defaultPrevented)return;const event=new StandardKeyboardEvent(e);if(6!==event.keyCode||!e.repeat){if(e.altKey&&!this._keyStatus.altKey)this._keyStatus.lastKeyPressed="alt";else if(e.ctrlKey&&!this._keyStatus.ctrlKey)this._keyStatus.lastKeyPressed="ctrl";else if(e.metaKey&&!this._keyStatus.metaKey)this._keyStatus.lastKeyPressed="meta";else if(e.shiftKey&&!this._keyStatus.shiftKey)this._keyStatus.lastKeyPressed="shift";else{if(6===event.keyCode)return;this._keyStatus.lastKeyPressed=void 0}this._keyStatus.altKey=e.altKey,this._keyStatus.ctrlKey=e.ctrlKey,this._keyStatus.metaKey=e.metaKey,this._keyStatus.shiftKey=e.shiftKey,this._keyStatus.lastKeyPressed&&(this._keyStatus.event=e,this.fire(this._keyStatus))}}),!0)),this._subscriptions.add(addDisposableListener(window,"keyup",(e=>{e.defaultPrevented||(!e.altKey&&this._keyStatus.altKey?this._keyStatus.lastKeyReleased="alt":!e.ctrlKey&&this._keyStatus.ctrlKey?this._keyStatus.lastKeyReleased="ctrl":!e.metaKey&&this._keyStatus.metaKey?this._keyStatus.lastKeyReleased="meta":!e.shiftKey&&this._keyStatus.shiftKey?this._keyStatus.lastKeyReleased="shift":this._keyStatus.lastKeyReleased=void 0,this._keyStatus.lastKeyPressed!==this._keyStatus.lastKeyReleased&&(this._keyStatus.lastKeyPressed=void 0),this._keyStatus.altKey=e.altKey,this._keyStatus.ctrlKey=e.ctrlKey,this._keyStatus.metaKey=e.metaKey,this._keyStatus.shiftKey=e.shiftKey,this._keyStatus.lastKeyReleased&&(this._keyStatus.event=e,this.fire(this._keyStatus)))}),!0)),this._subscriptions.add(addDisposableListener(document.body,"mousedown",(()=>{this._keyStatus.lastKeyPressed=void 0}),!0)),this._subscriptions.add(addDisposableListener(document.body,"mouseup",(()=>{this._keyStatus.lastKeyPressed=void 0}),!0)),this._subscriptions.add(addDisposableListener(document.body,"mousemove",(e=>{e.buttons&&(this._keyStatus.lastKeyPressed=void 0)}),!0)),this._subscriptions.add(addDisposableListener(window,"blur",(()=>{this.resetKeyStatus()})))}get keyStatus(){return this._keyStatus}resetKeyStatus(){this.doResetKeyStatus(),this.fire(this._keyStatus)}doResetKeyStatus(){this._keyStatus={altKey:!1,shiftKey:!1,ctrlKey:!1,metaKey:!1}}static getInstance(){return ModifierKeyEmitter.instance||(ModifierKeyEmitter.instance=new ModifierKeyEmitter),ModifierKeyEmitter.instance}dispose(){super.dispose(),this._subscriptions.dispose()}}export function addMatchMediaChangeListener(query,callback){window.matchMedia(query).addEventListener("change",callback)}