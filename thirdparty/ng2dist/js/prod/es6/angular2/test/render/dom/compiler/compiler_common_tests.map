{"version":3,"sources":["compiler_common_tests.js"],"names":[],"mappings":"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","file":"angular2/test/render/dom/compiler/compiler_common_tests.es6","sourcesContent":["import {\n  AsyncTestCompleter,\n  beforeEach,\n  ddescribe,\n  describe,\n  el,\n  expect,\n  iit,\n  inject,\n  IS_DARTIUM,\n  it,\n} from 'angular2/test_lib';\n\nimport {DOM} from 'angular2/src/dom/dom_adapter';\nimport {List, ListWrapper, Map, MapWrapper, StringMapWrapper} from 'angular2/src/facade/collection';\nimport {Type, isBlank, stringify, isPresent} from 'angular2/src/facade/lang';\nimport {PromiseWrapper, Promise} from 'angular2/src/facade/async';\n\nimport {Compiler, CompilerCache} from 'angular2/src/render/dom/compiler/compiler';\nimport {ProtoViewDto, ViewDefinition, DirectiveMetadata} from 'angular2/src/render/api';\nimport {CompileElement} from 'angular2/src/render/dom/compiler/compile_element';\nimport {CompileStep} from 'angular2/src/render/dom/compiler/compile_step'\nimport {CompileStepFactory} from 'angular2/src/render/dom/compiler/compile_step_factory';\nimport {CompileControl} from 'angular2/src/render/dom/compiler/compile_control';\nimport {TemplateLoader} from 'angular2/src/render/dom/compiler/template_loader';\n\nimport {UrlResolver} from 'angular2/src/services/url_resolver';\n\nexport function runCompilerCommonTests() {\n  describe('compiler', function() {\n    var mockStepFactory;\n\n    function createCompiler(processClosure, urlData = null) {\n      if (isBlank(urlData)) {\n        urlData = MapWrapper.create();\n      }\n      var tplLoader =  new FakeTemplateLoader(urlData);\n      mockStepFactory = new MockStepFactory([new MockStep(processClosure)]);\n      return new Compiler(mockStepFactory, tplLoader);\n    }\n\n    it('should run the steps and build the AppProtoView of the root element', inject([AsyncTestCompleter], (async) => {\n      var compiler = createCompiler((parent, current, control) => {\n        current.inheritedProtoView.bindVariable('b', 'a');\n      });\n      compiler.compile(new ViewDefinition({\n        componentId: 'someComponent',\n        template: '<div></div>'\n      })).then( (protoView) => {\n        expect(protoView.variableBindings).toEqual(MapWrapper.createFromStringMap({\n          'a': 'b'\n        }));\n        async.done();\n      });\n    }));\n\n    it('should run the steps and build the proto view', inject([AsyncTestCompleter], (async) => {\n      var compiler = createCompiler((parent, current, control) => {\n        current.inheritedProtoView.bindVariable('b', 'a');\n      });\n\n      var dirMetadata = new DirectiveMetadata({id: 'id', selector: 'CUSTOM', type: DirectiveMetadata.COMPONENT_TYPE});\n      compiler.compileHost(dirMetadata).then( (protoView) => {\n        expect(DOM.tagName(protoView.render.delegate.element)).toEqual('CUSTOM')\n        expect(mockStepFactory.viewDef.directives).toEqual([dirMetadata]);\n        expect(protoView.variableBindings).toEqual(MapWrapper.createFromStringMap({\n          'a': 'b'\n        }));\n        async.done();\n      });\n    }));\n\n    it('should use the inline template and compile in sync', inject([AsyncTestCompleter], (async) => {\n      var compiler = createCompiler(EMPTY_STEP);\n      compiler.compile(new ViewDefinition({\n        componentId: 'someId',\n        template: 'inline component'\n      })).then( (protoView) => {\n        expect(DOM.getInnerHTML(protoView.render.delegate.element)).toEqual('inline component');\n        async.done();\n      });\n    }));\n\n    it('should load url templates', inject([AsyncTestCompleter], (async) => {\n      var urlData = MapWrapper.createFromStringMap({\n        'someUrl': 'url component'\n      });\n      var compiler = createCompiler(EMPTY_STEP, urlData);\n      compiler.compile(new ViewDefinition({\n        componentId: 'someId',\n        absUrl: 'someUrl'\n      })).then( (protoView) => {\n        expect(DOM.getInnerHTML(protoView.render.delegate.element)).toEqual('url component');\n        async.done();\n      });\n    }));\n\n    it('should report loading errors', inject([AsyncTestCompleter], (async) => {\n      var compiler = createCompiler(EMPTY_STEP, MapWrapper.create());\n      PromiseWrapper.catchError(compiler.compile(new ViewDefinition({\n        componentId: 'someId',\n        absUrl: 'someUrl'\n      })), (e) => {\n        expect(e.message).toContain(`Failed to load the template \"someId\"`);\n        async.done();\n      });\n    }));\n\n    it('should wait for async subtasks to be resolved', inject([AsyncTestCompleter], (async) => {\n      var subTasksCompleted = false;\n\n      var completer = PromiseWrapper.completer();\n\n      var compiler = createCompiler( (parent, current, control) => {\n        ListWrapper.push(mockStepFactory.subTaskPromises, completer.promise.then((_) => {\n          subTasksCompleted = true;\n        }));\n      });\n\n      // It should always return a Promise because the subtask is async\n      var pvPromise = compiler.compile(new ViewDefinition({\n        componentId: 'someId',\n        template: 'some component'\n      }));\n      expect(pvPromise).toBePromise();\n      expect(subTasksCompleted).toEqual(false);\n\n      // The Promise should resolve after the subtask is ready\n      completer.resolve(null);\n      pvPromise.then((protoView) => {\n        expect(subTasksCompleted).toEqual(true);\n        async.done();\n      });\n    }));\n\n  });\n\n}\n\nclass MockStepFactory extends CompileStepFactory {\n  steps:List<CompileStep>;\n  subTaskPromises:List<Promise>;\n  viewDef:ViewDefinition;\n\n  constructor(steps) {\n    super();\n    this.steps = steps;\n  }\n  createSteps(viewDef, subTaskPromises) {\n    this.viewDef = viewDef;\n    this.subTaskPromises = subTaskPromises;\n    ListWrapper.forEach(this.subTaskPromises, (p) => ListWrapper.push(subTaskPromises, p) );\n    return this.steps;\n  }\n}\n\nclass MockStep extends CompileStep {\n  processClosure:Function;\n  constructor(process) {\n    super();\n    this.processClosure = process;\n  }\n  process(parent:CompileElement, current:CompileElement, control:CompileControl) {\n    this.processClosure(parent, current, control);\n  }\n}\n\nvar EMPTY_STEP = (parent, current, control) => {\n  if (isPresent(parent)) {\n    current.inheritedProtoView = parent.inheritedProtoView;\n  }\n};\n\nclass FakeTemplateLoader extends TemplateLoader {\n  _urlData: Map<string, string>;\n  constructor(urlData) {\n    super(null, new UrlResolver());\n    this._urlData = urlData;\n  }\n\n  load(template: ViewDefinition) {\n    if (isPresent(template.template)) {\n      return PromiseWrapper.resolve(DOM.createTemplate(template.template));\n    }\n\n    if (isPresent(template.absUrl)) {\n      var content = MapWrapper.get(this._urlData, template.absUrl);\n      if (isPresent(content)) {\n        return PromiseWrapper.resolve(DOM.createTemplate(content));\n      }\n    }\n\n    return PromiseWrapper.reject('Load failed');\n  }\n}\n"]}