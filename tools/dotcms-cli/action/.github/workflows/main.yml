name: dotCMS sync

on: [push]

jobs:

  dotcli-runner:
    runs-on: ubuntu-24.04
    outputs:
      url: ${{ steps.dotcli-runner.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Get dotCLI runner
        id: dotcli-runner
        run: |
          echo "::group::Get dotCLI runner"
          
          curl -o maven-metadata.xml "https://repo.dotcms.com/artifactory/libs-release-local/com/dotcms/dotcms-cli/maven-metadata.xml"
          LATEST_VERSION=$(xmllint --xpath "string(//versioning/latest)" maven-metadata.xml)
          URL="https://repo.dotcms.com/artifactory/libs-release-local/com/dotcms/dotcms-cli/${LATEST_VERSION}/dotcms-cli-${LATEST_VERSION}-runner.jar"

          echo "::notice::DOTCLI RUNNER: $URL"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

  sync-with-dotcms:
    needs: dotcli-runner
    runs-on: ubuntu-24.04
    env:
      # Global environment expected by dotCMS CLI
      # This is how we instruct the cli the target server
      DOT_API_URL: ${{ vars.DOT_API_URL }}
      # This is how we instruct the cli the target folder in the repo
      # By default it must be the root of the repo this allows setting up a different folder on top of the root
      DOT_REPO_BASE_PATH: ${{ vars.DOT_REPO_BASE_PATH }}
      # This is how we instruct the cli to create the workspace if it does not exist
      DOT_CREATE_WORKSPACE: ${{ vars.DOT_CREATE_WORKSPACE || 'true' }}
      # This is the CLI version to use, but we can always override this value
      DOT_CLI_JAR_DOWNLOAD_URL: ${{ vars.DOT_CLI_JAR_DOWNLOAD_URL || needs.dotcli-runner.outputs.url }}
      # Support for version number only
      DOT_CLI_VERSION: ${{ vars.DOT_CLI_VERSION }}
      # In case we want to force the download of the CLI jar
      DOT_FORCE_DOWNLOAD: ${{ vars.DOT_FORCE_DOWNLOAD || 'false' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load .env file
        uses: aarcangeli/load-dotenv@v1.0.0
        with:
          if-file-not-found: 'warn'

      - name: Resolve CLI URL
        id: resolve-cli-url
        run: |
          # Check if DOT_CLI_VERSION is set (version number only)
          if [ -n "${{ env.DOT_CLI_VERSION }}" ]; then
            VERSION="${{ env.DOT_CLI_VERSION }}"
            RESOLVED_URL="https://repo.dotcms.com/artifactory/libs-release-local/com/dotcms/dotcms-cli/${VERSION}/dotcms-cli-${VERSION}-runner.jar"
            echo "::notice::Using specified version: $VERSION"
            echo "::notice::Resolved URL: $RESOLVED_URL"
            echo "resolved-url=$RESOLVED_URL" >> "$GITHUB_OUTPUT"
          else
            # Use the original URL (either from DOT_CLI_JAR_DOWNLOAD_URL or latest)
            RESOLVED_URL="${{ env.DOT_CLI_JAR_DOWNLOAD_URL }}"
            echo "::notice::Using configured or latest URL: $RESOLVED_URL"
            echo "resolved-url=$RESOLVED_URL" >> "$GITHUB_OUTPUT"
          fi

      - name: Print env vars
        run: |
          echo "$GITHUB_ENV"

      - name: Get changes
        run: |
          echo "::group::Detecting changed files"
    
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"
          
          echo "Before: $BEFORE"
          echo "After: $AFTER"
          
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
          echo "::notice::First push - all files considered changed"
          git ls-tree --name-only -r HEAD > changed_files.txt
          elif git cat-file -e "$BEFORE" 2>/dev/null && git cat-file -e "$AFTER" 2>/dev/null; then
          echo "::notice::Normal diff between valid commits"
          git diff --name-only "$BEFORE" "$AFTER" > changed_files.txt
          else
          echo "::warning::One or both commits not accessible, falling back to current commit files"
          git ls-tree --name-only -r HEAD > changed_files.txt
          fi
          
          FILE_COUNT=$(wc -l < changed_files.txt)
          echo "::notice::Files detected: $FILE_COUNT"
          echo "::endgroup::"

      - name: List changed files
        run: |
          while IFS= read -r line
          do
            echo "\"$line\" was changed"
          done < changed_files.txt

      - name: Github Event Context properties
        run: |
          echo "Event: ${{ github.event }}"
          echo "Event Name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Commit Ref: ${{ github.ref }}"
          echo "Head Ref: ${{ github.head_ref }}"
          echo "Base Ref: ${{ github.base_ref }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "PR: ${{ github.pull_request }}"
          echo "Workspace: ${{ github.workspace }}"

      - name: Create workspace if not exists
        id: dot-workspace
        run: |
          if [ ${{ env.DOT_CREATE_WORKSPACE }} = true ]; then
            echo "Creating workspace ::: "             
            chmod +x ./.github/workflows/scripts/workspace.sh
            source ./.github/workflows/scripts/workspace.sh
            workspace_updated=$(create_workspace "${{github.workspace}}${{env.DOT_REPO_BASE_PATH}}" )          
            echo "workspace-updated=$workspace_updated" >> "$GITHUB_OUTPUT"
          fi
        shell: bash

      # This step requires permission to push to the repo
      # you need to grant read/write permission for workflows in the repo settings
      - name: Persist updated workspace
        run: |
          saveChanges="${{ steps.dot-workspace.outputs.workspace-updated }}"
          if [ -n "${saveChanges}" ]; then            
            git config user.name "${{ secrets.CI_MACHINE_USER }}"
            git config user.email "dotCMS-Machine-User@dotcms.com"
            git add .
            git commit -m "pushing workspace changes"
            git push
            echo "Workspace has been updated."
          fi

      - name: Run dotCMS CLI
        id: dot-push
        run: |
          set -e  # Fail on any error
          
          chmod +x ./.github/workflows/scripts/run-push.sh
          source ./.github/workflows/scripts/run-push.sh
          
          # Use resolved URL from previous step
          CLI_URL="${{ steps.resolve-cli-url.outputs.resolved-url }}"
          echo "Installing CLI from: $CLI_URL"
          
          install_cli "$CLI_URL" "${{env.DOT_FORCE_DOWNLOAD}}"
          
          # Run the CLI push and capture exit code
          run_cli_push "${{github.workspace}}${{env.DOT_REPO_BASE_PATH}}" "${{ secrets.DOT_TOKEN }}" "${{ env.DOT_CLI_OPTS }}"
          
          # If we reach here, the command succeeded
          echo "exit-code=0" >> "$GITHUB_OUTPUT"
          print_log
          echo "dotCMS CLI push completed successfully"
        shell: bash