dojo.require("dotcms.dijit.image.ImageEditor");
tinymce.PluginManager.add("doteditimage", function (editor) {
	let lastSelectedImage = undefined;
	function addButtons() {
		editor.addButton("editimage", {
			icon: "editimage",
			text: editor.settings.dotLanguageStrings["edit_image"],
			onclick: function () {
				const imgNode = editor.selection.getNode();

				const attrs = {
					fieldName: imgNode.dataset.fieldName,
					inode: imgNode.dataset.inode,
					identifier: imgNode.dataset.identifier,
					saveAs: imgNode.dataset.saveas,
				};

				const ImageEditor = new dotcms.dijit.image.ImageEditor({
					editImageText: "",
					fieldName: attrs.fieldName,
					binaryFieldId: attrs.identifier,
					fieldContentletId: attrs.identifier,
					saveAsFileName: attrs.saveAs,
					inode: attrs.inode,
					activeEditor: editor,
				});

				ImageEditor.execute();
			},
		});
	}
	function addEvents() {
		editor.on("click", function (e) {
			if (lastSelectedImage && lastSelectedImage.src != e.srcElement.src) {
				lastSelectedImage = undefined;
			}
			if (isEditableImage(e.srcElement)) {
				e.srcElement.draggable = false;
				lastSelectedImage = e.srcElement;
			}
		});
	}
	function isEditableImage(img) {
		const selectorMatched = editor.dom.is(
			img,
			"img:not([data-mce-object],[data-mce-placeholder])"
		);
		return selectorMatched;
	}
	function addToolbars() {
		const toolbarItems = "alignleft aligncenter alignright | editimage";
		editor.addContextToolbar(isEditableImage, toolbarItems);
	}
	addToolbars();
	addEvents();
	addButtons();
});
