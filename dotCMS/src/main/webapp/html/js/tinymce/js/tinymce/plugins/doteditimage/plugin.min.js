dojo.require("dotcms.dijit.image.ImageEditor");
tinymce.PluginManager.add("doteditimage", function (editor) {
	function addButtons() {
		editor.addButton("editimage", {
			icon: "editimage",
			text: editor.settings.dotLanguageStrings["edit_image"],
			onclick: function () {
				const imgNode = editor.selection.getNode().nodeName === "IMG" ?
								editor.selection.getNode() :
								editor.selection.getNode().querySelector("img")

				const attrs = {
					fieldName: imgNode.dataset.fieldName,
					inode: imgNode.dataset.inode,
					identifier: imgNode.dataset.identifier,
					saveAs: imgNode.dataset.saveas,
				};

				const ImageEditor = new dotcms.dijit.image.ImageEditor({
					editImageText: "",
					fieldName: attrs.fieldName,
					binaryFieldId: attrs.identifier,
					fieldContentletId: attrs.identifier,
					saveAsFileName: attrs.saveAs,
					inode: attrs.inode,
					activeEditor: editor,
					currentNode: editor.selection.getNode()
				});

				ImageEditor.execute();
			},
		});
	}

	function isEditableImage(node) {
		return editor.dom.is(node, "img:not([data-mce-object],[data-mce-placeholder])") || editor.dom.is(node, "figure.image");
	}

	function addToolbars() {
		const toolbarItems = "alignleft aligncenter alignright | editimage";
		editor.addContextToolbar(isEditableImage, toolbarItems);
	}
	addToolbars();
	addButtons();
});
