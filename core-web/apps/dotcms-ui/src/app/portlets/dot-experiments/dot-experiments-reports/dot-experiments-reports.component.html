<ng-container *ngIf="vm$ | async as vm">
    <dot-experiments-header
        [isLoading]="vm.isLoading"
        [status]="vm?.experiment?.status"
        [title]="vm.experiment?.name"
        (goBack)="goToExperimentList(vm.experiment.pageId)"
    >
        <button
            class="p-button-outlined"
            *ngIf="vm.hasEnoughSessions"
            [label]="'experiments.report.promote.variant' | dm"
            (click)="openPublishVariantDialog()"
            data-testId="publish-variant-button"
            pButton
            type="button"
        ></button>
    </dot-experiments-header>
    <div class="flex flex-column dot-experiment-report-content">
        <ng-container *ngIf="!vm.isLoading; else loadingTpl">
            <dot-experiments-experiment-summary
                *ngIf="vm.showSummary"
                [goals]="vm.experiment.goals"
                [scheduling]="vm.experiment.scheduling"
                [sessionsReached]="vm.results.sessions.total"
                [suggestedWinner]="vm.winnerLegendSummary"
            />

            <div class="flex justify-content-center w-full container">
                <div class="flex flex-column gap-2 content">
                    <dot-experiments-reports-chart
                        [config]="chartConfig"
                        [data]="vm.chartData"
                        [isEmpty]="!vm.hasEnoughSessions"
                        [isLoading]="vm.isLoading"
                    />
                    <dot-experiments-details-table
                        [data]="vm.detailData"
                        [isEmpty]="!vm.hasEnoughSessions"
                        [title]="'experiments.reports.resume' | dm"
                    >
                        <ng-template #headers>
                            <div class="flex col row-container">
                                <div class="flex col flex-wrap align-items-center">
                                    {{ 'experiments.reports.variants' | dm }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-items-center justify-content-end"
                                >
                                    {{ 'experiments.reports.best-variant' | dm }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-items-center justify-content-end"
                                >
                                    {{ 'experiments.configure.traffic.split.name' | dm }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-items-center justify-content-end"
                                >
                                    {{ 'experiments.reports.pageview' | dm }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-items-center justify-content-end"
                                >
                                    {{ 'experiments.reports.sessions' | dm }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-items-center justify-content-end"
                                >
                                    {{ 'experiments.reports.clicks' | dm }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-items-center justify-content-end"
                                >
                                    {{ 'experiments.reports.improvement' | dm }}
                                </div>
                            </div>
                        </ng-template>

                        <ng-template #rows let-row>
                            <div class="flex col row-container">
                                <div
                                    class="flex col flex-wrap align-content-center first-column"
                                    [ngClass]="{ 'prospect-winner': row.isWinner }"
                                >
                                    <div class="flex flex-row align-items-center gap-2">
                                        <i
                                            class="pi"
                                            [ngClass]="{
                                                'pi-arrow-circle-up': row.isWinner,
                                                'pi-arrow-circle-down': !row.isWinner
                                            }"
                                        ></i>
                                        <span>{{ row.name }}</span>
                                        <p-tag
                                            class="sm p-tag-success"
                                            *ngIf="row.isWinner"
                                            [value]="'winner' | dm | titlecase"
                                            icon="pi pi-check"
                                        />
                                    </div>
                                </div>
                                <div
                                    class="flex col flex-wrap align-content-center justify-content-end"
                                    [ngClass]="{ 'prospect-winner': row.isWinner }"
                                >
                                    {{ row.bestVariant | percent : '1.0-2' }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-content-center justify-content-end"
                                    [ngClass]="{ 'prospect-winner': row.isWinner }"
                                >
                                    {{ row.trafficSplit }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-content-center justify-content-end"
                                    [ngClass]="{ 'prospect-winner': row.isWinner }"
                                >
                                    {{ row.pageViews }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-content-center justify-content-end"
                                    [ngClass]="{ 'prospect-winner': row.isWinner }"
                                >
                                    {{ row.sessions }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-content-center justify-content-end"
                                    [ngClass]="{ 'prospect-winner': row.isWinner }"
                                >
                                    {{ row.clicks }}
                                </div>
                                <div
                                    class="flex col flex-wrap align-content-center justify-content-end"
                                    [ngClass]="{ 'prospect-winner': row.isWinner }"
                                >
                                    <ng-container
                                        *ngIf="row.name != defaultVariantName; else baselineTpl"
                                    >
                                        <div
                                            class="flex flex-row align-items-center gap-2 justify-content-end"
                                        >
                                            <i
                                                class="pi"
                                                [ngClass]="{
                                                    'pi-arrow-circle-up': row.better_than_baseline,
                                                    'pi-arrow-circle-down':
                                                        !row.better_than_baseline
                                                }"
                                            ></i>
                                            <span>{{ row.improvement | percent }}</span>
                                        </div>
                                    </ng-container>
                                    <ng-template #baselineTpl>
                                        <span>{{ 'experiments.reports.baseline' | dm }}</span>
                                    </ng-template>
                                </div>
                            </div>
                        </ng-template>
                    </dot-experiments-details-table>
                </div>
            </div>
        </ng-container>
    </div>
</ng-container>

<ng-template #loadingTpl>
    <dot-experiments-reports-skeleton />
</ng-template>
<ng-template dotDynamic></ng-template>
