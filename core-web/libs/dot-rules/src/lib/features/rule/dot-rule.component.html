@let rule = $rule();
@let ruleActions = $ruleActions();
@let saved = $saved();
@let saving = $saving();
@let hidden = $hidden();

<form [formGroup]="formModel" let rf="ngForm">
    @if (showAddToBundleDialog()) {
        <dot-add-to-bundle
            (cancel)="showAddToBundleDialog.set(false)"
            [assetIdentifier]="rule.key" />
    }
    <div
        [class.dot-rules-hidden]="hidden"
        [class.dot-rules-disabled]="!rule.enabled"
        [class.dot-rules-saving]="saving"
        [class.dot-rules-saved]="saved"
        [class.dot-rules-out-of-sync]="!saved && !saving"
        class="dot-rules-item">
        @if (!hidden) {
            <div
                (click)="setRuleExpandedState(!rule._expanded)"
                class="dot-rules-header flex flex-row flex-1">
                <div
                    class="dot-rules-header-info flex flex-row justify-start items-center basis-[70%] max-w-[70%]">
                    <i
                        [class.pi-angle-right]="!rule._expanded"
                        [class.pi-angle-down]="rule._expanded"
                        class="dot-rules-header-arrow pi"
                        aria-hidden="true"></i>
                    <div class="flex flex-col basis-[70%] max-w-[70%]">
                        <input
                            (click)="$event.stopPropagation()"
                            class="dot-rules-name-input"
                            pInputText
                            placeholder="{{ getI18nLabel('inputs.name.placeholder') | async }}"
                            formControlName="name"
                            [pAutoFocus]="true" />
                        <div
                            [hidden]="
                                !formModel.controls['name'].touched ||
                                formModel.controls['name'].valid
                            "
                            class="name dot-rules-warn basic label basis-1/2 max-w-1/2">
                            Name is required
                        </div>
                    </div>
                    @if (!hideFireOn) {
                        <span class="dot-rules-fire-on-label">
                            {{ getI18nLabel('inputs.fireOn.label') | async }}
                        </span>
                    }
                    @if (!hideFireOn) {
                        <p-select
                            (onChange)="onFireOnChange($event.value)"
                            (click)="$event.stopPropagation()"
                            [ngModel]="fireOnValue()"
                            [ngModelOptions]="{ standalone: true }"
                            [options]="fireOnOptions$ | async"
                            [style]="{ width: '9.5rem' }"
                            [placeholder]="fireOnPlaceholder$ | async"
                            class="dot-rules-fire-on-dropdown flex-none"
                            appendTo="body" />
                    }
                </div>
                <div
                    class="dot-rules-header-actions flex flex-row justify-end items-center basis-[30%] max-w-[30%]">
                    <span class="dot-rules-status-text" title="{{ getStatusText() }}">
                        {{ getStatusText(30) }}
                    </span>
                    <p-toggleSwitch
                        (onChange)="setRuleEnabledState($event)"
                        [(ngModel)]="rule.enabled"
                        [ngModelOptions]="{ standalone: true }"
                        [pTooltip]="rule.enabled ? tooltipRuleOnText : tooltipRuleOffText"
                        tooltipPosition="bottom" />
                    <div class="dot-rules-btn-group">
                        <button
                            (click)="ruleOptions.toggle($event); $event.stopPropagation()"
                            pButton
                            severity="secondary"
                            icon="pi pi-ellipsis-v"
                            ariaLabel="Rule options"></button>
                        <button
                            (click)="
                                onCreateConditionGroupClicked();
                                setRuleExpandedState(true);
                                $event.stopPropagation()
                            "
                            [disabled]="!rule.isPersisted()"
                            pButton
                            severity="secondary"
                            icon="pi pi-plus"
                            ariaLabel="Add Group"
                            styleClass="ml-2"></button>
                        <p-menu
                            [model]="ruleActionOptions"
                            #ruleOptions
                            appendTo="body"
                            [popup]="true" />
                    </div>
                </div>
            </div>
        }
        @if (rule._expanded) {
            <div class="dot-rules-accordion-body">
                @for (group of rule._conditionGroups; track group; let i = $index) {
                    <dot-condition-group
                        (createCondition)="onCreateCondition($event)"
                        (deleteCondition)="onDeleteCondition($event, group)"
                        (updateConditionGroupOperator)="
                            onUpdateConditionGroupOperator($event, group)
                        "
                        (updateConditionType)="onUpdateConditionType($event, group)"
                        (updateConditionParameter)="onUpdateConditionParameter($event, group)"
                        (updateConditionOperator)="onUpdateConditionOperator($event, group)"
                        [group]="group"
                        [conditionTypes]="$conditionTypes()"
                        [groupIndex]="i"
                        [conditionTypePlaceholder]="conditionTypePlaceholder" />
                }
                <div class="dot-rules-action-group">
                    <div class="dot-rules-action-separator">
                        {{ getI18nLabel('inputs.action.firesActions') | async }}
                    </div>
                    <div class="dot-rules-actions flex flex-col flex-1">
                        @for (ruleAction of ruleActions; track ruleAction; let i = $index) {
                            <div class="dot-rules-action-row flex flex-row">
                                <dot-rule-action
                                    (updateRuleActionType)="onUpdateRuleActionType($event)"
                                    (updateRuleActionParameter)="
                                        onUpdateRuleActionParameter($event)
                                    "
                                    (deleteRuleAction)="onDeleteRuleAction($event)"
                                    [action]="ruleAction"
                                    [index]="i"
                                    [actionTypePlaceholder]="actionTypePlaceholder"
                                    [ruleActionTypes]="$ruleActionTypes()"
                                    class="flex-1 flex flex-row" />
                                <div class="dot-rules-btn-group dot-rules-add-btn">
                                    @if (i === ruleActions.length - 1) {
                                        <button
                                            (click)="onCreateRuleAction()"
                                            [disabled]="!ruleAction.isPersisted()"
                                            [rounded]="true"
                                            [text]="true"
                                            pButton
                                            type="button"
                                            severity="success"
                                            icon="pi pi-plus"
                                            ariaLabel="Add Action"></button>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</form>
