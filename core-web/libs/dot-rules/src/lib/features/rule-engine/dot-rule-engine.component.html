@let loading = $loading();
@let showRules = $showRules();
@let rules = $rules();
@let pageId = $pageId();
@let isContentletHost = $isContentletHost();

@if (loading) {
    <div [class.dot-rules-loading]="loading" class="dot-rules-overlay"></div>
}
@if (!loading && globalError()?.message) {
    <div class="ui negative message dot-rules-message">
        <div class="header">{{ globalError().message }}</div>
        <p>{{ getI18nLabel('contact.admin.error') | async }}</p>
        @if (showCloseButton()) {
            <i (click)="clearGlobalError()" class="pi pi-times close-button"></i>
        }
    </div>
}
@if (!loading && showRules) {
    <div class="dot-rules-engine">
        <div class="dot-rules-header">
            <div flex layout="row" style="align-items: center">
                <input
                    (keyup)="filterText.set($event.target.value)"
                    [value]="filterText()"
                    pInputText
                    placeholder="{{ getI18nLabel('inputs.filter.placeholder') | async }}" />
                <div flex="2"></div>
                <button (click)="addRule()" class="dot-icon-button">
                    <i class="pi pi-plus"></i>
                </button>
            </div>
            <div class="dot-rules-filter-links">
                <span>{{ getI18nLabel('inputs.filter.status.show.label') | async }}:</span>
                <a
                    (click)="setFieldFilter('enabled', null)"
                    [class.active]="!isFilteringField('enabled')"
                    class="dot-rules-filter-link"
                    href="javascript:void(0)">
                    {{ getI18nLabel('inputs.filter.status.all.label') | async }}
                </a>
                <span>&#124;</span>
                <a
                    (click)="setFieldFilter('enabled', true)"
                    [class.active]="isFilteringField('enabled', true)"
                    class="dot-rules-filter-link"
                    href="javascript:void(0)">
                    {{ getI18nLabel('inputs.filter.status.active.label') | async }}
                </a>
                <span>&#124;</span>
                <a
                    (click)="setFieldFilter('enabled', false)"
                    [class.active]="isFilteringField('enabled', false)"
                    class="dot-rules-filter-link"
                    href="javascript:void(0)">
                    {{ getI18nLabel('inputs.filter.status.inactive.label') | async }}
                </a>
            </div>
        </div>
        @if (!rules.length) {
            <div class="dot-rules-empty">
                <i class="pi pi-sliders-h"></i>
                <h2>
                    {{ getI18nLabel('inputs.no.rules') | async }}
                    {{
                        getI18nLabel(
                            pageId && !isContentletHost ? 'inputs.on.page' : 'inputs.on.site'
                        ) | async
                    }}{{ getI18nLabel('inputs.add.one.now') | async }}
                </h2>
                @if (pageId && !isContentletHost) {
                    <span>
                        {{ getI18nLabel('inputs.page.rules.fired.every.time') | async }}
                    </span>
                }
                <button
                    (click)="addRule()"
                    pButton
                    label="{{ getI18nLabel('inputs.addRule.label') | async }}"
                    icon="pi pi-plus"></button>
            </div>
        }
        @for (rule of rules; track rule) {
            <dot-rule
                (updateName)="updateName.emit($event)"
                (updateFireOn)="updateFireOn.emit($event)"
                (updateEnabledState)="updateEnabledState.emit($event)"
                (updateExpandedState)="updateExpandedState.emit($event)"
                (createRuleAction)="createRuleAction.emit($event)"
                (updateRuleActionType)="updateRuleActionType.emit($event)"
                (updateRuleActionParameter)="updateRuleActionParameter.emit($event)"
                (deleteRuleAction)="deleteRuleAction.emit($event)"
                (openPushPublishDialog)="showPushPublishDialog($event)"
                (createCondition)="createCondition.emit($event)"
                (createConditionGroup)="createConditionGroup.emit($event)"
                (updateConditionGroupOperator)="updateConditionGroupOperator.emit($event)"
                (updateConditionType)="updateConditionType.emit($event)"
                (updateConditionParameter)="updateConditionParameter.emit($event)"
                (updateConditionOperator)="updateConditionOperator.emit($event)"
                (deleteCondition)="deleteCondition.emit($event)"
                (deleteRule)="deleteRule.emit($event)"
                [rule]="rule"
                [hidden]="isFiltered(rule) === true"
                [environmentStores]="$environmentStores()"
                [ruleActions]="rule._ruleActions"
                [ruleActionTypes]="$ruleActionTypes()"
                [conditionTypes]="$conditionTypes()"
                [saved]="rule._saved"
                [saving]="rule._saving"
                [errors]="rule._errors" />
        }
    </div>
}
