<form [formGroup]="formModel" let rf="ngForm">
    @if (showAddToBundleDialog) {
        <dot-add-to-bundle (cancel)="showAddToBundleDialog = false" [assetIdentifier]="rule.key" />
    }
    <div
        [class.cw-hidden]="hidden"
        [class.cw-disabled]="!rule.enabled"
        [class.cw-saving]="saving"
        [class.cw-saved]="saved"
        [class.cw-out-of-sync]="!saved && !saving"
        class="cw-rule">
        @if (!hidden) {
            <div
                (click)="setRuleExpandedState(!rule._expanded)"
                class="cw-header"
                flex
                layout="row">
                <div class="cw-header-info" flex="70" layout="row" layout-align="start center">
                    <i
                        [class.pi-angle-right]="!rule._expanded"
                        [class.pi-angle-down]="rule._expanded"
                        class="cw-header-info-arrow pi"
                        aria-hidden="true"></i>
                    <div flex="70" layout="column">
                        <input
                            (click)="$event.stopPropagation()"
                            class="cw-rule-name-input"
                            pInputText
                            placeholder="{{ rsrc('inputs.name.placeholder') | async }}"
                            formControlName="name"
                            [pAutoFocus]="true" />
                        <div
                            [hidden]="
                                !formModel.controls['name'].touched ||
                                formModel.controls['name'].valid
                            "
                            class="name cw-warn basic label"
                            flex="50">
                            Name is required
                        </div>
                    </div>
                    @if (!hideFireOn) {
                        <span class="cw-fire-on-label">
                            {{ rsrc('inputs.fireOn.label') | async }}
                        </span>
                    }
                    @if (!hideFireOn) {
                        <p-select
                            (onChange)="onFireOnChange($event.value)"
                            (click)="$event.stopPropagation()"
                            [ngModel]="fireOnValue"
                            [options]="fireOnOptions$ | async"
                            [style]="{ width: '150px' }"
                            [placeholder]="fireOnPlaceholder$ | async"
                            class="cw-fire-on-dropdown"
                            flex="none"
                            appendTo="body" />
                    }
                </div>
                <div class="cw-header-actions" flex="30" layout="row" layout-align="end center">
                    <span class="cw-rule-status-text" title="{{ statusText() }}">
                        {{ statusText(30) }}
                    </span>
                    <p-toggleSwitch
                        (onChange)="setRuleEnabledState($event)"
                        [(ngModel)]="rule.enabled"
                        [ngModelOptions]="{ standalone: true }"
                        [pTooltip]="rule.enabled ? tooltipRuleOnText : tooltipRuleOffText"
                        tooltipPosition="bottom" />
                    <div class="cw-btn-group">
                        <button
                            (click)="ruleOptions.toggle($event); $event.stopPropagation()"
                            class="p-button-secondary"
                            pButton
                            icon="pi pi-ellipsis-v"></button>
                        <button
                            (click)="
                                onCreateConditionGroupClicked();
                                setRuleExpandedState(true);
                                $event.stopPropagation()
                            "
                            [disabled]="!rule.isPersisted()"
                            class="p-button-secondary"
                            style="margin-left: 0.5rem"
                            pButton
                            icon="pi pi-plus"
                            arial-label="Add Group"></button>
                        <p-menu
                            [model]="ruleActionOptions"
                            #ruleOptions
                            appendTo="body"
                            [popup]="true" />
                    </div>
                </div>
            </div>
        }
        @if (rule._expanded) {
            <div class="cw-accordion-body">
                @for (group of rule._conditionGroups; track group; let i = $index) {
                    <dot-condition-group
                        (createCondition)="onCreateCondition($event)"
                        (deleteCondition)="onDeleteCondition($event, group)"
                        (updateConditionGroupOperator)="
                            onUpdateConditionGroupOperator($event, group)
                        "
                        (updateConditionType)="onUpdateConditionType($event, group)"
                        (updateConditionParameter)="onUpdateConditionParameter($event, group)"
                        (updateConditionOperator)="onUpdateConditionOperator($event, group)"
                        [group]="group"
                        [conditionTypes]="conditionTypes"
                        [groupIndex]="i"
                        [conditionTypePlaceholder]="conditionTypePlaceholder" />
                }
                <div class="cw-action-group">
                    <div class="cw-action-separator">
                        {{ rsrc('inputs.action.firesActions') | async }}
                    </div>
                    <div class="cw-rule-actions" flex layout="column">
                        @for (ruleAction of ruleActions; track ruleAction; let i = $index) {
                            <div class="cw-action-row" layout="row">
                                <dot-rule-action
                                    (updateRuleActionType)="onUpdateRuleActionType($event)"
                                    (updateRuleActionParameter)="
                                        onUpdateRuleActionParameter($event)
                                    "
                                    (deleteRuleAction)="onDeleteRuleAction($event)"
                                    [action]="ruleAction"
                                    [index]="i"
                                    [actionTypePlaceholder]="actionTypePlaceholder"
                                    [ruleActionTypes]="ruleActionTypes"
                                    flex
                                    layout="row" />
                                <div class="cw-btn-group cw-add-btn">
                                    @if (i === ruleActions.length - 1) {
                                        <div class="ui basic icon buttons">
                                            <button
                                                (click)="onCreateRuleAction()"
                                                [disabled]="!ruleAction.isPersisted()"
                                                class="p-button-rounded p-button-success p-button-text"
                                                pButton
                                                type="button"
                                                icon="pi pi-plus"
                                                arial-label="Add Action"></button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</form>
