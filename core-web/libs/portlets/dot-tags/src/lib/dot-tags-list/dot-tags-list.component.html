<p-toolbar class="gap-1 px-3 justify-start border-none!">
    <div class="flex w-full items-center gap-2 py-3">
        <p-iconField iconPosition="left">
            <p-inputIcon styleClass="pi pi-search" />
            <input
                pInputText
                type="text"
                [ngModel]="store.filter()"
                (ngModelChange)="onSearch($event)"
                [placeholder]="'tags.search.placeholder' | dm"
                [attr.aria-label]="'tags.search.placeholder' | dm"
                data-testid="tag-search-input"
                class="w-80" />
        </p-iconField>

        <div class="flex gap-2 ml-auto">
            @if (store.selectedTags().length > 0) {
                <p-button
                    [label]="store.exportLabelKey() | dm"
                    icon="pi pi-download"
                    [outlined]="true"
                    (onClick)="store.exportSelectedTags()"
                    data-testid="tag-export-btn" />
                <p-button
                    [label]="'tags.delete' | dm"
                    icon="pi pi-trash"
                    severity="danger"
                    [outlined]="true"
                    (onClick)="confirmDelete()"
                    data-testid="tag-delete-btn" />
            }
            <p-splitButton
                [label]="'add' | dm"
                icon="pi pi-plus"
                (onClick)="openCreateDialog()"
                [model]="addTagMenuItems"
                data-testid="tag-add-split-btn" />
        </div>
    </div>
</p-toolbar>

<!-- Table: flex-1 min-h-0 so pagination stays at bottom with scrollable body -->
<div class="flex-1 min-h-0 flex flex-col overflow-hidden" data-testid="tags-table-wrapper">
    <p-table
        [value]="store.tags()"
        [lazy]="true"
        (onLazyLoad)="onLazyLoad($event)"
        [paginator]="true"
        [rows]="store.rows()"
        [totalRecords]="store.totalRecords()"
        [first]="(store.page() - 1) * store.rows()"
        [rowsPerPageOptions]="[10, 25, 50]"
        [scrollable]="true"
        scrollHeight="flex"
        [pt]="$ptConfig()"
        [selection]="store.selectedTags()"
        (selectionChange)="store.setSelectedTags($event)"
        dataKey="id"
        data-testid="tags-table">
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 4rem">
                    <p-tableHeaderCheckbox />
                </th>
                <th pSortableColumn="tagname">
                    {{ 'tags.table.header.name' | dm }}
                    <p-sortIcon field="tagname" />
                </th>
                <th>{{ 'tags.table.header.site' | dm }}</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-tag>
            @if (store.status() === 'loading' || !store.tags().length) {
                <tr
                    data-testid="tags-loading-row"
                    class="cursor-default h-17 hover:bg-transparent!">
                    <td [style.width]="'4rem'" class="pl-4">
                        <span class="flex items-center justify-center h-full">
                            <p-skeleton height="1.5rem" width="2.5rem" />
                        </span>
                    </td>
                    <td>
                        <span class="flex items-center h-full">
                            <p-skeleton height="1.5rem" width="100%" />
                        </span>
                    </td>
                    <td>
                        <span class="flex items-center h-full">
                            <p-skeleton height="1.5rem" width="100%" />
                        </span>
                    </td>
                </tr>
            } @else {
                <tr data-testid="tag-row" class="cursor-pointer" (click)="openEditDialog(tag)">
                    <td (click)="$event.stopPropagation()">
                        <p-tableCheckbox [value]="tag" />
                    </td>
                    <td data-testid="tag-name">{{ tag.label }}</td>
                    <td data-testid="tag-site">{{ tag.siteName }}</td>
                </tr>
            }
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr class="hover:bg-transparent! h-full">
                <td colspan="3" class="p-6 text-center h-full border-none">
                    <div
                        class="flex flex-col items-center gap-4 max-w-100 mx-auto"
                        data-testid="tags-empty-state">
                        <div class="flex items-center justify-center w-20 h-20 rounded-full">
                            <i
                                class="pi pi-tags text-[var(--surface-500)] text-6xl!"
                                aria-hidden="true"></i>
                        </div>
                        <div class="flex flex-col text-center">
                            <h3 class="m-0 text-lg font-medium text-gray-800">
                                {{ 'tags.empty.state.title' | dm }}
                            </h3>
                            <p class="m-0 text-[var(--text-color)] text-base leading-6">
                                {{ 'tags.empty.state.description' | dm }}
                            </p>
                        </div>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-confirmDialog />
