<ng-container *ngIf="editorState$ | async as es">
    <dot-device-selector-seo
        #deviceSelector
        [apiLink]="es.iframeURL"
        [hideMediaTiles]="true"
        (selected)="updateCurrentDevice($event)"
        appendTo="body"
        data-testId="dot-device-selector"></dot-device-selector-seo>
    <dot-edit-ema-toolbar>
        <ng-container left>
            <p-button
                [label]="'editpage.toolbar.preview.page' | dm"
                (onClick)="deviceSelector.openMenu($event)"
                icon="pi pi-desktop"
                styleClass="p-button-text p-button-sm"
                data-testId="ema-preview" />
            <p-button label="Bookmark" icon="pi pi-star" styleClass="p-button-text p-button-sm" />
            <p-button
                [cdkCopyToClipboard]="es.iframeURL"
                [label]="'editpage.header.copy' | dm"
                (cdkCopyToClipboardCopied)="triggerCopyToast()"
                icon="pi pi-copy"
                styleClass="p-button-text p-button-sm"
                data-testId="ema-copy-url" />
            <a
                class="p-button-sm p-button-text"
                [href]="es.apiURL"
                [title]="es.apiURL"
                pButton
                target="_blank"
                data-testId="ema-api-link"
                icon="pi pi-link"
                label="API">
            </a>
        </ng-container>
        <ng-container right>
            <dot-edit-ema-language-selector
                [language]="es.editor.viewAs.language"
                (selected)="onLanguageSelected($event)"
                data-testId="language-selector" />
            <dot-edit-ema-persona-selector
                #personaSelector
                [pageId]="es.editor.page.identifier"
                [value]="es.editor.viewAs.persona"
                (selected)="onPersonaSelected($event)"
                (despersonalize)="onDespersonalize($event)"
                data-testId="persona-selector" />
            <p-button class="p-button-sm" label="Save" />
        </ng-container>
    </dot-edit-ema-toolbar>
    <div
        class="editor-content"
        [ngClass]="{
            'editor-content--device': !!currentDevice
        }">
        <dot-ema-device-display
            *ngIf="!!currentDevice"
            [currentDevice]="currentDevice"
            (resetDevice)="updateCurrentDevice()"
            data-testId="device-display" />
        <div
            class="iframe-wrapper"
            [ngClass]="{
                'iframe-wrapper--device': !!currentDevice
            }"
            [ngStyle]="{
                width: !!currentDevice ? currentDevice.cssWidth + 'px' : '100%',
                height: !!currentDevice ? currentDevice.cssHeight + 'px' : '100%'
            }">
            <iframe
                #iframe
                [src]="es.iframeURL | safeUrl"
                [title]="host"
                data-testId="iframe"
                style="border: none"
                width="100%"
                height="100%"></iframe>
            <dot-ema-contentlet-tools
                *ngIf="!rows.length && !!contentlet && !currentDevice"
                [contentlet]="contentlet"
                (edit)="editContentlet($event)"
                (delete)="deleteContentlet($event)"
                (addWidget)="addWidget($event)"
                (addForm)="addForm($event)"
                (addContent)="addContentlet($event)"
                data-testId="contentlet-tools" />
            <dot-ema-page-dropzone
                *ngIf="!!rows.length && !currentDevice"
                [rows]="rows"
                (place)="onPlaceItem($event)"
                data-testId="dropzone" />
        </div>
    </div>
    <dot-edit-ema-palette
        *ngIf="es.isEnterpriseLicense && !currentDevice"
        [languageId]="es.editor.viewAs.language.id"
        [containers]="es.editor.containers"
        (dragStart)="onDragStart($event)"
        (dragEnd)="onDragEnd($event)"
        data-testId="palette" />
</ng-container>
<p-dialog
    #dialog
    *ngIf="!currentDevice && dialogState$ | async as ds"
    [visible]="!!ds.type && ds.type !== 'shell'"
    [style]="{ height: '90vh', width: '90vw' }"
    [header]="ds.header"
    [draggable]="false"
    [resizable]="false"
    [maximizable]="true"
    [modal]="true"
    (visibleChange)="resetDialogIframeData()"
    data-testId="dialog"
    styleClass="edit-ema-dialog">
    <ng-container [ngSwitch]="ds.type">
        <dot-ema-form-selector *ngSwitchCase="'form'" (selected)="addSelectedForm($event)" />

        <ng-container *ngSwitchCase="'content'">
            <iframe
                #dialogIframe
                [style]="{
                    border: 'none',
                    display: ds.iframeLoading ? 'none' : 'block'
                }"
                [src]="ds.iframeURL | safeUrl"
                (load)="onIframeLoad()"
                title="dialog"
                data-testId="dialog-iframe"
                width="100%"
                height="100%"></iframe>
            <dot-spinner
                *ngIf="ds.iframeLoading"
                [ngStyle]="{ position: 'absolute', top: '50%' }"
                data-testId="spinner"></dot-spinner>
        </ng-container>
    </ng-container>
</p-dialog>
<p-confirmDialog
    *ngIf="!currentDevice"
    [style]="{
        width: '400px'
    }"
    [rejectIcon]="null"
    [acceptIcon]="null"
    rejectButtonStyleClass="p-button-outlined"
    data-testId="confirm-dialog"></p-confirmDialog>
