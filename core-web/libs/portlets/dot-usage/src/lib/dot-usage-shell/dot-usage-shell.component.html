<p-messages severity="info" data-testid="analytics-message">
    <ng-template pTemplate="content">
        <div class="flex align-items-center justify-content-between gap-2 w-full">
            <div class="flex align-items-center gap-2">
                <i class="pi pi-info-circle"></i>
                <span data-testid="message-content">
                    {{ 'analytics.feature.state' | dm }}
                    <b>{{ 'development' | dm }}</b>
                </span>
            </div>

        </div>
    </ng-template>
</p-messages>

<p-toolbar>
    <div class="p-toolbar-group-start">
        @if (lastUpdated()) {
            <span class="text-color-secondary">
                {{ 'usage.dashboard.lastUpdated' | dm }}:
                {{ lastUpdated()! | date: 'short' }}
            </span>
        }
    </div>
    <div class="p-toolbar-group-end">
        <p-button
            icon="pi pi-refresh"
            [label]="'analytics.dashboard.refresh.button' | dm"
            [loading]="loading()"
            [disabled]="loading()"
            (onClick)="onRefresh()"
            [rounded]="false"
            severity="primary"
            size="small"
            data-testid="refresh-button"></p-button>
    </div>
</p-toolbar>

<div class="mx-auto" style="max-width: 50rem">
    <!-- Loading State -->
    @if (loading()) {
        <div class="flex flex-column gap-6">
            <!-- Site Metrics: 3 cards -->
            <div>
                <h2>
                    <p-skeleton width="10rem" height="23px"></p-skeleton>
                </h2>
                <div class="flex gap-3">
                    @for (i of [1, 2, 3]; track i) {
                        <p-card class="flex-1">
                            <ng-template pTemplate="header">
                                <h3>
                                    <p-skeleton width="60%"></p-skeleton>
                                </h3>
                            </ng-template>
                            <ng-template pTemplate="body">
                                <p class="m-0">
                                    <p-skeleton width="80%" height="3rem"></p-skeleton>
                                </p>
                            </ng-template>
                        </p-card>
                    }
                </div>
            </div>

            <!-- System Configuration: 3 cards -->
            <div>
                <h2>
                    <p-skeleton width="12rem" height="1.5rem"></p-skeleton>
                </h2>
                <div class="flex gap-3">
                    @for (i of [1, 2, 3]; track i) {
                        <p-card class="flex-1">
                            <ng-template pTemplate="header">
                                <h3>
                                    <p-skeleton width="60%"></p-skeleton>
                                </h3>
                            </ng-template>
                            <ng-template pTemplate="body">
                                <p class="m-0">
                                    <p-skeleton width="80%" height="3rem"></p-skeleton>
                                </p>
                            </ng-template>
                        </p-card>
                    }
                </div>
            </div>

            <!-- User Activity: 2 cards -->
            <div>
                <h2>
                    <p-skeleton width="10rem" height="1.5rem"></p-skeleton>
                </h2>
                <div class="flex gap-3">
                    @for (i of [1, 2]; track i) {
                        <p-card class="flex-1">
                            <ng-template pTemplate="header">
                                <h3>
                                    <p-skeleton width="60%"></p-skeleton>
                                </h3>
                            </ng-template>
                            <ng-template pTemplate="body">
                                <p class="m-0">
                                    <p-skeleton width="80%" height="3rem"></p-skeleton>
                                </p>
                            </ng-template>
                        </p-card>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Error State -->
    @if (error() && !loading()) {
        <p-card>
            <ng-template pTemplate="header">
                <h3 class="flex align-items-center gap-2">
                    <i class="pi pi-exclamation-triangle"></i>
                    <strong>{{ 'usage.dashboard.error.title' | dm }}</strong>
                </h3>
            </ng-template>
            <ng-template pTemplate="body">
                <p class="m-0 mb-3">
                    @if (error() === 'usage.dashboard.error.requestFailed' && errorStatus()) {
                        {{
                            'usage.dashboard.error.requestFailed' | dm: [errorStatus()!.toString()]
                        }}
                    } @else {
                        {{ error() | dm }}
                    }
                </p>
                <p-button
                    [label]="'usage.dashboard.retry.button' | dm"
                    severity="secondary"
                    size="small"
                    (onClick)="onRetry()"
                    data-testid="retry-button"></p-button>
            </ng-template>
        </p-card>
    }

    <!-- Dashboard Content -->
    @if (hasData() && !loading()) {
        <div class="flex flex-column gap-6">
            @for (category of getCategories(); track category) {
                @if (getCategoryMetrics(category); as categoryMetrics) {
                    <div>
                        <h2>{{ getCategoryTitleKey(category) | dm }}</h2>
                        <div class="flex gap-3">
                            @for (
                                metricEntry of categoryMetrics | keyvalue;
                                track metricEntry.key
                            ) {
                                @if (metricEntry.value; as metricData) {
                                    <p-card
                                        class="flex-1"
                                        [attr.data-testid]="
                                            category + '-' + metricEntry.key + '-card'
                                        ">
                                        <ng-template pTemplate="header">
                                            <h3>
                                                {{ metricData.displayLabel | dm }}
                                            </h3>
                                        </ng-template>
                                        <ng-template pTemplate="body">
                                            <p
                                                class="metric-value"
                                                [class.metric-value--text]="
                                                    isStringValue(metricData.value)
                                                ">
                                                @if (
                                                    isI18nKey(formatMetricValue(metricData.value))
                                                ) {
                                                    {{ formatMetricValue(metricData.value) | dm }}
                                                } @else {
                                                    {{ formatMetricValue(metricData.value) }}
                                                }
                                            </p>
                                        </ng-template>
                                    </p-card>
                                }
                            }
                        </div>
                    </div>
                }
            }
        </div>
    }
</div>
