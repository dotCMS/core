<p-message severity="info" data-testid="analytics-message" [pt]="{ text: { class: 'w-full' } }">
    <div class="flex items-center justify-between gap-2 w-full">
        <div class="flex items-center gap-2">
            <i class="text-gray-900 pi pi-info-circle"></i>
            <span data-testid="message-content" class="text-gray-900 text-sm">
                {{ 'analytics.feature.state' | dm }}
                <b>{{ 'development' | dm }}</b>
            </span>
        </div>
    </div>
</p-message>

<p-toolbar class="block mb-6">
    <div class="p-toolbar-group-start text-sm">
        @if (lastUpdated()) {
            <span class="text-gray-600">
                {{ 'usage.dashboard.lastUpdated' | dm }}:
                {{ lastUpdated()! | date: 'short' }}
            </span>
        }
    </div>
    <div class="p-toolbar-group-end">
        <p-button
            icon="pi pi-refresh"
            [label]="'analytics.dashboard.refresh.button' | dm"
            [loading]="loading()"
            [disabled]="loading()"
            (onClick)="onRefresh()"
            [rounded]="false"
            severity="primary"
            size="small"
            data-testid="refresh-button"></p-button>
    </div>
</p-toolbar>

<div class="mx-auto max-w-[50rem]">
    <!-- Loading State -->
    @if (loading()) {
        <div
            class="flex flex-col gap-6"
            role="status"
            aria-live="polite"
            [attr.aria-busy]="loading()">
            <span class="sr-only">
                {{ 'usage.dashboard.loading' | dm }}
            </span>
            <!-- Site Metrics: 3 cards -->
            <div>
                <h2 class="mb-3 text-xl text-gray-900 font-bold tracking-tight leading-tight">
                    <p-skeleton class="block" width="10rem" height="1.5rem"></p-skeleton>
                </h2>
                <div class="flex gap-3">
                    @for (i of [1, 2, 3]; track i) {
                        <p-card
                            [pt]="{
                                root: { class: 'flex-1 border-[1px] border-gray-300 rounded-2xl' },
                                header: {class: 'px-4 pt-4 pb-0'},
                            }">
                            <ng-template pTemplate="header">
                                <h3 class="text-xs text-gray-600 uppercase font-normal tracking-wider m-0 leading-4">
                                    <p-skeleton class="block" width="60%"></p-skeleton>
                                </h3>
                            </ng-template>
                            <ng-template pTemplate="body">
                                <p class="m-0">
                                    <p-skeleton class="block" width="80%" height="3rem"></p-skeleton>
                                </p>
                            </ng-template>
                        </p-card>
                    }
                </div>
            </div>

            <!-- System Configuration: 3 cards -->
            <div>
                <h2 class="mb-3 text-xl text-gray-900 font-bold tracking-tight leading-tight">
                    <p-skeleton class="block" width="12rem" height="1.5rem"></p-skeleton>
                </h2>
                <div class="flex gap-3">
                    @for (i of [1, 2, 3]; track i) {
                        <p-card
                            [pt]="{
                                root: { class: 'flex-1 border-[1px] border-gray-300 rounded-2xl' },
                                header: {class: 'px-4 pt-4 pb-0'},
                            }">
                            <ng-template pTemplate="header">
                                <h3 class="text-xs text-gray-600 uppercase font-normal tracking-wider m-0 leading-4">
                                    <p-skeleton class="block" width="60%"></p-skeleton>
                                </h3>
                            </ng-template>
                            <ng-template pTemplate="body">
                                <p class="m-0">
                                    <p-skeleton class="block" width="80%" height="3rem"></p-skeleton>
                                </p>
                            </ng-template>
                        </p-card>
                    }
                </div>
            </div>

            <!-- User Activity: 2 cards -->
            <div>
                <h2 class="mb-3 text-xl text-gray-900 font-bold tracking-tight leading-tight">
                    <p-skeleton class="block" width="10rem" height="1.5rem"></p-skeleton>
                </h2>
                <div class="flex gap-3">
                    @for (i of [1, 2]; track i) {
                        <p-card
                            [pt]="{
                                root: { class: 'flex-1 border-[1px] border-gray-300 rounded-2xl' },
                                header: {class: 'px-4 pt-4 pb-0'},
                            }">
                            <ng-template pTemplate="header">
                                <h3 class="text-xs text-gray-600 uppercase font-normal tracking-wider m-0 leading-4">
                                    <p-skeleton class="block" width="60%"></p-skeleton>
                                </h3>
                            </ng-template>
                            <ng-template pTemplate="body">
                                <p class="m-0">
                                    <p-skeleton class="block" width="80%" height="3rem"></p-skeleton>
                                </p>
                            </ng-template>
                        </p-card>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Error State -->
    @if (error() && !loading()) {
        <p-card
            [pt]="{
                root: { class: 'border-[1px] border-gray-300 rounded-2xl' },
                header: {class: 'px-4 pt-4 pb-0'},
            }">
            <ng-template pTemplate="header">
                <h3 class="flex items-center gap-2 text-xs text-gray-600 uppercase font-normal tracking-wider m-0 leading-4">
                    <i class="pi pi-exclamation-triangle" aria-hidden="true"></i>
                    <strong>{{ 'usage.dashboard.error.title' | dm }}</strong>
                </h3>
            </ng-template>
            <ng-template pTemplate="body">
                <p class="m-0 mb-3">
                    @if (error() === 'usage.dashboard.error.requestFailed' && errorStatus()) {
                        {{
                            'usage.dashboard.error.requestFailed' | dm: [errorStatus()!.toString()]
                        }}
                    } @else {
                        {{ error() | dm }}
                    }
                </p>
                <p-button
                    [label]="'usage.dashboard.retry.button' | dm"
                    severity="secondary"
                    size="small"
                    (onClick)="onRetry()"
                    data-testid="retry-button"></p-button>
            </ng-template>
        </p-card>
    }

    <!-- Dashboard Content -->
    @if (hasData() && !loading()) {
        <div class="flex flex-col gap-6">
            @for (category of getCategories(); track category) {
                @if (getCategoryMetrics(category); as categoryMetrics) {
                    <div>
                        <h2 class="mb-3 text-xl text-gray-900 font-bold tracking-tight leading-tight">{{ getCategoryTitleKey(category) | dm }}</h2>
                        <div class="flex gap-3">
                            @for (
                                metricEntry of categoryMetrics | keyvalue;
                                track metricEntry.key
                            ) {
                                @if (metricEntry.value; as metricData) {
                                    <p-card
                                        [attr.data-testid]="
                                            category + '-' + metricEntry.key + '-card'
                                        "
                                        [pt]="{
                                            root: { class: 'flex-1 border-[1px] border-gray-300 rounded-2xl' },
                                            header: {class: 'px-4 pt-4 pb-0'},
                                        
                                        }">
                                        <ng-template pTemplate="header">
                                            <h3 class="text-xs text-gray-600 uppercase font-normal tracking-wider m-0 leading-4">
                                                {{ metricData.displayLabel | dm }}
                                            </h3>
                                        </ng-template>
                                        <ng-template pTemplate="body">
                                            <p
                                                class="m-0 text-4xl text-center"
                                                [class.metric-value--text]="
                                                    isStringValue(metricData.value)
                                                ">
                                                @if (
                                                    isI18nKey(formatMetricValue(metricData.value))
                                                ) {
                                                    {{ formatMetricValue(metricData.value) | dm }}
                                                } @else {
                                                    {{ formatMetricValue(metricData.value) }}
                                                }
                                            </p>
                                        </ng-template>
                                    </p-card>
                                }
                            }
                        </div>
                    </div>
                }
            }
        </div>
    }
</div>
