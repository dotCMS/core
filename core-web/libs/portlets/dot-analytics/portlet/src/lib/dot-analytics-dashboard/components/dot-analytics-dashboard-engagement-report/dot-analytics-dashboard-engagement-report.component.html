<div class="flex flex-col gap-3">
    @let kpis = $kpis();
    @let status = $status();

    <!-- Row 1: Engagement Rate + Trend Chart -->
    <div class="flex gap-3 max-lg:flex-col">
        <div class="flex-1 min-w-[280px] max-lg:min-w-0 max-lg:w-full">
            <dot-analytics-dashboard-metrics
                class="h-full"
                [name]="'analytics.engagement.metrics.engagement-rate'"
                [value]="
                    (kpis?.engagementRate?.value ?? '') + (kpis?.engagementRate?.value ? '%' : '')
                "
                [trend]="kpis?.engagementRate?.trend ?? 0"
                [subtitle]="kpis?.engagementRate?.subtitle ?? ''"
                [status]="status"
                data-testid="analytics-metric-card">
                <dot-analytics-sparkline
                    [data]="kpis?.engagementRate?.sparklineData ?? []"
                    [valueLabel]="'analytics.engagement.sparkline.value-label' | dm"
                    valueSuffix="%"
                    [status]="$status()" />
                @if ($isLoaded()) {
                    <div class="flex justify-center mt-auto">
                        <button
                            pButton
                            type="button"
                            [label]="'analytics.engagement.dialog.how-calculated.button' | dm"
                            class="p-button-outlined p-button-sm"
                            (click)="$showCalculationDialog.set(true)"></button>
                    </div>
                }
            </dot-analytics-dashboard-metrics>
        </div>

        <div class="flex-[2] min-w-0 max-lg:w-full">
            <dot-analytics-dashboard-chart
                class="h-full"
                [title]="'analytics.engagement.charts.trend.title' | dm"
                [type]="'bar'"
                [data]="$trend()!"
                [status]="status"
                height="13rem"
                data-testid="analytics-trend-chart" />
        </div>
    </div>

    <!-- Row 2: Three metrics -->
    <div class="flex gap-3 flex-wrap max-lg:flex-col">
        <dot-analytics-dashboard-metrics
            class="flex-1 min-w-[280px] max-lg:min-w-0 max-lg:w-full"
            [name]="'analytics.engagement.metrics.avg-interactions'"
            [value]="kpis?.avgInteractions?.value ?? ''"
            [trend]="kpis?.avgInteractions?.trend ?? 0"
            icon="pi-bullseye"
            [status]="status"
            data-testid="analytics-metric-card" />
        <dot-analytics-dashboard-metrics
            class="flex-1 min-w-[280px] max-lg:min-w-0 max-lg:w-full"
            [name]="'analytics.engagement.metrics.avg-session-time'"
            [value]="kpis?.avgSessionTime?.value ?? ''"
            [trend]="kpis?.avgSessionTime?.trend ?? 0"
            icon="pi-clock"
            [status]="status"
            data-testid="analytics-metric-card" />
        <dot-analytics-dashboard-metrics
            class="flex-1 min-w-[280px] max-lg:min-w-0 max-lg:w-full"
            [name]="'analytics.engagement.metrics.total-sessions'"
            [value]="kpis?.conversionRate?.value ?? ''"
            [trend]="kpis?.conversionRate?.trend ?? 0"
            icon="pi-bullseye"
            [status]="status"
            data-testid="analytics-metric-card" />
    </div>

    <!-- Row 3: Breakdown Chart + Platform Analytics -->
    @defer (on viewport) {
        <div class="flex gap-3 max-lg:flex-col align-items-stretch">
            <div class="flex-[5] min-w-0 max-lg:w-full">
                <dot-analytics-dashboard-chart
                    [title]="'analytics.engagement.charts.breakdown.title' | dm"
                    [type]="'doughnut'"
                    [data]="$breakdown()!"
                    [status]="status"
                    data-testid="analytics-breakdown-chart" />
            </div>
            <div class="flex-[7] min-w-0 max-lg:w-full">
                <dot-analytics-platforms-table
                    class="h-full"
                    [platforms]="$platforms()"
                    [status]="status" />
            </div>
        </div>
    } @placeholder {
        <div style="min-height: 24rem"></div>
    }
</div>

<!-- How it's calculated Dialog -->
<p-dialog
    [header]="'analytics.engagement.dialog.how-calculated.title' | dm"
    [(visible)]="$showCalculationDialog"
    [modal]="true"
    [dismissableMask]="true"
    [closable]="true"
    [style]="{ width: '32rem' }">
    <p class="text-color-secondary mt-0">
        {{ 'analytics.engagement.dialog.how-calculated.intro' | dm }}
    </p>

    <p class="font-semibold mb-2">
        {{ 'analytics.engagement.dialog.how-calculated.criteria-title' | dm }}
    </p>

    <ul class="engagement-criteria-list pl-4 m-0">
        <li class="mb-2">{{ 'analytics.engagement.dialog.how-calculated.criteria-time' | dm }}</li>
        <li class="mb-2">{{ 'analytics.engagement.dialog.how-calculated.criteria-click' | dm }}</li>
    </ul>

    <p class="text-color-secondary mt-3 mb-0">
        {{ 'analytics.engagement.dialog.how-calculated.conclusion' | dm }}
    </p>
</p-dialog>
