@let isLoading = $isLoading();
@let isError = $isError();
@let isEmpty = $isEmpty();
@let data = $data();

<p-card class="border border-gray-400 rounded-xl p-4">
    <ng-template pTemplate="header">
        <h3 class="text-lg font-bold text-black leading-normal m-0">
            {{ 'analytics.table.conversions-overview.title' | dm }}
        </h3>
    </ng-template>

    @if (isLoading) {
        <!-- Loading State -->
        <div class="flex flex-column gap-3 p-4" data-testid="conversions-overview-loading">
            @for (i of [1, 2, 3]; track i) {
                <div class="flex gap-3">
                    <div class="flex-1 h-6 bg-gray-200 rounded"></div>
                    <div class="flex-1 h-6 bg-gray-200 rounded"></div>
                    <div class="w-24 h-6 bg-gray-200 rounded"></div>
                    <div class="w-24 h-6 bg-gray-200 rounded"></div>
                    <div class="flex-2 h-6 bg-gray-200 rounded"></div>
                </div>
            }
        </div>
    } @else if (isError) {
        <!-- Error State -->
        <div class="p-4 min-h-[200px]" data-testid="conversions-overview-error">
            <dot-analytics-state-message
                message="analytics.error.loading.conversions-overview"
                icon="pi-exclamation-triangle" />
        </div>
    } @else if (isEmpty) {
        <!-- Empty State -->
        <div class="p-4 min-h-[200px]" data-testid="conversions-overview-empty">
            <dot-analytics-state-message
                message="analytics.table.conversions-overview.empty"
                icon="pi-info-circle" />
        </div>
    } @else {
        <!-- Data Table -->
        <p-table
            [value]="data"
            class="p-datatable-sm"
            [paginator]="true"
            [rows]="20"
            [rowsPerPageOptions]="[20, 50, 100]"
            sortField="Conversion.convRate"
            [sortOrder]="-1"
            data-testid="conversions-overview-table">
            <ng-template pTemplate="header">
                <tr>
                    <th>{{ 'analytics.table.conversions-overview.conversion-name' | dm }}</th>
                    <th class="text-right" pSortableColumn="Conversion.totalConversion">
                        {{ 'analytics.table.conversions-overview.total' | dm }}
                        <p-sortIcon field="Conversion.totalConversion" />
                    </th>
                    <th class="text-right" pSortableColumn="Conversion.convRate">
                        {{ 'analytics.table.conversions-overview.conv-rate' | dm }}
                        <p-sortIcon field="Conversion.convRate" />
                    </th>
                    <th>
                        {{ 'analytics.table.conversions-overview.top-attributed-content' | dm }}
                    </th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
                <tr>
                    <td>
                        <p-tag
                            [value]="row['Conversion.conversionName']"
                            class="bg-blue-50 border border-blue-200 rounded-sm text-blue-700 text-xs font-semibold py-0 px-2" />
                    </td>
                    <td class="text-right text-primary font-semibold">
                        {{ row['Conversion.totalConversion'] | number }}
                    </td>
                    <td class="text-right font-semibold">
                        {{ row['Conversion.convRate'] | number: '1.0-2' }}%
                    </td>
                    <td>
                        <div class="flex flex-col gap-1">
                            @for (
                                content of row['Conversion.topAttributedContent'];
                                track content.identifier
                            ) {
                                <div
                                    class="flex items-center justify-between gap-3 text-sm leading-snug">
                                    <div class="flex items-center gap-2 flex-1 min-w-0">
                                        <span class="text-black truncate">{{ content.title }}</span>
                                        <p-chip
                                            [label]="(content.conversions | number) || '0'"
                                            class="bg-gray-100 text-gray-700 text-xs font-semibold py-0.5 px-1 h-auto"
                                            pTooltip="Conversions"
                                            tooltipPosition="top" />
                                    </div>
                                    <span
                                        class="font-semibold text-primary min-w-[50px] text-right whitespace-nowrap">
                                        {{ content.conv_rate | number: '1.0-2' }}%
                                    </span>
                                </div>
                            }
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    }
</p-card>
