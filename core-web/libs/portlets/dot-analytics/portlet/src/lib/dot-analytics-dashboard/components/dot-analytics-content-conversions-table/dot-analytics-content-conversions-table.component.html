@let isLoading = $isLoading();
@let isError = $isError();
@let isEmpty = $isEmpty();
@let data = $data();
@let eventTypeOptions = $eventTypeOptions();

<p-card>
    <ng-template pTemplate="header">
        <h3 class="table-title">
            {{ 'analytics.table.content-conversions.title' | dm }}
        </h3>
    </ng-template>

    @if (isLoading) {
        <!-- Loading State -->
        <div class="flex flex-column gap-3 p-4" data-testid="content-conversions-loading">
            @for (i of [1, 2, 3]; track i) {
                <div class="flex gap-3">
                    <div
                        class="skeleton-cell flex-1"
                        style="
                            height: 1.5rem;
                            background: var(--surface-200);
                            border-radius: 4px;
                        "></div>
                    <div
                        class="skeleton-cell flex-1"
                        style="
                            height: 1.5rem;
                            background: var(--surface-200);
                            border-radius: 4px;
                        "></div>
                    <div
                        class="skeleton-cell"
                        style="
                            width: 80px;
                            height: 1.5rem;
                            background: var(--surface-200);
                            border-radius: 4px;
                        "></div>
                    <div
                        class="skeleton-cell"
                        style="
                            width: 80px;
                            height: 1.5rem;
                            background: var(--surface-200);
                            border-radius: 4px;
                        "></div>
                    <div
                        class="skeleton-cell"
                        style="
                            width: 80px;
                            height: 1.5rem;
                            background: var(--surface-200);
                            border-radius: 4px;
                        "></div>
                </div>
            }
        </div>
    } @else if (isError) {
        <!-- Error State -->
        <div class="p-4" style="min-height: 200px" data-testid="content-conversions-error">
            <dot-analytics-state-message
                message="analytics.error.loading.content-conversions"
                icon="pi-exclamation-triangle" />
        </div>
    } @else if (isEmpty) {
        <!-- Empty State -->
        <div class="p-4" style="min-height: 200px" data-testid="content-conversions-empty">
            <dot-analytics-state-message
                message="analytics.table.content-conversions.empty"
                icon="pi-info-circle" />
        </div>
    } @else {
        <!-- Data Table -->
        <p-table
            [value]="data"
            styleClass="p-datatable-sm"
            [paginator]="true"
            [rows]="20"
            [rowsPerPageOptions]="[20, 50, 100]"
            sortField="conversionRate"
            [sortOrder]="-1"
            data-testid="content-conversions-table">
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="eventType">
                        <div class="flex align-items-center">
                            {{ 'analytics.table.content-conversions.type' | dm }}
                            <p-sortIcon field="eventType" />
                            <p-columnFilter
                                field="eventType"
                                matchMode="in"
                                display="menu"
                                [showMatchModes]="false"
                                [showOperator]="false"
                                [showAddButton]="false"
                                [showClearButton]="false"
                                [showApplyButton]="false">
                                <ng-template
                                    pTemplate="filter"
                                    let-value
                                    let-filter="filterCallback">
                                    <p-multiSelect
                                        [ngModel]="value"
                                        [options]="eventTypeOptions"
                                        placeholder="Any"
                                        (onChange)="filter($event.value)"
                                        optionLabel="label"
                                        optionValue="value"
                                        [filter]="false"
                                        [showHeader]="false"
                                        data-testid="event-type-filter">
                                        <ng-template let-option pTemplate="item">
                                            <p-tag
                                                [value]="option.label"
                                                severity="secondary"
                                                [styleClass]="'event-type-badge ' + option.value" />
                                        </ng-template>
                                    </p-multiSelect>
                                </ng-template>
                            </p-columnFilter>
                        </div>
                    </th>
                    <th>
                        <div class="flex align-items-center">
                            {{ 'analytics.table.content-conversions.title-column' | dm }}
                            <p-columnFilter
                                type="text"
                                field="title"
                                display="menu"
                                [placeholder]="
                                    'analytics.table.content-conversions.filter.search-placeholder'
                                        | dm
                                "
                                [showMatchModes]="false"
                                [showOperator]="false"
                                [showAddButton]="false" />
                        </div>
                    </th>
                    <th class="text-right" pSortableColumn="events">
                        {{ 'analytics.table.content-conversions.count' | dm }}
                        <p-sortIcon field="events" />
                    </th>
                    <th class="text-right" pSortableColumn="conversions">
                        {{ 'analytics.table.content-conversions.conversions' | dm }}
                        <p-sortIcon field="conversions" />
                    </th>
                    <th class="text-right" pSortableColumn="conversionRate">
                        {{ 'analytics.table.content-conversions.conv-rate' | dm }}
                        <p-sortIcon field="conversionRate" />
                    </th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
                <tr>
                    <td>
                        <p-tag
                            [value]="row.eventType"
                            severity="secondary"
                            [styleClass]="'event-type-badge ' + row.eventType" />
                    </td>
                    <td>
                        <div class="content-title-cell">
                            <div class="content-title">{{ row.title }}</div>
                            <div class="content-identifier">{{ row.identifier }}</div>
                        </div>
                    </td>
                    <td class="text-right">{{ row.events | number }}</td>
                    <td class="text-right text-primary font-semibold">
                        {{ row.conversions | number }}
                    </td>
                    <td class="text-right">{{ row.conversionRate | number: '1.0-2' }}%</td>
                </tr>
            </ng-template>
        </p-table>
    }
</p-card>
