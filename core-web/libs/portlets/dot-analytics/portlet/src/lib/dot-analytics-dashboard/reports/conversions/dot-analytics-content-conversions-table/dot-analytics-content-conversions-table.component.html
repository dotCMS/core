@let isLoading = $isLoading();
@let isError = $isError();
@let isEmpty = $isEmpty();
@let data = $data();
@let eventTypeOptions = $eventTypeOptions();

@if (isLoading) {
    <div class="skeleton-table" data-testid="content-conversions-loading">
        <div class="skeleton-table__header">
            <div class="flex-1"><p-skeleton height="1rem" width="60%" /></div>
            <div class="flex-[2]"><p-skeleton height="1rem" width="50%" /></div>
            <div style="width: 5rem"><p-skeleton height="1rem" width="80%" /></div>
            <div style="width: 6rem"><p-skeleton height="1rem" width="80%" /></div>
            <div style="width: 5.5rem"><p-skeleton height="1rem" width="80%" /></div>
        </div>
        @for (i of [1, 2, 3, 4, 5]; track i) {
            <div class="skeleton-table__row">
                <div class="flex-1"><p-skeleton height="1rem" width="70%" /></div>
                <div class="flex-[2]"><p-skeleton height="1rem" width="60%" /></div>
                <div style="width: 5rem"><p-skeleton height="1rem" width="50%" /></div>
                <div style="width: 6rem"><p-skeleton height="1rem" width="50%" /></div>
                <div style="width: 5.5rem"><p-skeleton height="1rem" width="60%" /></div>
            </div>
        }
        <div class="skeleton-table__pagination">
            <p-skeleton height="1.5rem" width="15rem" />
        </div>
    </div>
} @else if (isError) {
    <div class="table-state" data-testid="content-conversions-error">
        <dot-analytics-state-message
            message="analytics.error.loading.content-conversions"
            icon="pi-exclamation-triangle" />
    </div>
} @else if (isEmpty) {
    <div class="table-state" data-testid="content-conversions-empty">
        <dot-analytics-empty-state />
    </div>
} @else {
    <!-- Data Table -->
    <p-table
        [value]="data"
        styleClass="p-datatable-sm"
        [paginator]="true"
        [rows]="20"
        [rowsPerPageOptions]="[20, 50, 100]"
        sortField="conversionRate"
        [sortOrder]="-1"
        data-testid="content-conversions-table">
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="eventType">
                    <div class="flex items-center">
                        {{ 'analytics.table.content-conversions.type' | dm }}
                        <p-sortIcon field="eventType" />
                        <p-columnFilter
                            field="eventType"
                            matchMode="in"
                            display="menu"
                            [showMatchModes]="false"
                            [showOperator]="false"
                            [showAddButton]="false"
                            [showClearButton]="false"
                            [showApplyButton]="false">
                            <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                                <p-multiSelect
                                    [ngModel]="value"
                                    [options]="eventTypeOptions"
                                    placeholder="Any"
                                    (onChange)="filter($event.value)"
                                    optionLabel="label"
                                    optionValue="value"
                                    [filter]="false"
                                    [showHeader]="false"
                                    data-testid="event-type-filter">
                                    <ng-template let-option pTemplate="item">
                                        <p-tag
                                            [value]="option.label"
                                            severity="secondary"
                                            [styleClass]="'event-type-badge ' + option.value" />
                                    </ng-template>
                                </p-multiSelect>
                            </ng-template>
                        </p-columnFilter>
                    </div>
                </th>
                <th>
                    {{ 'analytics.table.content-conversions.title-column' | dm }}
                    <p-columnFilter
                        type="text"
                        field="title"
                        display="menu"
                        [placeholder]="
                            'analytics.table.content-conversions.filter.search-placeholder' | dm
                        "
                        [showMatchModes]="false"
                        [showOperator]="false"
                        [showAddButton]="false" />
                </th>
                <th class="text-right" pSortableColumn="events">
                    {{ 'analytics.table.content-conversions.count' | dm }}
                    <p-sortIcon field="events" />
                </th>
                <th class="text-right" pSortableColumn="conversions">
                    {{ 'analytics.table.content-conversions.conversions' | dm }}
                    <p-sortIcon field="conversions" />
                </th>
                <th class="text-right" pSortableColumn="conversionRate">
                    {{ 'analytics.table.content-conversions.conv-rate' | dm }}
                    <p-sortIcon field="conversionRate" />
                </th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
            <tr>
                <td>
                    <p-tag
                        [value]="row.eventType"
                        severity="secondary"
                        [styleClass]="'event-type-badge ' + row.eventType" />
                </td>
                <td>
                    <div>
                        <div>{{ row.title }}</div>
                        <div class="content-identifier">{{ row.identifier }}</div>
                    </div>
                </td>
                <td class="text-right">{{ row.events | number }}</td>
                <td class="text-right text-primary font-semibold">
                    {{ row.conversions | number }}
                </td>
                <td class="text-right">{{ row.conversionRate | number: '1.0-2' }}%</td>
            </tr>
        </ng-template>
    </p-table>
}
