@let isLoading = $isLoading();
@let isError = $isError();
@let isEmpty = $isEmpty();
@let data = $data();

@if (isLoading) {
    <div class="skeleton-table" data-testid="conversions-overview-loading">
        <div class="skeleton-table__header">
            <div class="flex-[2]"><p-skeleton height="1rem" width="60%" /></div>
            <div class="w-20"><p-skeleton height="1rem" width="80%" /></div>
            <div class="w-[5.5rem]"><p-skeleton height="1rem" width="80%" /></div>
            <div class="flex-[2]"><p-skeleton height="1rem" width="50%" /></div>
        </div>
        @for (i of [1, 2, 3, 4, 5]; track i) {
            <div class="skeleton-table__row">
                <div class="flex-[2]"><p-skeleton height="1rem" width="70%" /></div>
                <div class="w-20"><p-skeleton height="1rem" width="50%" /></div>
                <div class="w-[5.5rem]"><p-skeleton height="1rem" width="60%" /></div>
                <div class="flex-[2]"><p-skeleton height="1rem" width="55%" /></div>
            </div>
        }
        <div class="skeleton-table__pagination">
            <p-skeleton height="1.5rem" width="15rem" />
        </div>
    </div>
} @else if (isError) {
    <div class="table-state" data-testid="conversions-overview-error">
        <dot-analytics-state-message
            message="analytics.error.loading.conversions-overview"
            icon="pi-exclamation-triangle" />
    </div>
} @else if (isEmpty) {
    <div class="table-state" data-testid="conversions-overview-empty">
        <dot-analytics-empty-state />
    </div>
} @else {
    <!-- Data Table -->
    <p-table
        [value]="data"
        styleClass="p-datatable-sm"
        [paginator]="true"
        [rows]="20"
        [rowsPerPageOptions]="[20, 50, 100]"
        sortField="Conversion.convRate"
        [sortOrder]="-1"
        data-testid="conversions-overview-table">
        <ng-template pTemplate="header">
            <tr>
                <th>
                    <div class="flex items-center">
                        {{ 'analytics.table.conversions-overview.conversion-name' | dm }}
                        <p-columnFilter
                            type="text"
                            field="Conversion.conversionName"
                            display="menu"
                            [showMatchModes]="false"
                            [showOperator]="false"
                            [showAddButton]="false" />
                    </div>
                </th>
                <th class="text-right" pSortableColumn="Conversion.totalConversion">
                    {{ 'analytics.table.conversions-overview.total' | dm }}
                    <p-sortIcon field="Conversion.totalConversion" />
                </th>
                <th class="text-right" pSortableColumn="Conversion.convRate">
                    {{ 'analytics.table.conversions-overview.conv-rate' | dm }}
                    <p-sortIcon field="Conversion.convRate" />
                </th>
                <th>
                    {{ 'analytics.table.conversions-overview.top-attributed-content' | dm }}
                </th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
            <tr>
                <td>
                    <p-tag
                        [value]="row['Conversion.conversionName']"
                        styleClass="conversion-name-badge" />
                </td>
                <td class="text-right text-primary font-semibold">
                    {{ row['Conversion.totalConversion'] | number }}
                </td>
                <td class="text-right font-semibold">
                    {{ row['Conversion.convRate'] | number: '1.0-2' }}%
                </td>
                <td>
                    @let topContent = row['Conversion.topAttributedContent'];
                    @if (topContent && topContent.length > 0) {
                        <div class="attributed-content-item">
                            <div class="content-info">
                                <span class="content-title">{{ topContent[0].title }}</span>
                                <p-tag
                                    [value]="topContent[0].event_type"
                                    severity="secondary"
                                    [styleClass]="'event-type-badge ' + topContent[0].event_type" />
                            </div>
                            <div class="attributed-content-right">
                                <span class="content-percentage">
                                    {{ topContent[0].conv_rate | number: '1.0-2' }}%
                                </span>
                                @if (topContent.length > 1) {
                                    <span class="more-indicator">+{{ topContent.length - 1 }}</span>
                                }
                            </div>
                        </div>
                    }
                </td>
            </tr>
        </ng-template>
    </p-table>
}
