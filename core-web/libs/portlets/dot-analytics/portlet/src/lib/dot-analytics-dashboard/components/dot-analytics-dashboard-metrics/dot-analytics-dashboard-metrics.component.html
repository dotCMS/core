@let metricIcon = $icon();
@let metricSubtitle = $subtitle();
@let isLoadingState = $isLoading();
@let isErrorState = $isError();
@let isEmptyState = $isEmpty();
@let hasIcon = !!metricIcon;
@let hasSubtitle = !!metricSubtitle;
@let formattedValue = $formattedValue();
@let iconClasses = $iconClasses();
@let metricName = $name();
@let trendData = $trendData();

<!-- Header template to avoid repetition -->
<ng-template #metricHeader>
    <div class="flex justify-between items-start">
        <h3 class="text-sm text-gray-600 tracking-wide m-0" data-testid="metric-title">
            {{ metricName | dm }}
        </h3>
        @if (hasIcon) {
            <i [class]="iconClasses" class="pi text-base shrink-0" data-testid="metric-icon"></i>
        }
    </div>
</ng-template>

<p-card class="h-full p-4 border border-gray-400 rounded-xl" data-testid="metric-card">
    @if (isErrorState) {
        <!-- Error state -->
        <div class="flex flex-col justify-between h-full gap-4">
            <!-- Header with title and icon -->
            <ng-container [ngTemplateOutlet]="metricHeader" />

            <!-- Error message centered -->
            <div class="flex flex-col justify-center items-center flex-1" [@fadeInContent]>
                <dot-analytics-state-message
                    message="analytics.metrics.error.reload"
                    icon="pi-exclamation-triangle" />
            </div>
        </div>
    } @else if (isEmptyState) {
        <!-- Empty state -->
        <div class="flex flex-col justify-between h-full gap-4">
            <!-- Header with title and icon -->
            <ng-container [ngTemplateOutlet]="metricHeader" />

            <!-- Empty message centered -->
            <div class="flex flex-col justify-center items-center flex-1" [@fadeInContent]>
                <dot-analytics-state-message
                    message="analytics.metrics.empty.insufficient-data"
                    icon="pi-info-circle" />
            </div>
        </div>
    } @else if (isLoadingState) {
        <!-- Loading state with skeleton -->
        <div class="flex flex-col justify-between h-full gap-2">
            <!-- Header with title and icon skeletons -->
            <div class="flex items-start" [@fadeInContent]>
                <p-skeleton width="8rem" height="1rem" styleClass="" />
                <p-skeleton
                    width="1.5rem"
                    height="1.5rem"
                    shape="circle"
                    styleClass="shrink-0 ml-auto" />
            </div>

            <!-- Skeleton content -->
            <div class="flex flex-col gap-1" [@fadeInContent]>
                <!-- Skeleton value -->
                <p-skeleton width="5rem" height="2rem" />
                <!-- Skeleton subtitle/trend -->
                <p-skeleton width="4rem" height="1rem" />
            </div>
        </div>
    } @else {
        <!-- Normal content - only shown when LOADED -->
        <div class="flex flex-col justify-between h-full gap-2">
            <!-- Header with title and icon -->
            <ng-container [ngTemplateOutlet]="metricHeader" />

            @let animated = $animated();
            @let duration = $animationDuration();
            <div class="flex flex-col gap-1" [@fadeInContent]>
                @if ($isFraction()) {
                    @let fractionParts = $fractionParts();
                    <div
                        class="flex items-baseline gap-0 text-3xl font-bold text-gray-900 m-0 leading-tight"
                        data-testid="metric-value">
                        <span class="text-3xl font-bold text-gray-900">
                            @if (fractionParts && animated) {
                                <span
                                    [dotCountUp]="fractionParts.numeratorValue"
                                    [duration]="duration"></span>
                            } @else {
                                {{ fractionParts?.numerator }}
                            }
                        </span>
                        <span class="text-3xl font-bold text-gray-900">/</span>
                        <span class="text-2xl font-bold text-gray-600">
                            @if (fractionParts && animated) {
                                <span
                                    [dotCountUp]="fractionParts.denominatorValue"
                                    [duration]="duration"></span>
                            } @else {
                                {{ fractionParts?.denominator }}
                            }
                        </span>
                    </div>
                } @else {
                    @let numericVal = $numericValue();
                    <div
                        class="text-3xl font-bold text-gray-900 m-0 leading-tight"
                        data-testid="metric-value">
                        @if (numericVal !== null && animated) {
                            <span
                                [dotCountUp]="numericVal.value"
                                [duration]="duration"
                                [suffix]="numericVal.suffix"
                                [format]="numericVal.format"></span>
                        } @else {
                            {{ formattedValue }}
                        }
                    </div>
                }
            </div>

            <!-- SubtÃ­tulo -->
            @if (hasSubtitle || trendData) {
                <div
                    class="text-base text-gray-600 m-0"
                    data-testid="metric-subtitle"
                    [@fadeInContent]>
                    @if (trendData) {
                        <span [class]="trendData.class">
                            {{ trendData.prefix }}{{ trendData.value }}%
                            <i
                                class="text-sm"
                                [class]="
                                    trendData.isPositive ? 'pi pi-arrow-up' : 'pi pi-arrow-down'
                                "></i>
                        </span>
                    }
                    {{ metricSubtitle | dm }}
                </div>
            }
            <!-- Projected content -->
            <div
                class="flex flex-col flex-1 w-full mt-2 empty:hidden"
                data-testid="metric-projected-content">
                <ng-content />
            </div>
        </div>
    }
</p-card>
