@let metricIcon = $icon();
@let metricSubtitle = $subtitle();
@let isLoadingState = $isLoading();
@let isErrorState = $isError();
@let isEmptyState = $isEmpty();
@let hasIcon = !!metricIcon;
@let hasSubtitle = !!metricSubtitle;
@let formattedValue = $formattedValue();
@let iconClasses = $iconClasses();
@let metricName = $name();

<!-- Header template to avoid repetition -->
<ng-template #metricHeader>
    <div class="flex justify-between items-start">
        <h3 class="metric-title" data-testid="metric-title">
            {{ metricName | dm }}
        </h3>
        @if (hasIcon) {
            <i [class]="iconClasses" class="metric-icon pi icon-md" data-testid="metric-icon"></i>
        }
    </div>
</ng-template>

<p-card
    class="h-full metric-card"
    [ngClass]="{
        'metric-card--loading': isLoadingState,
        'metric-card--empty': isEmptyState,
        'metric-card--error': isErrorState
    }"
    data-testid="metric-card">
    @if (isErrorState) {
        <!-- Error state -->
        <div class="flex flex-col justify-between h-full gap-4">
            <!-- Header with title and icon -->
            <ng-container [ngTemplateOutlet]="metricHeader" />

            <!-- Error message centered -->
            <div class="flex flex-col justify-center items-center flex-1" [@fadeInContent]>
                <dot-analytics-state-message
                    message="analytics.metrics.error.reload"
                    icon="pi-exclamation-triangle" />
            </div>
        </div>
    } @else if (isEmptyState) {
        <!-- Empty state -->
        <div class="flex flex-col justify-between h-full gap-4">
            <!-- Header with title and icon -->
            <ng-container [ngTemplateOutlet]="metricHeader" />

            <!-- Empty message centered -->
            <div class="flex flex-col justify-center items-center flex-1" [@fadeInContent]>
                <dot-analytics-state-message
                    message="analytics.metrics.empty.insufficient-data"
                    icon="pi-info-circle" />
            </div>
        </div>
    } @else if (isLoadingState) {
        <!-- Loading state with skeleton -->
        <div class="flex flex-col justify-between h-full gap-4">
            <!-- Header with title and icon skeletons -->
            <div class="flex justify-between items-start" [@fadeInContent]>
                <p-skeleton width="10rem" height="1.4rem"></p-skeleton>
                @if (hasIcon) {
                    <p-skeleton width="1.5rem" height="1.5rem" shape="circle" />
                }
            </div>

            <!-- Skeleton content -->
            <div class="flex flex-col gap-4" [@fadeInContent]>
                <!-- Skeleton value -->
                <p-skeleton width="1.5rem" height="1.4rem" />
            </div>

            <!-- Skeleton subtitle -->
            <p-skeleton width="10rem" height="1rem" [@fadeInContent] />
        </div>
    } @else {
        <!-- Normal content - only shown when LOADED -->
        <div class="flex flex-col justify-between h-full gap-4">
            <!-- Header with title and icon -->
            <ng-container [ngTemplateOutlet]="metricHeader" />

            <!-- Contenido principal -->
            <div class="flex flex-column gap-3" [@fadeInContent]>
                @if ($isFraction()) {
                    <div class="metric-value metric-value--fraction" data-testid="metric-value">
                        <span class="metric-value__numerator">
                            {{ $fractionParts()?.numerator }}
                        </span>
                        <span class="metric-value__separator">/</span>
                        <span class="metric-value__denominator">
                            {{ $fractionParts()?.denominator }}
                        </span>
                    </div>
                } @else {
                    <div class="metric-value" data-testid="metric-value">
                        {{ formattedValue }}
                    </div>
                }
            </div>

            <!-- SubtÃ­tulo -->
            @if (hasSubtitle) {
                <div class="metric-subtitle" data-testid="metric-subtitle" [@fadeInContent]>
                    {{ metricSubtitle | dm }}
                </div>
            }
        </div>
    }
</p-card>
