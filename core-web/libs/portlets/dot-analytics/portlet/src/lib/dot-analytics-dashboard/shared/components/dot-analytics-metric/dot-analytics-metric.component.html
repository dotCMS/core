@let metricIcon = $icon();
@let metricSubtitle = $subtitle();
@let metricTitle = $title();
@let isLoadingState = $isLoading();
@let isErrorState = $isError();
@let isEmptyState = $isEmpty();
@let hasIcon = !!metricIcon;
@let hasTitle = !!metricTitle;
@let hasSubtitle = !!metricSubtitle;
@let formattedValue = $formattedValue();
@let iconClasses = $iconClasses();
@let trendData = $trendData();

@if (hasTitle) {
    <h3 class="text-lg font-bold mb-2" data-testid="metric-title">
        {{ metricTitle | dm }}
        <ng-content select="[titleAction]" />
    </h3>
}

<p-card class="h-full" data-testid="metric-card">
    @if (isErrorState) {
        <div class="metric-fade-in flex flex-col justify-center items-center h-full">
            <dot-analytics-state-message
                message="analytics.metrics.error.reload"
                icon="pi-exclamation-triangle" />
        </div>
    } @else if (isEmptyState) {
        <!-- Empty state: dash preserves card layout -->
        <div class="metric-fade-in flex flex-col justify-between h-full gap-2">
            <div class="flex justify-between items-start gap-1">
                <div class="metric-value metric-value--empty" data-testid="metric-value">
                    &mdash;
                </div>
                @if (hasIcon) {
                    <i [class]="iconClasses" class="metric-icon pi" data-testid="metric-icon"></i>
                }
            </div>
            <div class="metric-subtitle" data-testid="metric-subtitle">
                {{ 'analytics.metrics.empty.no-activity' | dm }}
            </div>
        </div>
    } @else if (isLoadingState) {
        <!-- Loading state with skeleton (mirrors loaded structure) -->
        <div class="flex flex-col justify-between h-full w-full gap-2">
            <!-- Row: value + icon (same layout as loaded state) -->
            <div class="flex justify-between items-start w-full gap-1">
                <p-skeleton width="5rem" height="2.2rem" />
                @if (hasIcon) {
                    <span class="shrink-0">
                        <p-skeleton width="1.5rem" height="1.5rem" shape="circle" />
                    </span>
                }
            </div>
            <!-- Subtitle skeleton (separate row, same as loaded state) -->
            <p-skeleton width="4rem" height="1.03rem" />
        </div>
    } @else {
        <!-- Normal content - only shown when LOADED -->
        <div class="flex flex-col justify-between h-full gap-2">
            @let animated = $animated();
            @let duration = $animationDuration();
            <div class="metric-fade-in flex justify-between items-start gap-1">
                <div class="flex flex-col gap-1">
                    @if ($isFraction()) {
                        @let fractionParts = $fractionParts();
                        <div class="metric-value metric-value--fraction" data-testid="metric-value">
                            <span class="metric-value__numerator">
                                @if (fractionParts && animated) {
                                    <span
                                        [dotCountUp]="fractionParts.numeratorValue"
                                        [duration]="duration"></span>
                                } @else {
                                    {{ fractionParts?.numerator }}
                                }
                            </span>
                            <span class="metric-value__separator">/</span>
                            <span class="metric-value__denominator">
                                @if (fractionParts && animated) {
                                    <span
                                        [dotCountUp]="fractionParts.denominatorValue"
                                        [duration]="duration"></span>
                                } @else {
                                    {{ fractionParts?.denominator }}
                                }
                            </span>
                        </div>
                    } @else {
                        @let numericVal = $numericValue();
                        <div class="metric-value" data-testid="metric-value">
                            @if (numericVal !== null && animated) {
                                <span
                                    [dotCountUp]="numericVal.value"
                                    [duration]="duration"
                                    [suffix]="numericVal.suffix"
                                    [format]="numericVal.format"></span>
                            } @else {
                                {{ formattedValue }}
                            }
                        </div>
                    }
                </div>
                @if (hasIcon) {
                    <i [class]="iconClasses" class="metric-icon pi" data-testid="metric-icon"></i>
                }
            </div>

            <!-- SubtÃ­tulo -->
            @if (hasSubtitle || trendData) {
                <div class="metric-fade-in metric-subtitle" data-testid="metric-subtitle">
                    @if (trendData) {
                        <span [class]="trendData.class">
                            {{ trendData.prefix }}{{ trendData.value }}%
                            <i
                                [class]="
                                    trendData.isPositive ? 'pi pi-arrow-up' : 'pi pi-arrow-down'
                                "></i>
                        </span>
                    }
                    {{ metricSubtitle | dm }}
                </div>
            }
        </div>
    }

    <div
        class="metric-projected-content"
        [class.metric-projected-content--hidden]="isErrorState"
        data-testid="metric-projected-content">
        <ng-content />
    </div>
</p-card>
