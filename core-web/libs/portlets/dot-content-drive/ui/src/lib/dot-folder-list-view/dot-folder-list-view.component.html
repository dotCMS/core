<p-table
    #dataTable
    [value]="$items()"
    [tableStyle]="{ width: '100%', maxHeight: '100%' }"
    [paginator]="$showPagination()"
    [rows]="MIN_ROWS_PER_PAGE"
    [rowsPerPageOptions]="rowsPerPageOptions"
    [totalRecords]="$totalItems()"
    [lazy]="true"
    [lazyLoadOnInit]="true"
    [scrollable]="true"
    [(selection)]="selectedItems"
    (selectionChange)="onSelectionChange()"
    (onPage)="onPage($event)"
    (onSort)="onSort($event)"
    [first]="$offset()"
    (firstChange)="onFirstChange()"
    dataKey="identifier"
    sortMode="single"
    selectionMode="multiple"
    sortField="modDate"
    [sortOrder]="-1"
    data-testId="table"
    scrollHeight="flex"
    [pt]="$ptConfig()">
    <ng-template pTemplate="header">
        <tr data-testId="header-row">
            <th [style.width]="'3rem'">
                <p-tableHeaderCheckbox data-testId="header-checkbox" />
            </th>
            @for (column of HEADER_COLUMNS; track column.field) {
                @if (column.sortable) {
                    <th
                        [pSortableColumn]="column.field"
                        [style.width]="column.width"
                        data-testId="header-column-sortable">
                        {{ column.header | dm }}
                        <p-sortIcon [field]="column.field" data-testId="sort-icon" />
                    </th>
                } @else {
                    <th [style.width]="column.width" data-testId="header-column-not-sortable">
                        {{ column.header | dm }}
                    </th>
                }
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-item>
        @let status = item | dotContentletStatus;
        @let isFolder = item.type === 'folder';

        @if ($loading() || !$items().length) {
            <tr data-testId="loading-row" class="cursor-default h-17 hover:bg-transparent!">
                <td [style.width]="'3rem'" [style.padding-left]="'1rem'">
                    <span class="flex items-center justify-center h-full">
                        <p-skeleton height="1.5rem" width="2.5rem" />
                    </span>
                </td>
                @for (column of HEADER_COLUMNS; track column.field) {
                    <td [style.width]="column.width">
                        <span class="flex items-center justify-center h-full first:text-left">
                            <p-skeleton height="1.5rem" width="100%" />
                        </span>
                    </td>
                }
            </tr>
        } @else {
            <tr
                class="group transition-colors duration-200"
                [class.cursor-grabbing]="state.isDragging()"
                [class.text-[var(--text-color-hover)]]="state.dragOverRowId() === item.identifier"
                [class.bg-[var(--color-palette-primary-100)]]="
                    state.dragOverRowId() === item.identifier
                "
                [pSelectableRow]="item"
                data-testId="item-row"
                (contextmenu)="onContextMenu($event, item)"
                (dblclick)="onDoubleClick(item)"
                [draggable]="true"
                (dragstart)="onDragStart($event, item)"
                (dragend)="onDragEnd()"
                (dragover)="onDragOver($event, item)"
                (drop)="onDrop($event, item)">
                <td data-testId="item-checkbox" (click)="$event.stopPropagation()">
                    <p-tableCheckbox [value]="item" />
                </td>
                <td
                    class="grid grid-cols-[4.5rem_minmax(0,1fr)_min-content] items-center gap-3 w-full pl-3"
                    data-testId="item-title">
                    <div
                        class="cursor-pointer p-1 h-14 max-h-14 bg-(--color-palette-primary-100)"
                        (click)="onDoubleClick(item); $event.stopPropagation()">
                        @if (!isFolder) {
                            <dot-contentlet-thumbnail
                                [fieldVariable]="item?.contentType"
                                [iconSize]="'36px'"
                                [contentlet]="item"
                                data-testId="contentlet-thumbnail"
                                [attr.data-table-id]="item.identifier" />
                        } @else {
                            <i
                                class="pi pi-folder text-4xl! flex! items-center! justify-center! w-full! h-full! text-gray-700"
                                data-testId="folder-icon"></i>
                        }
                    </div>
                    <span
                        data-testId="item-title-text"
                        class="truncate cursor-pointer block"
                        (click)="onDoubleClick(item); $event.stopPropagation()">
                        {{ isFolder ? item.name : item.title }}
                    </span>
                    <span data-testId="lock-hint" class="text-gray-700]">
                        @if (!isFolder) {
                            @if (item.locked) {
                                <i class="pi pi-lock" data-testId="lock-icon"></i>
                            } @else {
                                <i class="pi pi-lock-open" data-testId="lock-open-icon"></i>
                            }
                        }
                    </span>
                </td>
                <td data-testId="item-status">
                    @if (!isFolder) {
                        @if (status === 'Published') {
                            <p-chip
                                class="bg-green-100! text-green-700! border-green-100! text-xs"
                                [label]="status" />
                        } @else if (status === 'Archived') {
                            <p-chip
                                class="bg-red-100! text-red-700! border-red-100! text-xs"
                                [label]="status" />
                        } @else {
                            <p-chip
                                class="bg-yellow-100! text-yellow-700! border-yellow-100! text-xs"
                                [label]="status" />
                        }
                    }
                </td>
                <td data-testId="item-language">
                    @if (!isFolder) {
                        <p-chip
                            class="bg-blue-100! text-blue-700! border-blue-100! text-xs"
                            [label]="item.languageId | dotLocaleTag: state.languagesMap()" />
                    }
                </td>

                <td data-testId="item-content-type">
                    {{ (isFolder ? 'Folder' : item.contentType) | dm }}
                </td>
                <td data-testId="item-mod-user-name">
                    {{ (isFolder ? item.owner : item.modUserName) ?? 'Unknown' }}
                </td>
                <td data-testId="item-mod-date">{{ item.modDate | dotRelativeDate }}</td>
                <td data-testId="item-actions" class="text-center">
                    <p-button
                        class="opacity-0 group-hover:opacity-100 transition-opacity duration-200"
                        icon="pi pi-ellipsis-v"
                        [text]="true"
                        [rounded]="true"
                        size="small"
                        (onClick)="onContextMenu($event, item)"
                        data-testId="kebab-menu-button"
                        aria-label="More actions" />
                </td>
            </tr>
        }
    </ng-template>
    <ng-template pTemplate="emptymessage">
        <tr class="hover:bg-transparent! h-max">
            <td colspan="7" class="p-6 text-center h-full border-none">
                <div class="flex flex-col items-center gap-4 max-w-[400px] mx-auto">
                    <div class="flex items-center justify-center w-20 h-20 rounded-full">
                        <i class="pi pi-folder-open text-(--surface-500) text-6xl!"></i>
                    </div>
                    <div class="flex flex-col">
                        <h3 class="m-0 text-lg font-medium text-center text-gray-800">
                            {{ 'content.drive.empty.state.title' | dm }}
                        </h3>
                        <p class="m-0 text-text-color text-base leading-6">
                            {{ 'content.drive.empty.state.description' | dm }}
                        </p>
                    </div>
                </div>
            </td>
        </tr>
    </ng-template>
</p-table>
