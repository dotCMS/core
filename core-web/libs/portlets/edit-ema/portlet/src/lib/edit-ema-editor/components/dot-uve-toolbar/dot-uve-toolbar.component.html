@let preview = $isPreviewMode();
@let live = $isLiveMode();
@let runningExperiment = $toolbar().runningExperiment;

<p-toolbar>
    <ng-template #start>
        <div class="flex items-center gap-1" [ngClass]="{ 'p-0': preview || live }">
            @if ($isEditMode()) {
                <p-button
                    [text]="true"
                    size="small"
                    [rounded]="true"
                    (click)="togglePalette()"
                    data-testId="uve-toolbar-palette-toggle">
                    <img
                        src="./assets/edit-uve-toolbar/left_panel_open.svg"
                        alt="Left Panel Open"
                        [class.hidden]="!$isPaletteOpen()"
                        data-testId="palette-open-icon" />
                    <img
                        src="./assets/edit-uve-toolbar/left_panel_close.svg"
                        alt="Left Panel Close"
                        [class.hidden]="$isPaletteOpen()"
                        data-testId="palette-close-icon" />
                </p-button>
            }
            <dot-editor-mode-selector data-testId="uve-toolbar-editor-mode-selector" />
            <dot-ema-bookmarks [url]="$toolbar().editor.bookmarksUrl" />
            <p-button
                (click)="op.toggle($event)"
                [text]="true"
                [rounded]="true"
                [pTooltip]="'editpage.header.copy' | dm"
                tooltipPosition="bottom"
                icon="pi pi-copy"
                size="small"
                data-testId="uve-toolbar-copy-url">
                <p-popover #op [pt]="copyUrlPopoverPt">
                    <div class="flex flex-col divide-y divide-gray-200">
                        @for (url of $pageURLS(); track url.value) {
                            <div class="flex flex-col gap-1 py-2 first:pt-0 last:pb-0">
                                <span class="text-sm font-semibold text-gray-900">
                                    {{ url.label | dm }}:
                                </span>
                                <div class="flex min-w-0 items-center gap-2">
                                    <a
                                        class="block min-w-0 flex-1 truncate text-sm text-gray-900 !no-underline hover:underline"
                                        [href]="url.value"
                                        target="_blank"
                                        rel="noreferrer noopener">
                                        {{ url.value }}
                                    </a>
                                    <p-button
                                        icon="pi pi-copy"
                                        [text]="true"
                                        size="small"
                                        [rounded]="true"
                                        styleClass="shrink-0"
                                        (cdkCopyToClipboardCopied)="triggerCopyToast()"
                                        [cdkCopyToClipboard]="url.value"
                                        data-testId="copy-url-button" />
                                </div>
                            </div>
                        }
                    </div>
                </p-popover>
            </p-button>
            <a
                title="Page API URL"
                [pTooltip]="'uve.toolbar.page.api.url' | dm"
                tooltipPosition="bottom"
                pButton
                class="p-button-text p-button-sm p-button-rounded-md !no-underline"
                target="_blank"
                data-testId="uve-toolbar-api-link"
                [href]="$apiURL()">
                <span pButtonLabel>API</span>
            </a>
            @if (preview || live) {
                @if ($devices()?.length) {
                    <dot-uve-device-selector
                        [devices]="$devices()"
                        data-testId="uve-toolbar-device-selector" />
                }
            } @else {
                @if ($urlContentMap(); as urlContentMap) {
                    <p-button
                        (click)="editUrlContentMap.emit(urlContentMap)"
                        [pTooltip]="
                            'editpage.toolbar.edit.url.map.content'
                                | dm: [urlContentMap.contentType]
                        "
                        tooltipPosition="bottom"
                        icon="pi pi-pencil"
                        [text]="true"
                        size="small"
                        [rounded]="true"
                        data-testId="edit-url-content-map" />
                }
            }
        </div>
    </ng-template>

    <ng-template #center>
        @if (live && !$socialMedia()) {
            <div class="flex items-center gap-1">
                <p-datePicker
                    inputStyleClass="p-inputtext-sm"
                    [ngModel]="$previewDate()"
                    (ngModelChange)="fetchPageOnDate($event)"
                    [showTime]="true"
                    [hourFormat]="'12'"
                    dataType="date"
                    [minDate]="$MIN_DATE()"
                    [readonlyInput]="true"
                    data-testId="uve-toolbar-calendar" />
                <p-button
                    class="uve-toolbar-chips"
                    [label]="'Today' | dm"
                    alt="Page Day"
                    (click)="fetchPageOnDate()"
                    data-testId="uve-toolbar-calendar-today-button" />
            </div>
        }
    </ng-template>

    <ng-template #end>
        <div class="flex items-center gap-1">
            <dot-toggle-lock-button />

            @if (runningExperiment) {
                <dot-ema-running-experiment
                    [runningExperiment]="runningExperiment"
                    data-testId="uve-toolbar-running-experiment" />
            }
            <dot-edit-ema-language-selector
                #languageSelector
                (selected)="onLanguageSelected($event)"
                [language]="$toolbar().currentLanguage"
                data-testId="uve-toolbar-language-selector" />

            <dot-edit-ema-persona-selector
                (selected)="onPersonaSelected($event)"
                (despersonalize)="onDespersonalize($event)"
                [pageId]="$personaSelectorProps().pageId"
                [value]="$personaSelectorProps().value"
                #personaSelector
                data-testId="uve-toolbar-persona-selector" />

            @if ($showWorkflowActions()) {
                <dot-uve-workflow-actions />
            }
        </div>
    </ng-template>
</p-toolbar>

@if ($infoDisplayProps(); as options) {
    <dot-ema-info-display data-testId="info-display" [options]="options" />
}
