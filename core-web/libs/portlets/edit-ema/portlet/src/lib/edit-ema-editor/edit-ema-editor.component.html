@let ogTagsResults = ogTagsResults$;
@let showSEOTool = $seoResults() && ogTagsResults;
@let dropzone = $dropzone();

<dot-uve-toolbar
    (translatePage)="translatePage($event)"
    (editUrlContentMap)="editContentMap($event)" />

@if (showSEOTool) {
    <dot-results-seo-tool
        [seoMedia]="$seoResults().socialMedia"
        [seoOGTags]="$seoResults().ogTags"
        [seoOGTagsResults]="ogTagsResults"
        data-testId="results-seo-tool" />
}

@if (uveStore.$canEditPageContent()) {
    <dot-uve-palette
        [ngClass]="$paletteClass()"
        (onNodeSelect)="handlePaletteNodeSelect($event)"
        data-testId="palette" />
}

<div
    class="editor-content"
    #editorContent
    [ngStyle]="$editorContentStyles()"
    [ngClass]="{ 'editor-content-preview': $mode() === UVE_MODE.PREVIEW }"
    data-testId="editor-content">
    <p-toolbar
        styleClass="browser-toolbar"
        [style]="{
            position: 'sticky',
            top: 0,
            left: 0,
            zIndex: 1000
        }">
        <ng-template pTemplate="start">
            @if (uveStore.$mode() === UVE_MODE.EDIT) {
                <button
                    pButton
                    type="button"
                    class="p-button-text p-button-sm p-button-icon-only p-button-rounded"
                    (click)="togglePalette()"
                    data-testId="uve-toolbar-palette-toggle">
                    <img
                        src="./assets/edit-uve-toolbar/left_panel_open.svg"
                        alt="Left Panel Open"
                        [class.hidden]="!$paletteOpen"
                        draggable="false"
                        data-testId="palette-open-icon" />
                    <img
                        src="./assets/edit-uve-toolbar/left_panel_close.svg"
                        alt="Left Panel Close"
                        [class.hidden]="$paletteOpen"
                        draggable="false"
                        data-testId="palette-close-icon" />
                </button>
            }
        </ng-template>
        <ng-template pTemplate="center">
            <div class="browser-url-bar-container">
                <div class="flex">
                    <p-button
                        (click)="copyUrlOverlay.toggle($event)"
                        [pTooltip]="'editpage.header.copy' | dm"
                        tooltipPosition="bottom"
                        icon="pi pi-copy"
                        styleClass="p-button-text p-button-sm"
                        data-testId="uve-toolbar-copy-url">
                        <p-overlayPanel #copyUrlOverlay>
                            <div class="url-list">
                                @for (url of $pageURLS(); track url.value) {
                                    <div class="url-item">
                                        <span class="url-label">{{ url.label | dm }}:</span>
                                        <div class="url-value">
                                            <a
                                                [href]="url.value"
                                                target="_blank"
                                                rel="noreferrer noopener">
                                                {{ url.value }}
                                            </a>
                                            <p-button
                                                icon="pi pi-copy"
                                                styleClass="p-button-text p-button-sm p-button-rounded"
                                                (cdkCopyToClipboardCopied)="triggerCopyToast()"
                                                [cdkCopyToClipboard]="url.value"
                                                data-testId="copy-url-button" />
                                        </div>
                                    </div>
                                }
                            </div>
                        </p-overlayPanel>
                    </p-button>
                    <div class="browser-url-bar">{{ $pageURL() }}</div>
                </div>
                <dot-uve-zoom-controls />
            </div>
        </ng-template>
        <ng-template pTemplate="end">
            @if (uveStore.$mode() === UVE_MODE.EDIT) {
                <button
                    pButton
                    type="button"
                    class="p-button-text p-button-sm p-button-icon-only p-button-rounded"
                    (click)="toggleRightSidebar()"
                    data-testId="right-sidebar-toggle">
                    <img
                        src="./assets/edit-uve-toolbar/left_panel_open.svg"
                        alt="Right Panel Open"
                        [class.hidden]="!$rightSidebarOpen"
                        class="flip-horizontal"
                        draggable="false"
                        data-testId="right-sidebar-open-icon" />
                    <img
                        src="./assets/edit-uve-toolbar/left_panel_close.svg"
                        alt="Right Panel Close"
                        [class.hidden]="$rightSidebarOpen"
                        class="flip-horizontal"
                        draggable="false"
                        data-testId="right-sidebar-close-icon" />
                </button>
            }
        </ng-template>
    </p-toolbar>
    <div class="canvas-viewport">
        <div class="canvas-row">
            <div class="canvas-gutter" aria-hidden="true"></div>
            <div class="canvas-outer" #zoomContainer [ngStyle]="$canvasOuterStyles()">
                <div class="canvas-inner" [ngStyle]="$canvasInnerStyles()">
                    <div
                        [ngClass]="{
                            'iframe-wrapper--device': $iframeProps().wrapper
                        }"
                        [ngStyle]="$iframeWrapperStyles()"
                        class="iframe-wrapper">
                        @if (uveStore.status() === UVE_STATUS.ERROR) {
                            <dot-uve-page-version-not-found />
                        }
                        <dot-uve-iframe
                            (load)="onIframePageLoad()"
                            (iframeDocHeightChange)="onIframeDocHeightChange($event)"
                            (internalNav)="handleInternalNavFromIframe($event)"
                            (inlineEditing)="handleInlineEditingFromIframe($event)"
                            [src]="$iframeSrc()"
                            [title]="host"
                            [pointerEvents]="$iframePointerEvents()"
                            [opacity]="$iframeOpacity()"
                            #iframe
                            data-testId="iframe"></dot-uve-iframe>

                        @if ($progressBar()) {
                            <p-progressBar
                                [ngStyle]="{
                                    position: 'absolute',
                                    top: '0',
                                    left: '0',
                                    width: '100%'
                                }"
                                [style]="{ height: '6px' }"
                                data-testId="progress-bar"
                                mode="indeterminate" />
                        }
                        @if ($showContentletControls()) {
                            <dot-uve-contentlet-tools
                                (outputSelectedContentlet)="handleSelectedContentlet($event)"
                                (editVTL)="handleEditVTL($event)"
                                (editContent)="handleEditContentlet($event)"
                                (deleteContent)="deleteContent($event)"
                                (addContent)="handleAddContent($event)"
                                (selectContent)="handleSelectContent($event)"
                                [contentletArea]="$contentArea"
                                [isEnterprise]="uveStore.isEnterprise()"
                                [allowContentDelete]="$allowContentDelete()"
                                [showStyleEditorOption]="uveStore.$canEditStyles()"
                                data-testId="contentlet-tools" />
                        }
                        @if (!$toggleLockOptions()?.showOverlay && dropzone) {
                            <dot-ema-page-dropzone
                                [containers]="dropzone.bounds"
                                [dragItem]="dropzone.dragItem"
                                [zoomLevel]="zoomService.$zoomLevel()"
                                data-testId="dropzone" />
                        }

                        @if ($toggleLockOptions()?.showOverlay) {
                            <dot-uve-lock-overlay />
                        }
                    </div>
                </div>
            </div>
            <div class="canvas-gutter" aria-hidden="true"></div>
        </div>
    </div>
</div>

@if (uveStore.$mode() === UVE_MODE.EDIT) {
    <div class="right-sidebar-wrapper" [class.open]="$rightSidebarOpen">
        <dot-uve-contentlet-quick-edit
            [data]="$contentletEditData()"
            [loading]="$isSubmitting()"
            (submit)="onFormSubmit($event)"
            (cancel)="onCancel()" />
    </div>
}

@if ($showDialogs()) {
    <dot-edit-ema-dialog
        (action)="onCustomEvent($event)"
        (reloadFromDialog)="reloadPage()"
        #dialog
        data-testId="ema-dialog" />
}
<p-confirmDialog
    [style]="{
        width: '400px'
    }"
    rejectIcon="hidden"
    acceptIcon="hidden"
    rejectButtonStyleClass="p-button-outlined"
    data-testId="confirm-dialog" />

@if ($showBlockEditorSidebar()) {
    <dot-block-editor-sidebar #blockSidebar (onSaved)="reloadPage()" />
}

<div
    #customDragImage
    class="absolute p-3 bg-white border border-round-lg z-1"
    style="top: -1000px; left: -1000px; width: fit-content"
    data-testId="drag-image">
    {{ uveStore.$areaContentType() }}
</div>
