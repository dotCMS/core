@let ogTagsResults = ogTagsResults$;
@let showSEOTool = $editorProps().seoResults && ogTagsResults;
@let dropzone = $editorProps().dropzone;

<dot-uve-toolbar
    (translatePage)="translatePage($event)"
    (editUrlContentMap)="editContentMap($event)" />

@if (showSEOTool) {
    <dot-results-seo-tool
        [seoMedia]="$editorProps().seoResults.socialMedia"
        [seoOGTags]="$editorProps().seoResults.ogTags"
        [seoOGTagsResults]="ogTagsResults"
        data-testId="results-seo-tool" />
}

@if (uveStore.$canEditPage()) {
    <dot-uve-palette
        [ngClass]="$paletteClass()"
        (onNodeSelect)="handlePaletteNodeSelect($event)"
        data-testId="palette" />
}

<div
    class="editor-content"
    #editorContent
    [ngStyle]="$editorContentStyles()"
    [ngClass]="{ 'editor-content-preview': $isPreviewMode() }"
    data-testId="editor-content">
    <p-toolbar
        styleClass="browser-toolbar"
        [style]="{
            position: 'sticky',
            top: 0,
            left: 0,
            zIndex: 1000
        }">
        <ng-template pTemplate="start">
            @if (uveStore.$isEditMode()) {
                <button
                    pButton
                    type="button"
                    class="p-button-text p-button-sm p-button-icon-only p-button-rounded"
                    (click)="togglePalette()"
                    data-testId="uve-toolbar-palette-toggle">
                    <img
                        src="./assets/edit-uve-toolbar/left_panel_open.svg"
                        alt="Left Panel Open"
                        [class.hidden]="!$paletteOpen()"
                        data-testId="palette-open-icon" />
                    <img
                        src="./assets/edit-uve-toolbar/left_panel_close.svg"
                        alt="Left Panel Close"
                        [class.hidden]="$paletteOpen()"
                        data-testId="palette-close-icon" />
                </button>
            }
        </ng-template>
        <ng-template pTemplate="center">
            <div class="browser-url-bar-container">
                <div class="browser-url-bar">{{ $pageURL() }}</div>
                <dot-uve-zoom-controls />
            </div>
        </ng-template>
        <ng-template pTemplate="end">
            <button
                pButton
                type="button"
                class="p-button-text p-button-sm p-button-icon-only p-button-rounded"
                (click)="toggleRightSidebar()"
                data-testId="right-sidebar-toggle">
                <img
                    src="./assets/edit-uve-toolbar/left_panel_open.svg"
                    alt="Right Panel Open"
                    [class.hidden]="!$rightSidebarOpen()"
                    class="flip-horizontal"
                    data-testId="right-sidebar-open-icon" />
                <img
                    src="./assets/edit-uve-toolbar/left_panel_close.svg"
                    alt="Right Panel Close"
                    [class.hidden]="$rightSidebarOpen()"
                    class="flip-horizontal"
                    data-testId="right-sidebar-close-icon" />
            </button>
        </ng-template>
    </p-toolbar>
    <div class="canvas-viewport">
        <div class="canvas-row">
            <div class="canvas-gutter" aria-hidden="true"></div>
            <div class="canvas-outer" #zoomContainer [ngStyle]="$canvasOuterStyles()">
                <div class="canvas-inner" [ngStyle]="$canvasInnerStyles()">
                    <div
                        [ngClass]="{
                            'iframe-wrapper--device': $editorProps().iframe.wrapper
                        }"
                        class="iframe-wrapper">
                        @if (uveStore.status() === UVE_STATUS.ERROR) {
                            <dot-uve-page-version-not-found />
                        }
                        <dot-uve-iframe
                            (load)="onIframePageLoad()"
                            (iframeDocHeightChange)="onIframeDocHeightChange($event)"
                            (internalNav)="handleInternalNavFromIframe($event)"
                            (inlineEditing)="handleInlineEditingFromIframe($event)"
                            [src]="$iframeSrc()"
                            [title]="host"
                            [pointerEvents]="$iframePointerEvents()"
                            [opacity]="$iframeOpacity()"
                            #iframe
                            data-testId="iframe"></dot-uve-iframe>

                        @if ($editorProps().progressBar) {
                            <p-progressBar
                                [ngStyle]="{
                                    position: 'absolute',
                                    top: '0',
                                    left: '0',
                                    width: '100%'
                                }"
                                [style]="{ height: '6px' }"
                                data-testId="progress-bar"
                                mode="indeterminate" />
                        }
                        @if ($showContentletControls()) {
                            <dot-uve-contentlet-tools
                                (outputSelectedContentlet)="handleSelectedContentlet($event)"
                                (editVTL)="handleEditVTL($event)"
                                (editContent)="handleEditContentlet($event)"
                                (deleteContent)="deleteContent($event)"
                                (addContent)="handleAddContent($event)"
                                (selectContent)="handleSelectContent($event)"
                                [contentletArea]="$contentArea()"
                                [isEnterprise]="uveStore.isEnterprise()"
                                [allowContentDelete]="$allowContentDelete()"
                                [showStyleEditorOption]="uveStore.$isStyleEditorEnabled()"
                                data-testId="contentlet-tools" />
                        }
                        @if (!$toggleLockOptions()?.showOverlay && dropzone) {
                            <dot-ema-page-dropzone
                                [containers]="dropzone.bounds"
                                [dragItem]="dropzone.dragItem"
                                [zoomLevel]="zoomService.$zoomLevel()"
                                data-testId="dropzone" />
                        }

                        @if ($toggleLockOptions()?.showOverlay) {
                            <dot-uve-lock-overlay />
                        }
                    </div>
                </div>
            </div>
            <div class="canvas-gutter" aria-hidden="true"></div>
        </div>
    </div>
</div>

<div class="right-sidebar" [ngClass]="$rightSidebarOpen() ? 'open' : 'closed'">
    @if ($contentletForm() && $selectedContentlet().fields.length > 0) {
        <form
            [formGroup]="$contentletForm()!"
            (ngSubmit)="onFormSubmit()"
            class="p-fluid p-3"
            style="width: 400px"
            (keydown.escape)="onCancel()"
            tabindex="0">
            @if ($selectedContentlet().contentlet?.inode) {
                <input type="hidden" formControlName="inode" />
            }
            @for (field of $selectedContentlet().fields; track field.variable) {
                <div class="field">
                    <label
                        [ngClass]="{ 'p-label-input-required': field.required }"
                        [for]="field.variable">
                        {{ field.name }}
                    </label>
                    @if (field.clazz === DotCMSClazzes.TEXT) {
                        <input
                            pInputText
                            [id]="field.variable"
                            [formControlName]="field.variable"
                            [readonly]="field.readOnly" />
                    } @else if (field.clazz === DotCMSClazzes.TEXTAREA) {
                        <textarea
                            [style]="{ height: '9.375rem', lineHeight: '1.5' }"
                            pInputTextarea
                            [id]="field.variable"
                            [formControlName]="field.variable"
                            [readonly]="field.readOnly"
                            rows="4"></textarea>
                    } @else if (field.clazz === DotCMSClazzes.CHECKBOX) {
                        @if (field.options && field.options.length > 0) {
                            <div class="field flex flex-column gap-2">
                                @for (option of field.options; track option.value) {
                                    <p-checkbox
                                        [formControlName]="field.variable"
                                        [value]="option.value"
                                        [inputId]="field.variable + '-' + option.value"
                                        [label]="option.label"
                                        [binary]="false"></p-checkbox>
                                }
                            </div>
                        } @else {
                            <p-checkbox
                                [formControlName]="field.variable"
                                [inputId]="field.variable"
                                [binary]="true"></p-checkbox>
                        }
                    } @else if (field.clazz === DotCMSClazzes.SELECT) {
                        <p-dropdown
                            [formControlName]="field.variable"
                            [inputId]="field.variable"
                            [options]="field.options"
                            optionLabel="label"
                            optionValue="value"
                            [showClear]="true"
                            [disabled]="field.readOnly"
                            [placeholder]="'Select ' + field.name"></p-dropdown>
                    } @else if (field.clazz === DotCMSClazzes.RADIO) {
                        <div class="field flex flex-column gap-2">
                            @for (option of field.options; track option.value) {
                                <p-radioButton
                                    [formControlName]="field.variable"
                                    [value]="option.value"
                                    [inputId]="field.variable + '-' + option.value"
                                    [label]="option.label"
                                    [disabled]="field.readOnly"></p-radioButton>
                            }
                        </div>
                    } @else if (field.clazz === DotCMSClazzes.MULTI_SELECT) {
                        <p-multiSelect
                            [formControlName]="field.variable"
                            [inputId]="field.variable"
                            [options]="field.options"
                            optionLabel="label"
                            optionValue="value"
                            [showClear]="true"
                            [disabled]="field.readOnly"
                            [placeholder]="'Select ' + field.name"></p-multiSelect>
                    }
                </div>
            }
            <div class="field flex justify-content-end gap-2">
                <p-button
                    type="button"
                    label="Cancel"
                    [outlined]="true"
                    (click)="onCancel()"
                    [disabled]="$isSubmitting()"></p-button>
                <p-button
                    type="submit"
                    label="Submit"
                    [disabled]="!$contentletForm()?.valid || $isSubmitting()"
                    [loading]="$isSubmitting()"></p-button>
            </div>
        </form>
    } @else {
        <div class="right-sidebar-empty">
            <p class="empty-message">Select a contentlet</p>
        </div>
    }
</div>

@if ($editorProps().showDialogs) {
    <dot-edit-ema-dialog
        (action)="onCustomEvent($event)"
        (reloadFromDialog)="reloadPage()"
        #dialog
        data-testId="ema-dialog" />
}
<p-confirmDialog
    [style]="{
        width: '400px'
    }"
    rejectIcon="hidden"
    acceptIcon="hidden"
    rejectButtonStyleClass="p-button-outlined"
    data-testId="confirm-dialog" />

@if ($editorProps().showBlockEditorSidebar) {
    <dot-block-editor-sidebar #blockSidebar (onSaved)="reloadPage()" />
}

<div
    #customDragImage
    class="absolute p-3 bg-white border border-round-lg z-1"
    style="top: -1000px; left: -1000px; width: fit-content"
    data-testId="drag-image">
    {{ uveStore.$areaContentType() }}
</div>
