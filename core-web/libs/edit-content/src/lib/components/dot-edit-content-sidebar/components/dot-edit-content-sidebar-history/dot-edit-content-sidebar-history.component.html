<!-- History List -->
<section class="history" role="region" aria-label="Content Version History">
    @if ($isLoading()) {
        <!-- Loading state -->
        <div class="history__loading" data-testid="loading-state">
            @for (item of [1, 2, 3]; track $index) {
                <div class="history__skeleton-item">
                    <p-skeleton width="100%" height="60px" />
                </div>
            }
        </div>
    } @else if (!$hasHistoryItems()) {
        <!-- Empty state -->
        <div class="history__empty" data-testid="empty-state">
            <div class="history__empty-icon">
                <i class="pi pi-history"></i>
            </div>
            <h3 class="history__empty-title">
                {{ 'edit.content.sidebar.history.empty.title' | dm }}
            </h3>
            <p class="history__empty-message">
                {{ 'edit.content.sidebar.history.empty.message' | dm }}
            </p>
        </div>
    } @else {
        <!-- History content -->
        <div class="history__content">
            <p-timeline
                [value]="$historyItems()"
                layout="vertical"
                styleClass="history__timeline"
                data-testid="history-timeline">
                <ng-template pTemplate="marker" let-item let-index="index">
                    <div
                        class="history__marker"
                        [class]="getTimelineMarkerClass(item)"
                        data-testid="timeline-marker"></div>
                </ng-template>

                <ng-template pTemplate="content" let-item let-index="index">
                    <div
                        class="history__timeline-item"
                        data-testid="history-item"
                        (mouseenter)="showOverlay($event, item)"
                        (mouseleave)="hideOverlay()">
                        <!-- Timeline item header -->
                        <div class="history__item-header">
                            <div class="history__time-section">
                                <span class="history__time-relative" data-testid="time-display">
                                    {{ item.modDate | dotRelativeDate }}
                                </span>

                                @if (item.live) {
                                    <p-chip
                                        styleClass="history__state history__state--live p-chip-sm p-chip-success"
                                        [label]="'edit.content.sidebar.history.published' | dm"
                                        data-testid="state-live" />
                                } @else if (item.working) {
                                    <p-chip
                                        styleClass="history__state history__state--working p-chip-sm p-chip-warning"
                                        [label]="'edit.content.sidebar.history.draft' | dm"
                                        data-testid="state-draft" />
                                }

                                @if (item.experimentVariant) {
                                    <p-chip
                                        styleClass="history__state history__state--variant p-chip-sm p-chip-secondary"
                                        [label]="'edit.content.sidebar.history.variant.tag' | dm"
                                        data-testid="state-variant" />
                                }
                            </div>

                            <div class="history__actions">
                                <p-button
                                    icon="pi pi-ellipsis-v"
                                    styleClass="p-button-rounded p-button-sm p-button-text history__menu-button p-button-tertiary"
                                    (click)="versionMenu.toggle($event)"
                                    data-testid="version-menu-button"></p-button>
                                <p-menu
                                    #versionMenu
                                    [appendTo]="'body'"
                                    [model]="getVersionMenuItems(item)"
                                    [popup]="true"></p-menu>
                            </div>
                        </div>

                        <!-- User info -->
                        <div class="history__user-section">
                            <p-avatar
                                dotGravatar
                                [email]="item.modUser"
                                styleClass="history__avatar"
                                data-testid="user-avatar"></p-avatar>
                            <span class="history__user-name" data-testid="history-user">
                                {{ item.modUserName || item.modUser }}
                            </span>
                        </div>
                    </div>
                </ng-template>
            </p-timeline>
        </div>

        <!-- OverlayPanel for version details -->
        <p-overlayPanel
            #overlayPanel
            [showCloseIcon]="false"
            [dismissable]="false"
            styleClass="history__overlay"
            data-testid="history-overlay">
            @if (selectedItem) {
                <div class="history__overlay-content">
                    <h4 class="history__overlay-title" data-testid="overlay-title">
                        {{ selectedItem.title }}
                    </h4>

                    <ul class="history__overlay-list">
                        <li>
                            {{ selectedItem.modDate | date: 'MMM d, yyyy - h:mma' }}
                        </li>
                        @if (selectedItem.experimentVariant) {
                            <li>
                                {{ 'edit.content.sidebar.history.variant' | dm }}:
                                {{ selectedItem.experimentVariant }}
                            </li>
                        }
                    </ul>
                </div>
            }
        </p-overlayPanel>
    }
</section>
