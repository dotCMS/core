<!-- Activities List -->
<section class="flex flex-col h-full min-h-0 relative" role="log" aria-label="Content Activities">
    @if ($isLoading()) {
        <dot-edit-content-sidebar-activities-skeleton data-testid="loading-state" />
    } @else {
        <div class="flex-1 min-h-0 overflow-y-auto py-3">
            <p-dataview
                #dv
                [value]="$activities()"
                [rows]="10"
                [layout]="'list'"
                [style]="{ display: 'block', border: 'none' }"
                [paginator]="false"
                data-testid="activities-list">
                <ng-template #list let-activities>
                    <div class="flex flex-col gap-5">
                        @for (
                            activity of activities;
                            track activity.taskId + '_' + activity.createdDate
                        ) {
                            <div
                                class="activity-item flex flex-col border-b border-[var(--gray-200)] last:border-b-0 py-3 first:pt-0 animate-[fadeIn_0.2s_ease-out]"
                                #activityItem
                                data-testid="activity-item">
                                <div class="flex items-start gap-3">
                                    <p-avatar
                                        shape="circle"
                                        dotGravatar
                                        [email]="activity?.email"
                                        [pt]="avatarPt"
                                        class="flex-shrink-0" />
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <span
                                                class="text-sm font-semibold text-[var(--gray-900)]"
                                                data-testid="activity-user">
                                                {{ activity.postedBy }}
                                            </span>
                                            <span
                                                class="text-xs text-[var(--gray-600)] ml-auto shrink-0"
                                                data-testid="activity-date">
                                                {{ activity.createdDate | dotRelativeDate }}
                                            </span>
                                        </div>
                                        <p
                                            class="mt-1.5 text-sm text-[var(--gray-700)] leading-[1.4] break-words whitespace-pre-line"
                                            data-testid="activity-description">
                                            {{ activity.commentDescription }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </ng-template>
                <ng-template #empty>
                    <span
                        class="block text-[var(--gray-800)] text-sm bg-[var(--gray-100)]"
                        data-testid="empty-state">
                        {{ 'edit.content.sidebar.activities.empty' | dm }}
                    </span>
                </ng-template>
            </p-dataview>
        </div>
        @if (!$hideForm()) {
            <div
                class="sticky bottom-0 z-[1] w-full py-3 border-t border-[var(--gray-200)]"
                data-testid="activities-footer">
                <form
                    [formGroup]="form"
                    (ngSubmit)="onSubmit()"
                    class="flex flex-col gap-3"
                    data-testid="activities-form">
                    <div class="relative">
                        <textarea
                            pInputTextarea
                            [rows]="5"
                            autoResize="false"
                            formControlName="comment"
                            data-testid="activities-input"
                            class="h-auto w-full resize-none text-sm leading-[1.4]"></textarea>

                        <dot-field-validation-message
                            [field]="form.get('comment')"
                            class="absolute bottom-[-0.75rem] left-0 [&_small]:animate-[fadeIn_0.2s_ease-out]" />

                        <!-- Character Counter -->
                        <div
                            class="mt-1 text-xs text-[var(--gray-600)] text-left transition-colors"
                            [class.text-[var(--color-palette-red)]!]="isAtMaxLength()"
                            data-testid="activities-char-counter">
                            @if (!isAtMaxLength()) {
                                {{ commentLength() }}/{{ commentMaxLength }}
                                {{ 'edit.content.sidebar.activities.characters' | dm }}
                            } @else {
                                <span>
                                    {{
                                        'edit.content.sidebar.activities.char.counter'
                                            | dm
                                                : [
                                                      commentLength().toString(),
                                                      commentMaxLength.toString()
                                                  ]
                                    }}
                                </span>
                            }
                        </div>
                    </div>

                    <div class="flex justify-end gap-2">
                        <p-button
                            type="button"
                            [disabled]="!form.dirty || !commentControl.value?.trim() || $isSaving()"
                            size="small"
                            severity="secondary"
                            data-testid="activities-clear"
                            (onClick)="clearComment()">
                            {{ 'edit.content.sidebar.activities.clear' | dm }}
                        </p-button>
                        <p-button
                            type="submit"
                            [loading]="$isSaving()"
                            [disabled]="$isSaving() || !commentControl.value?.trim()"
                            size="small"
                            severity="secondary"
                            data-testid="activities-submit">
                            {{ 'edit.content.sidebar.activities.send' | dm }}
                        </p-button>
                    </div>
                </form>
            </div>
        }
    }
</section>
