@let contentlet = $store.contentlet();
@let contentType = $store.contentType();
@let activeIndex = $store.activeSidebarTab();

<!-- Information Component -->
@let isLoadingInformation = $store.isLoadingInformation();
@let referencePagesCount = $store.information.relatedContent();

<aside class="overflow-auto w-full h-full">
    <p-tabs
        [value]="activeIndex"
        (valueChange)="onActiveIndexChange($event)"
        class="h-full flex flex-col"
        [pt]="tabsPt"
        data-testId="sidebar-tabs">
        <!-- Add prepend and append areas to the tabs -->
        <ng-template dotTabViewInsert [dotTabViewAppend]="appendContent" />

        <p-tablist>
            <p-tab [value]="0">
                <i class="pi pi-info-circle"></i>
            </p-tab>
            <p-tab [value]="1">
                <i class="pi pi-history"></i>
            </p-tab>
            <p-tab [value]="2">
                <i class="pi pi-comment"></i>
            </p-tab>
        </p-tablist>
        <p-tabpanels class="h-full">
            <p-tabpanel [value]="0" class="flex flex-col h-full">
                <!-- Information section -->
                <dot-edit-content-sidebar-section
                    [title]="'edit.content.sidebar.general.title' | dm">
                    <ng-template #sectionAction>
                        @if (!$store.isNew() && !$store.isCopyingLocale()) {
                            <dot-copy-button
                                [copy]="contentlet.identifier"
                                [label]="contentlet.shortyId"
                                [tooltipText]="'Identifier' | dm"
                                customClass="p-0! [&_.p-button-label]:text-sm [&_.p-button-label]:normal-case" />
                        }
                    </ng-template>

                    <dot-edit-content-sidebar-information
                        [data]="{
                            contentlet: contentlet,
                            contentType: contentType,
                            loading: isLoadingInformation,
                            referencesPageCount: referencePagesCount
                        }"
                        data-testId="information" />
                </dot-edit-content-sidebar-section>

                <dot-edit-content-sidebar-section [title]="'edit.content.sidebar.locales' | dm">
                    <dot-edit-content-sidebar-locales
                        [locales]="$store.locales()"
                        [defaultLocale]="$store.systemDefaultLocale()"
                        [currentLocale]="$store.currentLocale()"
                        [isLoading]="$store.isLoadingLocales()"
                        (switchLocale)="$store.switchLocale($event)"
                        data-testId="locales" />
                </dot-edit-content-sidebar-section>

                <!-- Workflow section -->
                <dot-edit-content-sidebar-section
                    [title]="'edit.content.sidebar.workflow.title' | dm"
                    class="[&_.dot-section]:border-b-0">
                    <dot-edit-content-sidebar-workflow
                        [workflowSelection]="$workflowSelection()"
                        [(showDialog)]="$showDialog"
                        (onSelectWorkflow)="$store.setSelectedWorkflow($event)"
                        [resetWorkflowAction]="$store.getResetWorkflowAction()"
                        (onResetWorkflow)="fireWorkflowAction($event)"
                        [workflow]="$workflow()"
                        [isLoading]="$store.isLoadingWorkflow()"
                        data-testId="workflow" />
                </dot-edit-content-sidebar-section>
            </p-tabpanel>
            <p-tabpanel [value]="1" class="h-full flex flex-col">
                <!-- History section -->
                <dot-edit-content-sidebar-history
                    [historyItems]="$versionsItems()"
                    [status]="$historyStatus()"
                    [contentIdentifier]="$store.contentlet()?.identifier || ''"
                    [historyPagination]="$versionsPagination()"
                    [historicalVersionInode]="$store.historicalVersionInode()"
                    [pushPublishHistoryItems]="$pushPublishHistoryItems()"
                    [pushPublishHistoryPagination]="$pushPublishHistoryPagination()"
                    (historyPageChange)="onVersionsPageChange($event)"
                    (pushPublishPageChange)="onPushPublishPageChange($event)"
                    (timelineItemAction)="onTimelineItemAction($event)"
                    (deletePushPublishHistory)="onDeletePushPublishHistory()"
                    data-testId="history" />
            </p-tabpanel>
            <p-tabpanel [value]="2" class="h-full flex flex-col">
                <!-- Activities section -->
                <dot-edit-content-sidebar-activities
                    [initialContentletState]="$initialContentletState()"
                    [activities]="$activities()"
                    [status]="$activitiesStatus()"
                    (commentSubmitted)="onCommentSubmitted($event)"
                    data-testId="activities" />
            </p-tabpanel>

            <p-tabpanel class="h-full flex-column tab-panel tab-panel--permissions">
                <ng-template pTemplate="header">
                    <i class="pi pi-cog"></i>
                </ng-template>
                <ng-template pTemplate="content">
                    <dot-edit-content-sidebar-permissions
                        [identifier]="$identifier() ?? ''"
                        [languageId]="$contentlet()?.languageId ?? 0"
                        data-testId="permissions" />
                </ng-template>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>
</aside>

<!-- Confirmation dialog for delete actions -->
<p-confirmDialog />

<!-- This is a custom control to hide the sidebar -->
<!-- Append template to add to the tabs -->
<ng-template #appendContent>
    <div
        class="min-h-[50px] border-l border-[var(--gray-200)] flex items-center justify-center flex-0 min-w-[64px]">
        <p-button
            (onClick)="$store.toggleSidebar()"
            [rounded]="true"
            [text]="true"
            [icon]="'pi pi-arrow-right'"
            size="small"
            ariaLabel="Toggle sidebar"
            data-testId="toggle-button"
            [pt]="toggleButtonPt">
            <svg
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <rect
                    x="2.70588"
                    y="3.17658"
                    width="14.5882"
                    height="13.647"
                    rx="1.17647"
                    stroke="currentColor"
                    stroke-width="1.41176" />
                <line
                    x1="12.3528"
                    y1="16.1223"
                    x2="12.3528"
                    y2="3.87806"
                    stroke="currentColor"
                    stroke-width="1.88235" />
                <rect
                    x="10.8887"
                    y="3.77783"
                    width="6.22222"
                    height="12.4444"
                    fill="currentColor" />
            </svg>
        </p-button>
    </div>
</ng-template>
