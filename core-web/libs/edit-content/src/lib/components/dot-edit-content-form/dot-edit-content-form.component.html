@let contentType = $store.contentType();
@let variable = contentType.variable;
@let contentlet = $store.contentlet();
@let tabs = $tabs();

<!-- TODO: Handle the error, no form -->
@if (form) {
    <form [formGroup]="form" class="p-fluid dot-edit-content-form h-100">
        <p-tabView
            [scrollable]="true"
            data-testId="edit-content-multiple-tabs"
            class="dot-edit-content-tabview">
            <!-- Add prepend and append areas to the tabs -->
            <ng-template
                dotTabViewInsert
                [dotTabViewPrepend]="prependContent"
                [dotTabViewAppend]="appendContent"></ng-template>
            <!-- Generations of panels  -->
            @for (tab of tabs; track tab) {
                <p-tabPanel [header]="tab.title">
                    <ng-container *ngTemplateOutlet="tabTemplate; context: { tab: tab }" />
                </p-tabPanel>
            }
        </p-tabView>

        <ng-template #tabTemplate let-tab="tab">
            <div class="dot-edit-content-form__layout">
                @for (row of tab.layout; track row) {
                    <div class="dot-edit-content-form__layout-row" data-testId="row">
                        @for (column of row.columns; track column) {
                            <div class="dot-edit-content-form__layout-column" data-testId="column">
                                @for (field of column.fields; track field) {
                                    @if (!isFilteredType(field)) {
                                        <dot-edit-content-field
                                            [contentType]="variable"
                                            [contentlet]="contentlet"
                                            [field]="field"
                                            data-testId="field" />
                                    }
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </ng-template>
    </form>
}

<!-- Prepend template to add to the tabs-->
<ng-template #prependContent>
    <div class="back-button__wrapper h-100 flex">
        <button
            pButton
            (click)="goBack()"
            icon="pi pi-chevron-left"
            class="p-button-tertiary p-button-rounded p-button-sm"></button>
    </div>
</ng-template>

<!-- Append template to add to the tabs -->
<ng-template #appendContent>
    <div
        class="dot-edit-content-actions"
        [class.dot-edit-content-actions--sidebar-open]="$store.showSidebar()">
        <dot-workflow-actions
            (actionFired)="
                fireWorkflowAction({
                    actionId: $event.id,
                    inode: contentlet?.inode,
                    contentType: variable
                })
            "
            [actions]="$store.actions()"
            [groupActions]="true" />

        <div
            class="dot-edit-content-actions__sidebar-toggle"
            [class.dot-edit-content-actions__sidebar-toggle--hidden]="$store.showSidebar()">
            <button
                class="dot-edit-content-actions__sidebar-btn p-button p-button-sm p-button-text p-button-rounded p-button-icon-only"
                (click)="$store.toggleSidebar()"
                data-testId="sidebar-toggle">
                <svg
                    width="20"
                    height="20"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <rect
                        x="2.70588"
                        y="3.17659"
                        width="14.5882"
                        height="13.6471"
                        rx="1.17647"
                        stroke="#426BF0"
                        stroke-width="1.41176" />
                    <line
                        x1="12.3528"
                        y1="16.1223"
                        x2="12.3528"
                        y2="3.87797"
                        stroke="#426BF0"
                        stroke-width="1.88235" />
                </svg>
            </button>
        </div>
    </div>
</ng-template>
