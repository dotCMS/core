@let contentType = $store.contentType();
@let contentlet = $store.contentlet();
@let showSidebar = $store.isSidebarOpen();
@let actions = $store.getActions();
@let showWorkflowActions = $store.showWorkflowActions();
@let activeIndex = $store.activeTab();

<!--Locales-->
@let currentLocale = $store.currentLocale();
@let currentLocaleId = currentLocale ? currentLocale.id.toString() : '';
@let currentIdentifier = $store.currentIdentifier();

<!--Lock-->
@let isContentLocked = $store.isContentLocked();
@let canLock = $store.canLock();
@let lockSwitchLabel = $store.lockSwitchLabel();
@let tabs = $tabs();

<!-- TODO: Handle the error, no form -->
@if (form) {
    <form
        [formGroup]="form"
        data-testId="edit-content-form"
        class="p-fluid h-full">
        <p-tabs
            [scrollable]="true"
            data-testId="edit-content-multiple-tabs"
            [class.dot-edit-content-tabview--single-tab]="$hasSingleTab()"
            (valueChange)="onActiveIndexChange($event)"
            [value]="activeIndex"
            scrollable="false"
            class="dot-edit-content-tabview">
            <!-- Add prepend and append areas to the tabs -->
            <ng-template dotTabViewInsert [dotTabViewAppend]="appendContent" />

            <p-tablist>
                <!--
                WARNING: TABS MUST NOT BE LAZY!
                Custom fields need to execute code that doesn't depend on whether the tab is active or not.
                They must load earlier, not lazy. Making tabs lazy will break custom fields functionality.
                -->
                @for (tab of tabs; track tab; let i = $index) {
                    <p-tab [value]="i" [@fadeIn]>
                        {{ tab.title }}
                    </p-tab>
                }
            </p-tablist>
            <p-tabpanels>
                @for (tab of tabs; track tab; let i = $index) {
                    <p-tabpanel [value]="i">
                        <ng-container *ngTemplateOutlet="tabPanelTemplate; context: { tab: tab }" />
                    </p-tabpanel>
                }
            </p-tabpanels>
        </p-tabs>

        <!-- Template for the tab tabPanel -->
        <ng-template #tabPanelTemplate let-tab="tab">
            <div class="p-4">
                @for (row of tab.layout; track row) {
                    <div
                        class="grid grid-flow-col auto-cols-[minmax(0,1fr)] gap-4 mb-4 last:mb-0"
                        data-testId="row">
                        @for (column of row.columns; track column) {
                            <div class="flex flex-col gap-4" data-testId="column">
                                @for (field of column.fields; track field) {
                                    <dot-edit-content-field
                                        [contentType]="contentType"
                                        [contentlet]="contentlet"
                                        [field]="field"
                                        (disabledWYSIWYGChange)="onDisabledWYSIWYGChange($event)"
                                        data-testId="field" />
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </ng-template>
    </form>
}

<!-- Append template to add to the tabs -->
<ng-template #appendContent>
    <div
        class="flex items-center w-full min-h-[52px] pr-4"
        data-testId="edit-content-actions"
        [class.dot-edit-content-actions--sidebar-open]="showSidebar">
        <!-- Left group for lock controls -->
        <div class="flex items-center gap-4">
            @if (!$store.isViewingHistoricalVersion()) {
                @if (canLock) {
                    <div
                        class="flex items-center gap-2"
                        [class.locked]="isContentLocked"
                        data-testid="content-lock-controls">
                        <p-toggleSwitch
                            [ngModel]="isContentLocked"
                            [disabled]="!canLock"
                            (onChange)="onContentLockChange($event)"
                            inputId="lockSwitch"
                            data-testId="content-lock-switch" />
                        <label for="lockSwitch" class="text-sm">{{ lockSwitchLabel | dm }}</label>
                    </div>
                }
            }
        </div>

        <!-- Right group for all other actions -->
        <div class="flex items-center gap-4 ml-auto">
            @if ($store.isViewingHistoricalVersion()) {
                <!-- Historical version actions - only Restore -->
                <button
                    pButton
                    (click)="$store.restoreCurrentHistoricalVersion()"
                    data-testId="restore-historical-version-button">
                    {{ 'edit.content.sidebar.history.restore' | dm }}
                </button>
                <!-- Compare button hidden as requested -->
            } @else {
                <!-- Normal actions -->
                @if ($showPreviewLink()) {
                    <button
                        pButton
                        class="p-button-link p-button-md"
                        text="true"
                        data-testId="preview-button"
                        (click)="showPreview()">
                        {{ 'edit.content.preview-link' | dm }}
                    </button>
                }

                @if (showWorkflowActions) {
                    <dot-workflow-actions
                        data-testId="workflow-actions"
                        (actionFired)="
                            fireWorkflowAction({
                                workflow: $event,
                                inode: contentlet?.inode,
                                contentType: contentType.variable,
                                languageId: currentLocaleId,
                                identifier: currentIdentifier
                            })
                        "
                        [actions]="actions"
                        [groupActions]="true" />
                }
            }

            @if (!showSidebar) {
                <!-- Sidebar toggle: only rendered when sidebar is collapsed to avoid white space when open -->
                <div
                    class="flex items-center border-l border-gray-300 min-h-[52px] min-w-16 justify-center"
                    data-testId="sidebar-toggle">
                    <button
                        class="p-button p-button-sm p-button-text p-button-rounded p-button-icon-only text-primary"
                        (click)="$store.toggleSidebar()"
                        data-testId="sidebar-toggle-button">
                        <svg
                            class="stroke-current"
                            width="20"
                            height="20"
                            viewBox="0 0 20 20"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <rect
                                x="2.70588"
                                y="3.17659"
                                width="14.5882"
                                height="13.6471"
                                rx="1.17647"
                                stroke="currentColor"
                                stroke-width="1.41176" />
                            <line
                                x1="12.3528"
                                y1="16.1223"
                                x2="12.3528"
                                y2="3.87797"
                                stroke="currentColor"
                                stroke-width="1.88235" />
                        </svg>
                    </button>
                </div>
            }
        </div>
    </div>
</ng-template>
