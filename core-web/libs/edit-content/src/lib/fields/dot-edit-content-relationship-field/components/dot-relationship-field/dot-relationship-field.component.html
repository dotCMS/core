@let pagination = store.pagination();
@let showPagination = store.totalPages() > 1;
@let data = store.data();
@let isDisabled = $isDisabled();
@let isEmpty = data.length === 0;
@let field = $field();
@let hintText = field.hint || null;
@let hasError = $hasError();
@let isRequired = $isRequired();

<p-table
    [value]="data"
    [columns]="store.columns()"
    data-testid="relationship-field-table"
    class="dot-relationship-field-table"
    [paginator]="false"
    [first]="pagination.offset"
    [rows]="pagination.rowsPerPage"
    [scrollable]="true"
    [reorderableColumns]="false"
    (onRowReorder)="onRowReorder($event)">
    <ng-template pTemplate="header" let-columns>
        <p-menu #menu [model]="$menuItems()" [popup]="true" appendTo="body" />

        <tr class="font-bold bg-[var(--gray-100)]">
            <th scope="col" class="w-12 min-w-12"></th>

            @for (column of columns; track $index) {
                @switch (column.type) {
                    @case ('title') {
                        <th scope="col" [class.w-48]="!isEmpty" [class.min-w-48]="!isEmpty">
                            {{ 'dot.file.relationship.field.table.title' | dm }}
                        </th>
                    }
                    @case ('language') {
                        <th scope="col" [class.min-w-32]="!isEmpty">
                            {{ 'dot.file.relationship.field.table.language' | dm }}
                        </th>
                    }
                    @case ('status') {
                        <th scope="col" [class.min-w-32]="!isEmpty">
                            {{ 'dot.file.relationship.field.table.status' | dm }}
                        </th>
                    }
                    @case ('image') {
                        <th scope="col" [class.w-24]="!isEmpty" [class.min-w-24]="!isEmpty">
                            <p class="truncate capitalize">{{ column.header }}</p>
                        </th>
                    }
                    @default {
                        <th scope="col" [class.min-w-32]="!isEmpty">
                            <span class="capitalize">{{ column.header }}</span>
                        </th>
                    }
                }
            }

            <th scope="col" class="w-16 min-w-16" alignFrozen="right" pFrozenColumn [frozen]="true">
                <p-button
                    (onClick)="menu.toggle($event)"
                    size="small"
                    icon="pi pi-plus"
                    [text]="true"
                    [disabled]="isDisabled" />
            </th>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td [colSpan]="$totalColumns()">
                <div class="flex p-2 gap-2 justify-center items-center">
                    <i class="pi pi-folder-open"></i>
                    <p class="text-[var(--gray-600)]">
                        {{ 'dot.file.relationship.field.empty.message' | dm }}
                    </p>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-item let-index="rowIndex" let-columns="columns">
        <tr
            [pReorderableRow]="index"
            [class.opacity-50]="isDisabled"
            [class.cursor-not-allowed]="isDisabled">
            <td class="w-12 min-w-12">
                @if (!isDisabled) {
                    <span class="pi pi-bars text-[var(--gray-600)]" pReorderableRowHandle></span>
                } @else {
                    <span class="pi pi-bars text-[var(--gray-600)] cursor-not-allowed"></span>
                }
            </td>

            @for (column of columns; track $index) {
                @switch (column.type) {
                    @case ('title') {
                        <td class="w-48 min-w-48" [class.cursor-not-allowed]="isDisabled">
                            <p class="truncate">{{ item.title }}</p>
                        </td>
                    }
                    @case ('language') {
                        <td class="min-w-32" [class.cursor-not-allowed]="isDisabled">
                            {{ item.language | language }}
                        </td>
                    }
                    @case ('status') {
                        <td class="min-w-32" [class.cursor-not-allowed]="isDisabled">
                            @let status = item | contentletStatus;
                            <p-chip
                                [class]="'p-chip-sm ' + status.classes"
                                [label]="status.label" />
                        </td>
                    }
                    @case ('image') {
                        <td class="w-24 min-w-24" [class.cursor-not-allowed]="isDisabled">
                            <div class="flex items-center justify-center">
                                <dot-contentlet-thumbnail
                                    [iconSize]="'30px'"
                                    [contentlet]="item"
                                    [playableVideo]="false"
                                    data-testId="contentlet-thumbnail" />
                            </div>
                        </td>
                    }
                    @default {
                        <td class="min-w-32">
                            <p class="truncate">{{ item[column.nameField] }}</p>
                        </td>
                    }
                }
            }

            <td
                class="w-16 min-w-16"
                pFrozenColumn
                alignFrozen="right"
                [frozen]="true"
                [class.cursor-not-allowed]="isDisabled">
                <p-button
                    size="small"
                    icon="pi pi-times"
                    severity="secondary"
                    [text]="true"
                    [disabled]="isDisabled"
                    (onClick)="deleteItem(item.inode)" />
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="summary">
        @if (hintText || showPagination || hasError) {
            <div
                class="flex items-center pt-2"
                [class.justify-between]="hintText || hasError"
                [class.justify-center]="!hintText && !hasError">
                @if (hasError) {
                    <div class="text-[var(--color-palette-red)]">
                        @if (isRequired) {
                            <small>{{ 'dot.edit.content.form.field.required' | dm }}</small>
                        }
                    </div>
                }
                @if (!hasError && hintText) {
                    <div class="text-[var(--gray-600)]">
                        <small [attr.data-testId]="'hint-' + field.variable">
                            {{ hintText }}
                        </small>
                    </div>
                }
                @if (showPagination) {
                    <dot-pagination
                        [currentPageReportLayout]="'center'"
                        (nextPage)="store.nextPage()"
                        (previousPage)="store.previousPage()"
                        [totalPages]="store.totalPages()"
                        [currentPage]="pagination.currentPage" />
                }
            </div>
        }
    </ng-template>
</p-table>
