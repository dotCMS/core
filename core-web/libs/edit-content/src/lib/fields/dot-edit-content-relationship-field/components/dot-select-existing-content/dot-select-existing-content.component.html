@let data = store.data();
@let columns = store.columns();
@let pagination = store.pagination();

@if ($visible()) {
    @defer {
        <p-dialog
            [modal]="true"
            [(visible)]="$visible"
            (onShow)="onShowDialog()"
            (onHide)="emitSelectedItems()"
            [draggable]="false"
            dataKey="id"
            appendTo="body"
            width="90%"
            [style]="{ width: '90%', 'max-width': '1040px', height: '90vh' }">
            <ng-template pTemplate="header">
                <div class="flex items-center justify-center gap-2">
                    <i class="pi pi-search"></i>
                    <span class="p-dialog-title">
                        {{ 'dot.file.relationship.dialog.search' | dm }}
                    </span>
                </div>
            </ng-template>
            @if (store.errorMessage()) {
                <div
                    class="flex justify-content-center border-1 border-solid border-gray-400 p-6 border-round text-base">
                    <p>{{ store.errorMessage() | dm }}</p>
                </div>
            } @else if (data.length === 0) {
                <div
                    class="flex justify-content-center border-1 border-solid border-gray-400 p-6 border-round text-base gap-2">
                    <i class="pi pi-folder-open"></i>
                    <p>{{ 'dot.file.relationship.dialog.search.empty.content' | dm }}</p>
                </div>
            } @else {
                <p-table
                    #datatable
                    [columns]="columns"
                    [value]="data"
                    selectionMode="multiple"
                    [(selection)]="$selectedItems"
                    [loading]="store.isLoading()"
                    [paginator]="data.length > pagination.rowsPerPage"
                    [first]="pagination.offset"
                    [rows]="pagination.rowsPerPage"
                    [scrollable]="true"
                    [globalFilterFields]="['title', 'step', 'description']"
                    styleClass="dotTable p-datatable-existing-content w-full">
                    <ng-template pTemplate="caption">
                        <div class="flex justify-content-between align-items-center w-full">
                            <div class="flex align-items-center gap-2">
                                <div class="flex-none">
                                    <dot-search
                                        (onSearch)="datatable.filterGlobal($event, 'contains')" />
                                </div>
                                <div class="flex-grow-1">
                                    <p class="text-primary-500">
                                        {{
                                            'dot.file.relationship.dialog.per.page'
                                                | dm: [pagination.rowsPerPage.toString()]
                                        }}
                                    </p>
                                </div>
                            </div>
                            @if (data.length > pagination.rowsPerPage) {
                                <dot-pagination
                                    [currentPageReportLayout]="'left'"
                                    (nextPage)="store.nextPage()"
                                    (previousPage)="store.previousPage()"
                                    [totalPages]="store.totalPages()"
                                    [currentPage]="pagination.currentPage" />
                            }
                        </div>
                    </ng-template>
                    <ng-template pTemplate="header" styleClass="relative" let-columns>
                        <tr>
                            <th
                                scope="col"
                                style="width: 4rem"
                                pFrozenColumn
                                alignFrozen="left"
                                [frozen]="true">
                                <p-tableHeaderCheckbox />
                            </th>
                            @for (column of columns; track $index) {
                                <th
                                    class="max-w-12rem"
                                    scope="col"
                                    [pSortableColumn]="column.field">
                                    <span class="capitalize">{{ column.header }}</span>
                                    <p-sortIcon [field]="column.field" />
                                </th>
                            }
                            <th scope="col" pFrozenColumn alignFrozen="right" [frozen]="true">
                                {{ 'dot.file.relationship.dialog.menu.column' | dm }}
                            </th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-item let-columns="columns">
                        <tr [class.p-highlight]="checkIfSelected(item)">
                            <td pFrozenColumn alignFrozen="left" [frozen]="true">
                                <p-tableCheckbox [value]="item" />
                            </td>
                            @for (column of columns; track $index) {
                                <td class="max-w-12rem">
                                    <p class="truncate-text">{{ item[column.field] }}</p>
                                </td>
                            }
                            <td pFrozenColumn alignFrozen="right" [frozen]="true">
                                <i class="pi pi-pencil"></i>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            }
            <ng-template pTemplate="footer">
                <div class="flex justify-content-between">
                    <div>
                        <p class="text-primary-500">
                            {{
                                'dot.file.relationship.dialog.selected.items'
                                    | dm: [$selectedItems().length.toString()]
                            }}
                        </p>
                    </div>
                    <div>
                        <p-button
                            [label]="'Cancel' | dm"
                            [outlined]="true"
                            (onClick)="closeDialog()"
                            [text]="true"
                            severity="primary" />
                        <p-button
                            [disabled]="$isApplyDisabled()"
                            (onClick)="closeDialog()"
                            [label]="$applyLabel()" />
                    </div>
                </div>
            </ng-template>
        </p-dialog>
    }
}
