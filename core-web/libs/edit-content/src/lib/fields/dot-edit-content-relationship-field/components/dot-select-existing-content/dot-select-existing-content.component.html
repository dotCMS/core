@let data = store.data();
@let columns = store.columns();
@let pagination = store.pagination();
@let selectionMode = store.selectionMode();
@let totalItems = $items().length;

<div class="flex flex-column gap-2 h-full justify-content-between">
    @if (store.errorMessage()) {
        <div
            class="flex justify-content-center border-1 border-solid border-gray-400 p-6 border-round text-base">
            <p>{{ store.errorMessage() | dm }}</p>
        </div>
    } @else if (data.length === 0) {
        <div
            class="flex justify-content-center border-1 border-solid border-gray-400 p-6 border-round text-base gap-2">
            <i class="pi pi-folder-open"></i>
            <p>{{ 'dot.file.relationship.dialog.search.empty.content' | dm }}</p>
        </div>
    } @else {
        <p-table
            #datatable
            [columns]="columns"
            [value]="data"
            [selectionMode]="selectionMode"
            [(selection)]="$selectedItems"
            [loading]="store.isLoading()"
            [paginator]="data.length > pagination.rowsPerPage"
            [first]="pagination.offset"
            [rows]="pagination.rowsPerPage"
            [scrollable]="true"
            [globalFilterFields]="['title', 'step', 'description']"
            styleClass="dotTable p-datatable-existing-content w-full">
            <ng-template pTemplate="caption">
                <div class="flex justify-content-between align-items-center w-full">
                    <div class="flex align-items-center gap-2">
                        <div class="flex-none">
                            <dot-search (onSearch)="datatable.filterGlobal($event, 'contains')" />
                        </div>
                        <div class="flex-grow-1">
                            <p class="text-primary-500">
                                {{
                                    'dot.file.relationship.dialog.per.page'
                                        | dm: [pagination.rowsPerPage.toString()]
                                }}
                            </p>
                        </div>
                    </div>
                    @if (data.length > pagination.rowsPerPage) {
                        <dot-pagination
                            [currentPageReportLayout]="'left'"
                            (nextPage)="store.nextPage()"
                            (previousPage)="store.previousPage()"
                            [totalPages]="store.totalPages()"
                            [currentPage]="pagination.currentPage" />
                    }
                </div>
            </ng-template>
            <ng-template pTemplate="header" styleClass="relative" let-columns>
                <tr>
                    <th
                        scope="col"
                        class="max-w-5rem"
                        pFrozenColumn
                        alignFrozen="left"
                        [frozen]="true">
                        @if (selectionMode === 'multiple') {
                            <p-tableHeaderCheckbox />
                        }
                    </th>
                    @for (column of columns; track $index) {
                        <th class="max-w-12rem" scope="col" [pSortableColumn]="column.field">
                            <span class="capitalize">{{ column.header }}</span>
                            <p-sortIcon [field]="column.field" />
                        </th>
                    }
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-columns="columns">
                <tr [class.p-highlight]="checkIfSelected(item)">
                    <td class="max-w-5rem" pFrozenColumn alignFrozen="left" [frozen]="true">
                        @if (selectionMode === 'multiple') {
                            <p-tableCheckbox [value]="item" />
                        } @else {
                            <p-tableRadioButton [value]="item" />
                        }
                    </td>
                    @for (column of columns; track $index) {
                        <td class="max-w-12rem">
                            <p class="truncate-text">{{ item.dynamicFields[column.field] }}</p>
                        </td>
                    }
                </tr>
            </ng-template>
        </p-table>
    }
    <div class="flex justify-content-between">
        <div>
            <p class="text-primary-500">
                {{ 'dot.file.relationship.dialog.selected.items' | dm: [totalItems.toString()] }}
            </p>
        </div>
        <div class="flex gap-2">
            <p-button
                [label]="'Cancel' | dm"
                [outlined]="true"
                (onClick)="closeDialog()"
                [text]="true"
                severity="primary" />
            <p-button
                [disabled]="totalItems === 0"
                (onClick)="closeDialog()"
                [label]="$applyLabel()" />
        </div>
    </div>
</div>
