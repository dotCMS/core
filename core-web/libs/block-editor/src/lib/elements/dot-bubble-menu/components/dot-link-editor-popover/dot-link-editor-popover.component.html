<div
    class="bubble-link-form"
    dotEditorModal
    #popover
    [editor]="editor()"
    [tippyOptions]="tippyModalOptions">
    <input
        #input
        pInputText
        type="text"
        placeholder="Paste link or search for pages"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchQueryChange($event)"
        (keydown.enter)="addLinkToNode(searchQuery())"
        [autofocus]="true"
        [style]="{ width: '100%' }"
        (keydown)="handleSearchInputKeyDown($event)" />

    @if (isSearching()) {
        <p-listbox
            [options]="[1, 2, 3]"
            [style]="{ width: '100%' }"
            [listStyle]="{ 'max-height': '250px' }">
            <ng-template let-item pTemplate="item">
                <div class="listbox-item">
                    <p-skeleton width="48px" height="48px"></p-skeleton>
                    <div class="skeleton-lines">
                        <p-skeleton width="80%" height="14px"></p-skeleton>
                        <p-skeleton width="40%" height="14px"></p-skeleton>
                    </div>
                </div>
            </ng-template>
        </p-listbox>
    }

    @if (showSearchResults()) {
        <p-listbox
            #resultListbox
            optionLabel="displayName"
            [options]="searchResults()"
            (onChange)="addLinkToNode($event.value.url)"
            [style]="{ width: '100%' }"
            [listStyle]="{ 'max-height': '250px' }">
            <ng-template let-item pTemplate="item">
                <div class="listbox-item">
                    @if (item.hasTitleImage) {
                        <img [src]="'/dA/' + item.inode" alt="icon" class="listbox-item__img" />
                    } @else {
                        <span class="listbox-item__icon pi pi-file"></span>
                    }
                    <div class="listbox-item__content">
                        <div class="listbox-item__title">{{ item.displayName }}</div>
                        <div class="listbox-item__url">{{ item.url }}</div>
                    </div>
                </div>
            </ng-template>

            <ng-template pTemplate="empty">
                <div class="empty-message">
                    <span class="empty-message__text">
                        No results for
                        <br />
                        <b>{{ searchQuery() }}</b>
                    </span>
                </div>
            </ng-template>
        </p-listbox>
    }

    @if (showLinkDetails()) {
        <div class="current-link-view">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem">
                <span class="pi pi-globe" style="font-size: 1.5em"></span>
                <a
                    [href]="existingLinkUrl()"
                    [target]="linkTargetAttribute()"
                    rel="noopener noreferrer"
                    style="
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                        max-width: 300px;
                        display: inline-block;
                    ">
                    {{ existingLinkUrl() }}
                </a>
            </div>
            <div style="margin-bottom: 2rem">
                <input
                    type="checkbox"
                    id="openInNewWindow"
                    [checked]="linkTargetAttribute() === '_blank'"
                    (change)="toggleTarget($event)"
                    style="margin-right: 4px" />
                <label for="openInNewWindow">Open link in new window</label>
            </div>
            <div style="display: flex; gap: 12px">
                <button
                    pButton
                    type="button"
                    style="width: 50%"
                    class="p-button-outlined"
                    (click)="copyLink()"
                    label="Copy Link"></button>
                <button
                    pButton
                    type="button"
                    style="width: 50%"
                    class="p-button-outlined"
                    (click)="removeLink()"
                    label="Remove Link"></button>
            </div>
        </div>
    }
</div>
